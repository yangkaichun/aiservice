<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三軍總醫院北投分院 - 智慧遠距精神醫療照護平台</title>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#64748B', // Slate 500
                        accent: '#E60012', // FET Red
                        success: '#10B981', // Emerald 500
                        warning: '#F59E0B', // Amber 500
                        danger: '#EF4444', // Red 500
                        sleep: {
                            deep: '#312E81',
                            light: '#818CF8',
                            rem: '#C084FC',
                            awake: '#FCA5A5',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F1F5F9; }
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .animate-slide-in { animation: slideInRight 0.3s ease-out forwards; }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || null;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area, Legend, PieChart, Pie, Cell } = RechartsObj || {};

        // --- Mock Data ---
        const mockPatients = [
            { id: 1, mrn: 'TSGH-8821', name: '王大明', age: 28, gender: '男', diagnosis: 'PTSD', risk: 'High', heartRate: 88, edaAvg: 5.5, sleepScore: 52, lastSync: '10分鐘前', status: '觀察中', medications: [{name: 'Zoloft (Sertraline)', dose: '50mg', freq: 'QD'}, {name: 'Xanax (Alprazolam)', dose: '0.5mg', freq: 'PRN'}] },
            { id: 2, mrn: 'TSGH-8822', name: '李小美', age: 34, gender: '女', diagnosis: '重度憂鬱', risk: 'Medium', heartRate: 72, edaAvg: 3.1, sleepScore: 78, lastSync: '1小時前', status: '穩定', medications: [{name: 'Prozac (Fluoxetine)', dose: '20mg', freq: 'QD'}] },
            { id: 3, mrn: 'TSGH-8823', name: '張志豪', age: 45, gender: '男', diagnosis: '焦慮症', risk: 'Low', heartRate: 68, edaAvg: 1.8, sleepScore: 85, lastSync: '剛剛', status: '穩定', medications: [{name: 'Lexapro (Escitalopram)', dose: '10mg', freq: 'QD'}] },
            { id: 4, mrn: 'TSGH-8824', name: '陳建國', age: 52, gender: '男', diagnosis: '酒精依賴', risk: 'High', heartRate: 92, edaAvg: 6.2, sleepScore: 45, lastSync: '30分鐘前', status: '警示', medications: [{name: 'Naltrexone', dose: '50mg', freq: 'QD'}, {name: 'Thiamine', dose: '100mg', freq: 'TID'}] },
            { id: 5, mrn: 'TSGH-8825', name: '林雅婷', age: 29, gender: '女', diagnosis: '適應障礙', risk: 'Medium', heartRate: 75, edaAvg: 2.8, sleepScore: 70, lastSync: '2小時前', status: '穩定', medications: [{name: 'Stilnox', dose: '10mg', freq: 'HS'}] },
            { id: 6, mrn: 'TSGH-8826', name: '黃國榮', age: 60, gender: '男', diagnosis: '失眠症', risk: 'Low', heartRate: 65, edaAvg: 1.5, sleepScore: 60, lastSync: '5分鐘前', status: '穩定', medications: [{name: 'Melatonin', dose: '5mg', freq: 'HS'}] },
            { id: 7, mrn: 'TSGH-8827', name: '劉淑芬', age: 41, gender: '女', diagnosis: '恐慌症', risk: 'High', heartRate: 95, edaAvg: 7.1, sleepScore: 48, lastSync: '斷線', status: '失聯', medications: [{name: 'Seroxat', dose: '20mg', freq: 'QD'}, {name: 'Rivotril', dose: '0.5mg', freq: 'BID'}] },
            { id: 8, mrn: 'TSGH-8828', name: '吳志偉', age: 22, gender: '男', diagnosis: '思覺失調', risk: 'Medium', heartRate: 78, edaAvg: 3.2, sleepScore: 65, lastSync: '15分鐘前', status: '觀察中', medications: [{name: 'Abilify', dose: '15mg', freq: 'QD'}] },
            { id: 9, mrn: 'TSGH-8829', name: '蔡佩珊', age: 31, gender: '女', diagnosis: '雙極性情感疾患', risk: 'High', heartRate: 82, edaAvg: 4.8, sleepScore: 55, lastSync: '10分鐘前', status: '警示', medications: [{name: 'Lithium', dose: '300mg', freq: 'TID'}, {name: 'Seroquel', dose: '200mg', freq: 'HS'}] },
            { id: 10, mrn: 'TSGH-8830', name: '楊宗翰', age: 38, gender: '男', diagnosis: 'PTSD', risk: 'Medium', heartRate: 76, edaAvg: 2.5, sleepScore: 72, lastSync: '剛剛', status: '穩定', medications: [{name: 'Efexor', dose: '75mg', freq: 'QD'}] },
        ];

        // Appointments Data
        const mockAppointments = [
            { id: 'A001', date: '2025-05-15', time: '14:00', patient: '王大明', doctor: '陳醫師', type: '視訊回診', status: '預約中' },
            { id: 'A002', date: '2025-05-15', time: '15:30', patient: '李小美', doctor: '林醫師', type: '初診評估', status: '預約中' },
            { id: 'A003', date: '2025-05-14', time: '10:00', patient: '張志豪', doctor: '陳醫師', type: '心理諮商', status: '已完成' },
            { id: 'A004', date: '2025-05-14', time: '11:00', patient: '陳建國', doctor: '陳醫師', type: '視訊回診', status: '已完成' },
            { id: 'A005', date: '2025-05-13', time: '16:00', patient: '林雅婷', doctor: '王醫師', type: '藥物諮詢', status: '已取消' },
            { id: 'A006', date: '2025-05-12', time: '09:00', patient: '黃國榮', doctor: '陳醫師', type: '睡眠治療', status: '已完成' },
            { id: 'A007', date: '2025-05-12', time: '10:30', patient: '吳志偉', doctor: '林醫師', type: '視訊回診', status: '已完成' },
            { id: 'A008', date: '2025-05-11', time: '14:00', patient: '蔡佩珊', doctor: '王醫師', type: '家屬諮詢', status: '已完成' },
            { id: 'A009', date: '2025-05-10', time: '15:00', patient: '楊宗翰', doctor: '陳醫師', type: 'PTSD追蹤', status: '已完成' },
            { id: 'A010', date: '2025-05-09', time: '11:00', patient: '劉淑芬', doctor: '陳醫師', type: '緊急評估', status: '已完成' },
            { id: 'A011', date: '2025-05-08', time: '09:30', patient: '王大明', doctor: '林醫師', type: '心理諮商', status: '已取消' },
            { id: 'A012', date: '2025-05-08', time: '16:00', patient: '李小美', doctor: '王醫師', type: '藥物調整', status: '已完成' },
        ];

        // --- UI Components ---

        const Card = ({ children, className = "", onClick, noHover }) => (
            <div 
                onClick={onClick}
                className={`bg-white rounded-2xl shadow-[0_2px_8px_rgba(0,0,0,0.04)] border border-slate-100 ${className} ${onClick && !noHover ? 'cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all duration-300' : ''}`}
            >
                {children}
            </div>
        );

        const StatusBadge = ({ type, text }) => {
            const styles = {
                High: 'bg-red-50 text-red-700 ring-1 ring-red-600/20',
                Medium: 'bg-amber-50 text-amber-700 ring-1 ring-amber-600/20',
                Low: 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-600/20',
                '預約中': 'bg-blue-50 text-blue-700 ring-1 ring-blue-600/20',
                '已完成': 'bg-slate-100 text-slate-700 ring-1 ring-slate-600/20',
                '已取消': 'bg-gray-100 text-gray-500 ring-1 ring-gray-600/20',
                'critical': 'bg-red-50 text-red-700 border border-red-100',
                'warning': 'bg-amber-50 text-amber-700 border border-amber-100',
                'online': 'bg-emerald-50 text-emerald-600 border border-emerald-100',
                'offline': 'bg-slate-100 text-slate-500 border border-slate-200',
                'syncing': 'bg-blue-50 text-blue-600 border border-blue-100'
            };
            const defaultStyle = 'bg-slate-50 text-slate-600';
            
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[type] || defaultStyle}`}>
                    {text || type}
                </span>
            );
        };

        const FallbackChart = () => (
            <div className="h-full w-full flex flex-col items-center justify-center bg-slate-50 rounded-2xl border border-dashed border-slate-300">
                <i data-lucide="BarChart2" className="w-8 h-8 text-slate-400 mb-2"></i>
                <span className="text-slate-500 text-sm">圖表載入中...</span>
            </div>
        );

        // --- Main Components ---

        const Dashboard = ({ setActivePage, setSelectedPatientId }) => {
            const [view, setView] = useState('main'); 
            const [selectedAlert, setSelectedAlert] = useState(null);
            
            // Alert State
            const [alerts, setAlerts] = useState([
                { id: 101, patientId: 1, type: 'critical', title: 'EDA 指數飆升', desc: '連續 30 分鐘 EDA > 5.0 uS', time: '10:45' },
                { id: 102, patientId: 7, type: 'warning', title: '裝置斷線', desc: '超過 24 小時無訊號回傳', time: '09:20' },
                { id: 103, patientId: 4, type: 'critical', title: '睡眠極短', desc: '昨日深層睡眠僅 15 分鐘', time: '08:15' },
            ]);

            const handleResolveAlert = (id) => {
                setAlerts(prev => prev.filter(a => a.id !== id));
                setSelectedAlert(null);
            };

            const stats = [
                { id: 'enrolled', title: '目前收案人數', value: '1,248', color: 'indigo', icon: 'Users', subView: 'details-enrolled' },
                { id: 'appointments', title: '今日視訊預約', value: '42', color: 'emerald', icon: 'Video', subView: 'details-appointments' },
                { id: 'risk', title: '高風險警示', value: '5', color: 'rose', icon: 'Activity', subView: 'details-risk' },
                { id: 'connection', title: '裝置連線率', value: '98%', color: 'sky', icon: 'Wifi', subView: 'details-connection' },
            ];

            const renderSubView = () => {
                const BackButton = () => (
                    <button 
                        onClick={() => setView('main')} 
                        className="group mb-6 flex items-center text-slate-500 hover:text-primary transition-colors px-4 py-2 bg-white rounded-xl shadow-sm border border-slate-100 hover:border-primary/30"
                    >
                        <i data-lucide="ArrowLeft" className="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform"></i> 
                        <span className="font-medium">返回總覽</span>
                    </button>
                );

                const TableContainer = ({ title, icon, color, children }) => (
                    <div className="animate-slide-in">
                        <BackButton />
                        <Card className="p-6">
                            <div className="flex items-center space-x-3 mb-6">
                                <div className={`p-2.5 rounded-xl bg-${color}-50 text-${color}-600`}>
                                    <i data-lucide={icon} className="w-6 h-6"></i>
                                </div>
                                <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                            </div>
                            <div className="overflow-hidden rounded-xl border border-slate-100">
                                {children}
                            </div>
                        </Card>
                    </div>
                );

                if (view === 'details-eda-dist') {
                    const distData = [
                        { name: '低壓力 (0-2 uS)', value: 850, color: '#10B981' },
                        { name: '中度壓力 (2-5 uS)', value: 320, color: '#F59E0B' },
                        { name: '高壓力 (>5 uS)', value: 78, color: '#EF4444' },
                    ];

                    return (
                        <div className="animate-slide-in">
                            <BackButton />
                            <Card className="p-8">
                                <h3 className="text-2xl font-bold text-slate-800 mb-6 flex items-center">
                                    <i data-lucide="BarChart3" className="w-6 h-6 mr-3 text-primary"></i>
                                    個案壓力指數 (EDA) 詳細分佈分析
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="h-80">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={distData} layout="vertical">
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                <XAxis type="number" />
                                                <YAxis dataKey="name" type="category" width={120} />
                                                <Tooltip cursor={{fill: '#F1F5F9'}} />
                                                <Bar dataKey="value" name="人數" radius={[0, 4, 4, 0]}>
                                                    {distData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={entry.color} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="bg-slate-50 p-6 rounded-2xl">
                                            <h4 className="font-bold text-slate-700 mb-2">分析摘要</h4>
                                            <p className="text-slate-600 leading-relaxed">
                                                全院目前共有 <span className="font-bold text-rose-600">78</span> 位病患處於高壓力區間，主要集中於 PTSD 與恐慌症患者群體。
                                                建議針對高壓力區間病患（EDA > 5 uS）進行優先關懷與主動介入。
                                            </p>
                                        </div>
                                        <div className="bg-blue-50 p-6 rounded-2xl">
                                            <h4 className="font-bold text-blue-700 mb-2">趨勢比較</h4>
                                            <p className="text-blue-600 leading-relaxed">
                                                相較於上週，中度壓力區間人數減少了 5%，顯示部分病患狀況趨於穩定。
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    );
                }

                if (view === 'details-enrolled') {
                    return (
                        <TableContainer title="目前收案名單 (模擬數據)" icon="Users" color="indigo">
                            <table className="min-w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-medium">
                                    <tr>
                                        <th className="px-6 py-4">病歷號</th>
                                        <th className="px-6 py-4">姓名</th>
                                        <th className="px-6 py-4">診斷</th>
                                        <th className="px-6 py-4">風險等級</th>
                                        <th className="px-6 py-4">狀態</th>
                                        <th className="px-6 py-4">操作</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {mockPatients.map(p => (
                                        <tr key={p.id} className="hover:bg-slate-50/50 transition-colors">
                                            <td className="px-6 py-4 font-mono text-slate-600">{p.mrn}</td>
                                            <td className="px-6 py-4 font-medium text-slate-900">{p.name}</td>
                                            <td className="px-6 py-4 text-slate-600">{p.diagnosis}</td>
                                            <td className="px-6 py-4"><StatusBadge type={p.risk} /></td>
                                            <td className="px-6 py-4 text-slate-600">{p.status}</td>
                                            <td className="px-6 py-4">
                                                <button 
                                                    onClick={() => { setSelectedPatientId(p.id); setActivePage('monitoring'); }}
                                                    className="text-primary hover:text-indigo-700 font-medium text-xs border border-primary/20 px-3 py-1.5 rounded-lg hover:bg-primary/5 transition-all"
                                                >
                                                    進入監測
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </TableContainer>
                    );
                }

                if (view === 'details-appointments') {
                     return (
                        <TableContainer title="今日視訊預約列表" icon="Video" color="emerald">
                             <table className="min-w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-medium">
                                    <tr>
                                        <th className="px-6 py-4">時間</th>
                                        <th className="px-6 py-4">病患</th>
                                        <th className="px-6 py-4">醫師</th>
                                        <th className="px-6 py-4">類型</th>
                                        <th className="px-6 py-4">狀態</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {mockAppointments.filter(a => a.date === '2025-05-15').map(a => (
                                        <tr key={a.id} className="hover:bg-slate-50/50">
                                            <td className="px-6 py-4 font-bold text-slate-800">{a.time}</td>
                                            <td className="px-6 py-4 text-slate-700">{a.patient}</td>
                                            <td className="px-6 py-4 text-slate-600">{a.doctor}</td>
                                            <td className="px-6 py-4 text-slate-600">{a.type}</td>
                                            <td className="px-6 py-4"><StatusBadge type={a.status} /></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </TableContainer>
                     );
                }

                if (view === 'details-risk') {
                     return (
                        <TableContainer title="高風險病患清單" icon="Activity" color="rose">
                            <div className="grid gap-4 p-6 bg-rose-50/30">
                                {mockPatients.filter(p => p.risk === 'High').map(p => (
                                    <div key={p.id} className="bg-white p-5 rounded-xl border border-rose-100 shadow-sm flex justify-between items-center hover:shadow-md transition-all">
                                        <div className="flex items-center space-x-4">
                                            <div className="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600">
                                                <i data-lucide="AlertTriangle" className="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-lg">{p.name} <span className="text-sm font-normal text-slate-500 ml-1">({p.mrn})</span></h4>
                                                <p className="text-sm text-slate-600 mt-1">
                                                    診斷: <span className="font-medium">{p.diagnosis}</span> | 
                                                    平均 EDA: <span className="text-rose-600 font-bold">{p.edaAvg}</span>
                                                </p>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => { setSelectedPatientId(p.id); setActivePage('monitoring'); }}
                                            className="px-4 py-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-100 font-medium text-sm transition-colors"
                                        >
                                            詳細數據
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </TableContainer>
                     );
                }

                 if (view === 'details-connection') {
                     return (
                        <div className="animate-slide-in">
                            <BackButton />
                            <Card className="p-8">
                                <div className="text-center mb-10">
                                    <div className="w-16 h-16 bg-sky-50 text-sky-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                        <i data-lucide="Wifi" className="w-8 h-8"></i>
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-800">全院裝置連線監控</h3>
                                    <p className="text-slate-500 mt-2">即時掃描穿戴裝置數據上傳狀態</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div className="bg-emerald-50/50 border border-emerald-100 p-6 rounded-2xl text-center">
                                        <span className="block text-3xl font-bold text-emerald-600 mb-1">1,223</span>
                                        <span className="text-sm font-medium text-emerald-800">連線正常</span>
                                    </div>
                                    <div className="bg-amber-50/50 border border-amber-100 p-6 rounded-2xl text-center">
                                        <span className="block text-3xl font-bold text-amber-600 mb-1">20</span>
                                        <span className="text-sm font-medium text-amber-800">低電量 (&lt;15%)</span>
                                    </div>
                                    <div className="bg-rose-50/50 border border-rose-100 p-6 rounded-2xl text-center">
                                        <span className="block text-3xl font-bold text-rose-600 mb-1">5</span>
                                        <span className="text-sm font-medium text-rose-800">斷線 (&gt;24hr)</span>
                                    </div>
                                </div>
                            </Card>
                        </div>
                     );
                }
            };

            if (view !== 'main') return renderSubView();

            return (
                <div className="space-y-8 animate-fade-in max-w-[1600px] mx-auto">
                    <header className="flex flex-col md:flex-row md:items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-800 tracking-tight flex items-center">
                                <i data-lucide="LayoutDashboard" className="w-8 h-8 mr-3 text-primary"></i>
                                個案總覽
                            </h2>
                            <p className="text-slate-500 mt-1">即時監控全院遠距收案病患狀態與系統運作</p>
                        </div>
                        <div className="mt-4 md:mt-0 px-4 py-2 bg-white rounded-lg border border-slate-200 text-sm text-slate-600 shadow-sm flex items-center">
                            <span className="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span>
                            系統運作正常 | 最後更新: 剛剛
                        </div>
                    </header>

                    {/* Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        {stats.map((stat) => (
                            <div 
                                key={stat.id} 
                                onClick={() => setView(stat.subView)}
                                className={`group bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg hover:-translate-y-1 transition-all-300 cursor-pointer relative overflow-hidden`}
                            >
                                <div className={`absolute top-0 right-0 w-24 h-24 bg-${stat.color}-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                                
                                <div className="relative z-10">
                                    <div className={`w-12 h-12 rounded-xl bg-${stat.color}-50 flex items-center justify-center mb-4 text-${stat.color}-600 group-hover:scale-110 transition-transform`}>
                                        <i data-lucide={stat.icon} className="w-6 h-6"></i>
                                    </div>
                                    <p className="text-slate-500 text-sm font-medium">{stat.title}</p>
                                    <h3 className="text-3xl font-bold text-slate-800 mt-1 tracking-tight">{stat.value}</h3>
                                    
                                    <div className="mt-4 flex items-center text-xs font-medium text-primary opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0">
                                        查看詳情 <i data-lucide="ArrowRight" className="w-3 h-3 ml-1"></i>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Interactive EDA Heatmap Card */}
                        <Card 
                            className="p-6 cursor-pointer hover:shadow-md transition-all group"
                            onClick={() => setView('details-eda-dist')}
                        >
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center">
                                    <span className="w-1 h-6 bg-primary rounded-full mr-3"></span>
                                    個案壓力指數 (EDA) 分佈
                                </h3>
                                <span className="text-xs text-primary font-medium opacity-0 group-hover:opacity-100 transition-opacity flex items-center">
                                    點擊查看詳細分析 <i data-lucide="ArrowRight" className="w-3 h-3 ml-1"></i>
                                </span>
                            </div>
                            <div className="aspect-[2/1] bg-slate-50 rounded-xl border border-slate-100 p-6 flex flex-col items-center justify-center relative overflow-hidden">
                                <div className="grid grid-cols-10 gap-1.5 w-full h-full opacity-80">
                                    {Array.from({ length: 60 }).map((_, i) => (
                                        <div 
                                            key={i} 
                                            className={`rounded-sm transition-opacity hover:opacity-100 ${
                                                Math.random() > 0.9 ? 'bg-rose-400' : 
                                                Math.random() > 0.6 ? 'bg-amber-300' : 
                                                'bg-emerald-200'
                                            }`}
                                            style={{ opacity: Math.random() * 0.5 + 0.5 }}
                                        ></div>
                                    ))}
                                </div>
                                <div className="absolute bottom-4 right-4 bg-white/90 px-3 py-1 rounded-full text-xs text-slate-500 shadow-sm border border-slate-100 flex items-center space-x-2">
                                    <span className="flex items-center"><span className="w-2 h-2 bg-rose-400 rounded-full mr-1"></span>高</span>
                                    <span className="flex items-center"><span className="w-2 h-2 bg-amber-300 rounded-full mr-1"></span>中</span>
                                    <span className="flex items-center"><span className="w-2 h-2 bg-emerald-200 rounded-full mr-1"></span>低</span>
                                </div>
                            </div>
                        </Card>

                        {/* Alerts Card with Resolved Action */}
                        <Card className="p-6 relative">
                            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center">
                                <span className="w-1 h-6 bg-accent rounded-full mr-3"></span>
                                即時異常通報
                                <span className="ml-auto bg-rose-100 text-rose-600 text-xs px-2 py-1 rounded-full">{alerts.length} 待處理</span>
                            </h3>
                            <div className="space-y-3">
                                {alerts.length === 0 ? (
                                    <div className="text-center py-8 text-slate-400">
                                        <i data-lucide="CheckCircle" className="w-8 h-8 mx-auto mb-2 text-emerald-400"></i>
                                        目前無異常通報
                                    </div>
                                ) : alerts.map((alert) => {
                                    const patient = mockPatients.find(p => p.id === alert.patientId);
                                    return (
                                        <div 
                                            key={alert.id} 
                                            className={`group flex items-center justify-between p-4 rounded-xl border transition-all hover:shadow-md ${
                                                alert.type === 'critical' ? 'bg-rose-50/50 border-rose-100' : 'bg-amber-50/50 border-amber-100'
                                            }`}
                                        >
                                            <div className="flex items-start space-x-4">
                                                <div className={`mt-1 p-2 rounded-lg ${alert.type === 'critical' ? 'bg-white text-rose-500' : 'bg-white text-amber-500'}`}>
                                                    <i data-lucide={alert.type === 'critical' ? 'AlertTriangle' : 'AlertCircle'} className="w-5 h-5"></i>
                                                </div>
                                                <div>
                                                    <div className="flex items-center">
                                                        <span className="font-bold text-slate-800 text-sm mr-2">{patient?.name}</span>
                                                        <span className="text-xs text-slate-500 font-mono">({patient?.mrn})</span>
                                                    </div>
                                                    <p className="text-sm font-medium text-slate-700 mt-0.5">{alert.title}</p>
                                                    <span className="text-xs text-slate-400 mt-1 block flex items-center">
                                                        <i data-lucide="Clock" className="w-3 h-3 mr-1"></i> {alert.time}
                                                    </span>
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => setSelectedAlert({...alert, patientName: patient?.name})}
                                                className="opacity-0 group-hover:opacity-100 transition-opacity bg-white text-slate-600 border border-slate-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary hover:text-white hover:border-primary"
                                            >
                                                查看
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Alert Modal with Resolve Button */}
                            {selectedAlert && (
                                <div className="absolute inset-0 z-20 flex items-center justify-center p-4">
                                    <div className="absolute inset-0 bg-white/60 backdrop-blur-sm rounded-2xl" onClick={() => setSelectedAlert(null)}></div>
                                    <div className="relative bg-white rounded-2xl shadow-xl border border-slate-100 p-6 w-full max-w-sm animate-fade-in">
                                        <div className={`w-14 h-14 rounded-full mx-auto mb-4 flex items-center justify-center ${selectedAlert.type === 'critical' ? 'bg-rose-100 text-rose-600' : 'bg-amber-100 text-amber-600'}`}>
                                            <i data-lucide="AlertTriangle" className="w-7 h-7"></i>
                                        </div>
                                        <h4 className="text-xl font-bold text-slate-900 text-center mb-1">{selectedAlert.title}</h4>
                                        <p className="text-slate-500 text-center text-sm mb-6">病患: {selectedAlert.patientName}</p>
                                        
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm space-y-2 mb-6">
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">異常描述</span>
                                                <span className="text-slate-800 font-medium text-right">{selectedAlert.desc}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">發生時間</span>
                                                <span className="text-slate-800 font-medium">{selectedAlert.time}</span>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <button 
                                                onClick={() => handleResolveAlert(selectedAlert.id)}
                                                className="px-4 py-2.5 rounded-xl border-2 border-emerald-500 text-emerald-600 font-bold hover:bg-emerald-50 transition-colors flex items-center justify-center"
                                            >
                                                <i data-lucide="CheckCircle" className="w-4 h-4 mr-2"></i> 已處理
                                            </button>
                                            <button 
                                                onClick={() => { setSelectedAlert(null); setSelectedPatientId(selectedAlert.patientId); setActivePage('monitoring'); }}
                                                className="px-4 py-2.5 rounded-xl bg-primary text-white font-medium hover:bg-indigo-700 shadow-lg shadow-indigo-500/20 transition-all"
                                            >
                                                前往監測
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </Card>
                    </div>
                </div>
            );
        };

        // --- Patient Monitoring (Original Design: AI & Detailed Sleep) ---
        
        const PatientMonitoring = ({ selectedPatientId, setSelectedPatientId }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [activeMetricView, setActiveMetricView] = useState(null); 
            const patient = mockPatients.find(p => p.id === selectedPatientId) || mockPatients[0];

            // Generating mock data
            const graphData = useMemo(() => {
                const baseHr = patient.heartRate;
                const baseEda = patient.edaAvg;
                return Array.from({ length: 12 }, (_, i) => ({
                    time: `${8 + i}:00`,
                    heartRate: Math.floor(baseHr + Math.sin(i) * 10 + Math.random() * 5),
                    eda: Math.abs(baseEda + Math.cos(i) * 1.5 + Math.random()).toFixed(2)
                }));
            }, [patient]);

            // Mock 24h Data for Sub-views
            const hr24h = useMemo(() => Array.from({length: 24}, (_, i) => ({ time: `${i}:00`, value: 60 + Math.random()*40 })), [patient]);
            const eda24h = useMemo(() => Array.from({length: 24}, (_, i) => ({ time: `${i}:00`, value: (Math.random()*8).toFixed(1) })), [patient]);
            const sleep7d = useMemo(() => Array.from({length: 7}, (_, i) => ({ day: `Day ${i+1}`, score: 60 + Math.floor(Math.random()*30) })), [patient]);
            const batteryLog = useMemo(() => Array.from({length: 12}, (_, i) => ({ time: `${i*2}:00`, level: 100 - i*5 })), [patient]);

            const filteredPatients = mockPatients.filter(p => 
                p.name.includes(searchQuery) || p.mrn.includes(searchQuery)
            );

            // General AI Analysis
            const aiAnalysis = useMemo(() => {
                if (patient.risk === 'High') {
                    return {
                        summary: "偵測到持續性的 EDA 數值升高，且伴隨睡眠品質低落。",
                        trend: "過去 24 小時內，病患的交感神經喚醒頻率較上週增加 35%。",
                        suggestion: "建議立即安排視訊訪談以評估焦慮指數，並檢視近期藥物依從性。",
                        statusColor: "rose"
                    };
                } else if (patient.risk === 'Medium') {
                    return {
                        summary: "生理數據顯示輕微波動，但仍在可控範圍內。",
                        trend: "睡眠中斷次數略有增加，EDA 峰值主要集中在夜間。",
                        suggestion: "建議透過 App 推送放鬆引導課程，並持續觀察未來 48 小時數據。",
                        statusColor: "amber"
                    };
                } else {
                    return {
                        summary: "各項生理指標穩定，符合治療預期目標。",
                        trend: "HRV (心率變異度) 呈現上升趨勢，顯示自律神經調節能力改善。",
                        suggestion: "維持目前治療計畫，並給予正面回饋以增強病患信心。",
                        statusColor: "emerald"
                    };
                }
            }, [patient]);

            // Sleep Analysis & AI Logic (New)
            const sleepData = useMemo(() => {
                const isBadSleep = patient.sleepScore < 60;
                const isOkSleep = patient.sleepScore >= 60 && patient.sleepScore < 80;
                
                const totalMinutes = isBadSleep ? 340 : (isOkSleep ? 420 : 480);
                const deep = isBadSleep ? 0.10 : (isOkSleep ? 0.15 : 0.22);
                const rem = isBadSleep ? 0.15 : (isOkSleep ? 0.20 : 0.25);
                const awake = isBadSleep ? 0.20 : (isOkSleep ? 0.10 : 0.05);
                const light = 1 - deep - rem - awake;

                const stages = {
                    deep: { pct: Math.round(deep * 100), min: Math.round(totalMinutes * deep) },
                    light: { pct: Math.round(light * 100), min: Math.round(totalMinutes * light) },
                    rem: { pct: Math.round(rem * 100), min: Math.round(totalMinutes * rem) },
                    awake: { pct: Math.round(awake * 100), min: Math.round(totalMinutes * awake) },
                    totalStr: `${Math.floor(totalMinutes/60)}h ${totalMinutes%60}m`
                };

                // Sleep AI Summary
                let aiSummary = "";
                let aiSuggestion = "";
                if (isBadSleep) {
                    aiSummary = "深層睡眠佔比過低 (<10%)，顯示大腦恢復功能受損。入睡潛伏期可能過長。";
                    aiSuggestion = "建議評估是否受到環境噪音或夜間藍光影響，可考慮短期助眠藥物調整。";
                } else if (isOkSleep) {
                    aiSummary = "整體睡眠結構完整，但片段化甦醒次數稍多，影響連續性。";
                    aiSuggestion = "建議加強日間光照並維持規律作息，以提升睡眠效率。";
                } else {
                    aiSummary = "睡眠結構呈現完美的黃金比例，REM 與深層睡眠週期規律。";
                    aiSuggestion = "保持目前的良好生活型態。";
                }

                return { stages, aiSummary, aiSuggestion, color: isBadSleep ? 'rose' : (isOkSleep ? 'amber' : 'indigo') };
            }, [patient]);

            // Metric Sub-views
            if (activeMetricView) {
                const closeMetricView = () => setActiveMetricView(null);
                
                let metricContent = null;
                switch(activeMetricView) {
                    case 'hr':
                        metricContent = (
                            <Card className="p-6 h-full flex flex-col animate-slide-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800">心率詳細分析 (24H)</h3>
                                    <button onClick={closeMetricView} className="text-slate-400 hover:text-slate-600"><i data-lucide="X" className="w-6 h-6"></i></button>
                                </div>
                                <div className="h-64 mb-6">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={hr24h}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="time" />
                                            <YAxis domain={['dataMin - 10', 'dataMax + 10']} />
                                            <Tooltip />
                                            <Line type="monotone" dataKey="value" stroke="#4F46E5" strokeWidth={3} dot={false} />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="grid grid-cols-3 gap-4 text-center">
                                    <div className="bg-slate-50 p-4 rounded-xl"><div className="text-sm text-slate-500">靜止心率</div><div className="text-2xl font-bold text-slate-800">62</div></div>
                                    <div className="bg-slate-50 p-4 rounded-xl"><div className="text-sm text-slate-500">最高心率</div><div className="text-2xl font-bold text-rose-600">115</div></div>
                                    <div className="bg-slate-50 p-4 rounded-xl"><div className="text-sm text-slate-500">平均心率</div><div className="text-2xl font-bold text-indigo-600">78</div></div>
                                </div>
                            </Card>
                        );
                        break;
                    case 'eda':
                        metricContent = (
                            <Card className="p-6 h-full flex flex-col animate-slide-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800">壓力 (EDA) 事件紀錄</h3>
                                    <button onClick={closeMetricView} className="text-slate-400 hover:text-slate-600"><i data-lucide="X" className="w-6 h-6"></i></button>
                                </div>
                                <div className="h-64 mb-6">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={eda24h}>
                                            <defs>
                                                <linearGradient id="colorEdaDetail" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#F59E0B" stopOpacity={0.3}/>
                                                    <stop offset="95%" stopColor="#F59E0B" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="time" />
                                            <YAxis />
                                            <Tooltip />
                                            <Area type="monotone" dataKey="value" stroke="#F59E0B" fill="url(#colorEdaDetail)" strokeWidth={3} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="flex-1 overflow-y-auto">
                                    <h4 className="font-bold text-slate-700 mb-3">今日壓力事件</h4>
                                    <div className="space-y-2">
                                        {[1,2,3].map(i => (
                                            <div key={i} className="flex justify-between items-center p-3 bg-amber-50 rounded-lg border border-amber-100">
                                                <span className="text-amber-800 font-mono">14:3{i}</span>
                                                <span className="text-sm text-amber-700">檢測到短暫交感神經興奮</span>
                                                <span className="font-bold text-amber-600">{(4 + Math.random()).toFixed(1)} uS</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </Card>
                        );
                        break;
                    case 'sleep':
                        metricContent = (
                            <Card className="p-6 h-full flex flex-col animate-slide-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800">睡眠品質週報 (7 Days)</h3>
                                    <button onClick={closeMetricView} className="text-slate-400 hover:text-slate-600"><i data-lucide="X" className="w-6 h-6"></i></button>
                                </div>
                                <div className="h-64 mb-6">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={sleep7d}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="day" />
                                            <YAxis />
                                            <Tooltip cursor={{fill: '#F1F5F9'}} />
                                            <Bar dataKey="score" fill="#4F46E5" radius={[4, 4, 0, 0]} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4">
                                    <h4 className="font-bold text-indigo-900 mb-2">週平均摘要</h4>
                                    <p className="text-sm text-indigo-700">本週平均睡眠分數為 <span className="font-bold">72</span> 分。相較於上週提升了 5%。週末的深層睡眠時間有顯著改善。</p>
                                </div>
                            </Card>
                        );
                        break;
                    case 'device':
                        metricContent = (
                            <Card className="p-6 h-full flex flex-col animate-slide-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800">裝置健康度與連線日誌</h3>
                                    <button onClick={closeMetricView} className="text-slate-400 hover:text-slate-600"><i data-lucide="X" className="w-6 h-6"></i></button>
                                </div>
                                <div className="h-48 mb-6">
                                    <h4 className="text-sm text-slate-500 mb-2">電池電量趨勢 (24H)</h4>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={batteryLog}>
                                            <defs>
                                                <linearGradient id="colorBatt" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#10B981" stopOpacity={0.3}/>
                                                    <stop offset="95%" stopColor="#10B981" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="time" />
                                            <YAxis domain={[0, 100]} />
                                            <Tooltip />
                                            <Area type="monotone" dataKey="level" stroke="#10B981" fill="url(#colorBatt)" strokeWidth={2} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="flex-1 overflow-y-auto">
                                    <h4 className="font-bold text-slate-700 mb-3">同步日誌</h4>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex justify-between p-2 border-b border-slate-100"><span>10:00 AM</span><span className="text-emerald-600 font-bold">同步成功</span></div>
                                        <div className="flex justify-between p-2 border-b border-slate-100"><span>09:45 AM</span><span className="text-emerald-600 font-bold">同步成功</span></div>
                                        <div className="flex justify-between p-2 border-b border-slate-100"><span>09:30 AM</span><span className="text-emerald-600 font-bold">同步成功</span></div>
                                        <div className="flex justify-between p-2 border-b border-slate-100"><span>09:15 AM</span><span className="text-amber-500 font-bold">連線逾時 (自動重試)</span></div>
                                    </div>
                                </div>
                            </Card>
                        );
                        break;
                }

                return (
                    <div className="space-y-6 animate-fade-in max-w-[1600px] mx-auto relative min-h-[600px]">
                        <button onClick={closeMetricView} className="mb-4 flex items-center text-slate-500 hover:text-primary transition-colors">
                            <i data-lucide="ArrowLeft" className="w-5 h-5 mr-1"></i> 返回儀表板
                        </button>
                        {metricContent}
                    </div>
                )
            }

            return (
                <div className="space-y-6 animate-fade-in max-w-[1600px] mx-auto">
                     <header className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-800 tracking-tight">個案生理監測</h2>
                            <div className="flex items-center space-x-3 mt-2">
                                <span className="bg-primary/10 text-primary px-3 py-1 rounded-lg text-sm font-bold">{patient.name}</span>
                                <span className="text-slate-400">|</span>
                                <span className="text-slate-600 font-mono text-sm">{patient.mrn}</span>
                                <span className="text-slate-400">|</span>
                                <span className="text-slate-600 text-sm">{patient.diagnosis}</span>
                            </div>
                        </div>
                        
                        {/* Search Bar */}
                        <div className="relative w-full lg:w-96 z-30">
                            <div className="group flex items-center bg-white border border-slate-200 rounded-xl px-4 py-3 shadow-sm focus-within:ring-2 focus-within:ring-primary/20 focus-within:border-primary transition-all">
                                <i data-lucide="Search" className="w-5 h-5 text-slate-400 group-focus-within:text-primary transition-colors"></i>
                                <input 
                                    type="text" 
                                    placeholder="搜尋病歷號或姓名..." 
                                    className="flex-1 ml-3 outline-none text-sm text-slate-700 placeholder:text-slate-400"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                            </div>
                            
                            {searchQuery && (
                                <div className="absolute top-full left-0 right-0 bg-white border border-slate-100 shadow-xl rounded-xl mt-2 max-h-80 overflow-y-auto py-2">
                                    {filteredPatients.map(p => (
                                        <div 
                                            key={p.id}
                                            onClick={() => { setSelectedPatientId(p.id); setSearchQuery(''); }}
                                            className="px-4 py-3 hover:bg-slate-50 cursor-pointer flex justify-between items-center transition-colors"
                                        >
                                            <div>
                                                <div className="font-bold text-slate-800">{p.name}</div>
                                                <div className="text-xs text-slate-500 font-mono">{p.mrn}</div>
                                            </div>
                                            <StatusBadge type={p.risk} />
                                        </div>
                                    ))}
                                    {filteredPatients.length === 0 && <div className="p-4 text-center text-slate-500 text-sm">無符合結果</div>}
                                </div>
                            )}
                        </div>
                    </header>

                    {/* Interactive Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {[
                            { id: 'hr', label: '即時心率', value: patient.heartRate, unit: 'bpm', color: 'primary', icon: 'Heart' },
                            { id: 'eda', label: 'EDA 壓力值', value: patient.edaAvg, unit: 'uS', color: patient.edaAvg > 4 ? 'accent' : 'warning', icon: 'Zap' },
                            { id: 'sleep', label: '睡眠分數', value: patient.sleepScore, unit: '分', color: 'primary', icon: 'Moon' },
                            { id: 'device', label: '裝置狀態', value: patient.lastSync, unit: '', color: patient.lastSync === '斷線' ? 'accent' : 'success', icon: 'Watch' }
                        ].map((item, idx) => (
                            <Card 
                                key={idx} 
                                onClick={() => setActiveMetricView(item.id)}
                                className="p-5 flex items-center space-x-4 cursor-pointer hover:border-primary/30 group"
                            >
                                <div className={`p-3 rounded-full bg-${item.color === 'primary' ? 'indigo' : item.color === 'accent' ? 'rose' : item.color === 'success' ? 'emerald' : 'amber'}-50 text-${item.color === 'primary' ? 'indigo' : item.color === 'accent' ? 'rose' : item.color === 'success' ? 'emerald' : 'amber'}-600`}>
                                    <i data-lucide={item.icon} className="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-primary transition-colors flex items-center">
                                        {item.label} <i data-lucide="ChevronRight" className="w-3 h-3 ml-1 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                    </p>
                                    <p className={`text-2xl font-bold text-slate-800 ${item.color === 'accent' ? 'text-rose-600' : ''}`}>
                                        {item.value} <span className="text-sm font-medium text-slate-400 ml-1">{item.unit}</span>
                                    </p>
                                </div>
                            </Card>
                        ))}
                    </div>

                    {/* NEW: Medication Info Card */}
                    <Card className="p-6 bg-blue-50/50 border-blue-100">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center">
                            <i data-lucide="Pill" className="w-5 h-5 mr-2 text-blue-500"></i>
                            目前用藥資訊
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {patient.medications && patient.medications.length > 0 ? (
                                patient.medications.map((med, idx) => (
                                    <div key={idx} className="bg-white p-4 rounded-xl border border-blue-100 shadow-sm flex justify-between items-center">
                                        <div>
                                            <p className="font-bold text-slate-700">{med.name}</p>
                                            <p className="text-xs text-slate-500">劑量: {med.dose}</p>
                                        </div>
                                        <span className="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-medium">{med.freq}</span>
                                    </div>
                                ))
                            ) : (
                                <p className="text-slate-500 text-sm">目前無登錄用藥資料</p>
                            )}
                        </div>
                    </Card>

                    {/* General AI Analysis Panel */}
                    <Card className={`relative overflow-hidden border-${aiAnalysis.statusColor}-100`}>
                         <div className={`absolute top-0 left-0 w-1 h-full bg-${aiAnalysis.statusColor}-500`}></div>
                         <div className={`absolute -right-10 -top-10 w-40 h-40 bg-${aiAnalysis.statusColor}-50 rounded-full blur-3xl opacity-50`}></div>
                         
                         <div className="p-6 md:p-8 relative z-10">
                            <div className="flex flex-col md:flex-row gap-6">
                                <div className="flex-shrink-0">
                                    <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                                        <i data-lucide="Sparkles" className="w-6 h-6 animate-pulse-soft"></i>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <h3 className="text-lg font-bold text-slate-800 mb-2 flex items-center">
                                        AI 智能綜合分析
                                        <span className={`ml-3 text-xs px-2 py-0.5 rounded-full bg-${aiAnalysis.statusColor}-100 text-${aiAnalysis.statusColor}-700 font-medium`}>
                                            Risk: {patient.risk}
                                        </span>
                                    </h3>
                                    <p className="text-slate-600 leading-relaxed mb-4">
                                        {aiAnalysis.summary} {aiAnalysis.trend}
                                    </p>
                                    <div className={`bg-${aiAnalysis.statusColor}-50/50 rounded-lg p-4 border border-${aiAnalysis.statusColor}-100`}>
                                        <div className="flex items-start">
                                            <i data-lucide="Lightbulb" className={`w-5 h-5 text-${aiAnalysis.statusColor}-600 mr-2 mt-0.5`}></i>
                                            <div>
                                                <span className={`text-sm font-bold text-${aiAnalysis.statusColor}-800 block mb-1`}>系統建議行動</span>
                                                <span className={`text-sm text-${aiAnalysis.statusColor}-700`}>{aiAnalysis.suggestion}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                         </div>
                    </Card>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Chart Section */}
                        <Card className="lg:col-span-2 p-6 flex flex-col">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center">
                                    <i data-lucide="Activity" className="w-5 h-5 mr-2 text-primary"></i>
                                    生理趨勢圖
                                </h3>
                                <div className="flex space-x-2">
                                    <span className="flex items-center text-xs text-slate-500"><span className="w-2 h-2 bg-indigo-500 rounded-full mr-1"></span>心率</span>
                                    <span className="flex items-center text-xs text-slate-500"><span className="w-2 h-2 bg-rose-500 rounded-full mr-1"></span>EDA</span>
                                </div>
                            </div>
                            <div className="h-80 w-full flex-1">
                                {RechartsObj ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={graphData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                            <defs>
                                                <linearGradient id="colorEda" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#E11D48" stopOpacity={0.1}/>
                                                    <stop offset="95%" stopColor="#E11D48" stopOpacity={0}/>
                                                </linearGradient>
                                                <linearGradient id="colorHr" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#4F46E5" stopOpacity={0.1}/>
                                                    <stop offset="95%" stopColor="#4F46E5" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E2E8F0" />
                                            <XAxis dataKey="time" axisLine={false} tickLine={false} tick={{fill: '#94A3B8', fontSize: 12}} dy={10} />
                                            <YAxis yAxisId="left" axisLine={false} tickLine={false} tick={{fill: '#94A3B8', fontSize: 12}} />
                                            <YAxis yAxisId="right" orientation="right" axisLine={false} tickLine={false} tick={{fill: '#94A3B8', fontSize: 12}} />
                                            <Tooltip 
                                                contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }} 
                                                cursor={{stroke: '#CBD5E1', strokeWidth: 1, strokeDasharray: '4 4'}}
                                            />
                                            <Area yAxisId="right" type="monotone" dataKey="eda" stroke="#E11D48" fillOpacity={1} fill="url(#colorEda)" strokeWidth={2} />
                                            <Area yAxisId="left" type="monotone" dataKey="heartRate" stroke="#4F46E5" fillOpacity={1} fill="url(#colorHr)" strokeWidth={2} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                ) : <FallbackChart />}
                            </div>
                            
                            <div className="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-100 flex items-start">
                                <i data-lucide="Info" className="w-4 h-4 text-slate-400 mr-2 mt-0.5"></i>
                                <div className="text-xs text-slate-600">
                                    <span className="font-bold text-slate-800">關於 EDA (膚電活動)：</span>
                                    測量皮膚導電度，反映交感神經喚醒程度。數值 &gt; 5.0 uS 通常表示處於高壓力或焦慮狀態。
                                </div>
                            </div>
                        </Card>

                        {/* Enhanced Sleep Analysis Section */}
                        <Card className="p-0 overflow-hidden flex flex-col">
                            <div className="p-6 pb-4 border-b border-slate-100">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center">
                                    <i data-lucide="Moon" className="w-5 h-5 mr-2 text-indigo-500"></i>
                                    睡眠結構分析
                                </h3>
                            </div>
                            
                            <div className="p-6 space-y-6 flex-1 overflow-y-auto custom-scrollbar">
                                {/* Score Circle */}
                                <div className="flex items-center justify-between">
                                    <div className="relative w-28 h-28">
                                        <svg className="w-full h-full transform -rotate-90">
                                            <circle cx="50%" cy="50%" r="45%" stroke="#F1F5F9" strokeWidth="8" fill="transparent" />
                                            <circle cx="50%" cy="50%" r="45%" stroke={sleepData.color === 'rose' ? '#F43F5E' : (sleepData.color === 'amber' ? '#F59E0B' : '#6366F1')} strokeWidth="8" fill="transparent" strokeDasharray="283" strokeDashoffset={283 - (283 * patient.sleepScore) / 100} strokeLinecap="round" className="transition-all duration-1000 ease-out" />
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                            <span className="text-3xl font-bold text-slate-800">{patient.sleepScore}</span>
                                            <span className="text-[10px] text-slate-400 uppercase">昨日評分</span>
                                        </div>
                                    </div>
                                    <div className="flex-1 pl-6">
                                        <div className="text-xs text-slate-500 mb-1">總睡眠時間</div>
                                        <div className="text-xl font-bold text-slate-800 mb-3">{sleepData.stages.totalStr}</div>
                                        <div className="text-xs text-slate-500 mb-1">睡眠效率</div>
                                        <div className="text-sm font-bold text-emerald-600">88% <span className="text-slate-400 font-normal">(優良)</span></div>
                                    </div>
                                </div>

                                {/* AI Sleep Summary Box */}
                                <div className={`bg-${sleepData.color}-50 p-4 rounded-xl border border-${sleepData.color}-100`}>
                                    <div className="flex items-center mb-2">
                                        <i data-lucide="Bot" className={`w-4 h-4 text-${sleepData.color}-600 mr-2`}></i>
                                        <span className={`text-xs font-bold text-${sleepData.color}-700 uppercase`}>AI 睡眠顧問</span>
                                    </div>
                                    <p className="text-sm text-slate-700 font-medium mb-2">{sleepData.aiSummary}</p>
                                    <p className={`text-xs text-${sleepData.color}-600`}>💡 建議：{sleepData.aiSuggestion}</p>
                                </div>

                                {/* Detailed Stages */}
                                <div className="space-y-4">
                                    <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">階段詳細佔比</div>
                                    
                                    {/* Awake */}
                                    <div>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="text-slate-600">清醒 (Awake)</span>
                                            <span className="font-bold text-slate-800">{sleepData.stages.awake.min}m ({sleepData.stages.awake.pct}%)</span>
                                        </div>
                                        <div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-red-300 h-2 rounded-full" style={{ width: `${sleepData.stages.awake.pct}%` }}></div></div>
                                    </div>

                                    {/* REM */}
                                    <div>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="text-slate-600">快速動眼 (REM)</span>
                                            <span className="font-bold text-slate-800">{sleepData.stages.rem.min}m ({sleepData.stages.rem.pct}%)</span>
                                        </div>
                                        <div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-purple-400 h-2 rounded-full" style={{ width: `${sleepData.stages.rem.pct}%` }}></div></div>
                                    </div>

                                    {/* Light */}
                                    <div>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="text-slate-600">淺層睡眠 (Light)</span>
                                            <span className="font-bold text-slate-800">{sleepData.stages.light.min}m ({sleepData.stages.light.pct}%)</span>
                                        </div>
                                        <div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-indigo-300 h-2 rounded-full" style={{ width: `${sleepData.stages.light.pct}%` }}></div></div>
                                    </div>

                                    {/* Deep */}
                                    <div>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="text-slate-600">深層睡眠 (Deep)</span>
                                            <span className="font-bold text-slate-800">{sleepData.stages.deep.min}m ({sleepData.stages.deep.pct}%)</span>
                                        </div>
                                        <div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-indigo-900 h-2 rounded-full" style={{ width: `${sleepData.stages.deep.pct}%` }}></div></div>
                                    </div>
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- Telehealth Room (Original Design) ---

        const TeleConsult = () => (
            <div className="space-y-8 animate-fade-in max-w-5xl mx-auto h-full flex flex-col">
                 <header>
                    <h2 className="text-3xl font-bold text-slate-800 tracking-tight">遠距診療室</h2>
                    <p className="text-slate-500 mt-1">管理您的視訊診次與進入看診</p>
                </header>

                <div className="bg-gradient-to-br from-indigo-600 to-violet-700 rounded-3xl p-10 text-white shadow-xl shadow-indigo-200 flex flex-col md:flex-row justify-between items-center relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -mr-16 -mt-16"></div>
                    <div className="relative z-10 mb-8 md:mb-0 max-w-lg">
                        <div className="inline-flex items-center bg-white/10 px-3 py-1 rounded-full text-xs font-medium mb-4 backdrop-blur-sm border border-white/10">
                            <span className="w-2 h-2 bg-emerald-400 rounded-full mr-2 animate-pulse"></span>
                            平台運作正常
                        </div>
                        <h3 className="text-3xl font-bold mb-3">準備開始視訊看診？</h3>
                        <p className="opacity-90 leading-relaxed text-indigo-100">
                            請點擊按鈕前往「遠傳健康+ 遠距診療平台」。系統將自動開啟加密連線的新視窗，請使用您的醫師帳號登入。
                        </p>
                    </div>
                    <a 
                        href="https://telecms.healthplus.tw/pages/login" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="relative z-10 bg-white text-indigo-700 px-8 py-4 rounded-2xl font-bold hover:bg-indigo-50 transition-all shadow-lg flex items-center group"
                    >
                        <i data-lucide="ExternalLink" className="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"></i>
                        開啟診療平台
                    </a>
                </div>

                <Card className="flex-1 flex flex-col overflow-hidden">
                    <div className="p-6 border-b border-slate-100 bg-slate-50/50">
                        <h3 className="text-lg font-bold text-slate-800 flex items-center">
                            <i data-lucide="History" className="w-5 h-5 mr-2 text-slate-500"></i>
                            預約與看診歷程
                        </h3>
                    </div>
                    <div className="flex-1 overflow-auto p-0">
                        <table className="min-w-full text-sm text-left">
                            <thead className="bg-white text-slate-500 font-medium sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th className="px-6 py-4">單號</th>
                                    <th className="px-6 py-4">時間</th>
                                    <th className="px-6 py-4">病患姓名</th>
                                    <th className="px-6 py-4">診療類型</th>
                                    <th className="px-6 py-4">狀態</th>
                                    <th className="px-6 py-4">記錄</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {mockAppointments.map((appt) => (
                                    <tr key={appt.id} className="hover:bg-slate-50/80 transition-colors">
                                        <td className="px-6 py-4 font-mono text-slate-400">{appt.id}</td>
                                        <td className="px-6 py-4">
                                            <div className="font-bold text-slate-800">{appt.time}</div>
                                            <div className="text-xs text-slate-400">{appt.date}</div>
                                        </td>
                                        <td className="px-6 py-4 font-medium text-slate-800">{appt.patient}</td>
                                        <td className="px-6 py-4">
                                            <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">{appt.type}</span>
                                        </td>
                                        <td className="px-6 py-4"><StatusBadge type={appt.status} /></td>
                                        <td className="px-6 py-4">
                                            <button className="text-slate-400 hover:text-primary transition-colors">
                                                <i data-lucide="FileText" className="w-5 h-5"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            </div>
        );

        // --- Device Management (New Enhanced Design) ---

        const DeviceSetup = () => {
            const [devices, setDevices] = useState([
                { id: 'd1', type: 'Fitbit Charge 6', mac: 'C8:12:89:AA:BB:CC', assignedTo: 1, battery: 82, status: 'online', lastSync: '剛剛' },
                { id: 'd2', type: 'Pixel Watch 2', mac: 'A1:B2:C3:D4:E5:F6', assignedTo: 2, battery: 45, status: 'online', lastSync: '15分鐘前' },
                { id: 'd3', type: 'Garmin Vivosmart 5', mac: '11:22:33:44:55:66', assignedTo: 7, battery: 12, status: 'offline', lastSync: '2天前' },
                { id: 'd4', type: 'Fitbit Sense 2', mac: 'DD:EE:FF:11:22:33', assignedTo: 4, battery: 68, status: 'syncing', lastSync: '同步中...' },
            ]);
            
            const [showPairModal, setShowPairModal] = useState(false);
            const [newDevice, setNewDevice] = useState({ type: 'Fitbit Charge 6', serial: '', patientId: '' });

            const handlePair = () => {
                if (!newDevice.patientId) return;
                const newId = `d${Date.now()}`;
                
                setDevices([
                    { 
                        id: newId, 
                        type: newDevice.type, 
                        mac: `XX:XX:${newDevice.serial.slice(-4) || '00:00'}`, 
                        assignedTo: parseInt(newDevice.patientId), 
                        battery: 100, 
                        status: 'online', 
                        lastSync: '剛剛' 
                    }, 
                    ...devices
                ]);
                setShowPairModal(false);
                setNewDevice({ type: 'Fitbit Charge 6', serial: '', patientId: '' });
            };

            const unpairDevice = (id) => {
                setDevices(devices.filter(d => d.id !== id));
            };

            return (
                <div className="space-y-8 animate-fade-in max-w-[1600px] mx-auto">
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-800 tracking-tight">裝置與數據源管理</h2>
                            <p className="text-slate-500 mt-1">管理裝置連結與穿戴裝置配對</p>
                        </div>
                        <button 
                            onClick={() => setShowPairModal(true)}
                            className="bg-primary hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 flex items-center transition-all active:scale-95"
                        >
                            <i data-lucide="PlusCircle" className="w-5 h-5 mr-2"></i>
                            配對新裝置
                        </button>
                    </header>

                    {/* API Status Card */}
                    <Card className="p-0 overflow-hidden">
                        <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 text-white flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                <div className="bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                                    <i data-lucide="CloudLightning" className="w-8 h-8 text-white"></i>
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold">裝置 (Sample)</h3>
                                    <p className="text-emerald-100 text-sm">數據閘道器狀態：<span className="font-bold text-white">正常運作中</span></p>
                                </div>
                            </div>
                            <div className="hidden md:flex space-x-2">
                                {['心率', 'EDA', '睡眠', '血氧', '步數'].map((tag, i) => (
                                    <span key={i} className="px-3 py-1 bg-white/10 rounded-full text-xs border border-white/20">{tag}</span>
                                ))}
                            </div>
                        </div>
                        <div className="bg-white p-4 border-t border-slate-100 flex justify-between items-center text-sm text-slate-500">
                            <span>上次全面同步：剛剛</span>
                            <span className="flex items-center"><i data-lucide="ShieldCheck" className="w-4 h-4 mr-1 text-emerald-500"></i> 符合 HIPAA/GDPR 隱私規範</span>
                        </div>
                    </Card>

                    {/* Device Grid */}
                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center">
                            <i data-lucide="Watch" className="w-5 h-5 mr-2 text-slate-500"></i>
                            已配對裝置清單 ({devices.length})
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            {devices.map((device) => {
                                const patient = mockPatients.find(p => p.id === device.assignedTo);
                                return (
                                    <Card key={device.id} className="p-6 relative group hover:border-primary/50 transition-colors">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex items-center space-x-3">
                                                <div className="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center text-slate-600">
                                                    <i data-lucide={device.type.includes('Phone') ? 'Smartphone' : 'Watch'} className="w-6 h-6"></i>
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-slate-800">{device.type}</h4>
                                                    <p className="text-xs text-slate-400 font-mono">{device.mac}</p>
                                                </div>
                                            </div>
                                            <StatusBadge type={device.status} text={device.status === 'online' ? '連線中' : (device.status === 'syncing' ? '同步中' : '離線')} />
                                        </div>
                                        
                                        <div className="bg-slate-50 rounded-xl p-3 mb-4 border border-slate-100">
                                            <p className="text-xs text-slate-500 mb-1">配對病患</p>
                                            <div className="flex items-center justify-between">
                                                <span className="font-bold text-slate-800">{patient ? patient.name : '未指派'}</span>
                                                <span className="text-xs bg-white px-2 py-0.5 rounded text-slate-500 border border-slate-200">{patient?.mrn}</span>
                                            </div>
                                        </div>

                                        <div className="flex items-center justify-between text-sm text-slate-500 border-t border-slate-100 pt-4">
                                            <span className={`flex items-center ${device.battery < 20 ? 'text-rose-500 font-bold' : ''}`}>
                                                <i data-lucide="BatteryMedium" className="w-4 h-4 mr-1"></i> {device.battery}%
                                            </span>
                                            <span className="flex items-center">
                                                <i data-lucide="RefreshCw" className="w-3 h-3 mr-1"></i> {device.lastSync}
                                            </span>
                                        </div>

                                        <div className="absolute top-4 right-14 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button 
                                                onClick={() => unpairDevice(device.id)}
                                                className="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-colors" title="解除配對"
                                            >
                                                <i data-lucide="Trash2" className="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </Card>
                                );
                            })}
                            
                            {/* Add New Placeholder */}
                            <button 
                                onClick={() => setShowPairModal(true)}
                                className="border-2 border-dashed border-slate-200 rounded-2xl p-6 flex flex-col items-center justify-center text-slate-400 hover:border-primary hover:text-primary hover:bg-primary/5 transition-all min-h-[200px]"
                            >
                                <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm mb-3">
                                    <i data-lucide="Plus" className="w-6 h-6"></i>
                                </div>
                                <span className="font-bold">配對新裝置</span>
                            </button>
                        </div>
                    </div>

                    {/* Pairing Modal */}
                    {showPairModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setShowPairModal(false)}></div>
                            <div className="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
                                <div className="p-6 border-b border-slate-100 bg-slate-50">
                                    <h3 className="text-xl font-bold text-slate-800">新增裝置配對</h3>
                                    <p className="text-sm text-slate-500">將穿戴裝置綁定至病患帳號</p>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">裝置型號</label>
                                        <select 
                                            className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                                            value={newDevice.type}
                                            onChange={(e) => setNewDevice({...newDevice, type: e.target.value})}
                                        >
                                            <option value="Fitbit Charge 6">Fitbit Charge 6</option>
                                            <option value="Fitbit Sense 2">Fitbit Sense 2</option>
                                            <option value="Google Pixel Watch 2">Google Pixel Watch 2</option>
                                            <option value="Garmin Vivosmart 5">Garmin Vivosmart 5</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">裝置序號 / 配對碼</label>
                                        <input 
                                            type="text" 
                                            placeholder="請輸入裝置背面的序號"
                                            className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                                            value={newDevice.serial}
                                            onChange={(e) => setNewDevice({...newDevice, serial: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">指派病患</label>
                                        <select 
                                            className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                                            value={newDevice.patientId}
                                            onChange={(e) => setNewDevice({...newDevice, patientId: e.target.value})}
                                        >
                                            <option value="">-- 請選擇病患 --</option>
                                            {mockPatients.map(p => (
                                                <option key={p.id} value={p.id}>{p.name} ({p.mrn})</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div className="p-6 border-t border-slate-100 flex space-x-3 bg-slate-50/50">
                                    <button 
                                        onClick={() => setShowPairModal(false)}
                                        className="flex-1 py-3 border border-slate-200 rounded-xl text-slate-600 font-bold hover:bg-white transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={handlePair}
                                        disabled={!newDevice.patientId}
                                        className="flex-1 py-3 bg-primary text-white rounded-xl font-bold hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-indigo-200/50 transition-all"
                                    >
                                        確認配對
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Sidebar & Layout ---
        
        const Sidebar = ({ activePage, setActivePage }) => {
            const menuItems = [
                { id: 'dashboard', label: '平台總覽', icon: 'LayoutDashboard' },
                { id: 'monitoring', label: '個案生理監測', icon: 'Activity' },
                { id: 'telehealth', label: '遠距診療室', icon: 'Video' },
                { id: 'devices', label: '裝置與數據源', icon: 'Watch' },
            ];

            return (
                <div className="w-72 bg-white h-screen shadow-[4px_0_24px_rgba(0,0,0,0.02)] fixed left-0 top-0 flex flex-col z-20 border-r border-slate-100">
                    <div className="p-8 flex flex-col items-center">
                         <div className="flex items-center justify-center mb-6">
                            <img 
                                src="image/fetlogo.png" 
                                alt="FET Logo" 
                                className="h-12 object-contain"
                                onError={(e) => {
                                    e.target.style.display = 'none'; 
                                    e.target.parentNode.innerHTML += '<div class="text-2xl font-black text-accent tracking-tighter">FET<span class="text-slate-800">Health</span></div>';
                                }}
                            />
                        </div>
                        <div className="text-center">
                            <h1 className="text-sm font-bold text-slate-800 tracking-wide">三軍總醫院北投分院</h1>
                            <div className="h-0.5 w-8 bg-primary/30 mx-auto my-3"></div>
                            <p className="text-xs text-slate-400 font-medium">智慧遠距精神醫療平台</p>
                        </div>
                    </div>
                    
                    <nav className="flex-1 px-4 space-y-2 mt-4">
                        {menuItems.map((item) => {
                            const isActive = activePage === item.id;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => setActivePage(item.id)}
                                    className={`w-full flex items-center space-x-3 px-5 py-4 rounded-2xl transition-all duration-200 group ${
                                        isActive 
                                        ? 'bg-primary text-white shadow-lg shadow-indigo-200' 
                                        : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                                    }`}
                                >
                                    <i data-lucide={item.icon} className={`w-5 h-5 ${isActive ? 'text-white' : 'text-slate-400 group-hover:text-slate-600'}`}></i>
                                    <span className="font-medium tracking-wide">{item.label}</span>
                                    {isActive && <i data-lucide="ChevronRight" className="w-4 h-4 ml-auto opacity-50"></i>}
                                </button>
                            );
                        })}
                    </nav>

                    <div className="p-6">
                        <div className="bg-slate-50 rounded-2xl p-4 flex items-center space-x-3 border border-slate-100">
                            <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold border-2 border-white shadow-sm">
                                Dr.
                            </div>
                            <div className="flex-1">
                                <p className="text-sm font-bold text-slate-800">陳醫師</p>
                                <p className="text-xs text-slate-500">身心科主治醫師</p>
                            </div>
                            <button className="text-slate-400 hover:text-slate-600">
                                <i data-lucide="LogOut" className="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activePage, setActivePage] = useState('dashboard');
            const [selectedPatientId, setSelectedPatientId] = useState(1);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [activePage, selectedPatientId]);

            return (
                <div className="flex min-h-screen bg-[#F1F5F9]">
                    <Sidebar activePage={activePage} setActivePage={setActivePage} />
                    <main className="flex-1 ml-72 p-10 overflow-y-auto h-screen">
                        {activePage === 'dashboard' && <Dashboard setActivePage={setActivePage} setSelectedPatientId={setSelectedPatientId} />}
                        {activePage === 'monitoring' && <PatientMonitoring selectedPatientId={selectedPatientId} setSelectedPatientId={setSelectedPatientId} />}
                        {activePage === 'telehealth' && <TeleConsult />}
                        {activePage === 'devices' && <DeviceSetup />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>