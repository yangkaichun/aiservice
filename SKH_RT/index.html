<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>放射腫瘤科營運績效戰情室</title>
    <link rel="icon" href="image/feticon.ico" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome 6 (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Subtle animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Menu active state styling */
        .menu-active {
            background-color: #f3f4f6; /* gray-100 */
            color: #0891b2; /* cyan-600 */
            border-right: 3px solid #0891b2;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Mock Data Generators ---
        const generateDailyData = () => {
            const hours = Array.from({length: 12}, (_, i) => `${i+8}:00`); // 8:00 to 19:00
            const revenue = hours.map(() => Math.floor(Math.random() * 50000) + 20000);
            const costs = hours.map(() => Math.floor(Math.random() * 20000) + 10000);
            return { labels: hours, revenue, costs };
        };

        // --- Components ---

        // 1. Recursive Menu Component (Handles 4+ levels)
        const MenuItem = ({ item, level = 0 }) => {
            const [isOpen, setIsOpen] = useState(false);
            const hasChildren = item.children && item.children.length > 0;
            const paddingLeft = level * 16 + 20; // Indent based on level

            const handleClick = () => {
                if (hasChildren) setIsOpen(!isOpen);
            };

            return (
                <div className="text-sm select-none">
                    <div 
                        className={`flex items-center py-3 px-4 cursor-pointer hover:bg-gray-50 transition-colors text-gray-600 ${isOpen ? 'bg-gray-50 text-cyan-700 font-medium' : ''}`}
                        style={{ paddingLeft: `${paddingLeft}px` }}
                        onClick={handleClick}
                    >
                        <div className="w-6 flex justify-center mr-2 text-gray-400">
                            {item.icon && <i className={`fa-solid ${item.icon}`}></i>}
                        </div>
                        <span className="flex-1">{item.title}</span>
                        {hasChildren && (
                            <i className={`fa-solid fa-chevron-down text-xs transition-transform duration-200 ${isOpen ? 'transform rotate-180' : ''}`}></i>
                        )}
                    </div>
                    
                    {hasChildren && isOpen && (
                        <div className="border-l border-gray-200 ml-6">
                            {item.children.map((child, idx) => (
                                <MenuItem key={idx} item={child} level={level + 1} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 2. Chart Components using Chart.js
        const LineChart = ({ title, color }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                const { labels, revenue, costs } = generateDailyData();
                
                if (chartRef.current) chartRef.current.destroy();

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '門診營收',
                                data: revenue,
                                borderColor: '#0891b2', // cyan-600
                                backgroundColor: 'rgba(8, 145, 178, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: '營運成本',
                                data: costs,
                                borderColor: '#ef4444', // red-500
                                borderDash: [5, 5],
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } },
                            title: { display: false }
                        },
                        scales: {
                            y: { grid: { borderDash: [2, 4] }, beginAtZero: true },
                            x: { grid: { display: false } }
                        }
                    }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, []);

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-80 flex flex-col">
                    <h3 className="text-gray-700 font-bold mb-4 flex items-center">
                        <i className="fa-solid fa-chart-line mr-2 text-cyan-600"></i> {title}
                    </h3>
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        };

        const PieChart = ({ title }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) chartRef.current.destroy();

                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['醫師', '物理師', '放射師', '護理師', '行政'],
                        datasets: [{
                            data: [25, 15, 35, 15, 10],
                            backgroundColor: ['#0e7490', '#06b6d4', '#22d3ee', '#67e8f9', '#cffafe'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } }
                        },
                        cutout: '70%'
                    }
                });
            }, []);

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-64 flex flex-col">
                    <h3 className="text-gray-700 font-bold mb-2 text-sm">{title}</h3>
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                    <div className="text-center text-xs text-gray-400 mt-2">TDABC 人員時間投入分析</div>
                </div>
            );
        };

        // 3. KPI Card
        const KpiCard = ({ title, value, subtext, icon, colorClass, trend }) => (
            <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-start justify-between transition hover:shadow-md">
                <div>
                    <p className="text-gray-500 text-xs font-medium uppercase tracking-wider">{title}</p>
                    <h4 className="text-2xl font-bold text-gray-800 mt-1">{value}</h4>
                    <p className={`text-xs mt-2 font-medium ${trend === 'up' ? 'text-green-500' : 'text-red-500'}`}>
                        {trend === 'up' ? <i className="fa-solid fa-arrow-up mr-1"></i> : <i className="fa-solid fa-arrow-down mr-1"></i>}
                        {subtext}
                    </p>
                </div>
                <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10`}>
                    <i className={`fa-solid ${icon} text-xl ${colorClass.replace('bg-', 'text-')}`}></i>
                </div>
            </div>
        );

        // 4. Main Application
        const App = () => {
            // Menu Data Structure (4 Levels)
            const menuData = [
                { title: "總覽 Dashboard", icon: "fa-table-columns", link: "#" },
                { 
                    title: "營運績效管理", 
                    icon: "fa-chart-pie",
                    children: [
                        { 
                            title: "財務分析", 
                            children: [
                                { title: "健保點值收入", children: [{ title: "每日趨勢" }, { title: "申報狀態" }] },
                                { title: "自費療程收入", children: [{ title: "VMAT" }, { title: "SBRT/SRS" }] },
                                { title: "每日門診收入", children: [{ title: "掛號費" }, { title: "部分負擔" }] }
                            ]
                        },
                        { 
                            title: "成本控制", 
                            children: [
                                { title: "人員成本 (TDABC)", children: [{ title: "醫師" }, { title: "物理師" }] },
                                { title: "能源消耗", children: [{ title: "電力日報" }] }
                            ]
                        }
                    ]
                },
                {
                    title: "放射設備管理",
                    icon: "fa-x-ray",
                    children: [
                        {
                            title: "Elekta Versa HD",
                            children: [
                                { title: "妥善率分析", children: [{title: "每日停機時間"}, {title: "維修紀錄"}] },
                                { title: "排程與負載" }
                            ]
                        },
                        { title: "Varian TrueBeam" },
                        { title: "CT-Sim 模擬定位" }
                    ]
                },
                { title: "系統設定", icon: "fa-gear" }
            ];

            return (
                <div className="flex h-screen overflow-hidden text-gray-800">
                    
                    {/* Left Sidebar */}
                    <aside className="w-64 bg-white border-r border-gray-200 flex flex-col z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
                        {/* Logo Area */}
                        <div className="h-16 flex items-center px-6 border-b border-gray-100">
                            <div className="flex items-center gap-3">
                                {/* Using a div as fallback if image is missing, but trying image first */}
                                <img 
                                    src="image/fetlogo.png" 
                                    alt="Logo" 
                                    className="h-8 object-contain"
                                    onError={(e) => {e.target.style.display='none'; e.target.nextSibling.style.display='flex'}}
                                />
                                <div className="hidden font-bold text-red-600 text-xl tracking-tighter" style={{fontFamily: 'Arial Black'}}>FET</div>
                                <span className="font-semibold text-gray-700 text-sm">放射腫瘤戰情室</span>
                            </div>
                        </div>

                        {/* Navigation */}
                        <div className="flex-1 overflow-y-auto scrollbar-hide py-4">
                            {menuData.map((item, idx) => (
                                <MenuItem key={idx} item={item} />
                            ))}
                        </div>

                        {/* Footer / User Info */}
                        <div className="p-4 border-t border-gray-100 bg-gray-50">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-cyan-600 flex items-center justify-center text-white text-xs font-bold">
                                    DR
                                </div>
                                <div>
                                    <p className="text-xs font-bold text-gray-700">Dr. Chen</p>
                                    <p className="text-[10px] text-gray-500">主任醫師 | 管理員</p>
                                </div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50">
                        
                        {/* Top Header */}
                        <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shadow-sm">
                            <h2 className="text-lg font-bold text-gray-700">營運總覽 Dashboard</h2>
                            
                            {/* System Status Indicators */}
                            <div className="flex items-center gap-6">
                                <div className="flex items-center gap-2 text-xs font-medium bg-green-50 px-3 py-1 rounded-full border border-green-100 text-green-700">
                                    <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    HIS 系統連線正常
                                </div>
                                <div className="flex items-center gap-2 text-xs font-medium bg-green-50 px-3 py-1 rounded-full border border-green-100 text-green-700">
                                    <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    批價系統連線正常
                                </div>
                                <div className="w-px h-6 bg-gray-200 mx-2"></div>
                                <button className="text-gray-400 hover:text-gray-600"><i className="fa-regular fa-bell"></i></button>
                                <button className="text-gray-400 hover:text-gray-600"><i className="fa-solid fa-rotate-right"></i></button>
                            </div>
                        </header>

                        {/* Dashboard Content */}
                        <div className="flex-1 overflow-y-auto p-8 fade-in">
                            
                            {/* KPI Row */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                <KpiCard 
                                    title="今日門診收入" 
                                    value="NT$ 185,400" 
                                    subtext="較昨日 +12%" 
                                    trend="up" 
                                    icon="fa-sack-dollar" 
                                    colorClass="bg-cyan-600" 
                                />
                                <KpiCard 
                                    title="健保申報點數" 
                                    value="245,000 pts" 
                                    subtext="達成率 98%" 
                                    trend="up" 
                                    icon="fa-file-invoice-dollar" 
                                    colorClass="bg-blue-500" 
                                />
                                <KpiCard 
                                    title="自費療程收入" 
                                    value="NT$ 450,000" 
                                    subtext="較上週 -5%" 
                                    trend="down" 
                                    icon="fa-star-of-life" 
                                    colorClass="bg-indigo-500" 
                                />
                                <KpiCard 
                                    title="今日治療人次" 
                                    value="42 人" 
                                    subtext="滿載率 85%" 
                                    trend="up" 
                                    icon="fa-user-group" 
                                    colorClass="bg-teal-500" 
                                />
                            </div>

                            {/* Main Section: Equipment & Finance */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                                
                                {/* Left: Equipment Status (Elekta) */}
                                <div className="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
                                    <div className="p-4 border-b border-gray-100 flex justify-between items-center">
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                            <i className="fa-solid fa-circle-radiation text-yellow-500"></i>
                                            主要設備狀態
                                        </h3>
                                        <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">運轉中</span>
                                    </div>
                                    
                                    {/* Machine Image */}
                                    <div className="relative h-48 bg-gray-100">
                                        <img 
                                            src="image/elekta.jpg" 
                                            alt="Elekta Versa HD" 
                                            className="w-full h-full object-cover"
                                            onError={(e) => {
                                                e.target.style.display = 'none';
                                                e.target.parentNode.classList.add('flex', 'items-center', 'justify-center', 'text-gray-400');
                                                e.target.parentNode.innerText = '';
                                            }}
                                        />
                                        <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent p-3">
                                            <p className="text-white font-bold text-sm">Elekta Versa HD (LINAC-1)</p>
                                        </div>
                                    </div>

                                    {/* Machine Stats */}
                                    <div className="p-4 flex-1 space-y-4">
                                        <div>
                                            <div className="flex justify-between text-xs mb-1">
                                                <span className="text-gray-500">妥善率 (Availability)</span>
                                                <span className="font-bold text-cyan-700">99.2%</span>
                                            </div>
                                            <div className="w-full bg-gray-100 rounded-full h-2">
                                                <div className="bg-cyan-600 h-2 rounded-full" style={{width: '99.2%'}}></div>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-4 pt-2">
                                            <div className="bg-slate-50 p-3 rounded-lg">
                                                <p className="text-[10px] text-gray-500 uppercase">今日用電</p>
                                                <p className="text-sm font-bold text-gray-700"><i className="fa-solid fa-bolt text-yellow-400 mr-1"></i> 145 kWh</p>
                                            </div>
                                            <div className="bg-slate-50 p-3 rounded-lg">
                                                <p className="text-[10px] text-gray-500 uppercase">治療人次</p>
                                                <p className="text-sm font-bold text-gray-700">28 / 35</p>
                                            </div>
                                        </div>
                                        
                                        <div className="text-xs text-gray-400 border-t border-gray-100 pt-3 mt-1">
                                            上次保養: 2023/10/15 | 下次排程: 2023/11/15
                                        </div>
                                    </div>
                                </div>

                                {/* Center: Financial Chart */}
                                <div className="lg:col-span-2 space-y-6">
                                    <LineChart title="營運收入與成本分析 (Daily)" />
                                    
                                    <div className="grid grid-cols-2 gap-6">
                                        <PieChart title="人員成本分攤 (TDABC)" />
                                        
                                        {/* Additional Metrics Card */}
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-64">
                                            <h3 className="text-gray-700 font-bold mb-4 text-sm">關鍵成本指標</h3>
                                            <ul className="space-y-4">
                                                <li className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600 flex items-center gap-2">
                                                        <i className="fa-solid fa-plug text-gray-400 w-4"></i> 設備儀器空間用電
                                                    </span>
                                                    <span className="font-mono font-bold text-gray-800">NT$ 3,240 <span className="text-xs text-gray-400 font-normal">/日</span></span>
                                                </li>
                                                <li className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600 flex items-center gap-2">
                                                        <i className="fa-solid fa-user-doctor text-gray-400 w-4"></i> 單位治療人力成本
                                                    </span>
                                                    <span className="font-mono font-bold text-gray-800">NT$ 850 <span className="text-xs text-gray-400 font-normal">/人次</span></span>
                                                </li>
                                                <li className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600 flex items-center gap-2">
                                                        <i className="fa-solid fa-coins text-gray-400 w-4"></i> 平均健保點值
                                                    </span>
                                                    <span className="font-mono font-bold text-orange-600">0.92 <span className="text-xs text-gray-400 font-normal">(浮動)</span></span>
                                                </li>
                                            </ul>
                                            <div className="mt-6 bg-blue-50 p-3 rounded text-xs text-blue-700 flex items-start gap-2">
                                                <i className="fa-solid fa-circle-info mt-0.5"></i>
                                                <span>數據來源整合：HIS 病歷系統、批價收費系統、台電智慧電表API。每 15 分鐘更新一次。</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>