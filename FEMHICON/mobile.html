<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>äºæ±é†«é™¢ç‰ˆé¢ç”¢ç”Ÿå™¨ (æ‰‹æ©Ÿç‰ˆ)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<link href="https://unpkg.com/ionicons@4.5.10-0/dist/css/ionicons.min.css" rel="stylesheet">

<style>
    /* === æ‰‹æ©Ÿç‰ˆåŸºç¤è¨­å®š === */
    body {
        margin: 0;
        padding: 0;
        font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
        background-color: #222;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    /* === é è¦½å€ (è‡ªå‹•ç¸®æ”¾) === */
    #preview-area {
        flex: 1;
        background-color: #222;
        display: flex;
        justify-content: center;
        align-items: flex-start; /* æ‰‹æ©Ÿç‰ˆé ä¸Šå°é½Š */
        padding-top: 20px;
        overflow: hidden;
        position: relative;
    }

    #scale-wrapper {
        transform-origin: top center;
        /* scale æœƒç”± JS å‹•æ…‹è¨ˆç®— */
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* åŸå§‹ç•«å¸ƒ 2500x1686 */
    #main-canvas {
        width: 2500px;
        height: 1686px;
        background-color: #f4f6f8; 
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 50px;
        padding: 60px;
        box-sizing: border-box;
        /* èƒŒæ™¯ç›´è§’ï¼Œä¸è¨­åœ“è§’ */
    }

    /* === å¡ç‰‡æ¨£å¼ === */
    .slot-card {
        background-color: #ffffff;
        border-radius: 40px; /* å¡ç‰‡åœ“è§’ */
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        cursor: pointer; /* æ‰‹æ©Ÿä¸Šæ˜¯é»æ“Š */
        border: 10px solid transparent; 
        position: relative;
        overflow: hidden;
    }

    .slot-card.active-slot {
        border-color: #ff3333;
        box-shadow: 0 0 80px rgba(255, 50, 50, 0.6); /* æ‰‹æ©Ÿç‰ˆåŠ å¼·é™°å½± */
        z-index: 10;
    }

    #main-canvas.hide-selection .slot-card.active-slot {
        border-color: transparent !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05) !important;
        z-index: auto !important;
    }

    .slot-card.special-green {
        background-color: #00854a;
    }
    .slot-card.special-green .external-icon-render,
    .slot-card.special-green .icon-display,
    .slot-card.special-green .label-display {
        fill: #ffffff !important;
        stroke: #ffffff !important;
        color: #ffffff !important;
    }
    .slot-card.special-green .icon-outline {
        fill: none !important; 
        stroke: #ffffff !important;
    }
    .slot-card.special-green .icon-fill {
        fill: #ffffff !important;
        stroke: none !important;
    }

    .icon-display { width: 250px; height: 250px; margin-bottom: 40px; fill: #00854a; pointer-events: none; }
    .icon-display.icon-outline { fill: none; stroke: #00854a; stroke-width: 5; stroke-linecap: round; stroke-linejoin: round; }
    .icon-display.icon-fill { fill: #00854a; stroke: none; }
    
    .external-icon-render{font-size:180px;line-height:1;color:#00854a;margin-bottom:40px;display:inline-block;pointer-events:none}
    .material-icons.external-icon-render{font-size:220px}
    
    .label-display {
        font-weight: bold;
        color: #333;
        line-height: 1.3;
        pointer-events: none;
        white-space: pre-wrap;
        min-height: 1.3em;
    }

    /* === æ‰‹æ©Ÿç‰ˆæ§åˆ¶é¢æ¿ (åº•éƒ¨æ»‘å‹•å€) === */
    #library-area {
        height: 45vh; /* ä½”æ“šè¢å¹•ä¸‹åŠéƒ¨ */
        background-color: #fff;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        z-index: 100;
        transition: transform 0.3s ease;
    }

    #library-area.hidden {
        transform: translateY(100%); /* å®Œå…¨éš±è—åˆ°åº•éƒ¨ */
    }

    /* æ§åˆ¶é¢æ¿æ¨™é ­ */
    .control-header {
        padding: 15px;
        background: #f5f5f5;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        overflow-x: auto; /* å…è¨±æ©«å‘æ²å‹• */
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }
    
    /* éš±è—æ²è»¸ */
    .control-header::-webkit-scrollbar { display: none; }

    .status-badge {
        background: #00854a;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        margin-right: 10px;
    }

    .edit-group {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: white;
        padding: 5px 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .edit-group label { font-size: 12px; color: #555; }
    .edit-group input, .edit-group select {
        border: none;
        background: transparent;
        font-size: 14px;
        padding: 5px;
        outline: none;
    }
    
    /* æ–‡å­—è¼¸å…¥æ¡†ç‰¹åˆ¥å¯¬ä¸€é» */
    #text-input { width: 120px; }

    /* åœ–ç¤ºåº«æ²å‹•å€ */
    .library-scroll {
        flex: 1;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* æ‰‹æ©Ÿç‰ˆç¶²æ ¼ */
        gap: 10px;
        padding: 15px;
        background-color: #ffffff;
        padding-bottom: 80px; /* é¿é–‹æ‡¸æµ®æŒ‰éˆ• */
    }
    
    .lib-item {
        aspect-ratio: 1;
        border: 1px solid #eee;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fafafa;
    }
    .lib-item:active { background-color: #e8f5e9; border-color: #00854a; }
    .lib-item svg { width: 32px; height: 32px; fill: #00854a; }
    .lib-item i, .lib-item span { font-size: 30px; color: #00854a; }
    .lib-item .lib-name { font-size: 9px; color: #888; margin-top: 5px; text-align: center; overflow: hidden; width: 100%; white-space: nowrap; text-overflow: ellipsis; }

    /* æ‰‹æ©Ÿç‰ˆæ‰‹å‹•è¼¸å…¥å€ */
    #manual-input-container {
        padding: 10px;
        background: #e8f5e9;
        font-size: 12px;
        display: none;
    }
    #manual-input-container.active { display: flex; align-items: center; gap: 5px; }

    /* === æ‡¸æµ®æŒ‰éˆ• (æ‰‹æ©Ÿç‰ˆç½®åº•) === */
    .floating-btns {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 200;
    }

    .float-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #00854a;
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: transform 0.2s;
    }
    .float-btn:active { transform: scale(0.9); }
    
    .float-btn span:last-child { display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—æŒ‰éˆ•æ–‡å­—ï¼Œåªç•™åœ–ç¤º */
    
    #download-btn { background-color: #d84315; width: 60px; height: 60px; font-size: 24px; }
    #toggle-border-btn { background-color: #555; }
    
    /* æ¨£å¼åˆ‡æ›æŒ‰éˆ• (æ”¾åœ¨ header å…§) */
    .mini-btn {
        background: #2c3e50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
    }
</style>
</head>
<body>

<div id="preview-area">
    <div id="scale-wrapper">
        <div id="main-canvas"></div>
    </div>
</div>

<div class="floating-btns">
    <button id="download-btn" class="float-btn" onclick="saveAsJpeg()">
        <span>ğŸ’¾</span>
    </button>
    <button id="toggle-border-btn" class="float-btn" onclick="toggleRedBorder()">
        <span>ğŸ”³</span>
    </button>
    <button id="toggle-panel-btn" class="float-btn" onclick="toggleLibrary()">
        <span>ğŸ› ï¸</span>
    </button>
</div>

<div id="library-area">
    <div class="control-header">
        <span class="status-badge" id="status-text">#1</span>
        
        <button class="mini-btn" onclick="toggleSlotStyle()">æ›è‰²</button>

        <div class="edit-group">
            <label>æ–‡å­—</label>
            <input type="text" id="text-input" placeholder="è¼¸å…¥..." oninput="updateText(this.value)" style="width: 80px;">
        </div>

        <div class="edit-group">
            <label>å¤§å°</label>
            <input type="number" id="font-size-input" value="80" step="2" onchange="updateFontSize(this.value)" style="width: 40px;">
        </div>

        <div class="edit-group">
            <label>åœ–ç¤º</label>
            <input type="number" id="icon-size-input" value="250" step="10" onchange="updateIconSize(this.value)" style="width: 40px;">
        </div>

        <div class="edit-group">
            <label>å­—é«”</label>
            <select id="font-family-select" onchange="updateFontFamily(this.value)">
                <option value='"Microsoft JhengHei", "Heiti TC", sans-serif'>æ­£é»‘</option>
                <option value='"Noto Sans TC", sans-serif'>é»‘é«”</option>
                <option value='"Noto Serif TC", serif'>å®‹é«”</option>
                <option value='"Zen Maru Gothic", sans-serif'>åœ“é«”</option>
            </select>
        </div>

        <div class="edit-group">
            <label>ä¾†æº</label>
            <select id="icon-source-select" onchange="changeIconSource(this.value)">
                <option value="internal">å…§å»º</option>
                <option value="none">ç„¡</option>
                <option value="fontawesome">FA</option>
                <option value="material">Mat</option>
                <option value="bootstrap">BS</option>
            </select>
        </div>
    </div>
    
    <div id="manual-input-container">
        <input type="text" id="manual-code" placeholder="Icon ä»£ç¢¼" style="flex:1;">
        <button class="mini-btn" onclick="applyManualIcon()">OK</button>
    </div>

    <div class="library-scroll" id="icon-library"></div>
</div>

<script>
    /* æ‰‹æ©Ÿç‰ˆé‚è¼¯ - è‡ªå‹•ç¸®æ”¾åŠŸèƒ½ */
    function resizePreview() {
        const wrapper = document.getElementById('scale-wrapper');
        const previewArea = document.getElementById('preview-area');
        
        // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ï¼š(è¢å¹•å¯¬åº¦ - é‚Šè·) / 2500
        const margin = 20;
        const availableWidth = window.innerWidth - margin;
        const scale = availableWidth / 2500;
        
        wrapper.style.transform = `scale(${scale})`;
        
        // èª¿æ•´é«˜åº¦ä»¥é©æ‡‰ç¸®æ”¾å¾Œçš„å…§å®¹ (é¿å…é è¦½å€éå¤§æˆ–éå°)
        // åŸå§‹é«˜åº¦ 1686 * scale
        const scaledHeight = 1686 * scale;
        previewArea.style.height = `${scaledHeight + 50}px`;
        previewArea.style.flex = "none"; // å–æ¶ˆ flex è‡ªå‹•ä¼¸å±•ï¼Œæ”¹ç”¨å›ºå®šé«˜åº¦
    }

    window.addEventListener('resize', resizePreview);
    window.addEventListener('load', resizePreview);

    /* ä»¥ä¸‹ç‚ºæ ¸å¿ƒé‚è¼¯ï¼Œèˆ‡é›»è…¦ç‰ˆå®Œå…¨ç›¸åŒ */
    
    const mainCanvas = document.getElementById("main-canvas");
    const iconLibrary = document.getElementById("icon-library");
    const manualInputContainer = document.getElementById("manual-input-container");
    const statusText = document.getElementById("status-text");
    const textInput = document.getElementById("text-input");
    const fontSizeInput = document.getElementById("font-size-input");
    const iconSizeInput = document.getElementById("icon-size-input");
    const fontFamilySelect = document.getElementById("font-family-select");
    const libraryArea = document.getElementById("library-area");
    const sourceSelect = document.getElementById("icon-source-select");
    const manualCodeInput = document.getElementById("manual-code");

    let selectedSlotIndex = 0;
    let currentSourceMode = "internal";

    // è³‡æ–™åº« (èˆ‡é›»è…¦ç‰ˆå…±ç”¨)
    const originalIcons = [
        { id: "guide", name: "æ›è™ŸåŠ\nå°±é†«æŒ‡å—", type: "outline", svg: '<svg viewBox="0 0 100 100"><path d="M50,90 C50,90 10,65 10,35 C10,15 25,5 45,15 C50,18 50,18 55,15 C75,5 90,15 90,35 C90,65 50,90 50,90 Z" /><polyline points="25,35 35,35 45,20 55,50 65,35 75,35" /></svg>' },
        { id: "news", name: "æœ€æ–°æ¶ˆæ¯", type: "fill", svg: '<svg viewBox="0 0 24 24"><path d="M20,3H4C2.9,3,2,3.9,2,5v14c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V5C22,3.9,21.1,3,20,3z M19,19H5v-2h14V19z M19,15H5v-2h14V15z M19,11H5V7h14V11z"/></svg>' },
        { id: "app", name: "APPä¸‹è¼‰åŠ\nç—…äººåƒèˆ‡å•å·", type: "outline", svg: '<svg viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2" stroke-width="2"/><line x1="11" y1="18" x2="13" y2="18" stroke-width="2"/></svg>' },
        { id: "feature", name: "ç‰¹è‰²é†«ç™‚åŠ\nè¡›æ•™å°ˆå€", type: "fill", svg: '<svg viewBox="0 0 24 24"><path d="M19,11h-5V6c0-0.55-0.45-1-1-1h-2c-0.55,0-1,0.45-1,1v5H5c-0.55,0-1,0.45-1,1v2c0,0.55,0.45,1,1,1h5v5c0,0.55,0.45,1,1,1h2c0.55,0,1-0.45,1-1v-5h5c0.55,0,1-0.45,1-1v-2C20,11.45,19.55,11,19,11z"/></svg>' },
        { id: "heart", name: "äºæ±â¤ï¸å¥åº·", type: "special", svg: '<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>' },
        { id: "bind", name: "ç¶å®šè³‡è¨Š", type: "outline", svg: '<svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>' }
    ];
    // ç‚ºäº†ç¯€çœæ‰‹æ©Ÿç‰ˆä»£ç¢¼é•·åº¦ï¼Œé€™è£¡åŒæ¨£è¼‰å…¥å¤§é‡åœ–ç¤º (çœç•¥è©³ç´°å®šç¾©ï¼Œä½¿ç”¨å‰é¢çš„é‚è¼¯)
    const basePaths = ["M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z", "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z", "M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z", "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z", "M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4zm-4-2V5c0-.55.45-1 1-1s1 .45 1 1v1h-1v1h1v1h-1v1h1v1h-1v2h1v1h-2z"];
    // æ“´å……
    const techMedPaths = ["M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.5-7.5H7v-2h7.5V8H7v-2h7.5V4H20v15H6.5z", "M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M19,19H5V5H19V19M7,10H9V14H7V10M11,7H13V14H11V7M15,12H17V14H15V12Z"];
    let allPaths = [];
    for (let i = 0; i < 70; i++) basePaths.forEach(p => allPaths.push(p));
    for (let i = 0; i < 10; i++) techMedPaths.forEach(p => allPaths.push(p));
    const extendedIcons = allPaths.map((path, index) => ({ id: `ext_${index}`, name: "", type: "fill", svg: `<svg viewBox="0 0 24 24"><path d="${path}"/></svg>` }));
    const internalIconData = [...originalIcons, ...extendedIcons];
    
    // å¤–éƒ¨åœ–ç¤ºæ¸…å–®
    const faString = "fa-solid fa-house,fa-solid fa-user,fa-solid fa-check"; // æ‰‹æ©Ÿç‰ˆç¯„ä¾‹ç¸®çŸ­ï¼Œå¯¦éš›è«‹ç”¨å®Œæ•´å­—ä¸²
    const matString = "home,search,settings,check,favorite";

    // ç‹€æ…‹
    let slotState = [
        { type: "internal", val: 0, customText: originalIcons[0].name, style: "white", fontSize: 80, fontFamily: '"Microsoft JhengHei", "Heiti TC", sans-serif', iconSize: 250 },
        { type: "internal", val: 1, customText: originalIcons[1].name, style: "white", fontSize: 80, fontFamily: '"Microsoft JhengHei", "Heiti TC", sans-serif', iconSize: 250 },
        { type: "internal", val: 2, customText: originalIcons[2].name, style: "white", fontSize: 80, fontFamily: '"Microsoft JhengHei", "Heiti TC", sans-serif', iconSize: 250 },
        { type: "internal", val: 3, customText: originalIcons[3].name, style: "white", fontSize: 80, fontFamily: '"Microsoft JhengHei", "Heiti TC", sans-serif', iconSize: 250 },
        { type: "internal", val: 4, customText: originalIcons[4].name, style: "green", fontSize: 80, fontFamily: '"Microsoft JhengHei", "Heiti TC", sans-serif', iconSize: 250 },
        { type: "internal", val: 5, customText: originalIcons[5].name, style: "white", fontSize: 80, fontFamily: '"Microsoft JhengHei", "Heiti TC", sans-serif', iconSize: 250 }
    ];

    function renderCanvas() {
        mainCanvas.innerHTML = "";
        slotState.forEach((state, slotIndex) => {
            const slot = document.createElement("div");
            slot.className = "slot-card";
            if (state.style === "green") slot.classList.add("special-green");
            if (slotIndex === selectedSlotIndex) slot.classList.add("active-slot");

            let iconHTML = "";
            if (state.type === "none") {
                iconHTML = ""; 
            } else if (state.type === "internal") {
                const icon = internalIconData[state.val] || internalIconData[0];
                let svgContent = icon.svg;
                if (icon.type === "outline") {
                    svgContent = svgContent.replace("<svg", `<svg style="width:${state.iconSize}px;height:${state.iconSize}px;" class="icon-display icon-outline"`);
                } else {
                    svgContent = svgContent.replace("<svg", `<svg style="width:${state.iconSize}px;height:${state.iconSize}px;" class="icon-display icon-fill"`);
                }
                iconHTML = svgContent;
            } else {
                let fs = state.iconSize; 
                let iconClass = state.val;
                if (state.type === "material") {
                     iconHTML = `<span style="font-size:${fs}px;" class="material-icons external-icon-render">${state.val}</span>`;
                } else {
                     iconHTML = `<i style="font-size:${fs}px;" class="${state.val} external-icon-render"></i>`;
                }
            }

            slot.innerHTML = `${iconHTML}<div class="label-display" style="font-size: ${state.fontSize}px; font-family: ${state.fontFamily};">${state.customText}</div>`;
            slot.onclick = () => selectSlot(slotIndex);
            mainCanvas.appendChild(slot);
        });
    }

    function selectSlot(index) {
        selectedSlotIndex = index;
        const state = slotState[index];
        statusText.textContent = `#${index + 1}`;
        textInput.value = state.customText;
        fontSizeInput.value = state.fontSize;
        iconSizeInput.value = state.iconSize;
        fontFamilySelect.value = state.fontFamily;
        
        if (state.type === "none") {
            sourceSelect.value = "none";
            changeIconSource("none");
        } else if (state.type === "internal") {
            sourceSelect.value = "internal";
            changeIconSource("internal");
        } else {
            sourceSelect.value = state.type;
            changeIconSource(state.type);
        }
        renderCanvas();
    }

    function updateText(val) { slotState[selectedSlotIndex].customText = val; renderCanvas(); }
    function updateFontSize(val) { slotState[selectedSlotIndex].fontSize = val; renderCanvas(); }
    function updateIconSize(val) { slotState[selectedSlotIndex].iconSize = val; renderCanvas(); }
    function updateFontFamily(val) { slotState[selectedSlotIndex].fontFamily = val; renderCanvas(); }
    function toggleSlotStyle() {
        const currentStyle = slotState[selectedSlotIndex].style;
        slotState[selectedSlotIndex].style = currentStyle === "green" ? "white" : "green";
        renderCanvas();
    }

    function changeIconSource(source) {
        currentSourceMode = source;
        iconLibrary.scrollTop = 0;
        if (source === "internal") {
            manualInputContainer.classList.remove("active");
            renderInternalLibrary();
        } else if (source === "none") {
            manualInputContainer.classList.remove("active");
            iconLibrary.innerHTML = "<div style='width:100%;text-align:center;padding:20px;color:#888;'>ç„¡åœ–ç¤º</div>";
            slotState[selectedSlotIndex].type = "none";
            renderCanvas();
        } else {
            // æ‰‹æ©Ÿç‰ˆç¯„ä¾‹ç°¡åŒ–
            manualInputContainer.classList.add("active");
            let list = faString.split(','); 
            if(source === 'material') list = matString.split(',');
            renderLibraryList(list, source);
        }
    }

    function renderInternalLibrary() {
        iconLibrary.innerHTML = "";
        // æ¸²æŸ“å‰ 100 å€‹é¿å…æ‰‹æ©Ÿå¡é “ï¼Œå¯¦éš›å¯åšåˆ†é 
        internalIconData.slice(0, 100).forEach((icon, index) => {
            const item = document.createElement("div");
            item.className = "lib-item";
            let smallSvg = icon.svg.replace("<svg", '<svg style="fill:#00854a"');
            item.innerHTML = `${smallSvg}<div class="lib-name">${icon.name.replace("\n", "")}</div>`;
            item.onclick = () => {
                slotState[selectedSlotIndex].type = "internal";
                slotState[selectedSlotIndex].val = index;
                if (icon.name) {
                    slotState[selectedSlotIndex].customText = icon.name;
                    textInput.value = icon.name;
                }
                renderCanvas();
            };
            iconLibrary.appendChild(item);
        });
    }
    
    function renderLibraryList(list, type) {
        iconLibrary.innerHTML = "";
        list.forEach(val => {
            const item = document.createElement("div");
            item.className = "lib-item";
            let preview = "";
            if (type === "fontawesome") preview = `<i class="${val}"></i>`;
            else if (type === "material") preview = `<span class="material-icons">${val}</span>`;
            
            item.innerHTML = `${preview}<div class="lib-name">${val}</div>`;
            item.onclick = () => {
                slotState[selectedSlotIndex].type = type;
                slotState[selectedSlotIndex].val = val;
                renderCanvas();
            };
            iconLibrary.appendChild(item);
        });
    }

    function toggleLibrary() { libraryArea.classList.toggle("hidden"); }
    function toggleRedBorder() { mainCanvas.classList.toggle("hide-selection"); }

    function saveAsJpeg() {
        const node = document.getElementById("main-canvas");
        const originalHideState = node.classList.contains('hide-selection');
        if (!originalHideState) node.classList.add('hide-selection');

        const wrapper = document.getElementById("scale-wrapper");
        const originalTransform = wrapper.style.transform;
        wrapper.style.transform = "none"; // æ¢å¾©åŸå§‹å¤§å°æˆªåœ–

        // ç¢ºä¿ Clone é‚è¼¯ (æ‰‹æ©Ÿç‰ˆç°¡åŒ–ç›´æ¥æˆªåœ–)
        domtoimage.toPng(node, {
            width: 2500,
            height: 1686,
            bgcolor: "#f4f6f8", 
            style: { transform: "none", transformOrigin: "top left", margin: "0" }
        })
        .then(function (dataUrl) {
            const link = document.createElement("a");
            link.download = "hospital-menu-mobile.png";
            link.href = dataUrl;
            link.click();
            wrapper.style.transform = originalTransform;
            if (!originalHideState) node.classList.remove('hide-selection');
        })
        .catch(function (error) {
            alert("æˆªåœ–å¤±æ•—");
            wrapper.style.transform = originalTransform;
        });
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        textInput.value = slotState[0].customText;
        renderInternalLibrary(); 
        renderCanvas();
        resizePreview();
    });
</script>
</body>
</html>