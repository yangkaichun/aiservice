<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新光醫院 | 全院檢查儀器營運戰情室</title>
    <link rel="icon" href="image/feticon.ico" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- React Ecosystem -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        :root {
            --primary: #0ea5e9; /* Sky 500 */
            --bg-app: #f8fafc;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-app);
            color: #1e293b;
            overflow: hidden;
        }

        /* Animations */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-ring { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); } }
        
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }

        /* Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.1);
            border-color: #bae6fd;
        }

        /* Status Indicators */
        .status-active { color: #10b981; background: #ecfdf5; border: 1px solid #a7f3d0; }
        .status-idle { color: #64748b; background: #f1f5f9; border: 1px solid #e2e8f0; }
        .status-warning { color: #f59e0b; background: #fffbeb; border: 1px solid #fde68a; }
        .status-error { color: #ef4444; background: #fef2f2; border: 1px solid #fecaca; }

        /* Custom Scroll */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. Simulation Data Engine ---
        // Generates random operational data for machines
        const useMachineData = () => {
            const [machines, setMachines] = useState([
                // Radiology
                { id: 'MR01', name: 'MRI 3T (GE)', type: 'MRI', dept: 'Radiology', status: 'Scanning', progress: 45, patients: 12, total: 25, nextMaint: '12/10' },
                { id: 'MR02', name: 'MRI 1.5T (Siemens)', type: 'MRI', dept: 'Radiology', status: 'Idle', progress: 0, patients: 8, total: 20, nextMaint: '12/15' },
                { id: 'CT01', name: 'CT 640 (Toshiba)', type: 'CT', dept: 'Radiology', status: 'Scanning', progress: 88, patients: 45, total: 60, nextMaint: '01/05' },
                { id: 'CT02', name: 'CT 256 (Philips)', type: 'CT', dept: 'Radiology', status: 'Scanning', progress: 20, patients: 38, total: 55, nextMaint: '01/20' },
                { id: 'XR01', name: 'Digital X-Ray 1', type: 'X-Ray', dept: 'Radiology', status: 'Busy', progress: 95, patients: 120, total: 150, nextMaint: '11/30' },
                { id: 'XR02', name: 'Digital X-Ray 2', type: 'X-Ray', dept: 'Radiology', status: 'Maintenance', progress: 0, patients: 0, total: 0, nextMaint: 'Today' },
                
                // Nuclear Medicine
                { id: 'PT01', name: 'PET/CT (GE Discovery)', type: 'PET', dept: 'Nuclear Med', status: 'Injecting', progress: 10, patients: 5, total: 8, nextMaint: '12/01' },
                { id: 'SP01', name: 'SPECT/CT', type: 'SPECT', dept: 'Nuclear Med', status: 'Scanning', progress: 60, patients: 10, total: 15, nextMaint: '12/22' },

                // Radiation Oncology
                { id: 'LN01', name: 'Elekta Versa HD', type: 'Linac', dept: 'Rad Oncology', status: 'Beam On', progress: 92, patients: 28, total: 35, nextMaint: '12/05' },
                { id: 'LN02', name: 'Elekta Synergy', type: 'Linac', dept: 'Rad Oncology', status: 'Setup', progress: 15, patients: 22, total: 30, nextMaint: '12/12' },

                // Ultrasound
                { id: 'US01', name: 'Ultrasound A', type: 'Sono', dept: 'Ultrasound', status: 'Scanning', progress: 30, patients: 15, total: 20, nextMaint: 'None' },
                { id: 'US02', name: 'Ultrasound B', type: 'Sono', dept: 'Ultrasound', status: 'Idle', progress: 0, patients: 12, total: 20, nextMaint: 'None' },
            ]);

            const [summary, setSummary] = useState({
                totalExams: 452,
                utilization: 82.5,
                alerts: 1
            });

            // Simulate real-time changes
            useEffect(() => {
                const interval = setInterval(() => {
                    setMachines(prev => prev.map(m => {
                        // Randomly update status and progress
                        if (m.status === 'Maintenance') return m;
                        
                        let newProgress = m.progress;
                        let newStatus = m.status;
                        let newPatients = m.patients;

                        if (newStatus === 'Scanning' || newStatus === 'Beam On') {
                            newProgress += 5;
                            if (newProgress >= 100) {
                                newProgress = 0;
                                newStatus = 'Idle'; // Exam finished
                                newPatients += 1;
                            }
                        } else if (newStatus === 'Idle' && Math.random() > 0.7) {
                            newStatus = m.type === 'Linac' ? 'Setup' : m.type === 'PET' ? 'Injecting' : 'Scanning';
                        } else if ((newStatus === 'Setup' || newStatus === 'Injecting') && Math.random() > 0.5) {
                            newStatus = m.type === 'Linac' ? 'Beam On' : 'Scanning';
                        }

                        return { ...m, status: newStatus, progress: newProgress, patients: newPatients };
                    }));

                    setSummary(prev => ({
                        totalExams: prev.totalExams + (Math.random() > 0.5 ? 1 : 0),
                        utilization: +(80 + Math.random() * 5).toFixed(1),
                        alerts: 1 // Keep constant for demo
                    }));

                }, 2000);
                return () => clearInterval(interval);
            }, []);

            return { machines, summary };
        };

        // --- 2. Components ---

        const Header = ({ summary }) => (
            <header className="h-20 bg-white/90 backdrop-blur border-b border-slate-200 flex justify-between items-center px-8 shrink-0 z-10 sticky top-0">
                <div className="flex items-center gap-3">
                    <img src="image/fetlogo.png" className="h-8 object-contain" onError={(e) => e.target.style.display='none'} />
                    <h1 className="text-xl font-black text-slate-800 tracking-tight">
                        SKH <span className="text-sky-500">DEVICE</span> CENTER
                    </h1>
                    <span className="px-2 py-1 bg-slate-100 text-slate-500 text-xs rounded font-bold ml-2">全院檢查儀器戰情室</span>
                </div>
                <div className="flex gap-6">
                    <div className="text-center">
                        <p className="text-[10px] text-slate-400 font-bold uppercase">今日總檢查量</p>
                        <p className="text-lg font-black text-slate-700">{summary.totalExams}</p>
                    </div>
                    <div className="text-center">
                        <p className="text-[10px] text-slate-400 font-bold uppercase">平均稼動率</p>
                        <p className="text-lg font-black text-emerald-500">{summary.utilization}%</p>
                    </div>
                    <div className="text-center">
                        <p className="text-[10px] text-slate-400 font-bold uppercase">異常警示</p>
                        <p className="text-lg font-black text-rose-500 animate-pulse">{summary.alerts}</p>
                    </div>
                    <div className="border-l pl-6 flex items-center">
                        <span className="text-sm font-mono font-bold text-slate-500">{new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
            </header>
        );

        const MachineCard = ({ machine, onClick }) => {
            let statusClass = 'status-idle';
            let icon = 'fa-power-off';
            let statusText = machine.status;

            if (['Scanning', 'Beam On', 'Injecting'].includes(machine.status)) {
                statusClass = 'status-active';
                icon = 'fa-circle-notch fa-spin';
                statusText = '運轉中';
            } else if (machine.status === 'Maintenance') {
                statusClass = 'status-error';
                icon = 'fa-wrench';
                statusText = '維修中';
            } else if (machine.status === 'Setup') {
                statusClass = 'status-warning';
                icon = 'fa-user-gear';
                statusText = '準備中';
            }

            return (
                <div onClick={() => onClick(machine)} className="glass-card p-5 cursor-pointer group relative overflow-hidden hover:border-sky-400">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg bg-slate-100 text-slate-500 group-hover:bg-sky-50 group-hover:text-sky-600 transition-colors`}>
                                <i className={`fa-solid ${machine.type === 'MRI' ? 'fa-magnet' : machine.type === 'CT' ? 'fa-ring' : machine.type === 'Linac' ? 'fa-certificate' : 'fa-x-ray'}`}></i>
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-700 text-sm">{machine.name}</h3>
                                <p className="text-xs text-slate-400">{machine.id}</p>
                            </div>
                        </div>
                        <span className={`text-[10px] px-2 py-1 rounded-full font-bold flex items-center gap-1 ${statusClass}`}>
                            <i className={`fa-solid ${icon} text-[8px]`}></i> {statusText}
                        </span>
                    </div>

                    <div className="space-y-3">
                        <div className="flex justify-between text-xs text-slate-500">
                            <span>今日進度</span>
                            <span className="font-mono">{machine.patients} / {machine.total}</span>
                        </div>
                        <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                            <div 
                                className={`h-full transition-all duration-500 ${machine.status === 'Maintenance' ? 'bg-slate-300' : 'bg-sky-500'}`} 
                                style={{width: `${(machine.patients / machine.total) * 100}%`}}
                            ></div>
                        </div>
                        
                        {machine.status !== 'Maintenance' && machine.status !== 'Idle' && (
                            <div className="pt-2 border-t border-slate-50">
                                <div className="flex justify-between text-[10px] text-slate-400 mb-1">
                                    <span>Current Scan Progress</span>
                                    <span>{machine.progress}%</span>
                                </div>
                                <div className="w-full bg-slate-100 h-1 rounded-full overflow-hidden">
                                    <div className="h-full bg-emerald-400 transition-all duration-300" style={{width: `${machine.progress}%`}}></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DetailPanel = ({ machine, onClose }) => {
            if (!machine) return null;

            return (
                <div className="fixed inset-y-0 right-0 w-96 bg-white shadow-2xl border-l border-slate-200 z-50 transform transition-transform duration-300 ease-in-out flex flex-col">
                    <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2">
                            <i className="fa-solid fa-server text-sky-500"></i> {machine.name}
                        </h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><i className="fa-solid fa-times"></i></button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-5 space-y-6">
                        {/* Status Section */}
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <p className="text-xs font-bold text-slate-400 uppercase mb-2">目前狀態</p>
                            <div className="flex justify-between items-center">
                                <span className="text-2xl font-black text-slate-700">{machine.status}</span>
                                <span className="text-sm font-mono text-slate-500">Load: {Math.round((machine.patients/machine.total)*100)}%</span>
                            </div>
                        </div>

                        {/* Patient List (Mock) */}
                        <div>
                            <h4 className="font-bold text-sm text-slate-700 mb-3">今日排程清單</h4>
                            <div className="space-y-2">
                                {Array.from({length: 6}).map((_, i) => {
                                    const isDone = i < (machine.patients % 6);
                                    const isCurrent = i === (machine.patients % 6);
                                    return (
                                        <div key={i} className={`p-3 rounded-lg border flex justify-between items-center text-sm ${isCurrent ? 'bg-sky-50 border-sky-200' : isDone ? 'bg-slate-50 border-slate-100 opacity-60' : 'bg-white border-slate-100'}`}>
                                            <div className="flex items-center gap-3">
                                                <span className="font-mono text-slate-400 text-xs">{10+i}:00</span>
                                                <span className="font-bold text-slate-700">病患-{100+i}</span>
                                            </div>
                                            {isDone ? <i className="fa-solid fa-check-circle text-emerald-500"></i> : 
                                             isCurrent ? <span className="text-[10px] bg-sky-100 text-sky-700 px-2 py-0.5 rounded animate-pulse">檢查中</span> : 
                                             <span className="text-xs text-slate-400">等待中</span>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Maintenance Info */}
                        <div>
                            <h4 className="font-bold text-sm text-slate-700 mb-3">設備維護資訊</h4>
                            <ul className="text-xs text-slate-500 space-y-2 bg-white p-3 rounded-lg border border-slate-100">
                                <li className="flex justify-between"><span>下次保養日期:</span> <span className="font-bold">{machine.nextMaint}</span></li>
                                <li className="flex justify-between"><span>上次校正 (QA):</span> <span className="font-bold text-emerald-600">Pass (今日 07:30)</span></li>
                                <li className="flex justify-between"><span>負責工程師:</span> <span>王大明 (Ext. 1234)</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. Main App ---
        const App = () => {
            const { machines, summary } = useMachineData();
            const [selectedMachine, setSelectedMachine] = useState(null);
            const [filter, setFilter] = useState('All');

            // Group machines by department for clearer view
            const depts = ['Radiology', 'Nuclear Med', 'Rad Oncology', 'Ultrasound'];
            
            const filteredMachines = filter === 'All' ? machines : machines.filter(m => m.dept === filter);

            return (
                <div className="flex flex-col h-screen w-screen bg-slate-50">
                    <Header summary={summary} />

                    <div className="flex-1 overflow-y-auto p-8 relative">
                        {/* Filter Tabs */}
                        <div className="flex gap-2 mb-8 overflow-x-auto pb-2">
                            <button onClick={() => setFilter('All')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${filter === 'All' ? 'bg-sky-500 text-white shadow-lg shadow-sky-200' : 'bg-white text-slate-500 hover:bg-slate-100'}`}>全部儀器</button>
                            {depts.map(d => (
                                <button key={d} onClick={() => setFilter(d)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${filter === d ? 'bg-sky-500 text-white shadow-lg shadow-sky-200' : 'bg-white text-slate-500 hover:bg-slate-100'}`}>
                                    {d === 'Rad Oncology' ? '放射腫瘤' : d === 'Radiology' ? '放射診斷' : d === 'Nuclear Med' ? '核子醫學' : '超音波室'}
                                </button>
                            ))}
                        </div>

                        {/* Machine Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {filteredMachines.map(machine => (
                                <MachineCard key={machine.id} machine={machine} onClick={setSelectedMachine} />
                            ))}
                        </div>

                        {/* Empty State */}
                        {filteredMachines.length === 0 && (
                            <div className="text-center text-slate-400 py-20">
                                <i className="fa-solid fa-filter-circle-xmark text-4xl mb-4"></i>
                                <p>無符合篩選條件的設備</p>
                            </div>
                        )}
                    </div>

                    {/* Overlay & Detail Panel */}
                    {selectedMachine && (
                        <div className="fixed inset-0 z-40">
                            <div className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity" onClick={() => setSelectedMachine(null)}></div>
                            <DetailPanel machine={selectedMachine} onClose={() => setSelectedMachine(null)} />
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>