<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫療數位孿生儀表板</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. 基礎與佈局 --- */
        
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #010038; /* 深藍色背景 [1] */
            color: #00b3ff; /* 霓虹藍色文字 [2] */
            margin: 0;
            padding: 0;
            overflow: hidden; /* 隱藏滾動條 */
        }

       .dashboard-container {
            display: grid;
            height: 100vh;
            padding: 20px;
            gap: 20px;
            /* * 使用 CSS Grid Areas 進行宏觀佈局 [3]
             * 佈局:
             * | HEADER | HEADER |
             * | HUMAN-TWIN | FACILITY-TWIN |
             * | HUMAN-TWIN | FACILITY-DETAILS |
            */
            grid-template-columns: 2fr 1.5fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "header header"
                "human-twin facility-twin"
                "human-twin facility-details";
            perspective: 1500px; /* 創建 3D 視口 */
        }

        header {
            grid-area: header;
            text-align: center;
        }

       .widget {
            /* "全息投影" 面板效果 */
            background: rgba(0, 25, 50, 0.7);
            border: 1px solid #00b3ff;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 180, 255, 0.5), 
                        inset 0 0 10px rgba(0, 180, 255, 0.3); /* 發光邊框 */
            backdrop-filter: blur(5px); /* 磨砂玻璃效果 */
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;

            /* 3D 傾斜效果，模擬 S_S_Final_Image */
            transform: rotateY(3deg) translateZ(-10px);
            transition: transform 0.4s, box-shadow 0.4s;
        }

       .widget:hover {
            transform: rotateY(0deg) translateZ(0) scale(1.02);
            box-shadow: 0 0 25px rgba(0, 180, 255, 0.8), 
                        inset 0 0 15px rgba(0, 180, 255, 0.5);
        }

        /* 將小部件分配到網格區域 */
       .human-twin { grid-area: human-twin; }
       .facility-twin { grid-area: facility-twin; }
       .facility-details { grid-area: facility-details; }

        /* --- 2. 標題與文字效果 --- */

        h1, h3 {
            margin: 0 0 20px 0;
            color: #fff;
            /* 發光文字效果 [2, 1] */
            text-shadow: 0 0 10px #00b3ff, 0 0 20px #00b3ff;
            animation: glowing-text 2s ease-in-out infinite alternate;
        }

        @keyframes glowing-text {
            from { text-shadow: 0 0 10px #00b3ff; }
            to { text-shadow: 0 0 20px #00b3ff, 0 0 5px #fff; }
        }

        /* --- 3. 模組 A: 人體孿生 --- */
        
        /* 移除了 #ecg-canvas 樣式 */

        /* 新增: 頭像容器樣式 */
       .avatar-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #000;
            border-radius: 8px;
        }

        #patient-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%; /* 圓形頭像 */
            border: 4px solid #00b3ff;
            box-shadow: 0 0 15px #00b3ff;
            object-fit: cover; /* 確保圖片填滿 */
        }
        
       .vitals-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

       .vital {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #005f80;
            padding: 15px;
            border-radius: 5px;
        }

       .vital.label {
            font-size: 1rem;
            color: #00b3ff;
            display: block;
            margin-bottom: 5px;
        }

       .vital.value {
            font-size: 3rem;
            font-weight: 700;
            color: #fff;
            /* 數位數字外觀 [4] */
            text-shadow: 0 0 8px #fff; 
        }

       .vital.unit {
            font-size: 1rem;
            color: #00b3ff;
            margin-left: 5px;
        }

       .stats-container {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        /* 純 CSS 環圈圖 [5, 6] */
       .doughnut-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            /* 使用 conic-gradient 繪製圖表 */
            background: conic-gradient(
                #00b3ff 0% 75%, 
                #333 75% 100%
            );
            
            /* 使用偽元素創建環圈的"洞" [5] */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

       .doughnut-chart::before {
            content: '';
            width: 90px;
            height: 90px;
            background: #010038; /* 匹配.vital 的背景 */
            border-radius: 50%;
            position: absolute;
        }

       .doughnut-label {
            position: relative; /* 確保在 ::before 之上 */
            text-align: center;
            color: #fff;
        }
       .doughnut-label.value {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }
       .doughnut-label.label {
            font-size: 0.9rem;
            color: #00b3ff;
        }

        /* --- 4. 模組 B: 設施孿生 (SVG 地圖) --- */
        
       .map-container {
            flex-grow: 1; /* 填滿.widget 的剩餘空間 */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-radius: 5px;
            padding: 10px;
            position: relative; /* 用於疊加狀態指示燈 */
        }

       .facility-map {
            width: 100%;
            height: 100%;
        }

        /* SVG 路徑的默認樣式 */
       .facility-map.room {
            fill: #333;
            stroke: #00b3ff;
            stroke-width: 2;
            cursor: pointer;
            transition: fill 0.3s ease;
        }

        /* SVG 點擊高亮效果 [7, 8] */
       .facility-map.room:hover {
            fill: #555;
        }

       .facility-map.room.selected {
            fill: #00b3ff;
            stroke: #fff;
        }

        /* 警報閃爍動畫 [9] */
       .facility-map.room.alert {
            fill: #ff4242; /* 警報紅色 [10] */
            animation: blink-fill 1s infinite;
        }

        @keyframes blink-fill {
            0%, 100% { fill: #ff4242; }
            50% { fill: #333; }
        }

        /* --- 5. 設施詳情 & 狀態指示燈 --- */

       .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
       .detail-item.label {
            font-size: 0.9rem;
            color: #00b3ff;
        }
       .detail-item.value {
            font-size: 1.5rem;
            color: #fff;
        }

        /* 狀態指示燈 [10, 11, 12] */
       .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

       .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
        }
        
       .status-dot.online { background-color: #72ff7d; }
       .status-dot.offline { background-color: #ff4242; }

        /* 脈衝動畫 [10] */
       .status-dot::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: inherit;
            animation: pulse 1.5s infinite ease-out;
        }

       .status-dot.offline::before {
            animation: none; /* 離線時不發光 */
        }

        @keyframes pulse {
            from {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }
        
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header>
            <h1>醫療數位孿生儀表板 (Demo)</h1>
        </header>

        <div class="widget human-twin">
            <!-- <h3> 標題現在是動態的 -->
            <h3 id="human-twin-title">人體孿生 (Patient-001)</h3>
            
            <!-- 移除了 <canvas id="ecg-canvas"></canvas> -->
            
            <!-- 新增: 病患頭像 -->
            <div class="avatar-container">
                <!-- 
                  注意: 
                  請將下面的 'src' 網址替換為您本地的圖片路徑 (例如 'p1.png')。
                  目前使用 placehold.co 作為佔位符。
                -->
                <img id="patient-avatar" src="p1.jpg" alt="病患頭像">
            </div>

            <div class="vitals-grid">
                <div class="vital">
                    <span class="label">心率 (HR)</span>
                    <span class="value" id="vital-hr">72</span>
                    <span class="unit">bpm</span>
                </div>
                <div class="vital">
                    <span class="label">血壓 (BP)</span>
                    <span class="value" id="vital-bp">120/80</span>
                    <span class="unit">mmHg</span>
                </div>
                <div class="vital">
                    <span class="label">血氧 (SpO2)</span>
                    <span class="value" id="vital-spo2">98</span>
                    <span class="unit">%</span>
                </div>
                <div class="vital">
                    <span class="label">呼吸 (RR)</span>
                    <span class="value" id="vital-rr">16</span>
                    <span class="unit">/min</span>
                </div>
            </div>

            <div class="stats-container">
                <div class="doughnut-chart" id="physio-load">
                    <div class="doughnut-label">
                        <span class="value" id="doughnut-value">75%</span>
                        <span class="label">生理負荷</span>
                    </div>
                </div>
                <div class="patient-info">
                    <!-- 這些 <p> 標籤現在是動態的 -->
                    <p id="patient-info-name"><strong>病患:</strong> Patient-001</p>
                    <p id="patient-info-status"><strong>狀態:</strong> 穩定</p>
                    <p id="patient-info-location"><strong>位置:</strong> ICU 病房 101</p>
                </div>
            </div>
        </div>

        <div class="widget facility-twin">
            <h3>設施孿生 (ICU 樓層)</h3>
            <div class="map-container">
                <svg class="facility-map" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
                    <title>ICU 樓層平面圖</title>
                    
                    <path class="room" id="room-101" d="M 10,10 H 140 V 90 H 10 Z" />
                    <text x="75" y="55" fill="#fff" font-size="12" text-anchor="middle">ICU 101</text>
                    
                    <path class="room" id="room-102" d="M 160,10 H 290 V 90 H 160 Z" />
                    <text x="225" y="55" fill="#fff" font-size="12" text-anchor="middle">ICU 102</text>
                    
                    <path class="room" id="room-103" d="M 10,110 H 140 V 190 H 10 Z" />
                    <text x="75" y="155" fill="#fff" font-size="12" text-anchor="middle">ICU 103</text>
                    
                    <!-- 更新: 將 MRI 變更為 ICU 104 -->
                    <path class="room" id="room-104" d="M 160,110 H 290 V 190 H 160 Z" />
                    <text x="225" y="155" fill="#fff" font-size="12" text-anchor="middle">ICU 104</text>
                </svg>
            </div>
        </div>

        <div class="widget facility-details">
            <h3>設施詳情</h3>
            <div class="details-grid">
                <div class="detail-item">
                    <span class="label">選定區域</span>
                    <span class="value" id="details-room-name">--</span>
                </div>
                <div class="detail-item">
                    <span class="label">狀態</span>
                    <div class="status-indicator">
                        <span class="status-dot online" id="details-status-dot"></span>
                        <span class="value" id="details-status-text">--</span>
                    </div>
                </div>
            </div>
            <div class="detail-item">
                <span class="label">關聯病患</span>
                <span class="value" id="details-patient">--</span>
            </div>
            <div class="detail-item">
                <span class="label">設備</span>
                <span class="value" id="details-equipment">--</span>
            </div>
        </div>
    </div>

    <script>
        // 確保在 DOM 加載完成後執行 [13, 14, 15]
        document.addEventListener('DOMContentLoaded', function() {

            // --- 1. 緩存 DOM 元素 ---
            const hrElement = document.getElementById('vital-hr');
            const bpElement = document.getElementById('vital-bp');
            const spo2Element = document.getElementById('vital-spo2');
            const rrElement = document.getElementById('vital-rr');
            
            // 移除 ECG 相關
            // const ecgCanvas = document.getElementById('ecg-canvas');
            // const ctx = ecgCanvas.getContext('2d');
            
            const roomPaths = document.querySelectorAll('.facility-map.room');
            
            const detailsName = document.getElementById('details-room-name');
            const detailsStatusText = document.getElementById('details-status-text');
            const detailsStatusDot = document.getElementById('details-status-dot');
            const detailsPatient = document.getElementById('details-patient');
            const detailsEquipment = document.getElementById('details-equipment');

            // 新增: 人體孿生 DOM 元素
            const humanTwinTitle = document.getElementById('human-twin-title');
            const patientAvatar = document.getElementById('patient-avatar');
            const patientInfoName = document.getElementById('patient-info-name');
            const patientInfoStatus = document.getElementById('patient-info-status');
            const patientInfoLocation = document.getElementById('patient-info-location');


            // --- 2. 移除 ECG 繪圖引擎 ---
            // [16]
            
            // (ECG 相關的 drawEcg, resizeCanvas, ecgWaveform, ecgDataIndex, ecgX, step 均已移除)


            // --- 3. 數據模擬引擎 (setInterval) ---
            
            // 模擬病房與病患數據庫
            // 這是 Demo 的核心數據模型
            const patientDatabase = {
                "room-101": { 
                    patientId: "Patient-001", 
                    avatarUrl: "https://placehold.co/150x150/010038/00b3ff?text=P1", // 替換為 'p1.png'
                    equipment: "Ventilator V-100", 
                    status: "online",
                    baseVitals: { hr: 72, bpSys: 120, bpDia: 80, spo2: 98, rr: 16 }
                },
                "room-102": { 
                    patientId: "Patient-002", 
                    avatarUrl: "https://placehold.co/150x150/010038/00b3ff?text=P2", // 替換為 'p2.png'
                    equipment: "Dialysis D-50", 
                    status: "online",
                    baseVitals: { hr: 85, bpSys: 130, bpDia: 85, spo2: 97, rr: 18 }
                },
                "room-103": { 
                    patientId: "Patient-003", 
                    avatarUrl: "https://placehold.co/150x150/010038/00b3ff?text=P3", // 替換為 'p3.png'
                    equipment: "ECMO E-20", 
                    status: "online",
                    baseVitals: { hr: 68, bpSys: 110, bpDia: 75, spo2: 99, rr: 14 }
                },
                 "room-104": { 
                    patientId: "N/A", 
                    avatarUrl: "https://placehold.co/150x150/333/777?text=Empty",
                    equipment: "Empty", 
                    status: "offline",
                    baseVitals: null // 沒有病患
                },
            };

            // 用於儲存當前選定病患的基礎生命體徵
            let currentBaseVitals = null;
            let currentSelectedRoom = 'room-101'; // 初始選中

            // 模擬生命體徵 (中頻率更新) [17]
            // 更新: 模擬邏輯現在基於 currentBaseVitals
            setInterval(function simulateVitals() {
                if (!currentBaseVitals) {
                    // 如果房間為空，顯示 --
                    hrElement.innerText = '--';
                    spo2Element.innerText = '--';
                    rrElement.innerText = '--';
                    bpElement.innerText = '--/--';
                    return;
                }

                // [18, 19]
                hrElement.innerText = Math.floor(Math.random() * 5) + (currentBaseVitals.hr - 2);
                spo2Element.innerText = Math.floor(Math.random() * 2) + (currentBaseVitals.spo2 - 1);
                rrElement.innerText = Math.floor(Math.random() * 2) + (currentBaseVitals.rr - 1);
                
                let sys = Math.floor(Math.random() * 5) + (currentBaseVitals.bpSys - 2);
                let dia = Math.floor(Math.random() * 3) + (currentBaseVitals.bpDia - 1);
                bpElement.innerText = `${sys}/${dia}`;
                
            }, 1500);

            // 模擬設施狀態 (低頻率更新) [17]
            // 更新: 包含 room-104 並更新 patientDatabase
            setInterval(function simulateFacility() {
                // 隨機讓一個病房發出警報
                if (Math.random() > 0.7) {
                    // 選擇一個有病患的房間
                    const occupiedRooms = ["room-101", "room-102", "room-103"];
                    let randomRoom = occupiedRooms[Math.floor(Math.random() * occupiedRooms.length)];
                    let roomEl = document.getElementById(randomRoom);
                    
                    if (roomEl) {
                        // 切換警報狀態
                        if (roomEl.classList.contains('alert')) {
                            roomEl.classList.remove('alert');
                            patientDatabase[randomRoom].status = "online";
                        } else {
                            roomEl.classList.add('alert');
                            patientDatabase[randomRoom].status = "alert";
                        }
                        
                        // 更新詳情面板(如果選中)
                        if (roomEl.classList.contains('selected')) {
                            updateDetails(randomRoom);
                            updateHumanTwin(randomRoom); // 同時更新人體孿生面板的狀態
                        }
                    }
                }
            }, 5000);


            // --- 4. 設施地圖互動 ---

            // 更新: 抽離出一個函數來更新人體孿生面板
            function updateHumanTwin(roomId) {
                const data = patientDatabase[roomId];
                if (!data) return;

                // 設置基礎生命體徵
                currentBaseVitals = data.baseVitals;
                
                // 更新頭像
                // 替換 'src' 為您本地的圖片 (例如 data.avatarUrl)
                patientAvatar.src = data.avatarUrl; 
                
                // 更新標題
                humanTwinTitle.innerText = `人體孿生 (${data.patientId})`;
                
                // 更新病患資訊
                patientInfoName.innerText = `病患: ${data.patientId}`;
                patientInfoLocation.innerText = `位置: ${roomId.toUpperCase()}`;
                
                // 更新狀態
                if (data.status === 'online') {
                    patientInfoStatus.innerText = '狀態: 穩定';
                    patientInfoStatus.style.color = '#fff';
                } else if (data.status === 'alert') {
                    patientInfoStatus.innerText = '狀態: 警報!';
                    patientInfoStatus.style.color = '#ff4242'; // 警報紅色
                } else {
                    patientInfoStatus.innerText = '狀態: 離線';
                    patientInfoStatus.style.color = '#777';
                }

                // 如果沒有病患，立即清除生命體徵
                if (!data.baseVitals) {
                    simulateVitals();
                }
            }

            function updateDetails(roomId) {
                const data = patientDatabase[roomId]; // 使用新的數據庫
                if (!data) return;

                detailsName.innerText = roomId.toUpperCase();
                detailsPatient.innerText = data.patientId;
                detailsEquipment.innerText = data.equipment;
                
                if (data.status === 'online') {
                    detailsStatusText.innerText = "Online";
                    detailsStatusDot.className = "status-dot online";
                } else if (data.status === 'alert') {
                    detailsStatusText.innerText = "Alert!";
                    detailsStatusDot.className = "status-dot offline"; // 使用 offline 的紅色
                } else {
                    detailsStatusText.innerText = "Offline";
                    detailsStatusDot.className = "status-dot offline";
                }
            }

            // 為每個 SVG 房間路徑添加點擊事件 [7, 8, 20]
            roomPaths.forEach(path => {
                path.addEventListener('click', function() {
                    // 1. 移除所有路徑的 'selected' 類 [8]
                    roomPaths.forEach(p => p.classList.remove('selected'));
                    
                    // 2. 為被點擊的路徑添加 'selected' 類 [8]
                    this.classList.add('selected');
                    
                    // 3. 更新兩個面板
                    currentSelectedRoom = this.id;
                    updateDetails(currentSelectedRoom);
                    updateHumanTwin(currentSelectedRoom); // <--- 新增
                });
            });

            // --- 5. 啟動 ---
            // 移除 resizeCanvas() 和 drawEcg()
            
            // 設置初始選中狀態
            document.getElementById(currentSelectedRoom).classList.add('selected');
            updateDetails(currentSelectedRoom);
            updateHumanTwin(currentSelectedRoom); // <--- 新增
        });
    </script>
</body>
</html>
