<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫療數位孿生儀表板</title>
    <link rel="shortcut icon" href="feticon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. 基礎與佈局 --- */
        
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #010038; /* 深藍色背景 [1] */
            color: #00b3ff; /* 霓虹藍色文字 [2] */
            margin: 0;
            padding: 0;
            overflow: hidden; /* 隱藏滾動條 */
        }

       .dashboard-container {
            display: grid;
            height: 100vh;
            padding: 20px;
            gap: 20px;
            /* * 使用 CSS Grid Areas 進行宏觀佈局 [3]
             * 佈局:
             * | HEADER | HEADER |
             * | HUMAN-TWIN | FACILITY-TWIN |
             * | HUMAN-TWIN | FACILITY-DETAILS |
            */
            grid-template-columns: 2fr 1.5fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "header header"
                "human-twin facility-twin"
                "human-twin facility-details";
            perspective: 1500px; /* 創建 3D 視口 */
        }

        header {
            grid-area: header;
            text-align: center;
        }

       .widget {
            /* "全息投影" 面板效果 */
            background: rgba(0, 25, 50, 0.7);
            border: 1px solid #00b3ff;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 180, 255, 0.5), 
                        inset 0 0 10px rgba(0, 180, 255, 0.3); /* 發光邊框 */
            backdrop-filter: blur(5px); /* 磨砂玻璃效果 */
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;

            /* 3D 傾斜效果，模擬 S_S_Final_Image */
            transform: rotateY(3deg) translateZ(-10px);
            transition: transform 0.4s, box-shadow 0.4s;
        }

       .widget:hover {
            transform: rotateY(0deg) translateZ(0) scale(1.02);
            box-shadow: 0 0 25px rgba(0, 180, 255, 0.8), 
                        inset 0 0 15px rgba(0, 180, 255, 0.5);
        }

        /* 將小部件分配到網格區域 */
       .human-twin { grid-area: human-twin; }
       .facility-twin { grid-area: facility-twin; }
       .facility-details { grid-area: facility-details; }

        /* --- 2. 標題與文字效果 --- */

        h1, h3 {
            margin: 0 0 20px 0;
            color: #fff;
            /* 發光文字效果 [2, 1] */
            text-shadow: 0 0 10px #00b3ff, 0 0 20px #00b3ff;
            animation: glowing-text 2s ease-in-out infinite alternate;
        }

        @keyframes glowing-text {
            from { text-shadow: 0 0 10px #00b3ff; }
            to { text-shadow: 0 0 20px #00b3ff, 0 0 5px #fff; }
        }

        /* --- 3. 模組 A: 人體孿生 --- */
        
/* ... existing code ... -->
        #patient-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%; /* 圓形頭像 */
            border: 4px solid #00b3ff;
            box-shadow: 0 0 15px #00b3ff;
            object-fit: cover; /* 確保圖片填滿 */
            /* * 新增: 錯誤處理，如果 p1.jpg 加載失敗
             * 會顯示一個藍色的佔位符 [21]
             */
            background-color: #00b3ff;
        }
        
       .vitals-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

       .vital {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #005f80;
            padding: 15px;
            border-radius: 5px;
        }

       .vital.label {
            font-size: 1rem;
            color: #00b3ff;
            display: block;
            margin-bottom: 5px;
        }

       .vital.value {
            font-size: 3rem;
            font-weight: 700;
            color: #fff;
            /* 數位數字外觀 [4] */
            text-shadow: 0 0 8px #fff; 
        }

       .vital.unit {
            font-size: 1rem;
            color: #00b3ff;
            margin-left: 5px;
        }

       /* 移除了 .stats-container, .doughnut-chart, .patient-info 相關樣式 */

        /* 新增: 動態圖表容器 */
       .graphs-container {
            flex-grow: 1; /* 填滿剩餘的垂直空間 */
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0; /* 確保 flex-grow 在 flex column 中正常運作 */
        }

       .graph-wrapper {
            flex-grow: 1; /* 每個圖表均分空間 */
            display: flex;
            flex-direction: column;
            background: #000;
            border: 1px solid #005f80; /* 匹配 vitals 邊框 */
            border-radius: 4px;
            padding: 5px;
        }

       .graph-label {
            color: #00b3ff;
            margin: 0 0 5px 5px;
            font-size: 0.9rem;
            font-weight: 400;
        }

        #ecg-canvas, #eeg-canvas {
            width: 100%;
            flex-grow: 1; /* 畫布填滿 wrapper */
            border-radius: 4px;
        }


        /* --- 4. 模組 B: 設施孿生 (SVG 地圖) --- */
        
       .map-container {
            flex-grow: 1; /* 填滿.widget 的剩餘空間 */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-radius: 5px;
            padding: 10px;
            position: relative; /* 用於疊加狀態指示燈 */
        }

       .facility-map {
            width: 100%;
            height: 100%;
        }

        /* * 修正 (FIX): 
         * 選擇器從 .facility-map.room 改為 .facility-map .room
         * (使用後代選擇器)
         */
         
        /* SVG 路徑的默認樣式 */
       .facility-map .room {
            fill: #333;
            stroke: #00b3ff;
            stroke-width: 2;
            cursor: pointer;
            transition: fill 0.3s ease;
        }

        /* SVG 點擊高亮效果 [7, 8] */
       .facility-map .room:hover {
            fill: #555;
        }

       .facility-map .room.selected {
            fill: #00b3ff;
            stroke: #fff;
        }

        /* 警報閃爍動畫 [9] */
       .facility-map .room.alert {
            fill: #ff4242; /* 警報紅色 [10] */
            animation: blink-fill 1s infinite;
        }

        @keyframes blink-fill {
            0%, 100% { fill: #ff4242; }
            50% { fill: #333; }
        }

        /* --- 5. 設施詳情 & 狀態指示燈 --- */

       .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
       .detail-item.label {
            font-size: 0.9rem;
            color: #00b3ff;
        }
       .detail-item.value {
            font-size: 1.5rem;
            color: #fff;
        }

        /* 狀態指示燈 [10, 11, 12] */
       .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

       .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
        }
        
       .status-dot.online { background-color: #72ff7d; }
       .status-dot.offline { background-color: #ff4242; }

        /* 脈衝動畫 [10] */
       .status-dot::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: inherit;
            animation: pulse 1.5s infinite ease-out;
        }

       .status-dot.offline::before {
            animation: none; /* 離線時不發光 */
        }

        @keyframes pulse {
            from {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }
        
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header>
            <h1>醫療數位孿生儀表板 (Demo)</h1>
        </header>

        <div class="widget human-twin">
            <!-- <h3> 標題現在是動態的 -->
            <h3 id="human-twin-title">人體孿生 (Patient-001)</h3>
            
            <!-- 新增: 病患頭像 -->
            <div class="avatar-container">
                <!-- 
                  更新: 
                  'src' 路徑已設為 'p1.jpg'。
                  並添加了 'onerror' 事件處理，以防圖片加載失敗。
                -->
                <img id="patient-avatar" 
                     src="p1.jpg" 
                     alt="病患頭像"
                     onerror="this.src='https://placehold.co/150x150/010038/FF0000?text=Error'; this.style.borderColor='#ff0000';">
            </div>

            <div class="vitals-grid">
                <div class="vital">
                    <span class="label">心率 (HR)</span>
                    <span class="value" id="vital-hr">72</span>
                    <span class="unit">bpm</span>
                </div>
                <div class="vital">
                    <span class="label">血壓 (BP)</span>
                    <span class="value" id="vital-bp">120/80</span>
                    <span class="unit">mmHg</span>
                </div>
                <div class="vital">
                    <span class="label">血氧 (SpO2)</span>
                    <span class="value" id="vital-spo2">98</span>
                    <span class="unit">%</span>
                </div>
                <div class="vital">
                    <span class="label">呼吸 (RR)</span>
                    <span class="value" id="vital-rr">16</span>
                    <span class="unit">/min</span>
                </div>
            </div>

            <!-- 移除 .stats-container (環圈圖和病患資訊) -->

            <!-- 新增: 動態圖表容器 -->
            <div class="graphs-container">
                <div class="graph-wrapper">
                    <h4 class="graph-label">心電圖 (ECG)</h4>
                    <canvas id="ecg-canvas"></canvas>
                </div>
                <div class="graph-wrapper">
                    <h4 class="graph-label">腦波圖 (EEG) - 5 通道</h4>
                    <canvas id="eeg-canvas"></canvas>
                </div>
            </div>
        </div>

        <div class="widget facility-twin">
            <h3>設施孿生 (ICU 樓層)</h3>
            <div class="map-container">
                <svg class="facility-map" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
                    <title>ICU 樓層平面圖</title>
                    
                    <path class="room" id="room-101" d="M 10,10 H 140 V 90 H 10 Z" />
                    <text x="75" y="55" fill="#fff" font-size="12" text-anchor="middle">ICU 101</text>
                    
                    <path class="room" id="room-102" d="M 160,10 H 290 V 90 H 160 Z" />
                    <text x="225" y="55" fill="#fff" font-size="12" text-anchor="middle">ICU 102</text>
                    
                    <path class="room" id="room-103" d="M 10,110 H 140 V 190 H 10 Z" />
                    <text x="75" y="155" fill="#fff" font-size="12" text-anchor="middle">ICU 103</text>
                    
                    <!-- 更新: ICU 104 -->
                    <path class="room" id="room-104" d="M 160,110 H 290 V 190 H 160 Z" />
                    <text x="225" y="155" fill="#fff" font-size="12" text-anchor="middle">ICU 104</text>
                </svg>
            </div>
        </div>

        <div class="widget facility-details">
            <h3>設施詳情</h3>
            <div class="details-grid">
                <div class="detail-item">
                    <span class="label">選定區域</span>
                    <span class="value" id="details-room-name">--</span>
                </div>
                <div class="detail-item">
                    <span class="label">狀態</span>
                    <div class="status-indicator">
                        <span class="status-dot online" id="details-status-dot"></span>
                        <span class="value" id="details-status-text">--</span>
                    </div>
                </div>
            </div>
            <div class="detail-item">
                <span class="label">關聯病患</span>
                <span class="value" id="details-patient">--</span>
            </div>
            <div class="detail-item">
                <span class="label">設備</span>
                <span class="value" id="details-equipment">--</span>
            </div>
        </div>
    </div>

    <script>
        // 確保在 DOM 加載完成後執行 [13, 14, 15]
        document.addEventListener('DOMContentLoaded', function() {

            // --- 1. 緩存 DOM 元素 ---
            const hrElement = document.getElementById('vital-hr');
            const bpElement = document.getElementById('vital-bp');
            const spo2Element = document.getElementById('vital-spo2');
            const rrElement = document.getElementById('vital-rr');
            
            /* * 修正 (FIX): 
             * 選擇器從 .facility-map.room 改為 .facility-map .room
             */
            const roomPaths = document.querySelectorAll('.facility-map .room');
            
            const detailsName = document.getElementById('details-room-name');
            const detailsStatusText = document.getElementById('details-status-text');
            const detailsStatusDot = document.getElementById('details-status-dot');
            const detailsPatient = document.getElementById('details-patient');
            const detailsEquipment = document.getElementById('details-equipment');

            // 人體孿生 DOM 元素
            const humanTwinTitle = document.getElementById('human-twin-title');
            const patientAvatar = document.getElementById('patient-avatar');
            // 修正: 移除了不存在的 DOM 元素
            // const patientInfoName = document.getElementById('patient-info-name');
            // const patientInfoStatus = document.getElementById('patient-info-status');
            // const patientInfoLocation = document.getElementById('patient-info-location');

            // 新增: 畫布元素
            const ecgCanvas = document.getElementById('ecg-canvas');
            const ecgCtx = ecgCanvas.getContext('2d');
            const eegCanvas = document.getElementById('eeg-canvas');
            const eegCtx = eegCanvas.getContext('2d');


            // --- 2. 數據模擬引擎 ---
            
            <!-- 
              * 修正 (FIX): 
              * 修正了 SyntaxError: Unexpected token ':'
              * 這裡的 patientDatabase 物件宣告不完整。
            -->
            
            <!-- 模擬病房與病患數據庫 -->
            <!-- 使用 p1.jpg, p2.jpg, p3.jpg, p4.jpg -->
            <const patientDatabase = {
                "room-101": { 
                    patientId: "Patient-001", 
                    avatarUrl: "p1.jpg", // 更新
                    equipment: "Ventilator V-100", 
                    status: "online",
                    baseVitals: { hr: 72, bpSys: 120, bpDia: 80, spo2: 98, rr: 16 }
                },
                "room-102": { 
                    patientId: "Patient-002", 
                    avatarUrl: "p2.jpg", // 更新
                    equipment: "Dialysis D-50", 
                    status: "online",
                    baseVitals: { hr: 85, bpSys: 130, bpDia: 85, spo2: 97, rr: 18 }
                },
                "room-103": { 
                    patientId: "Patient-003", 
                    avatarUrl: "p3.jpg", // 更新
                    equipment: "ECMO E-20", 
                    status: "online",
                    baseVitals: { hr: 68, bpSys: 110, bpDia: 75, spo2: 99, rr: 14 }
                },
                 "room-104": { 
                    patientId: "Patient-004", // 更新
                    avatarUrl: "p4.jpg", // 更新
                    equipment: "Infusion Pump I-30", // 更新
                    status: "online", // 更新
                    baseVitals: { hr: 75, bpSys: 115, bpDia: 78, spo2: 98, rr: 16 } // 更新
                },
            };

            // 用於儲存當前選定病患的基礎生命體徵
            let currentBaseVitals = null;
            let currentSelectedRoom = 'room-101'; // 初始選中

            // 模擬生命體徵 (中頻率更新) [17]
            setInterval(function simulateVitals() {
                if (!currentBaseVitals) {
                    hrElement.innerText = '--';
                    spo2Element.innerText = '--';
                    rrElement.innerText = '--';
                    bpElement.innerText = '--/--';
                    return;
                }

                hrElement.innerText = Math.floor(Math.random() * 5) + (currentBaseVitals.hr - 2);
                spo2Element.innerText = Math.floor(Math.random() * 2) + (currentBaseVitals.spo2 - 1);
                rrElement.innerText = Math.floor(Math.random() * 2) + (currentBaseVitals.rr - 1);
                
                let sys = Math.floor(Math.random() * 5) + (currentBaseVitals.bpSys - 2);
                let dia = Math.floor(Math.random() * 3) + (currentBaseVitals.bpDia - 1);
                bpElement.innerText = `${sys}/${dia}`;
                
            }, 1500);

            // 模擬設施狀態 (低頻率更新) [17]
            setInterval(function simulateFacility() {
                if (Math.random() > 0.7) {
                    // 選擇一個有病患的房間
                    const occupiedRooms = ["room-101", "room-102", "room-103", "room-104"];
                    let randomRoom = occupiedRooms[Math.floor(Math.random() * occupiedRooms.length)];
                    let roomEl = document.getElementById(randomRoom);
                    
                    if (roomEl) {
                        // 切換警報狀態
                        if (roomEl.classList.contains('alert')) {
                            roomEl.classList.remove('alert');
                            patientDatabase[randomRoom].status = "online";
                        } else {
                            roomEl.classList.add('alert');
                            patientDatabase[randomRoom].status = "alert";
                        }
                        
                        if (roomEl.classList.contains('selected')) {
                            updateDetails(randomRoom);
                            updateHumanTwin(randomRoom);
                        }
                    }
                }
            }, 5000);


            // --- 3. 設施地圖互動 ---

            function updateHumanTwin(roomId) {
                const data = patientDatabase[roomId];
                if (!data) return;

                currentBaseVitals = data.baseVitals;
                
                // 更新頭像
                patientAvatar.src = data.avatarUrl; 
                // 重置邊框顏色，以防 'onerror' 觸發
                patientAvatar.style.borderColor = '#00b3ff';
                
                humanTwinTitle.innerText = `人體孿生 (${data.patientId})`;
                
                <!-- 修正: 移除了對不存在元素的 .innerText 賦值 -->
                <!-- patientInfoName.innerText = `病患: ${data.patientId}`; -->
                <!-- patientInfoLocation.innerText = `位置: ${roomId.toUpperCase()}`; -->
                
                <!-- 更新: 移除 patientInfoStatus 的更新 (該元素已被移除) -->
                
                if (!data.baseVitals) {
                    simulateVitals();
                }
            }

            function updateDetails(roomId) {
                const data = patientDatabase[roomId];
                if (!data) return;

                detailsName.innerText = roomId.toUpperCase();
                detailsPatient.innerText = data.patientId;
                detailsEquipment.innerText = data.equipment;
                
                if (data.status === 'online') {
                    detailsStatusText.innerText = "Online";
                    detailsStatusDot.className = "status-dot online";
                } else if (data.status === 'alert') {
                    detailsStatusText.innerText = "Alert!";
                    detailsStatusDot.className = "status-dot offline";
                } else {
                    detailsStatusText.innerText = "Offline";
                    detailsStatusDot.className = "status-dot offline";
                }
            }

            // 為每個 SVG 房間路徑添加點擊事件 [7, 8, 20]
            roomPaths.forEach(path => {
                path.addEventListener('click', function() {
                    // 1. 移除所有路徑的 'selected' 類 [8]
                    roomPaths.forEach(p => p.classList.remove('selected'));
                    
                    // 2. 為被點擊的路徑添加 'selected' 類 [8]
                    this.classList.add('selected');
                    
                    // 3. 更新兩個面板
                    currentSelectedRoom = this.id;
                    updateDetails(currentSelectedRoom);
                    updateHumanTwin(currentSelectedRoom);
                });
            });

            // --- 4. 新增: 畫布繪圖引擎 ---

            // ECG 數據 (與之前版本相同)
            const ecgWaveform = [
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 
                102, 105, 103, 100, // P 波
                100, 100, 98, 95,   // Q
                180, // R
                90, 95, 100, 105, 110, 108, 105, // S-T
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                100, 100, 100, 100, 100, 100, 100, 100, 100, 100
            ];
            let ecgDataIndex = 0;
            let ecgX = 0;
            const ecgStep = 2; // 每次前進 2 像素

            // EEG 數據
            const eegLines = 5; // 5 通道腦波
            let eegX = 0;
            const eegStep = 2;
            let lastEegY = new Array(eegLines).fill(0); // 儲存 5 條線各自的 Y 
            
            // 響應式調整畫布大小
            function resizeCanvases() {
                ecgCanvas.width = ecgCanvas.offsetWidth;
                ecgCanvas.height = ecgCanvas.offsetHeight;
                ecgCtx.strokeStyle = '#00ff00'; // ECG 綠色
                ecgCtx.lineWidth = 2;
                ecgCtx.shadowBlur = 5;
                ecgCtx.shadowColor = '#00ff00';

                eegCanvas.width = eegCanvas.offsetWidth;
                eegCanvas.height = eegCanvas.offsetHeight;
                eegCtx.strokeStyle = '#FFFF00'; // EEG 黃色
                eegCtx.lineWidth = 1; // 腦波線條細一點

                // 初始化 EEG Y 座標
                for (let i = 0; i < eegLines; i++) {
                    lastEegY[i] = (eegCanvas.height / (eegLines + 1)) * (i + 1);
                }
            }
            
            // 繪製 ECG 波形
            function drawEcgWave() {
                let canvasHeight = ecgCanvas.height;
                let baseHeight = canvasHeight / 1.8;
                let scale = canvasHeight / 200; // 根據畫布高度動態縮放

                ecgCtx.clearRect(ecgX, 0, ecgStep + 10, canvasHeight);

                ecgCtx.beginPath();
                
                let y1_val = ecgWaveform[ecgDataIndex];
                let y2_index = (ecgDataIndex + 1) % ecgWaveform.length;
                let y2_val = ecgWaveform[y2_index];

                let canvasY1 = baseHeight - (y1_val - 100) * scale; 
                let canvasY2 = baseHeight - (y2_val - 100) * scale;

                ecgCtx.moveTo(ecgX, canvasY1);
                ecgCtx.lineTo(ecgX + ecgStep, canvasY2);
                ecgCtx.stroke();

                ecgX += ecgStep;
                ecgDataIndex = y2_index;
                
                if (ecgX > ecgCanvas.width) {
                    ecgX = 0; 
                }
            }

            // 繪製 EEG 波形 (多通道)
            function drawEegWave() {
                let canvasHeight = eegCanvas.height;
                let baseSpacing = canvasHeight / (eegLines + 1);
                let amplitude = baseSpacing * 0.4; // 振幅

                eegCtx.clearRect(eegX, 0, eegStep + 10, canvasHeight);

                for (let i = 0; i < eegLines; i++) {
                    let currentBaseY = baseSpacing * (i + 1);
                    // 模擬隨機波動
                    let newY = currentBaseY + (Math.random() - 0.5) * amplitude;

                    eegCtx.beginPath();
                    eegCtx.moveTo(eegX, lastEegY[i]);
                    eegCtx.lineTo(eegX + eegStep, newY);
                    eegCtx.stroke();
                    
                    lastEegY[i] = newY;
                }
                
                eegX += eegStep;

                if (eegX > eegCanvas.width) {
                    eegX = 0;
                    // 當 X 歸零時，重置 Y 到基線，防止線條飄移
                    for (let i = 0; i < eegLines; i++) {
                         lastEegY[i] = (eegCanvas.height / (eegLines + 1)) * (i + 1);
                    }
                }
            }

            // 主動畫循環
            function animateGraphs() {
                drawEcgWave();
                drawEegWave();
                requestAnimationFrame(animateGraphs); // 請求下一幀
            }

            // --- 5. 啟動 ---
            
            resizeCanvases(); // 設置初始畫布大小
            animateGraphs();  // 開始繪製動畫

            // 設置初始選中狀態
            document.getElementById(currentSelectedRoom).classList.add('selected');
            updateDetails(currentSelectedRoom);
            updateHumanTwin(currentSelectedRoom);
        });
    </script>
</body>
</html>
