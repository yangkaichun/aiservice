<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="YangHealth">
    <meta name="theme-color" content="#ffffff">

    <link rel="apple-touch-icon" href="image/yanghealth.png">
    <link rel="icon" type="image/x-icon" href="image/yanghealth.ico">

    <title>YangHome Health | Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="config.js"></script>
    <script src="did.js"></script>

    <script>
        const savedSession = localStorage.getItem('healthTwinSession');
        let loggedInSession = null;
        if (!savedSession) {
            window.location.href = 'index.html';
        } else {
            loggedInSession = JSON.parse(savedSession);
        }
    </script>

    <style>
        /* 極簡白底風格 */
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1e293b; }
        
        .clean-card { 
            background: #ffffff; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); 
            border-radius: 1rem;
        }
        
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        
        .btn-gemini { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; }
        .btn-gemini:hover { background: linear-gradient(135deg, #4f46e5, #7c3aed); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25); }
        
        .prose h1, .prose h2, .prose h3 { color: #1e293b; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        
        .filter-btn { @apply px-3 py-1.5 text-xs font-medium rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 transition; }
        .filter-btn.active { @apply bg-indigo-600 text-white border-indigo-600; }
        
        #loadingState { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; }
        
        /* 影片播放容器 */
        video {
            display: block; width: 100%; height: auto; border-radius: 0.5rem;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden relative">

    <div id="avatarModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col justify-center items-center p-4 backdrop-blur-sm animate-fade-in" onclick="closeAvatarModal()">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-white">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i data-lucide="video" class="w-5 h-5 text-indigo-600"></i> AI Avatar (HeyGen)
                </h3>
                <button onclick="closeAvatarModal()" class="p-1 hover:bg-slate-100 rounded-full transition"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
            </div>
            
            <div class="p-6 bg-slate-900 flex justify-center items-center min-h-[320px]">
                
                <div id="avatarLoading" class="flex flex-col items-center justify-center text-white text-center">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 border-4 border-indigo-500/30 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <p class="text-base font-bold tracking-wide">AI 影片生成中...</p>
                    <p class="text-xs text-slate-400 mt-2">這可能需要 30~60 秒，請稍候</p>
                </div>
                
                <video id="avatarVideo" controls playsinline class="hidden shadow-lg"></video>
            </div>
        </div>
    </div>

    <div id="ios-install-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex-col items-center justify-end pb-10 animate-fade-in" onclick="closeIosModal()">
        <div class="bg-white w-[90%] max-w-md rounded-3xl p-6 relative shadow-2xl" onclick="event.stopPropagation()">
            <button onclick="closeIosModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="text-center">
                <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-indigo-100">
                    <img src="image/yanghealth.png" class="w-10 h-10 object-contain">
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">安裝應用程式</h3>
                <p class="text-sm text-slate-500 mb-6">為獲得最佳體驗，請將此網頁加入主畫面：</p>
                <div class="space-y-3 text-left text-sm text-slate-600 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-white border border-slate-200 flex items-center justify-center font-bold text-xs text-indigo-600 shadow-sm">1</span>
                        <span>點擊瀏覽器下方工具列的 <strong>分享</strong> <i data-lucide="share" class="w-4 h-4 inline align-text-bottom"></i></span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-white border border-slate-200 flex items-center justify-center font-bold text-xs text-indigo-600 shadow-sm">2</span>
                        <span>往下滑，選擇 <strong>加入主畫面</strong> <i data-lucide="plus-square" class="w-4 h-4 inline align-text-bottom"></i></span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-white border border-slate-200 flex items-center justify-center font-bold text-xs text-indigo-600 shadow-sm">3</span>
                        <span>點擊右上角的 <strong>加入</strong> 即可</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="aiAnalysisModal" class="fixed inset-0 bg-black/60 z-50 hidden flex-col justify-center items-center p-4 backdrop-blur-sm" onclick="closeAiModal()">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden relative" onclick="event.stopPropagation()">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-white">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-white rounded-lg shadow-sm text-indigo-600"><i data-lucide="sparkles" class="w-6 h-6"></i></div>
                    <div><h3 class="font-bold text-lg text-slate-800">Gemini 2.0 Flash 分析</h3><p class="text-xs text-slate-500">AI 智慧評估 (Experimental)</p></div>
                </div>
                <button onclick="closeAiModal()" class="p-2 hover:bg-slate-100 rounded-full transition text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="aiModalContent" class="p-6 overflow-y-auto text-slate-600 text-sm leading-relaxed scroll-smooth"></div>
            
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex flex-wrap gap-2 items-center justify-between">
                <div class="flex gap-2">
                    <button id="btn-tts" onclick="toggleSpeech()" class="hidden px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg font-bold text-sm transition flex items-center gap-2 border border-indigo-100 group">
                        <i data-lucide="volume-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i><span id="btn-tts-text">語音播放</span>
                    </button>
                    
                    <button id="btn-avatar" onclick="playAvatar()" class="hidden px-4 py-2 text-rose-600 hover:bg-rose-50 rounded-lg font-bold text-sm transition flex items-center gap-2 border border-rose-100 group">
                        <i data-lucide="video" class="w-5 h-5 group-hover:scale-110 transition-transform"></i><span>Avatar 輸出</span>
                    </button>
                </div>
                
                <button onclick="closeAiModal()" class="px-5 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium transition shadow-sm ml-auto">關閉</button>
            </div>
        </div>
    </div>

    <div id="mobileOverlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-slate-200 flex flex-col z-30 shadow-2xl lg:shadow-none transform -translate-x-full lg:translate-x-0 sidebar-transition lg:relative">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <div><div class="flex items-center gap-2 text-indigo-600 font-bold text-xl"><i data-lucide="activity" class="w-6 h-6"></i>YangHome Health</div><p class="text-xs text-slate-400 mt-1">智慧醫療監測系統</p></div>
            <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        
        <div class="p-4 pb-2">
            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 shadow-sm">
                <div id="avatar-container" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center overflow-hidden shrink-0">
                    <span id="sidebar-user-text" class="text-indigo-600 font-bold">U</span>
                </div>
                <div class="flex-1 overflow-hidden">
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Currently Logged In</p>
                    <p id="sidebar-user-name" class="text-sm font-bold text-slate-700 truncate">Guest</p>
                </div>
            </div>
        </div>

        <div class="p-4 flex-1 overflow-hidden flex flex-col">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-2 flex justify-between items-center">選擇用戶<span id="userCount" class="bg-slate-100 text-slate-500 py-0.5 px-2 rounded-full text-[10px]">0</span></h3>
            <div id="userList" class="space-y-1 overflow-y-auto flex-1 pr-1">
                <div class="p-4 text-center text-slate-400 text-sm animate-pulse"><i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i>正在載入使用者...</div>
            </div>
        </div>

        <div class="mt-auto p-4 border-t border-slate-100 bg-slate-50">
            <button onclick="installPWA()" id="btn-install-sidebar" class="w-full py-2.5 px-4 bg-sky-500 hover:bg-sky-600 text-white rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 mb-2 shadow-sm hidden">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span id="sidebar-install-text">安裝 App</span>
            </button>

            <button onclick="getAIAnalysis()" class="w-full py-3 px-4 btn-gemini rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 mb-3 shadow-md group"><i data-lucide="sparkles" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>AI 分析 (Gemini)</button>
            <a href="accountsetting.html" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:bg-slate-100 text-slate-500 hover:text-slate-800 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-2 shadow-sm"><i data-lucide="link" class="w-4 h-4"></i> 帳號綁定</a>
            <a href="setting.html" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:bg-slate-100 text-slate-500 hover:text-slate-800 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-2 shadow-sm group"><i data-lucide="settings-2" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-500"></i> 管理者後台</a>
            <a href="phd.html" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-2 shadow-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i> 新增數據</a>
            <button onclick="logout()" class="w-full py-2.5 px-4 bg-white text-rose-500 border border-slate-200 hover:bg-rose-50 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-3 shadow-sm"><i data-lucide="log-out" class="w-4 h-4"></i> 登出系統</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full">
        <header class="h-16 bg-white/90 backdrop-blur-md border-b border-slate-200 flex justify-between items-center px-4 lg:px-8 sticky top-0 z-10 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <div class="overflow-hidden">
                    <h1 id="currentUserName" class="text-lg lg:text-xl font-bold text-slate-800 truncate">概況總覽</h1>
                    <p id="defaultSubtitle" class="text-xs text-slate-400 mt-0.5 hidden sm:block">即時生理數據分析</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-1.5 mr-2">
                    <div class="group relative flex items-center" title="Google 帳號狀態">
                        <i data-lucide="globe" id="icon-google" class="w-5 h-5 text-slate-300"></i>
                    </div>
                    <div class="group relative flex items-center" title="LINE 帳號狀態">
                        <i data-lucide="message-circle" id="icon-line" class="w-5 h-5 text-slate-300"></i>
                    </div>
                </div>
                <button onclick="refreshCurrentUserData()" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition" title="刷新"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth">
            <div id="dashboardContent" class="max-w-7xl mx-auto hidden pb-32">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                    <div class="clean-card p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-rose-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-rose-500 mb-2"><i data-lucide="heart" class="w-5 h-5"></i><span class="font-semibold text-sm">收縮壓</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-sbp" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">mmHg</span></div>
                            <div id="status-sbp" class="mt-2 text-xs font-medium text-slate-500">分析中...</div>
                        </div>
                    </div>
                    <div class="clean-card p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-blue-500 mb-2"><i data-lucide="activity" class="w-5 h-5"></i><span class="font-semibold text-sm">舒張壓</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-dbp" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">mmHg</span></div>
                            <div id="status-dbp" class="mt-2 text-xs font-medium text-slate-500">分析中...</div>
                        </div>
                    </div>
                    <div class="clean-card p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-emerald-500 mb-2"><i data-lucide="zap" class="w-5 h-5"></i><span class="font-semibold text-sm">心率</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-pulse" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">BPM</span></div>
                            <div class="mt-2 text-xs font-medium text-slate-500">最新測量</div>
                        </div>
                    </div>
                    <div class="clean-card p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-amber-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-amber-500 mb-2"><i data-lucide="droplet" class="w-5 h-5"></i><span class="font-semibold text-sm">血糖 (Glucose)</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-glucose" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">mg/dL</span></div>
                            <div id="status-glucose" class="mt-2 text-xs font-medium text-slate-500">最新測量</div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-2 mb-4 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                    <button onclick="setFilter('30days')" id="btn-30days" class="filter-btn active">近 30 天</button>
                    <button onclick="setFilter('6months')" id="btn-6months" class="filter-btn">近半年</button>
                    <button onclick="setFilter('1year')" id="btn-1year" class="filter-btn">近一年</button>
                    <div class="flex items-center gap-2 border-l border-slate-200 pl-3 ml-1">
                        <input type="date" id="filter-start" class="text-xs border border-slate-200 rounded px-2 py-1 focus:ring-1 focus:ring-indigo-500 outline-none">
                        <span class="text-slate-400 text-xs">-</span>
                        <input type="date" id="filter-end" class="text-xs border border-slate-200 rounded px-2 py-1 focus:ring-1 focus:ring-indigo-500 outline-none">
                        <button onclick="setFilter('custom')" id="btn-custom" class="p-1.5 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition"><i data-lucide="search" class="w-3 h-3"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="clean-card p-5 flex flex-col h-[400px]">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-indigo-500"></i> 血壓趨勢圖</h3>
                            </div>
                            <div class="flex-1 relative w-full h-full min-h-0"><canvas id="mainChart"></canvas></div>
                        </div>
                        <div class="clean-card p-5 flex flex-col h-[350px]">
                            <div class="mb-4">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4 text-amber-500"></i> 血糖趨勢圖</h3>
                            </div>
                            <div class="flex-1 relative w-full h-full min-h-0"><canvas id="glucoseChart"></canvas></div>
                        </div>
                    </div>

                    <div class="clean-card p-5 overflow-hidden flex flex-col h-[775px]">
                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">歷史紀錄</h3>
                            <button onclick="downloadCSV()" class="p-1.5 text-xs text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded transition flex items-center gap-1" title="匯出 CSV">
                                <i data-lucide="download" class="w-4 h-4"></i> 下載
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto pr-1">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-400 uppercase border-b border-slate-100 sticky top-0 bg-white/95 backdrop-blur z-10">
                                    <tr><th class="py-2 pl-2">時間</th><th class="py-2 text-right">血壓/心跳</th><th class="py-2 text-right pr-2">血糖</th></tr>
                                </thead>
                                <tbody id="historyTable" class="text-slate-600 divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="loadingState">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <p class="mt-3 text-indigo-600 font-bold text-sm tracking-wider">載入中...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = config.API_URL;
        
        let allUserData = []; 
        let filteredData = []; 
        let currentFilter = '30days';
        let bpChartInstance = null; 
        let glucoseChartInstance = null; 
        let currentSelectedUid = null;
        let currentUserInfo = null; 
        
        let currentAudio = null;
        let isSpeaking = false;

        let deferredPrompt;
        const btnInstall = document.getElementById('btn-install-sidebar');

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // PWA 安裝邏輯
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                initInstallButton();
            });

            initInstallButton();
            initDashboard();
        });

        function initInstallButton() {
            const btn = document.getElementById('btn-install-sidebar');
            if (!btn) return;

            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            if (isStandalone) {
                btn.classList.add('hidden');
                return;
            }

            const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
            const btnText = document.getElementById('sidebar-install-text');
            const icon = btn.querySelector('i');

            if (isIos) {
                if(btnText) btnText.innerText = "安裝 App (iOS)";
                if(icon) icon.setAttribute('data-lucide', 'share');
                btn.onclick = () => {
                    document.getElementById('ios-install-modal').classList.remove('hidden');
                    document.getElementById('ios-install-modal').classList.add('flex');
                };
            } else {
                if(btnText) btnText.innerText = "安裝 App";
                if(icon) icon.setAttribute('data-lucide', 'download');
                btn.onclick = installPWA;
            }
            
            btn.classList.remove('hidden');
            lucide.createIcons();
        }

        const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => { deferredPrompt = null; });
            } else if (isIos) {
                document.getElementById('ios-install-modal').classList.remove('hidden');
                document.getElementById('ios-install-modal').classList.add('flex');
            } else {
                alert("請使用瀏覽器選單中的「安裝應用程式」或「加入主畫面」。");
            }
        }

        function closeIosModal() {
            document.getElementById('ios-install-modal').classList.add('hidden');
            document.getElementById('ios-install-modal').classList.remove('flex');
        }

        // ------------------------------------------
        // [新增] Avatar 播放 (串接 did.js / HeyGen)
        // ------------------------------------------
        async function playAvatar() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            isSpeaking = false; 
            updateTTSButton(false);

            const contentEl = document.getElementById('aiModalContent');
            const contentText = contentEl.innerText || contentEl.textContent;
            
            if (!contentText) {
                alert("沒有分析內容可供朗讀");
                return;
            }

            const modal = document.getElementById('avatarModal');
            const loading = document.getElementById('avatarLoading');
            const video = document.getElementById('avatarVideo');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            video.classList.add('hidden');
            video.pause();
            video.src = "";

            try {
                // 自動組合成絕對路徑
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                const avatarImageUrl = baseUrl + 'image/avatar.png';
                
                // 呼叫 did.js 中的函式
                const videoUrl = await generateAndPollVideo(contentText, avatarImageUrl);
                
                loading.classList.add('hidden');
                loading.classList.remove('flex');
                
                video.src = videoUrl;
                video.classList.remove('hidden');
                video.play();

            } catch (err) {
                console.error("Avatar Gen Error:", err);
                alert("Avatar 生成失敗: " + err.message);
                closeAvatarModal();
            }
        }

        function closeAvatarModal() {
            const modal = document.getElementById('avatarModal');
            const video = document.getElementById('avatarVideo');
            video.pause();
            video.src = "";
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        // ------------------------------------------

        function updateSidebarDisplayName(name, pictureUrl) {
            document.getElementById('sidebar-user-name').innerText = name || "Guest";
            const avatarContainer = document.getElementById('avatar-container');
            
            if (pictureUrl) {
                avatarContainer.innerHTML = `<img src="${pictureUrl}" class="w-full h-full object-cover" alt="Avatar">`;
            } else {
                avatarContainer.innerHTML = `<span id="sidebar-user-text" class="text-indigo-600 font-bold">${(name || "G").charAt(0).toUpperCase()}</span>`;
            }
        }

        function logout() { 
            if(confirm("確定要登出系統嗎？")) { 
                localStorage.removeItem('healthTwinSession'); 
                window.location.href = 'index.html'; 
            } 
        }

        function toggleSidebar() { 
            const sidebar = document.getElementById('sidebar'); 
            const overlay = document.getElementById('mobileOverlay'); 
            if (sidebar.classList.contains('-translate-x-full')) { 
                sidebar.classList.remove('-translate-x-full'); 
                overlay.classList.remove('hidden'); 
            } else { 
                sidebar.classList.add('-translate-x-full'); 
                overlay.classList.add('hidden'); 
            } 
        }

        async function initDashboard() {
            try {
                const response = await fetch(`${API_URL}?action=getSettings&t=${new Date().getTime()}`);
                const users = await response.json();
                
                const activeUsers = users.filter(u => u.status === 'active');
                renderUserList(activeUsers);
                
                if (loggedInSession) {
                    const me = activeUsers.find(u => u.uid === loggedInSession.uid);
                    if (me) {
                        updateSidebarDisplayName(me.name, loggedInSession.picture);
                        await selectUser(me.uid, me.name, me);
                    } else {
                        const sessionName = loggedInSession.name || loggedInSession.email;
                        updateSidebarDisplayName(sessionName, loggedInSession.picture);
                        await selectUser(loggedInSession.uid, sessionName, loggedInSession);
                    }
                } else if (activeUsers.length > 0) {
                    await selectUser(activeUsers[0].uid, activeUsers[0].name);
                }

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('dashboardContent').classList.add('animate-fade-in');

            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('userList').innerHTML = '<div class="p-4 text-center text-rose-500 text-sm">載入使用者失敗</div>';
            }
        }

        function renderUserList(users) {
            const listContainer = document.getElementById('userList'); 
            document.getElementById('userCount').innerText = users.length; 
            listContainer.innerHTML = ''; 
            
            if (users.length === 0) { 
                listContainer.innerHTML = '<div class="p-4 text-center text-sm text-slate-400">無可用使用者</div>'; 
                return; 
            } 

            users.forEach(user => { 
                const div = document.createElement('div'); 
                const avatarText = user.name ? user.name.charAt(0).toUpperCase() : '?'; 
                div.id = `user-item-${user.uid}`; 
                div.className = `p-3 rounded-xl cursor-pointer hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center gap-3 text-slate-600 font-medium group user-item border border-transparent`; 
                div.innerHTML = `<div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold shrink-0">${avatarText}</div><span class="truncate">${user.name || user.email || user.uid}</span>`; 
                div.onclick = () => { selectUser(user.uid, user.name || user.email, user); if (window.innerWidth < 1024) toggleSidebar(); }; 
                listContainer.appendChild(div); 
            }); 
        }

        async function selectUser(uid, name, userObj = null) {
            currentSelectedUid = uid;
            currentUserInfo = userObj;
            updateBindingIcons(userObj);

            document.querySelectorAll('.user-item').forEach(el => { el.classList.remove('bg-indigo-50', 'text-indigo-600', 'shadow-sm', 'border-indigo-100'); el.classList.add('border-transparent'); }); 
            const element = document.getElementById(`user-item-${uid}`); 
            if (element) { element.classList.add('bg-indigo-50', 'text-indigo-600', 'shadow-sm', 'border-indigo-100'); element.classList.remove('border-transparent'); } 
            
            document.getElementById('currentUserName').innerText = name;
            await fetchUserData(uid);
        }

        function updateBindingIcons(user) {
            const googleIcon = document.getElementById('icon-google');
            const lineIcon = document.getElementById('icon-line');
            googleIcon.classList.remove('text-indigo-600'); googleIcon.classList.add('text-slate-300');
            lineIcon.classList.remove('text-[#06C755]'); lineIcon.classList.add('text-slate-300');
            if (user && user.provider) {
                const providers = user.provider.toLowerCase();
                if (providers.includes('google')) { googleIcon.classList.remove('text-slate-300'); googleIcon.classList.add('text-indigo-600'); }
                if (providers.includes('line')) { lineIcon.classList.remove('text-slate-300'); lineIcon.classList.add('text-[#06C755]'); }
            }
        }

        async function fetchUserData(uid) {
            document.getElementById('loadingState').classList.remove('hidden'); 
            document.getElementById('dashboardContent').classList.add('hidden');
            
            try {
                const response = await fetch(`${API_URL}?action=getData&uid=${encodeURIComponent(uid)}&t=${new Date().getTime()}`);
                const rawData = await response.json();
                
                allUserData = rawData.map(item => {
                    const sbp = item.sbp ? parseInt(item.sbp) : null;
                    const dbp = item.dbp ? parseInt(item.dbp) : null;
                    const pulse = item.hr ? parseInt(item.hr) : null;
                    const glucose = item.glucose ? parseInt(item.glucose) : null;
                    return { timestamp: item.date, sbp: sbp, dbp: dbp, pulse: pulse, glucose: glucose, context: item.context, note: item.note };
                });

                setFilter('30days');
                
                document.getElementById('loadingState').classList.add('hidden'); 
                document.getElementById('dashboardContent').classList.remove('hidden'); 
                document.getElementById('dashboardContent').classList.add('animate-fade-in'); 
                
            } catch (error) {
                console.error(error);
                alert("讀取資料失敗");
                document.getElementById('loadingState').classList.add('hidden'); 
            }
        }

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (type !== 'custom') document.getElementById(`btn-${type}`).classList.add('active');
            if (type === 'custom') document.getElementById('btn-custom').classList.add('bg-indigo-100');

            const now = new Date();
            let startDate = new Date();
            if (type === '30days') startDate.setDate(now.getDate() - 30);
            else if (type === '6months') startDate.setMonth(now.getMonth() - 6);
            else if (type === '1year') startDate.setFullYear(now.getFullYear() - 1);
            else if (type === 'custom') {
                const s = document.getElementById('filter-start').value;
                const e = document.getElementById('filter-end').value;
                if (!s || !e) { alert("請選擇開始與結束日期"); return; }
                startDate = new Date(s);
                now.setTime(new Date(e).getTime() + 86399000);
            }

            filteredData = allUserData.filter(d => {
                const dDate = new Date(d.timestamp);
                return dDate >= startDate && dDate <= now;
            });
            filteredData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            updateDashboardUI(filteredData);
        }
        
        function refreshCurrentUserData() {
            if (currentSelectedUid) fetchUserData(currentSelectedUid);
        }

        function updateDashboardUI(data) { 
            if (!data || data.length === 0) { 
                document.getElementById('val-sbp').innerText = '--'; 
                document.getElementById('val-dbp').innerText = '--'; 
                document.getElementById('val-glucose').innerText = '--'; 
                renderCharts([]); 
                document.getElementById('historyTable').innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400">該時段無資料</td></tr>';
                return; 
            } 
            const latestBP = [...data].reverse().find(d => d.sbp != null);
            const latestGlu = [...data].reverse().find(d => d.glucose != null);

            if (latestBP) {
                document.getElementById('val-sbp').innerText = latestBP.sbp;
                document.getElementById('val-dbp').innerText = latestBP.dbp;
                document.getElementById('val-pulse').innerText = latestBP.pulse || '--';
            } else {
                document.getElementById('val-sbp').innerText = '--';
                document.getElementById('val-dbp').innerText = '--';
            }
            if (latestGlu) document.getElementById('val-glucose').innerText = latestGlu.glucose;
            else document.getElementById('val-glucose').innerText = '--';

            const historyBody = document.getElementById('historyTable'); 
            const displayList = [...data].reverse(); 
            historyBody.innerHTML = displayList.map(d => { 
                const dateObj = new Date(d.timestamp); 
                const timeStr = `${dateObj.getFullYear()}/${(dateObj.getMonth()+1).toString().padStart(2,'0')}/${dateObj.getDate().toString().padStart(2,'0')} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`; 
                
                let bpDisplay = (d.sbp) ? `<span class="text-rose-600">${d.sbp}</span>/<span class="text-blue-600">${d.dbp}</span> <span class="text-xs text-slate-400">(${d.pulse})</span>` : '-';
                let gluDisplay = (d.glucose) ? `<span class="text-amber-600 font-bold">${d.glucose}</span>` : '-';
                return `<tr class="hover:bg-slate-50 transition"><td class="py-3 pl-2 text-slate-500 font-mono text-xs">${timeStr}</td><td class="py-3 text-right font-medium text-sm">${bpDisplay}</td><td class="py-3 pr-2 text-right font-medium text-sm">${gluDisplay}</td></tr>`; 
            }).join(''); 
            renderCharts(data); 
        }

        function renderCharts(data) { 
            const labels = data.map(d => { 
                const date = new Date(d.timestamp); 
                const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                return `${date.getMonth()+1}/${date.getDate()} ${timeStr}`; 
            }); 
            
            const sbpData = data.map(d => d.sbp); 
            const dbpData = data.map(d => d.dbp); 
            const glucoseData = data.map(d => d.glucose); 

            const ctxBP = document.getElementById('mainChart').getContext('2d'); 
            if (bpChartInstance) bpChartInstance.destroy(); 
            bpChartInstance = new Chart(ctxBP, { 
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [
                        { label: '收縮壓', data: sbpData, borderColor: '#F43F5E', backgroundColor: 'rgba(244, 63, 94, 0.1)', borderWidth: 2, tension: 0.3, fill: true, spanGaps: true }, 
                        { label: '舒張壓', data: dbpData, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.3, fill: true, spanGaps: true }
                    ] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { position: 'top', align: 'end' } }, 
                    scales: { y: { suggestedMin: 60, suggestedMax: 160 } } 
                } 
            }); 

            const ctxGlu = document.getElementById('glucoseChart').getContext('2d'); 
            if (glucoseChartInstance) glucoseChartInstance.destroy(); 
            glucoseChartInstance = new Chart(ctxGlu, { 
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [{ label: '血糖', data: glucoseData, borderColor: '#F59E0B', backgroundColor: 'rgba(245, 158, 11, 0.1)', borderWidth: 2, tension: 0.3, fill: true, spanGaps: true }] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { suggestedMin: 70, suggestedMax: 180 } } 
                } 
            }); 
        }

        function downloadCSV() {
            if (!filteredData || filteredData.length === 0) { alert("目前篩選範圍內沒有資料可下載"); return; }
            let csvContent = "\uFEFF時間,收縮壓,舒張壓,心率,血糖,情境,備註\n";
            [...filteredData].reverse().forEach(row => {
                const d = new Date(row.timestamp);
                const timeStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                csvContent += `${timeStr},${row.sbp||''},${row.dbp||''},${row.pulse||''},${row.glucose||''},${row.context||''},${row.note||''}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const userName = document.getElementById('currentUserName').innerText;
            link.setAttribute("href", url);
            link.setAttribute("download", `${userName}_健康紀錄_${currentFilter}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function getAIAnalysis() { 
            if (!currentSelectedUid) { alert("請先選擇一位用戶"); return; } 
            const modal = document.getElementById('aiAnalysisModal'); 
            const content = document.getElementById('aiModalContent'); 
            const btnTTS = document.getElementById('btn-tts');
            const btnAvatar = document.getElementById('btn-avatar');
            
            modal.classList.remove('hidden'); modal.classList.add('flex'); 
            content.innerHTML = `<div class="flex flex-col items-center justify-center py-12"><div class="tech-loader"><div class="tech-ring"></div><div class="tech-ring"></div><i data-lucide="sparkles" class="tech-heart w-8 h-8"></i></div><p class="text-slate-500 mt-4 font-bold tracking-wider">AI ANALYZING...</p></div>`; 
            btnTTS.classList.add('hidden'); 
            btnAvatar.classList.add('hidden'); // 先隱藏

            try { 
                const response = await fetch(`${API_URL}?action=askAI&uid=${currentSelectedUid}`); 
                const data = await response.json(); 
                if (data.result) { 
                    content.innerHTML = `<div class="prose prose-sm text-slate-700">${marked.parse(data.result)}</div>`; 
                    btnTTS.classList.remove('hidden'); 
                    btnAvatar.classList.remove('hidden'); // 分析成功後顯示
                } else { throw new Error("AI 無回應"); } 
            } catch (err) { 
                content.innerHTML = `<div class="text-center py-8 text-rose-500">分析失敗: ${err.message}</div>`; 
            } 
        }

        async function toggleSpeech() {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                isSpeaking = false;
                updateTTSButton(false);
                return;
            }
            const contentEl = document.getElementById('aiModalContent');
            const contentText = contentEl.innerText || contentEl.textContent;
            if (!contentText) return;
            updateTTSButton(true, true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getTTS', text: contentText, uid: currentSelectedUid || 'unknown' })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                if (data.audioContent) {
                    const audioSrc = "data:audio/mp3;base64," + data.audioContent;
                    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
                    currentAudio = new Audio(audioSrc);
                    currentAudio.onended = () => { isSpeaking = false; updateTTSButton(false); };
                    currentAudio.play();
                    isSpeaking = true;
                    updateTTSButton(true, false);
                }
            } catch (error) {
                console.error("TTS Error:", error);
                alert("語音生成失敗: " + error.message);
                isSpeaking = false;
                updateTTSButton(false);
            }
        }

        function updateTTSButton(playing, isLoading = false) {
            const btn = document.getElementById('btn-tts');
            const btnText = document.getElementById('btn-tts-text');
            const existingIcon = btn.querySelector('svg') || btn.querySelector('i');
            if (existingIcon) existingIcon.remove();
            const newIcon = document.createElement('i');
            newIcon.classList.add('w-5', 'h-5', 'group-hover:scale-110', 'transition-transform');
            
            if (isLoading) {
                btnText.innerText = "生成語音中...";
                newIcon.setAttribute('data-lucide', 'loader-2');
                newIcon.classList.add('animate-spin');
                btn.classList.remove('bg-rose-50', 'text-rose-600', 'border-rose-100');
                btn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-100');
            } else if (playing) {
                btnText.innerText = "停止朗讀";
                newIcon.setAttribute('data-lucide', 'square'); 
                btn.classList.remove('hover:bg-indigo-50', 'text-indigo-600', 'border-indigo-100', 'bg-indigo-50');
                btn.classList.add('bg-rose-50', 'text-rose-600', 'border-rose-100');
            } else {
                btnText.innerText = "語音播放";
                newIcon.setAttribute('data-lucide', 'volume-2'); 
                btn.classList.remove('bg-rose-50', 'text-rose-600', 'border-rose-100', 'bg-indigo-50');
                btn.classList.add('hover:bg-indigo-50', 'text-indigo-600', 'border-indigo-100');
            }
            btn.insertBefore(newIcon, btnText);
            lucide.createIcons();
        }

        function closeAiModal() { 
            if (currentAudio && !currentAudio.paused) { currentAudio.pause(); currentAudio = null; }
            isSpeaking = false; 
            updateTTSButton(false);
            closeAvatarModal(); 
            document.getElementById('aiAnalysisModal').classList.add('hidden'); 
            document.getElementById('aiAnalysisModal').classList.remove('flex'); 
        }
    </script>
</body>
</html>
}