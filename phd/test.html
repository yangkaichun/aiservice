<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>API è¨ºæ–·å·¥å…·</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f0f0; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #1d4ed8; }
        #status { font-weight: bold; margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #2d2d2d; color: #76e068; padding: 15px; overflow-x: auto; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ” API è³‡æ–™è®€å–è¨ºæ–·</h2>
        <p>æ¸¬è©¦ç›®æ¨™ï¼šè®€å– <strong>kaichun.yang@gmail.com</strong> çš„å¥åº·æ•¸æ“š</p>
        <button onclick="runTest()">é–‹å§‹æ¸¬è©¦</button>
        <div id="status">æº–å‚™å°±ç·’...</div>
    </div>

    <div class="card">
        <h2>ğŸ“Š æ¸¬è©¦çµæœ (è§£æå¾Œ)</h2>
        <div id="parsed-result">å°šæœªåŸ·è¡Œ</div>
    </div>

    <div class="card">
        <h2>ğŸ“ åŸå§‹ JSON å›å‚³</h2>
        <pre id="raw-json">ç­‰å¾…è³‡æ–™...</pre>
    </div>

    <script>
        // é€™æ˜¯æ‚¨ä¹‹å‰æä¾›çš„ Script URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbzX0k_hP6poVZAxty89nQ6yJyuhNHw4M713G2IQolRPDQnNLFd_By3xqgfpQRtytOQT4A/exec';
        
        // æŒ‡å®šæ¸¬è©¦çš„ Email
        const TARGET_USER = "kaichun.yang@gmail.com";

        async function runTest() {
            const statusDiv = document.getElementById('status');
            const rawPre = document.getElementById('raw-json');
            const parsedDiv = document.getElementById('parsed-result');

            statusDiv.innerText = "â³ æ­£åœ¨è«‹æ±‚è³‡æ–™...";
            statusDiv.className = "";
            rawPre.innerText = "Loading...";
            parsedDiv.innerHTML = "";

            try {
                // å¼·åˆ¶åŠ å…¥æ™‚é–“æˆ³è¨˜é¿é–‹å¿«å–
                const url = `${API_URL}?action=getDataByUser&user=${encodeURIComponent(TARGET_USER)}&t=${new Date().getTime()}`;
                console.log("Fetching:", url);

                const response = await fetch(url);
                const text = await response.text(); // å…ˆè®€æˆæ–‡å­—ï¼Œé¿å… JSON è§£æå¤±æ•—çœ‹ä¸åˆ°éŒ¯èª¤
                
                console.log("Raw Response:", text);

                try {
                    const json = JSON.parse(text);
                    rawPre.innerText = JSON.stringify(json, null, 2); // ç¾åŒ–è¼¸å‡º

                    if (Array.isArray(json) && json.length > 0) {
                        statusDiv.innerText = `âœ… æ¸¬è©¦æˆåŠŸï¼è®€å–åˆ° ${json.length} ç­†è³‡æ–™`;
                        statusDiv.className = "success";
                        
                        // ç°¡å–®åˆ—è¡¨é¡¯ç¤º
                        let html = "<ul style='list-style:none; padding:0;'>";
                        json.forEach((row, i) => {
                            // é¡¯ç¤ºé—œéµæ¬„ä½
                            html += `<li style="padding:5px; border-bottom:1px solid #eee;">
                                <strong>#${i+1}</strong> 
                                æ™‚é–“: ${row.timestamp} | 
                                å§“å: ${row.name} | 
                                æ”¶ç¸®å£“: ${row.sbp}
                            </li>`;
                        });
                        html += "</ul>";
                        parsedDiv.innerHTML = html;

                    } else {
                        statusDiv.innerText = "âš ï¸ è«‹æ±‚æˆåŠŸä½†å›å‚³ç©ºè³‡æ–™ (é•·åº¦ç‚º 0)";
                        statusDiv.className = "error";
                        parsedDiv.innerHTML = "<p>å¯èƒ½åŸå› ï¼š</p><ul><li>å¾Œç«¯æ²’æœ‰æ‰¾åˆ°è©² Email å°æ‡‰çš„ UID</li><li>Data è¡¨ä¸­çš„ UID èˆ‡ Users è¡¨ä¸åŒ¹é…</li><li>æ¬Šé™ä¸è¶³</li></ul>";
                    }

                } catch (e) {
                    rawPre.innerText = text; // é¡¯ç¤ºåŸå§‹æ–‡å­—
                    statusDiv.innerText = "âŒ JSON è§£æå¤±æ•— (å¯èƒ½å›å‚³äº† HTML éŒ¯èª¤é é¢)";
                    statusDiv.className = "error";
                }

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "âŒ é€£ç·šå¤±æ•—: " + error.message;
                statusDiv.className = "error";
            }
        }
    </script>
</body>
</html>