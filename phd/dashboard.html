// ==========================================
// 1. doGet: 專門負責「讀取」資料給 Dashboard
// ==========================================
function doGet(e) {
  try {
    // 取得目前活動的試算表，建議指定工作表名稱，例如 "Data"
    // 如果您的工作表名稱不是 "Data"，請修改下面這一行
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Data");
    
    // 如果找不到 "Data" 工作表，嘗試抓取第一個工作表 (防呆)
    if (!sheet) {
      sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
    }

    var data = sheet.getDataRange().getValues();

    // 如果完全沒資料，回傳空陣列
    if (data.length === 0) {
      return ContentService.createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // 移除標題列 (第一列)
    var headers = data.shift();
    
    // 將陣列轉換為 JSON 物件陣列 (對應 Dashboard 的欄位)
    // 注意：這裡的索引 [0], [1]... 必須對應您 Excel 的實際欄位順序
    var result = data.map(function(row) {
      return {
        timestamp: row[0], // A欄: 時間
        name: row[1],      // B欄: Email/姓名 (用來切換用戶)
        context: row[2] // C欄: 時機 (Dashboard 暫時沒用到，可不傳)
        sbp: row[3],       // D欄: 收縮壓
        dbp: row[4],       // E欄: 舒張壓
        pulse: row[5],      // F欄: 心率
        glucose: row[6] // 血糖
      };
    });

    // 回傳 JSON
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // 發生錯誤時回傳錯誤訊息
    return ContentService
      .createTextOutput(JSON.stringify({ error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ==========================================
// 2. doPost: 專門負責「接收」上傳的資料並寫入
// ==========================================
function doPost(e) {
  // 為了讓 GitHub Pages 可以呼叫，我們需要回傳正確的 JSON
  var lock = LockService.getScriptLock();
  lock.tryLock(10000); // 防止多人同時寫入衝突

  try {
    // 解析前端傳來的資料
    var data = JSON.parse(e.postData.contents);
    var idToken = data.token; // 這是前端傳來的 Google JWT Token

    // --- 安全性檢查 (可選) ---
    // 如果前端有傳 token，我們就驗證；如果沒有(測試用)，則跳過
    var userEmail = "測試用戶"; 
    
    if (idToken) {
        var verifyUrl = "https://oauth2.googleapis.com/tokeninfo?id_token=" + idToken;
        var response = UrlFetchApp.fetch(verifyUrl, { muteHttpExceptions: true });
        var identity = JSON.parse(response.getContentText());

        // 如果 Token 無效或過期
        if (identity.error || !identity.email) {
          throw new Error("身份驗證失敗: " + identity.error_description);
        }
        userEmail = identity.email; // 這是真正經過驗證的使用者 Email
    } else if (data.name) {
        // 如果沒有 Token 但有傳 name (例如從簡單表單傳來的)
        userEmail = data.name;
    }
    // -----------------------

    // 寫入 Google Sheets
    // 請確認您的工作表名稱是否為 "Data"
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Data");
    if (!sheet) {
       // 如果沒有叫 Data 的表，就建一個，或是抓第一個
       sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
    }
    
    var timestamp = new Date();
    
    // 這裡的寫入順序，必須跟上面的 doGet 讀取順序一致
    // A:時間, B:姓名, C:時機, D:收縮, E:舒張, F:心跳, G:血糖, H:備註
    sheet.appendRow([
      timestamp,           
      userEmail,           
      data.context || "",        
      data.sbp,            
      data.dbp,            
      data.hr,             
      data.glucose || "",  
      data.note || ""      
    ]);

    // 回傳成功訊息
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "success", 
      message: "數據已儲存",
      email: userEmail 
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // 錯誤處理
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "error", 
      message: error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);

  } finally {
    lock.releaseLock();
  }
}
