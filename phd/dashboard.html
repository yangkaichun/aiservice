<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YangHome Health | Dashboard</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="image/yanghealth.ico">
    <link rel="apple-touch-icon" href="image/yanghealth.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // ----------------------------------------------------
        // è«‹ç¢ºèªæ­¤è™•çš„ API Key æ˜¯å¦æ­£ç¢º (èˆ‡ code.gs ä¿æŒä¸€è‡´)
        // ----------------------------------------------------
        const API_KEY = "AIzaSyDnRyQUyW-0EgB0hSzyPFZu6mT_0L12xSg"; 

        const savedSession = localStorage.getItem('healthTwinSession');
        if (!savedSession) {
            alert("ğŸ”’ è«‹å…ˆç™»å…¥");
            window.location.href = 'index.html';
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Loading Spinner */
        .spinner { border: 3px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Markdown Styles */
        .prose h3 { font-size: 1.1em; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; color: #334155; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose strong { color: #0f172a; font-weight: 600; }
    </style>
</head>
<body class="text-slate-800 pb-20 md:pb-0">

    <header class="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 flex justify-between items-center px-4 sticky top-0 z-20">
        <div class="flex items-center gap-3">
             <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md shadow-indigo-200">
                <i data-lucide="activity" class="w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-lg text-slate-800 tracking-tight">Health<span class="text-indigo-600">Twin</span></h1>
        </div>
        <div class="flex items-center gap-3">
             <button onclick="handleAIAnalysis()" class="p-2 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 transition relative" title="AI åˆ†æ">
                <i data-lucide="sparkles" class="w-5 h-5"></i>
            </button>
            <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200 overflow-hidden">
                <i data-lucide="user" class="w-4 h-4 text-slate-400"></i>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-3xl mx-auto space-y-6">
        
        <div class="glass-card rounded-2xl p-5 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-bold text-slate-800" id="user-greeting">æ—©å®‰, User</h2>
                    <p class="text-slate-500 text-sm mt-1">ä»Šæ—¥å¥åº·æ‘˜è¦å·²æº–å‚™å°±ç·’</p>
                </div>
                <div class="px-3 py-1 bg-green-50 text-green-700 text-xs font-bold rounded-full border border-green-100 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    Online
                </div>
            </div>
        </div>

        <div id="ai-card" class="hidden glass-card rounded-2xl p-5 border-indigo-100 bg-gradient-to-br from-white to-indigo-50/30">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <i data-lucide="bot" class="w-5 h-5 text-indigo-600"></i>
                    <h3 class="font-bold text-slate-800">AI å¥åº·æ´å¯Ÿ</h3>
                </div>
                <button id="btn-play-audio" class="p-2 text-slate-400 hover:text-indigo-600 transition" title="æ’­æ”¾èªéŸ³">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="ai-content" class="prose text-sm text-slate-600 leading-relaxed">
                </div>
            <div id="ai-loading" class="hidden py-4 flex justify-center">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                    <i data-lucide="heart" class="w-12 h-12 text-rose-500"></i>
                </div>
                <p class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">è¡€å£“ (BP)</p>
                <div class="flex items-baseline gap-1">
                    <span class="text-2xl font-bold text-slate-800" id="val-sbp">--</span>
                    <span class="text-sm text-slate-400">/</span>
                    <span class="text-xl font-semibold text-slate-600" id="val-dbp">--</span>
                </div>
                <p class="text-xs text-slate-400 mt-2 flex items-center gap-1">
                    <i data-lucide="clock" class="w-3 h-3"></i> <span id="time-bp">--:--</span>
                </p>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden group">
                 <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                    <i data-lucide="droplet" class="w-12 h-12 text-blue-500"></i>
                </div>
                <p class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">è¡€ç³– (Glucose)</p>
                <div class="flex items-baseline gap-1">
                    <span class="text-2xl font-bold text-slate-800" id="val-glucose">--</span>
                    <span class="text-sm text-slate-500">mg/dL</span>
                </div>
                <p class="text-xs text-slate-400 mt-2 flex items-center gap-1">
                     <span id="tag-context" class="px-1.5 py-0.5 bg-slate-100 rounded text-slate-500 text-[10px]">-</span>
                </p>
            </div>
        </div>

        <div class="glass-card rounded-2xl p-5 shadow-sm">
            <h3 class="font-bold text-slate-800 mb-4 text-sm flex items-center gap-2">
                <i data-lucide="line-chart" class="w-4 h-4 text-slate-400"></i> è¿‘æœŸè¶¨å‹¢
            </h3>
            <div class="chart-container">
                <canvas id="healthChart"></canvas>
            </div>
        </div>

        <div class="glass-card rounded-2xl p-5 shadow-sm">
             <h3 class="font-bold text-slate-800 mb-4 text-sm flex items-center gap-2">
                <i data-lucide="download-cloud" class="w-4 h-4 text-slate-400"></i> è³‡æ–™åŒ¯å‡º (CSV)
            </h3>
            <div class="flex flex-col sm:flex-row gap-3 items-end">
                <div class="w-full">
                    <label class="block text-xs text-slate-500 mb-1">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="dl-start" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div class="w-full">
                    <label class="block text-xs text-slate-500 mb-1">çµæŸæ—¥æœŸ</label>
                    <input type="date" id="dl-end" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <button onclick="downloadCSV()" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition shadow-md whitespace-nowrap">
                    åŒ¯å‡º
                </button>
            </div>
        </div>

        <div class="h-8"></div>
    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 pb-safe md:hidden z-30">
        <div class="flex justify-around items-center h-16">
            <a href="#" class="flex flex-col items-center justify-center w-full h-full text-indigo-600">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[10px] font-medium">é¦–é </span>
            </a>
            <a href="input.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <i data-lucide="plus-circle" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[10px] font-medium">ç´€éŒ„</span>
            </a>
            <a href="phd.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <i data-lucide="settings" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[10px] font-medium">è¨­ç½®</span>
            </a>
        </div>
    </nav>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzX0k_hP6poVZAxty89nQ6yJyuhNHw4M713G2IQolRPDQnNLFd_By3xqgfpQRtytOQT4A/exec';
        let currentUserData = [];
        let session = JSON.parse(savedSession);
        let audioPlayer = null;
        let lastAIResponseText = "";

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initDashboard();
            
            // ç¶å®šæ’­æ”¾æŒ‰éˆ•
            document.getElementById('btn-play-audio').addEventListener('click', () => {
                if (lastAIResponseText) playAudio(lastAIResponseText);
            });
        });

        async function initDashboard() {
            document.getElementById('user-greeting').innerText = `æ—©å®‰, ${session.name || 'User'}`;
            await fetchData();
        }

        async function fetchData() {
            try {
                // è®€å–æ‰€æœ‰è³‡æ–™ (å¾Œç«¯å°šæœªå¯¦ä½œ filter by userï¼Œæ•…å‰ç«¯éæ¿¾)
                const res = await fetch(`${API_URL}?action=getAll`);
                const json = await res.json();
                
                // 1. æ ¹æ“š UID æˆ– Email éæ¿¾
                // æ³¨æ„: Data Sheet å­˜çš„æ˜¯ UIDï¼Œæ‰€ä»¥è¦æ¯”å° session.uid
                const myUid = session.uid; 
                if (!myUid) { console.error("No UID in session"); return; }

                // éæ¿¾å‡ºå±¬æ–¼ç›®å‰ä½¿ç”¨è€…çš„è³‡æ–™
                currentUserData = json.filter(row => String(row.rawId) === String(myUid));
                
                // ä¾æ™‚é–“æ’åº (èˆŠ->æ–°)
                currentUserData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                updateUI(currentUserData);
                renderChart(currentUserData);

            } catch (error) {
                console.error("Fetch Data Error:", error);
            }
        }

        function updateUI(data) {
            if (data.length === 0) return;
            const last = data[data.length - 1]; // æœ€æ–°ä¸€ç­†

            document.getElementById('val-sbp').innerText = last.sbp || '--';
            document.getElementById('val-dbp').innerText = last.dbp || '--';
            document.getElementById('val-glucose').innerText = last.glucose || '--';
            document.getElementById('tag-context').innerText = last.context || 'ä¸€èˆ¬';
            
            if (last.timestamp) {
                const d = new Date(last.timestamp);
                const timeStr = `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                document.getElementById('time-bp').innerText = timeStr;
            }
        }

        let chartInstance = null;
        function renderChart(data) {
            const ctx = document.getElementById('healthChart').getContext('2d');
            
            // å–æœ€è¿‘ 10 ç­†
            const recent = data.slice(-10);
            const labels = recent.map(d => {
                const date = new Date(d.timestamp);
                return `${date.getMonth()+1}/${date.getDate()}`;
            });
            const sbpData = recent.map(d => d.sbp);
            const dbpData = recent.map(d => d.dbp);
            const gluData = recent.map(d => d.glucose); // è¡€ç³–å¯èƒ½ä¸é€£çºŒï¼ŒChart.js æœƒè™•ç† null

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¶ç¸®å£“',
                            data: sbpData,
                            borderColor: '#ec4899', // pink-500
                            backgroundColor: '#ec4899',
                            tension: 0.4,
                            pointRadius: 3
                        },
                        {
                            label: 'èˆ’å¼µå£“',
                            data: dbpData,
                            borderColor: '#6366f1', // indigo-500
                            backgroundColor: '#6366f1',
                            tension: 0.4,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                    },
                    scales: {
                        y: { beginAtZero: false, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // -----------------------------------------------------------
        // AI åˆ†æèˆ‡èªéŸ³ (Gemini + Google TTS)
        // -----------------------------------------------------------
        async function handleAIAnalysis() {
            if (currentUserData.length === 0) { alert("ç„¡æ•¸æ“šå¯åˆ†æ"); return; }
            
            const aiCard = document.getElementById('ai-card');
            const aiContent = document.getElementById('ai-content');
            const aiLoading = document.getElementById('ai-loading');
            
            aiCard.classList.remove('hidden');
            aiContent.innerHTML = '';
            aiLoading.classList.remove('hidden');
            aiLoading.classList.add('flex');

            // æº–å‚™ Prompt
            const recent = currentUserData.slice(-5);
            const promptData = recent.map(r => `[${r.timestamp}] SBP:${r.sbp}, DBP:${r.dbp}, Glu:${r.glucose}, ctx:${r.context}`).join('\n');
            
            const prompt = `ä½ æ˜¯å°ˆæ¥­çš„å¥åº·ç®¡ç†å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹ç”¨æˆ¶æœ€è¿‘çš„ç”Ÿç†æ•¸æ“šï¼Œçµ¦å‡ºç°¡çŸ­çš„(50å­—å…§)å¥åº·åˆ†æèˆ‡å»ºè­°ï¼Œèªæ°£è¦ªåˆ‡ã€‚è‹¥æ•¸å€¼ç•°å¸¸(BP>130/80, Glu>100ç©ºè…¹)è«‹æé†’ã€‚\næ•¸æ“š:\n${promptData}`;

            try {
                // å‘¼å« Gemini API (é€é Generative Language API)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                
                aiLoading.classList.add('hidden');
                aiLoading.classList.remove('flex');

                if (json.candidates && json.candidates.length > 0) {
                    const responseText = json.candidates[0].content.parts[0].text;
                    lastAIResponseText = responseText; // å­˜èµ·ä¾†çµ¦èªéŸ³ç”¨
                    aiContent.innerHTML = marked.parse(responseText);
                    
                    // è‡ªå‹•æ’­æ”¾èªéŸ³
                    playAudio(responseText);
                } else {
                    aiContent.innerText = "AI æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                }

            } catch (e) {
                console.error(e);
                aiLoading.classList.add('hidden');
                aiContent.innerText = "åˆ†æç™¼ç”ŸéŒ¯èª¤ã€‚";
            }
        }

        // -----------------------------------------------------------
        // ä¿®æ­£å¾Œçš„èªéŸ³æ’­æ”¾ (Google Cloud TTS)
        // -----------------------------------------------------------
        async function playAudio(text) {
            if (!text) return;
            if (audioPlayer) { audioPlayer.pause(); audioPlayer = null; }

            // ç§»é™¤ Markdown ç¬¦è™Ÿä»¥å…è®€å‡ºä¾†
            const cleanText = text.replace(/[*#]/g, '');

            try {
                const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${API_KEY}`;
                
                const payload = {
                    input: { text: cleanText },
                    voice: { languageCode: "zh-TW", name: "zh-TW-Neural2-A" }, // è‹¥ç„¡æ¬Šé™å¯æ”¹ç‚º zh-TW-Standard-A
                    audioConfig: { audioEncoding: "MP3" }
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                const json = await response.json();

                if (json.error) {
                    console.error("TTS API Error:", json.error);
                    alert("èªéŸ³åˆæˆå¤±æ•—: " + json.error.message);
                    return;
                }

                if (json.audioContent) {
                    const audioUrl = "data:audio/mp3;base64," + json.audioContent;
                    audioPlayer = new Audio(audioUrl);
                    audioPlayer.play();
                }

            } catch (error) {
                console.error("Play Audio Error:", error);
            }
        }

        function downloadCSV() {
            const startDateVal = document.getElementById('dl-start').value;
            const endDateVal = document.getElementById('dl-end').value;
            
            if (!startDateVal || !endDateVal) { alert("è«‹é¸æ“‡å®Œæ•´çš„é–‹å§‹èˆ‡çµæŸæ—¥æœŸ"); return; }
            
            const startDate = new Date(startDateVal);
            const endDate = new Date(endDateVal);
            endDate.setHours(23, 59, 59);

            const exportData = currentUserData.filter(d => {
                const dDate = new Date(d.timestamp);
                return dDate >= startDate && dDate <= endDate;
            });

            if (exportData.length === 0) { alert("é¸å®šçš„æ—¥æœŸç¯„åœå…§æ²’æœ‰è³‡æ–™"); return; }

            let csvContent = "\uFEFFæ™‚é–“,å§“å,æ”¶ç¸®å£“,èˆ’å¼µå£“,å¿ƒç‡,è¡€ç³–,æƒ…å¢ƒ\n";
            exportData.forEach(row => {
                const d = new Date(row.timestamp);
                const timeStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                csvContent += `${timeStr},${row.name},${row.sbp},${row.dbp},${row.pulse},${row.glucose || ''},${row.context || ''}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            const userNameOnly = document.getElementById('user-greeting').innerText.replace('æ—©å®‰, ', '');
            link.setAttribute("href", url);
            link.setAttribute("download", `HealthData_${userNameOnly}_${startDateVal}_${endDateVal}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>