<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YangHome Health | Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="image/yanghealth.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        const savedSession = localStorage.getItem('healthTwinSession');
        if (!savedSession) {
            // alert("ğŸ”’ è«‹å…ˆç™»å…¥");
            window.location.href = 'index.html';
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden relative">

    <div class="fixed top-0 right-0 z-50 bg-emerald-600 text-white text-[10px] px-2 py-1 font-mono rounded-bl-lg shadow-md opacity-90 pointer-events-none">v10.0 (UID Match Fix)</div>

    <div id="debug-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-black/80 text-white text-xs p-3 rounded shadow-lg hidden transition-opacity duration-500">
        è®€å–ä¸­...
    </div>

    <div id="mobileOverlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-slate-200 flex flex-col z-30 shadow-2xl lg:shadow-none transform -translate-x-full lg:translate-x-0 sidebar-transition lg:relative">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <div><div class="flex items-center gap-2 text-indigo-600 font-bold text-xl"><i data-lucide="activity" class="w-6 h-6"></i>YangHome Health AI</div><p class="text-xs text-slate-400 mt-1">æ™ºæ…§é†«ç™‚ç›£æ¸¬ç³»çµ±</p></div>
            <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>

        <div class="p-4 pb-2">
            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 shadow-sm">
                <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center overflow-hidden shrink-0"><img id="sidebar-user-img" class="w-full h-full object-cover hidden"><span id="sidebar-user-text" class="text-indigo-600 font-bold">U</span></div>
                <div class="flex-1 overflow-hidden"><p class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Currently Logged In</p><p id="sidebar-user-name" class="text-sm font-bold text-slate-700 truncate">Guest</p></div>
            </div>
        </div>

        <div class="p-4 flex-1 overflow-hidden flex flex-col">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-2 flex justify-between items-center">é¸æ“‡ç”¨æˆ¶ (Patients)<span id="userCount" class="bg-slate-100 text-slate-500 py-0.5 px-2 rounded-full text-[10px]">0</span></h3>
            <div id="userList" class="space-y-1 overflow-y-auto flex-1 pr-1"><div class="p-4 text-center text-slate-400 text-sm animate-pulse"><i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i>æ­£åœ¨è¼‰å…¥æ•¸æ“š...</div></div>
        </div>
        <div class="mt-auto p-4 border-t border-slate-100 bg-slate-50">
            <a href="setting.html" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:bg-slate-100 text-slate-600 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-2 shadow-sm"><i data-lucide="settings-2" class="w-4 h-4"></i> ç®¡ç†è€…å¾Œå°</a>
            <a href="phd.html" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-2 shadow-sm"><i data-lucide="user-cog" class="w-4 h-4"></i> å¸³è™Ÿè¨­ç½®</a>
            <button onclick="fetchData()" class="w-full py-2.5 px-4 bg-white border border-slate-200 hover:bg-indigo-50 hover:text-indigo-600 text-slate-600 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-3 shadow-sm"><i data-lucide="refresh-cw" class="w-4 h-4"></i> é‡æ•´æ•¸æ“š</button>
            <button onclick="logout()" class="w-full py-2.5 px-4 bg-rose-50 border border-rose-100 text-rose-600 hover:bg-rose-100 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 mb-3 shadow-sm"><i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡ºç³»çµ±</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full">
        <header class="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 flex justify-between items-center px-4 lg:px-8 sticky top-0 z-10 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <div class="overflow-hidden"><h1 id="currentUserName" class="text-lg lg:text-xl font-bold text-slate-800 truncate">æ¦‚æ³ç¸½è¦½</h1><p id="defaultSubtitle" class="text-xs text-slate-400 mt-0.5 hidden sm:block">å³æ™‚ç”Ÿç†æ•¸æ“šåˆ†æ</p></div>
            </div>
            <div class="flex items-center gap-2 sm:gap-4">
                <a href="index.html" class="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition shadow-sm shadow-indigo-200"><i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">æ–°å¢ç´€éŒ„</span></a>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth">
            <div id="dashboardContent" class="max-w-7xl mx-auto hidden animate-fade-in pb-10">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-rose-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-rose-500 mb-2"><i data-lucide="heart" class="w-5 h-5"></i><span class="font-semibold text-sm">æ”¶ç¸®å£“</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-sbp" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">mmHg</span></div>
                            <div id="status-sbp" class="mt-2 text-xs font-medium text-slate-500">...</div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-blue-500 mb-2"><i data-lucide="activity" class="w-5 h-5"></i><span class="font-semibold text-sm">èˆ’å¼µå£“</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-dbp" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">mmHg</span></div>
                            <div id="status-dbp" class="mt-2 text-xs font-medium text-slate-500">...</div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-emerald-500 mb-2"><i data-lucide="zap" class="w-5 h-5"></i><span class="font-semibold text-sm">å¿ƒç‡</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-pulse" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">BPM</span></div>
                            <div class="mt-2 text-xs font-medium text-slate-500">...</div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-amber-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-amber-500 mb-2"><i data-lucide="droplet" class="w-5 h-5"></i><span class="font-semibold text-sm">è¡€ç³– (Glucose)</span></div>
                            <div class="flex items-baseline gap-2"><span id="val-glucose" class="text-3xl font-bold text-slate-800">--</span><span class="text-sm text-slate-400">mg/dL</span></div>
                            <div id="status-glucose" class="mt-2 text-xs font-medium text-slate-500">...</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass-card rounded-2xl p-5 flex flex-col h-[400px]">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-indigo-500"></i> è¡€å£“è¶¨å‹¢åœ–</h3>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <button onclick="setChartRange('30d')" id="btn-30d" class="px-3 py-1 text-xs font-bold rounded-md transition bg-white text-indigo-600 shadow-sm range-btn">è¿‘30å¤©</button>
                                    <button onclick="setChartRange('6m')" id="btn-6m" class="px-3 py-1 text-xs font-bold rounded-md transition text-slate-500 hover:bg-white/50 range-btn">è¿‘åŠå¹´</button>
                                    <button onclick="setChartRange('all')" id="btn-all" class="px-3 py-1 text-xs font-bold rounded-md transition text-slate-500 hover:bg-white/50 range-btn">å…¨éƒ¨</button>
                                </div>
                            </div>
                            <div class="flex-1 relative w-full h-full min-h-0"><canvas id="mainChart"></canvas></div>
                        </div>
                        <div class="glass-card rounded-2xl p-5 flex flex-col h-[350px]">
                            <div class="mb-4"><h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4 text-amber-500"></i> è¡€ç³–è¶¨å‹¢åœ–</h3></div>
                            <div class="flex-1 relative w-full h-full min-h-0"><canvas id="glucoseChart"></canvas></div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-5 overflow-hidden flex flex-col h-[775px]">
                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="history" class="w-4 h-4 text-slate-500"></i> æ­·å²ç´€éŒ„</h3>
                            <button onclick="openHistoryWindow()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full font-bold hover:bg-indigo-100 transition flex items-center gap-1">
                                <i data-lucide="external-link" class="w-3 h-3"></i> å®Œæ•´ç´€éŒ„
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto pr-1">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-400 uppercase border-b border-slate-100 sticky top-0 bg-white/95 backdrop-blur z-10">
                                    <tr>
                                        <th class="py-2 pl-2">æ™‚é–“</th>
                                        <th class="py-2 text-right">è¡€å£“/å¿ƒè·³</th>
                                        <th class="py-2 text-right pr-2">è¡€ç³–</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable" class="text-slate-600 divide-y divide-slate-50">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="loadingState" class="h-full flex flex-col items-center justify-center text-slate-400 min-h-[50vh]">
                <div class="relative"><div class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-500 rounded-full animate-spin"></div><div class="absolute inset-0 flex items-center justify-center"><div class="w-2 h-2 bg-indigo-500 rounded-full"></div></div></div>
                <p class="mt-4 text-sm font-medium animate-pulse">æ­£åœ¨å¾é›²ç«¯è³‡æ–™åº«åŒæ­¥æ•¸æ“š...</p>
            </div>
        </div>
    </main>

    <div id="aiAnalysisModal" class="fixed inset-0 bg-black/60 z-50 hidden flex-col justify-center items-center p-4 backdrop-blur-sm animate-fade-in" onclick="closeAiModal()"><div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden relative" onclick="event.stopPropagation()"><div class="p-5 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-white"><div class="flex items-center gap-3"><div class="p-2 bg-white rounded-lg shadow-sm text-indigo-600"><i data-lucide="sparkles" class="w-6 h-6"></i></div><div><h3 class="font-bold text-lg text-slate-800">Gemini å¥åº·åˆ†æ</h3></div></div><button onclick="closeAiModal()" class="p-2 hover:bg-slate-100 rounded-full transition text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button></div><div id="aiModalContent" class="p-6 overflow-y-auto text-slate-600 text-sm leading-relaxed scroll-smooth"></div><div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center"><button id="btn-tts" onclick="toggleSpeech()" class="hidden px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg font-bold text-sm transition flex items-center gap-2 border border-indigo-100"><i data-lucide="volume-2" class="w-5 h-5"></i><span id="btn-tts-text">èªéŸ³æ’­æ”¾</span></button><button onclick="closeAiModal()" class="px-5 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium transition shadow-sm">é—œé–‰</button></div></div></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzX0k_hP6poVZAxty89nQ6yJyuhNHw4M713G2IQolRPDQnNLFd_By3xqgfpQRtytOQT4A/exec'; 
        
        let allData = [];
        let currentUserData = [];
        let globalUsersMap = [];
        let bpChartInstance = null;
        let glucoseChartInstance = null;
        let currentChartRange = '30d'; 
        let currentSelectedUid = null;
        
        const loggedInSession = JSON.parse(localStorage.getItem('healthTwinSession')) || { name: 'Guest', email: '' };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (loggedInSession && loggedInSession.email) {
                document.getElementById('sidebar-user-name').innerText = loggedInSession.name;
                if (loggedInSession.picture) {
                    const img = document.getElementById('sidebar-user-img');
                    img.src = loggedInSession.picture; img.classList.remove('hidden'); 
                    document.getElementById('sidebar-user-text').classList.add('hidden');
                } else {
                    document.getElementById('sidebar-user-text').innerText = loggedInSession.name.charAt(0).toUpperCase();
                }
            }
            fetchData();
        });

        function logout() { if(confirm("ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ")) { localStorage.removeItem('healthTwinSession'); window.location.href = 'index.html'; } }
        function toggleSidebar() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('mobileOverlay'); if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); } else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); } }

        async function fetchData() {
            try {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('dashboardContent').classList.add('hidden');
                
                const ts = new Date().getTime();
                const [dataRes, mapRes] = await Promise.all([
                    fetch(API_URL + `?v=${ts}`), 
                    fetch(`${API_URL}?action=getSettings&v=${ts}`) 
                ]);

                if (!dataRes.ok || !mapRes.ok) throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤");

                const json = await dataRes.json();
                globalUsersMap = await mapRes.json();
                allData = json; 
                
                showToast(`Data:${json.length}, Users:${globalUsersMap.length}`);

                let targetUserUid = null;
                const myEmail = loggedInSession.email.trim().toLowerCase();
                const myName = loggedInSession.name;

                // é—œéµé‚è¼¯ï¼šåœ¨ Users Map ä¸­å°‹æ‰¾ç™»å…¥è€…
                // å› ç‚º CSV ä¸­ UID æ˜¯ "12122123456"ï¼Œæ‰€ä»¥è¦ç”¨ Email å»åæŸ¥å‡ºé€™å€‹ UID
                let me = globalUsersMap.find(u => 
                    (u.email && String(u.email).toLowerCase().trim() === myEmail) || 
                    (u.name && u.name === myName)
                );

                if (me) {
                    targetUserUid = String(me.uid).trim();
                }

                renderUserList(globalUsersMap, targetUserUid);
                
                // 3. æ±ºå®šè¦é¡¯ç¤ºèª°çš„è³‡æ–™
                if (targetUserUid) {
                    selectUser(targetUserUid, null);
                } else if (myEmail && allData.length > 0) {
                    // Fallback: å¦‚æœ User Map æ‰¾ä¸åˆ°äººï¼Œå˜—è©¦ç›´æ¥ç”¨ Email åœ¨ Data ä¸­æ‰¾
                    const orphanData = allData.filter(d => 
                        String(d.originalId).toLowerCase().trim() === myEmail || 
                        String(d.rawId).toLowerCase().trim() === myEmail
                    );
                    
                    if (orphanData.length > 0) {
                        document.getElementById('currentUserName').innerText = `${loggedInSession.name} (æœªè¨»å†Š)`;
                        currentUserData = orphanData;
                        currentUserData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        updateDashboard();
                        
                        document.getElementById('loadingState').classList.add('hidden');
                        document.getElementById('dashboardContent').classList.remove('hidden');
                        document.getElementById('dashboardContent').classList.add('animate-fade-in');
                    } else if (globalUsersMap.length > 0) {
                        selectUser(globalUsersMap[0].uid, null);
                    } else {
                        showEmptyState();
                    }
                } else if (globalUsersMap.length > 0) {
                    selectUser(globalUsersMap[0].uid, null);
                } else {
                    showEmptyState();
                }

            } catch (error) {
                console.error(error);
                document.getElementById('loadingState').innerHTML = `<div class="text-center text-rose-500"><p>è®€å–å¤±æ•—</p><p class="text-xs">${error.message}</p></div>`;
            }
        }

        function showEmptyState() {
            document.getElementById('currentUserName').innerText = "å°šç„¡è³‡æ–™";
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            currentUserData = [];
            updateDashboard();
        }

        function showToast(msg) {
            const t = document.getElementById('debug-toast');
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 4000);
        }

        function renderUserList(usersMap, targetUid) {
            const listContainer = document.getElementById('userList');
            document.getElementById('userCount').innerText = usersMap.length;
            listContainer.innerHTML = '';
            
            if (usersMap.length === 0) { 
                listContainer.innerHTML = '<div class="p-4 text-center text-sm text-slate-400">ç›®å‰ç„¡å…¶ä»–ç”¨æˆ¶</div>'; 
                return;
            }

            usersMap.forEach((u, index) => {
                const div = document.createElement('div');
                let displayName = u.name || u.email || u.uid || "Unknown";
                const avatarText = displayName.charAt(0).toUpperCase();
                const safeUid = String(u.uid).trim();
                
                div.id = `user-item-${safeUid}`; 
                div.className = `p-3 rounded-xl cursor-pointer hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center gap-3 text-slate-600 font-medium group user-item border border-transparent`;
                div.innerHTML = `<div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold shrink-0">${avatarText}</div><span class="truncate">${displayName}</span>`;
                
                div.onclick = () => { 
                    selectUser(safeUid, div); 
                    if (window.innerWidth < 1024) toggleSidebar(); 
                };
                
                listContainer.appendChild(div);
            });
        }

        function selectUser(uid, element) {
            currentSelectedUid = String(uid).trim();
            const safeUid = currentSelectedUid;
            
            document.querySelectorAll('.user-item').forEach(el => { 
                el.classList.remove('bg-indigo-50', 'text-indigo-600', 'shadow-sm', 'border-indigo-100'); 
                el.classList.add('border-transparent'); 
            });
            if (!element) { element = document.getElementById(`user-item-${safeUid}`); }
            if (element) { 
                element.classList.add('bg-indigo-50', 'text-indigo-600', 'shadow-sm', 'border-indigo-100'); 
                element.classList.remove('border-transparent'); 
            }
            
            const userObj = globalUsersMap.find(u => String(u.uid).trim() === safeUid);
            if (!userObj) return;

            let displayTitle = userObj.name || userObj.email || "Unknown User";
            
            // Build Valid IDs (åŒ…å« UID, Email, LineID)
            const validIds = [userObj.uid, userObj.email, userObj.lineUserId]
                .filter(val => val) 
                .map(val => String(val).toLowerCase().trim());
            
            // é—œéµç¯©é¸
            currentUserData = allData.filter(d => {
                const dRaw = String(d.rawId || "").toLowerCase().trim();
                const dOrig = String(d.originalId || "").toLowerCase().trim();
                return validIds.includes(dRaw) || validIds.includes(dOrig);
            });
            
            currentUserData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (userObj.birthday) {
                const bDate = new Date(userObj.birthday);
                if (!isNaN(bDate.getTime())) {
                    const rocYear = bDate.getFullYear() - 1911;
                    displayTitle += ` (æ°‘åœ‹${rocYear}å¹´${bDate.getMonth() + 1}æœˆ${bDate.getDate()}æ—¥)`;
                }
            }
            document.getElementById('currentUserName').innerText = displayTitle;
            
            updateDashboard();
            
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('animate-fade-in');
        }

        function openHistoryWindow() {
            if (!currentSelectedUid) { alert("è«‹å…ˆé¸æ“‡ä¸€ä½ç”¨æˆ¶"); return; }
            window.open(`pdhistory.html?uid=${currentSelectedUid}`, '_blank');
        }

        function setChartRange(range) { 
            currentChartRange = range; 
            document.querySelectorAll('.range-btn').forEach(btn => btn.className = "px-3 py-1 text-xs font-bold rounded-md transition text-slate-500 hover:bg-white/50 range-btn"); 
            document.getElementById(`btn-${range}`).className = "px-3 py-1 text-xs font-bold rounded-md bg-white text-indigo-600 shadow-sm range-btn"; 
            updateDashboard(); 
        }

        function updateDashboard() { 
            if (currentUserData.length === 0) { 
                ['val-sbp', 'val-dbp', 'val-pulse', 'val-glucose'].forEach(id => document.getElementById(id).innerText = '--');
                document.getElementById('status-sbp').innerText = 'å°šç„¡è³‡æ–™'; 
                document.getElementById('status-glucose').innerText = 'å°šç„¡è³‡æ–™'; 
                document.getElementById('historyTable').innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-sm">ç›®å‰æ²’æœ‰æ¸¬é‡ç´€éŒ„</td></tr>'; 
                renderChart([]); 
                return; 
            } 
            
            const latest = currentUserData[currentUserData.length - 1]; 
            
            const sbp = (latest.sbp !== "" && latest.sbp != null) ? latest.sbp : '--';
            const dbp = (latest.dbp !== "" && latest.dbp != null) ? latest.dbp : '--';
            const pulse = (latest.pulse !== "" && latest.pulse != null) ? latest.pulse : '--';
            const glucose = (latest.glucose !== "" && latest.glucose != null) ? latest.glucose : '--';

            document.getElementById('val-sbp').innerText = sbp; 
            document.getElementById('val-dbp').innerText = dbp; 
            document.getElementById('val-pulse').innerText = pulse; 
            document.getElementById('val-glucose').innerText = glucose; 

            if (sbp !== '--' && parseInt(sbp) > 140) {
                document.getElementById('status-sbp').innerHTML = `<span class="flex items-center gap-1 text-rose-500 font-bold"><i data-lucide="alert-circle" class="w-3 h-3"></i> åé«˜</span>`;
            } else if (sbp !== '--') {
                document.getElementById('status-sbp').innerHTML = `<span class="flex items-center gap-1 text-emerald-500 font-bold"><i data-lucide="check" class="w-3 h-3"></i> æ­£å¸¸</span>`;
            } else {
                document.getElementById('status-sbp').innerText = "ç„¡è³‡æ–™";
            }

            if (glucose !== '--' && parseInt(glucose) > 100) {
                document.getElementById('status-glucose').innerText = "æ³¨æ„æ•¸å€¼"; 
            } else if (glucose !== '--') {
                document.getElementById('status-glucose').innerText = "æ•¸å€¼ç©©å®š"; 
            } else {
                document.getElementById('status-glucose').innerText = "ç„¡è³‡æ–™";
            }
            
            lucide.createIcons(); 

            // History Table (Simplified)
            const historyBody = document.getElementById('historyTable'); 
            const displayData = currentUserData.slice(-50).reverse();

            if (displayData.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-sm">ç„¡è³‡æ–™</td></tr>';
            } else {
                historyBody.innerHTML = displayData.map(d => { 
                    let timeStr = d.timestamp;
                    if (timeStr && (timeStr.includes('T') || timeStr.includes('-'))) {
                        const dObj = new Date(timeStr);
                        if (!isNaN(dObj.getTime())) {
                            timeStr = `${dObj.getMonth()+1}/${dObj.getDate()} ${String(dObj.getHours()).padStart(2,'0')}:${String(dObj.getMinutes()).padStart(2,'0')}`;
                        } else {
                            timeStr = timeStr.substring(0, 16).replace('T', ' '); 
                        }
                    }
                    
                    const rSbp = (d.sbp || '-');
                    const rDbp = (d.dbp || '-');
                    const rPulse = (d.pulse || '-');
                    const rGlu = (d.glucose ? `<span class="text-amber-600 font-bold">${d.glucose}</span>` : '<span class="text-slate-300">-</span>');

                    return `<tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                        <td class="py-3 pl-2 text-slate-500 font-mono text-xs whitespace-nowrap">${timeStr}</td>
                        <td class="py-3 text-right font-medium">
                            <div class="text-sm"><span class="text-rose-600">${rSbp}</span>/<span class="text-blue-600">${rDbp}</span></div>
                            <div class="text-xs text-slate-400">HR: ${rPulse}</div>
                        </td>
                        <td class="py-3 pr-2 text-right font-medium">${rGlu}</td>
                    </tr>`; 
                }).join('');
            }
            
            let chartData = [...currentUserData]; 
            const now = new Date(); 
            if (currentChartRange === '30d') { 
                const d = new Date(); d.setDate(now.getDate() - 30); 
                chartData = chartData.filter(x => new Date(x.timestamp) >= d); 
            } else if (currentChartRange === '6m') { 
                const d = new Date(); d.setMonth(now.getMonth() - 6); 
                chartData = chartData.filter(x => new Date(x.timestamp) >= d); 
            } 
            renderChart(chartData); 
        }

        function renderChart(data) { 
            const labels = data.map(d => { 
                const date = new Date(d.timestamp); 
                return isNaN(date) ? d.timestamp.substring(5,16) : `${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`; 
            }); 
            
            const sbpData = data.map(d => (d.sbp && d.sbp > 0) ? d.sbp : null); 
            const dbpData = data.map(d => (d.dbp && d.dbp > 0) ? d.dbp : null); 
            const glucoseData = data.map(d => (d.glucose && d.glucose > 0) ? d.glucose : null); 
            
            const ctxBP = document.getElementById('mainChart').getContext('2d'); 
            let gradientSbp = ctxBP.createLinearGradient(0, 0, 0, 400); 
            gradientSbp.addColorStop(0, 'rgba(244, 63, 94, 0.4)'); gradientSbp.addColorStop(1, 'rgba(244, 63, 94, 0.05)'); 
            let gradientDbp = ctxBP.createLinearGradient(0, 0, 0, 400); 
            gradientDbp.addColorStop(0, 'rgba(59, 130, 246, 0.4)'); gradientDbp.addColorStop(1, 'rgba(59, 130, 246, 0.05)'); 
            
            if (bpChartInstance) bpChartInstance.destroy(); 
            bpChartInstance = new Chart(ctxBP, { 
                type: 'line', 
                data: { labels: labels, datasets: [{ label: 'æ”¶ç¸®å£“', data: sbpData, borderColor: '#F43F5E', backgroundColor: gradientSbp, borderWidth: 2, tension: 0.3, pointRadius: 3, fill: true, spanGaps: false }, { label: 'èˆ’å¼µå£“', data: dbpData, borderColor: '#3B82F6', backgroundColor: gradientDbp, borderWidth: 2, tension: 0.3, pointRadius: 3, fill: true, spanGaps: false }] }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', align: 'end' }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { suggestedMin: 60, suggestedMax: 160 }, x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } } 
            }); 
            
            const ctxGlu = document.getElementById('glucoseChart').getContext('2d'); 
            let gradientGlu = ctxGlu.createLinearGradient(0, 0, 0, 300); 
            gradientGlu.addColorStop(0, 'rgba(245, 158, 11, 0.4)'); gradientGlu.addColorStop(1, 'rgba(245, 158, 11, 0.05)'); 
            
            if (glucoseChartInstance) glucoseChartInstance.destroy(); 
            glucoseChartInstance = new Chart(ctxGlu, { 
                type: 'line', 
                data: { labels: labels, datasets: [{ label: 'è¡€ç³–', data: glucoseData, borderColor: '#F59E0B', backgroundColor: gradientGlu, borderWidth: 2, tension: 0.3, pointRadius: 4, fill: true, spanGaps: false }] }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { suggestedMin: 70, suggestedMax: 180, grid: { color: '#f1f5f9' } }, x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } } 
            }); 
        }

        async function getAIAnalysis() { /* ä¿æŒåŸæ¨£ */ }
        function toggleSpeech() { /* ä¿æŒåŸæ¨£ */ }
        function closeAiModal() { document.getElementById('aiAnalysisModal').classList.add('hidden'); document.getElementById('aiAnalysisModal').classList.remove('flex'); window.speechSynthesis.cancel(); }
    </script>
</body>
</html>