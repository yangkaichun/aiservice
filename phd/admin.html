<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
</head>
<body class="bg-slate-100 min-h-screen p-6 relative">
    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-slate-800">使用者管理後台</h1>
            <a href="dashboard.html" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 transition">返回 Dashboard</a>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3">姓名 / Email</th>
                            <th class="px-6 py-3">生日</th>
                            <th class="px-6 py-3">狀態</th>
                            <th class="px-6 py-3">操作</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="4" class="px-6 py-4 text-center">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-xl p-6 shadow-2xl relative">
            <h3 class="text-lg font-bold text-slate-800 mb-4">編輯使用者資料</h3>
            <form id="editForm" onsubmit="handleEditSubmit(event)" class="space-y-4">
                <input type="hidden" id="edit-uid">
                
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-1">姓名</label>
                    <input type="text" id="edit-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-1">生日</label>
                    <input type="date" id="edit-birthday" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                </div>
                
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">取消</button>
                    <button type="submit" id="btn-save-edit" class="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg font-bold transition flex items-center gap-2">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = config.API_URL;
        lucide.createIcons();
        const savedSession = localStorage.getItem('healthTwinSession');
        const currentUser = savedSession ? JSON.parse(savedSession) : null;

        // 安全檢查
        if (!currentUser || currentUser.email !== 'kaichun.yang@gmail.com') {
            alert("您沒有權限訪問此頁面");
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', fetchUsers);

        async function fetchUsers() {
            try {
                // 使用 POST 且不帶 headers，避免 CORS
                const res = await fetch(`${API_URL}?t=${new Date().getTime()}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'adminGetUsers',
                        adminEmail: currentUser.email
                    })
                });
                const data = await res.json();
                if (data.success) {
                    renderTable(data.users);
                } else {
                    alert("讀取失敗: " + data.error);
                }
            } catch (e) {
                console.error(e);
                alert("連線錯誤 (Fetch Error)");
            }
        }

        function renderTable(users) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const isPending = user.status === 'pending';
                const statusBadge = isPending 
                    ? `<span class="px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold">待審核</span>`
                    : `<span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">已啟用</span>`;
                
                // 授權/取消按鈕
                let authBtn = '';
                if (user.email === 'kaichun.yang@gmail.com') {
                    authBtn = `<span class="text-slate-300 text-xs font-bold mr-2">管理員</span>`;
                } else if (isPending) {
                    authBtn = `<button onclick="updateStatus('${user.uid}', 'active')" class="px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-sm text-xs font-bold mr-2">授權開通</button>`;
                } else {
                    authBtn = `<button onclick="updateStatus('${user.uid}', 'pending')" class="px-3 py-1.5 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition shadow-sm text-xs font-bold mr-2">取消授權</button>`;
                }

                // 編輯按鈕
                const userDataStr = encodeURIComponent(JSON.stringify(user));
                const editBtn = `<button onclick="openEditModal('${userDataStr}')" class="px-3 py-1.5 bg-slate-200 text-slate-600 hover:bg-slate-300 rounded-lg transition shadow-sm text-xs font-bold flex items-center gap-1"><i data-lucide="edit-2" class="w-3 h-3"></i> 編輯</button>`;

                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${user.name}</div>
                        <div class="text-xs text-slate-500">${user.email}</div>
                    </td>
                    <td class="px-6 py-4">${user.birthday}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 flex items-center">
                        ${authBtn}
                        ${editBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        async function updateStatus(targetUid, newStatus) {
            const actionName = newStatus === 'active' ? '授權' : '取消授權';
            if(!confirm(`確定要${actionName}此用戶嗎？`)) return;
            
            try {
                // 完全移除 headers，只保留 body
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'adminAuthorize',
                        adminEmail: currentUser.email,
                        targetUid: targetUid,
                        status: newStatus
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`${actionName}成功`);
                    fetchUsers();
                } else {
                    alert("失敗: " + data.message);
                }
            } catch (e) {
                alert("連線錯誤");
            }
        }

        function openEditModal(userStr) {
            const user = JSON.parse(decodeURIComponent(userStr));
            document.getElementById('edit-uid').value = user.uid; // 使用 UID
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-birthday').value = user.birthday;
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
        }

        // [關鍵修正]：使用 adminUpdateUser，且 fetch 不帶 headers
        async function handleEditSubmit(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btn-save-edit');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> 處理中...`;
            lucide.createIcons();

            const uid = document.getElementById('edit-uid').value;
            const name = document.getElementById('edit-name').value;
            const birthday = document.getElementById('edit-birthday').value;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    // [重點] 移除 headers 設定，讓瀏覽器發送簡單請求 (Simple Request)
                    body: JSON.stringify({
                        action: 'adminUpdateUser', 
                        adminEmail: currentUser.email,
                        targetUid: uid,        
                        newName: name,
                        newBirthday: birthday
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert("更新成功");
                    closeEditModal();
                    fetchUsers(); // 重新整理列表
                } else {
                    alert("更新失敗: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("連線錯誤，請稍後再試。");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>