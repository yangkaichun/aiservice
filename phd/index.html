<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="YangHealth">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="image/yanghealth.png">
    <link rel="icon" type="image/x-icon" href="image/yanghealth.ico">
    <title>YangHome Health | Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; min-height: 100vh; overflow-y: auto; }
        .clean-card { background-color: #ffffff; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .app-install-btn { background: linear-gradient(to right, #1e293b, #334155); color: white; transition: all 0.3s ease; }
        .app-install-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(30, 41, 59, 0.3); }
        #login-overlay { backdrop-filter: blur(5px); }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 py-10 relative">

    <div id="login-overlay" class="fixed inset-0 bg-white/80 z-50 hidden flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-indigo-600 font-bold text-lg animate-pulse">正在驗證身分...</p>
    </div>

    <div id="install-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex-col items-center justify-end pb-10 animate-fade-in" onclick="closeInstallModal()">
        <div class="bg-white w-[90%] max-w-md rounded-3xl p-6 relative shadow-2xl" onclick="event.stopPropagation()">
            <button onclick="closeInstallModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="text-center">
                <h3 class="text-xl font-bold text-slate-800 mb-2">安裝應用程式</h3>
                <p class="text-sm text-slate-500 mb-6">請使用瀏覽器選單中的「安裝」或「加入主畫面」。</p>
            </div>
        </div>
    </div>

    <div class="clean-card w-full max-w-md p-8 my-8 mb-20" id="main-card">
        <div class="text-center mb-8">
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 bg-white rounded-3xl flex items-center justify-center shadow-sm overflow-hidden p-4 border border-slate-100">
                    <img src="image/yanghealth.png" alt="YangHealth Logo" class="w-full h-full object-contain">
                </div>
            </div>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">YangHome Health</h1>
            <p class="text-slate-400 text-xs font-bold mt-2 tracking-widest uppercase">AI-Powered Health Monitor</p>
        </div>

        <div id="login-section" class="space-y-6">
            <div class="flex justify-center">
                <div id="g_id_onload"
                     data-client_id="142808541856-1sfda1hcfk12p1r0a5fbmldugb1f99vn.apps.googleusercontent.com" 
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue" data-text="sign_in_with" data-shape="pill" data-logo_alignment="left"></div>
            </div>
        </div>

        <div class="space-y-3 pt-4 border-t border-slate-100 mt-6">
            <button type="button" onclick="handleInstallApp()" id="btn-install-app" class="w-full py-2 px-3 app-install-btn rounded-xl flex items-center justify-between shadow-md mb-3 hidden">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center overflow-hidden p-1 shadow-sm"><img src="image/yanghealth.png" class="w-full h-full object-contain"></div>
                    <div class="text-left"><div class="text-xs font-medium text-slate-300">Install App</div><div class="text-sm font-bold text-white">安裝應用程式</div></div>
                </div>
                <i data-lucide="download" class="w-5 h-5 text-white/80 mr-1"></i>
            </button>
        </div>
    </div>
    
    <script>
        const API_URL = config.API_URL;
        lucide.createIcons();
        let deferredPrompt;

        document.addEventListener('DOMContentLoaded', () => {
            initInstallButton();
            // 自動檢查是否已經有 session
            const savedSession = localStorage.getItem('healthTwinSession');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                // 如果已經有 session，依照權限跳轉
                if (session.status === 'pending') window.location.href = 'waitforuserright.html';
                else if (session.status === 'active') window.location.href = 'dashboard.html';
            }
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        function initInstallButton() {
            const btn = document.getElementById('btn-install-app');
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            if (!isStandalone) btn.classList.remove('hidden');
        }

        function handleInstallApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => deferredPrompt = null);
            } else {
                document.getElementById('install-modal').classList.remove('hidden');
                document.getElementById('install-modal').classList.add('flex');
            }
        }
        function closeInstallModal() {
            document.getElementById('install-modal').classList.add('hidden');
            document.getElementById('install-modal').classList.remove('flex');
        }

        async function handleCredentialResponse(response) {
            const overlay = document.getElementById('login-overlay');
            overlay.classList.remove('hidden'); overlay.classList.add('flex');

            try {
                // 解析 Google Token 取得 email 與圖片
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                const googleEmail = payload.email;
                const googleName = payload.name;
                const googlePicture = payload.picture;

                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'socialLogin',
                        token: response.credential, 
                        provider: 'google'
                    })
                });
                const data = await res.json();

                if (data.isNewUser) {
                    // [新用戶] 跳轉到註冊頁面，並帶入預設資料
                    const signupData = { email: googleEmail, name: googleName, picture: googlePicture };
                    sessionStorage.setItem('signupPrefill', JSON.stringify(signupData));
                    window.location.href = 'signup.html';
                } else if (data.success) {
                    // [舊用戶] 檢查狀態
                    const user = data.user;
                    const sessionData = { ...user, picture: googlePicture }; // 補上圖片
                    localStorage.setItem('healthTwinSession', JSON.stringify(sessionData));

                    if (user.status === 'pending') {
                        window.location.href = 'waitforuserright.html';
                    } else {
                        // 如果是 active
                        // 檢查是否是管理員 (Email 檢查)
                        if (user.email === 'kaichun.yang@gmail.com') {
                            // 管理員可選擇去 admin.html 或 dashboard (這邊預設去 dashboard，admin.html 透過 dashboard 連結進入)
                            window.location.href = 'dashboard.html';
                        } else {
                            window.location.href = 'dashboard.html';
                        }
                    }
                } else {
                    alert("登入失敗");
                }
            } catch (e) {
                console.error(e);
                alert("連線錯誤");
            } finally {
                overlay.classList.add('hidden'); overlay.classList.remove('flex');
            }
        }
    </script>
</body>
</html>