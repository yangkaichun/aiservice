<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YangHome Health | ç™»å…¥èˆ‡è¼¸å…¥</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="image/yanghealth.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .glass-card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 2rem; }
        .line-btn { background-color: #06C755; color: white; transition: all 0.2s; }
        .line-btn:hover { background-color: #05b34c; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="login-view" class="w-full max-w-md glass-card text-center transition-all duration-500">
        <div class="mb-6">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="activity" class="w-8 h-8 text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-800">YangHome Health</h1>
            <p class="text-slate-500 mt-2">è«‹é¸æ“‡ç™»å…¥æ–¹å¼</p>
        </div>

        <div class="flex justify-center mb-4">
            <div id="g_id_onload"
                 data-client_id="YOUR_GOOGLE_CLIENT_ID" 
                 data-callback="handleCredentialResponse"
                 data-auto_select="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left" data-width="320"></div>
        </div>

        <div class="flex justify-center">
            <button onclick="lineLogin()" class="line-btn w-[320px] h-[40px] rounded flex items-center justify-center gap-2 font-medium shadow-sm">
                <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 2.5c-5.5 0-10 3.9-10 8.8 0 4.4 3.6 8.1 8.6 8.7-.4 1.5-1.2 3.1-1.3 3.3-.1.2-.1.5.2.6.1.1.3.1.5 0 .6-.3 3.5-2 4.8-2.8 5.6-.8 9.2-4.1 9.2-8.3 0-4.9-4.5-8.8-10-8.8z"/></svg>
                LINE ç™»å…¥
            </button>
        </div>
        
        <div id="login-msg" class="mt-4 text-sm text-slate-400"></div>
    </div>

    <div id="input-view" class="hidden w-full max-w-md glass-card transition-all duration-500">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-xl font-bold text-slate-800">æ–°å¢ç´€éŒ„</h2>
                <p id="user-greeting" class="text-sm text-slate-500"></p>
            </div>
            <button onclick="logout()" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </div>

        <form id="healthForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">æ¸¬é‡æƒ…å¢ƒ</label>
                <select id="context" class="w-full rounded-lg border-slate-200 focus:border-blue-500 p-2.5 bg-slate-50">
                    <option value="èµ·åºŠç©ºè…¹">ğŸŒ… èµ·åºŠç©ºè…¹</option>
                    <option value="æ—©é¤å¾Œ">ğŸ³ æ—©é¤å¾Œ</option>
                    <option value="åˆé¤å¾Œ">ğŸ± åˆé¤å¾Œ</option>
                    <option value="æ™šé¤å¾Œ">ğŸ½ï¸ æ™šé¤å¾Œ</option>
                    <option value="ç¡å‰">ğŸŒ™ ç¡å‰</option>
                    <option value="èº«é«”ä¸é©">âš ï¸ èº«é«”ä¸é©</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ”¶ç¸®å£“ (SBP)</label>
                    <input type="number" id="sbp" required class="w-full rounded-lg border-slate-200 p-2.5 bg-slate-50" placeholder="120">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">èˆ’å¼µå£“ (DBP)</label>
                    <input type="number" id="dbp" required class="w-full rounded-lg border-slate-200 p-2.5 bg-slate-50" placeholder="80">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">å¿ƒç‡ (HR)</label>
                    <input type="number" id="hr" required class="w-full rounded-lg border-slate-200 p-2.5 bg-slate-50" placeholder="72">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">è¡€ç³– (é¸å¡«)</label>
                    <input type="number" id="glucose" class="w-full rounded-lg border-slate-200 p-2.5 bg-slate-50" placeholder="100">
                </div>
            </div>
            <div>
                 <label class="block text-sm font-medium text-slate-700 mb-1">å‚™è¨» (é¸å¡«)</label>
                 <textarea id="note" rows="2" class="w-full rounded-lg border-slate-200 p-2.5 bg-slate-50" placeholder="ä¾‹å¦‚ï¼šå‰›é‹å‹•å®Œ..."></textarea>
            </div>

            <button type="submit" id="btn-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg shadow-sm flex items-center justify-center gap-2 mt-2">
                <i data-lucide="send" class="w-4 h-4"></i> æäº¤ç´€éŒ„
            </button>
            <div id="status-msg" class="text-center text-sm min-h-[20px]"></div>
        </form>

        <div class="mt-6 flex justify-center gap-4 border-t pt-4">
             <a href="dashboard.html" class="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-600">
                 <div class="p-2 bg-slate-50 rounded-lg"><i data-lucide="bar-chart-2" class="w-5 h-5"></i></div>
                 <span class="text-xs">å„€è¡¨æ¿</span>
             </a>
             <a href="phd.html" class="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-600">
                 <div class="p-2 bg-slate-50 rounded-lg"><i data-lucide="user-cog" class="w-5 h-5"></i></div>
                 <span class="text-xs">è¨­å®š</span>
             </a>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const API_URL = "https://script.google.com/macros/s/AKfycbzQpB9tT-M0Fh.../exec"; // â˜…è«‹æ›¿æ›ç‚ºä½ çš„ Web App URLâ˜…
        
        // ä¾†è‡ª Code.gs æ¨¡æ¿çš„è®Šæ•¸ (å¦‚æœé é¢æ˜¯é€é Apps Script æ¸²æŸ“)
        // é€é URL åˆ¤æ–·æ˜¯å¦æœ‰ code (LINE Return)
        const urlParams = new URLSearchParams(window.location.search);
        const lineCode = urlParams.get('code');

        let currentUser = null;

        // 1. åˆå§‹åŒ–æª¢æŸ¥
        window.onload = function() {
            const savedUser = localStorage.getItem('healthUser');
            
            // A. å¦‚æœå·²ç™»å…¥éï¼Œç›´æ¥é¡¯ç¤ºè¼¸å…¥é é¢
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showInputView();
            } 
            // B. å¦‚æœæ˜¯ LINE ç™»å…¥è·³è½‰å›ä¾† (ç¶²å€æœ‰ code)
            else if (lineCode) {
                handleLineLoginCallback(lineCode);
            }
        };

        // 2. Google ç™»å…¥è™•ç†
        function handleCredentialResponse(response) {
            const data = decodeJwtResponse(response.credential);
            const userPayload = {
                action: 'login',
                provider: 'google',
                email: data.email,
                name: data.name,
                picture: data.picture,
                sub: data.sub
            };
            performLogin(userPayload);
        }

        // 3. LINE ç™»å…¥è·³è½‰
        function lineLogin() {
            const channelId = '2008700923'; // ä½ çš„ LINE Channel ID
            // é‡è¦ï¼šé€™è£¡çš„ Redirect URI å¿…é ˆèˆ‡ä½ åœ¨ LINE Developer Console è¨­å®šçš„ä¸€æ¨¡ä¸€æ¨£
            // é€šå¸¸æ˜¯ Apps Script çš„ exec ç¶²å€
            const redirectUri = encodeURIComponent(window.location.href.split('?')[0]); 
            const state = 'login_' + Date.now();
            
            const lineAuthUrl = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${channelId}&redirect_uri=${redirectUri}&state=${state}&scope=profile%20openid%20email`;
            
            window.location.href = lineAuthUrl;
        }

        // 4. LINE Callback è™•ç† (å¾Œç«¯é©—è­‰)
        async function handleLineLoginCallback(code) {
            document.getElementById('login-msg').innerText = "æ­£åœ¨é©—è­‰ LINE ç™»å…¥...";
            
            const payload = {
                action: 'login',
                provider: 'line',
                code: code,
                redirectUri: window.location.href.split('?')[0] // å¿…é ˆå‚³å›å¾Œç«¯åšæ¯”å°
            };
            
            performLogin(payload);
        }

        // å…±ç”¨ç™»å…¥åŸ·è¡Œ
        async function performLogin(payload) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Apps Script ç‰¹æ€§
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // ç”±æ–¼ no-cors ç„¡æ³•è®€å–å›æ‡‰ï¼Œæˆ‘å€‘é€™è£¡åšä¸€å€‹å‡è¨­æˆåŠŸçš„è™•ç† (åœ¨ Web App å¯¦éš›ç’°å¢ƒå»ºè­°ç”¨ callback æˆ– redirect)
                // ä½†ç‚ºäº†ä½¿ç”¨è€…é«”é©—ï¼Œè‹¥æ˜¯ Google ç™»å…¥ï¼Œæˆ‘å€‘å·²ç¶“æœ‰ Email äº†ã€‚
                // è‹¥æ˜¯ LINEï¼Œå› ç‚º no-cors æ‹¿ä¸åˆ° profileï¼Œé€™è£¡éœ€è¦ç‰¹åˆ¥è™•ç†ï¼š
                // å»ºè­°ï¼šå°‡ Apps Script éƒ¨ç½²ç‚º Web App æ™‚ï¼Œå°‡ "Who has access" è¨­ç‚º "Anyone"ï¼Œé€™æ¨£å¯ä»¥ç”¨ cors æ¨¡å¼ fetch
                
                // å¦‚æœæ˜¯ Googleï¼Œç›´æ¥ç”¨å‰ç«¯è³‡æ–™é€²å…¥
                if(payload.provider === 'google') {
                    currentUser = { email: payload.email, name: payload.name };
                    localStorage.setItem('healthUser', JSON.stringify(currentUser));
                    showInputView();
                } else {
                    // LINE éœ€è¦å¾Œç«¯å›æ‡‰ User Infoï¼Œä½†åœ¨ no-cors ä¸‹ç„¡æ³•è®€å–ã€‚
                    // æš«æ™‚è§£æ³•ï¼šå‡è¨­å¾Œç«¯é©—è­‰æˆåŠŸï¼Œä¸¦æç¤ºä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥ (æˆ–å»ºè­°æ”¹ç”¨ Google ç™»å…¥)
                    // å®Œç¾çš„è§£æ³•éœ€è¦ Apps Script ä½¿ç”¨ JSONP æˆ–å…è¨± CORS
                    alert("LINE ç™»å…¥è«‹æ±‚å·²ç™¼é€ã€‚è‹¥é é¢æœªè·³è½‰ï¼Œè«‹é‡æ–°æ•´ç†æˆ–ä½¿ç”¨ Google ç™»å…¥ã€‚");
                    // å¯¦éš›ä¸Šï¼Œå¦‚æœè¦å®Œæ•´æ”¯æ´ LINE æµç¨‹ä¸”æ‹¿å› User Infoï¼Œå»ºè­°å¾Œç«¯ doGet è™•ç†å®Œç›´æ¥å›å‚³å« User Data çš„ HTML
                }

            } catch (e) {
                console.error(e);
                document.getElementById('login-msg').innerText = "ç™»å…¥é€£ç·šéŒ¯èª¤";
            }
        }

        function showInputView() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('input-view').classList.remove('hidden');
            document.getElementById('user-greeting').innerText = `Hi, ${currentUser.name || 'User'}`;
            // æ¸…é™¤ç¶²å€åƒæ•¸
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function logout() {
            localStorage.removeItem('healthUser');
            location.reload();
        }

        // æäº¤è¡¨å–® (ä¸è®Š)
        document.getElementById('healthForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const status = document.getElementById('status-msg');
            btn.innerHTML = 'è™•ç†ä¸­...';
            btn.disabled = true;

            const payload = {
                action: 'input',
                userEmail: currentUser.email, // å‚³é€ Email
                context: document.getElementById('context').value,
                sbp: document.getElementById('sbp').value,
                dbp: document.getElementById('dbp').value,
                hr: document.getElementById('hr').value,
                glucose: document.getElementById('glucose').value,
                note: document.getElementById('note').value
            };

            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            status.innerHTML = '<span class="text-green-600">ç´€éŒ„æˆåŠŸ (å·²é€è‡³å¾Œç«¯è™•ç† UID)</span>';
            document.getElementById('healthForm').reset();
            setTimeout(() => { btn.disabled = false; btn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> æäº¤ç´€éŒ„'; lucide.createIcons(); status.innerHTML=''; }, 2000);
        });
    </script>
</body>
</html>