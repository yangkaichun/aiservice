<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©³ç´°æ­·å²ç´€éŒ„ | YangHome Health</title>
    <link rel="icon" type="image/x-icon" href="image/yanghealth.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>

    <script>
        const savedSession = localStorage.getItem('healthTwinSession');
        let session = null;
        if (!savedSession) { 
            alert("ğŸ”’ è«‹å…ˆç™»å…¥"); 
            window.location.href = 'index.html'; 
        } else {
            session = JSON.parse(savedSession);
        }
    </script>
    <style> body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; } </style>
</head>
<body class="p-6">

    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden min-h-[80vh] flex flex-col">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <div>
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="history" class="w-6 h-6 text-indigo-600"></i>
                    å®Œæ•´æ­·å²ç´€éŒ„
                </h1>
                <p class="text-xs text-slate-500 mt-1" id="user-subtitle">Loading...</p>
            </div>
            <a href="dashboard.html" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-bold transition shadow-sm">
                è¿”å›ç¸½è¦½
            </a>
        </div>

        <div class="flex-1 overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 text-slate-400 text-xs uppercase font-bold sticky top-0">
                    <tr>
                        <th class="px-6 py-4 border-b border-slate-100">æ™‚é–“</th>
                        <th class="px-6 py-4 border-b border-slate-100">æƒ…å¢ƒ/é¡å‹</th>
                        <th class="px-6 py-4 border-b border-slate-100 text-rose-500">æ”¶ç¸®å£“</th>
                        <th class="px-6 py-4 border-b border-slate-100 text-blue-500">èˆ’å¼µå£“</th>
                        <th class="px-6 py-4 border-b border-slate-100">å¿ƒç‡</th>
                        <th class="px-6 py-4 border-b border-slate-100 text-amber-500">è¡€ç³–</th>
                        <th class="px-6 py-4 border-b border-slate-100">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-100 text-sm">
                    <tr><td colspan="7" class="p-8 text-center text-slate-400"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>è¼‰å…¥è³‡æ–™ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = config.API_URL;
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', () => {
            if(session) {
                document.getElementById('user-subtitle').innerText = `User: ${session.name || session.email}`;
                fetchHistory();
            }
        });

        async function fetchHistory() {
            try {
                // [é—œéµä¿®æ­£] ä½¿ç”¨ session.uid æŠ“å–è³‡æ–™
                const response = await fetch(`${API_URL}?action=getData&uid=${session.uid}`);
                const data = await response.json();
                
                const tbody = document.getElementById('table-body');
                
                if(!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400">ç›®å‰å°šç„¡ç´€éŒ„</td></tr>`;
                    return;
                }

                // æ’åºï¼šæœ€æ–°çš„åœ¨ä¸Šé¢
                const sortedData = data.sort((a, b) => new Date(b.date) - new Date(a.date));

                tbody.innerHTML = sortedData.map(row => {
                    // æ—¥æœŸæ ¼å¼åŒ–è™•ç†
                    let timeStr = row.date;
                    try {
                        const dObj = new Date(timeStr);
                        if (!isNaN(dObj.getTime())) {
                            timeStr = `${dObj.getFullYear()}/${(dObj.getMonth()+1).toString().padStart(2,'0')}/${dObj.getDate().toString().padStart(2,'0')} <span class="text-slate-400 text-xs ml-1">${dObj.getHours().toString().padStart(2,'0')}:${dObj.getMinutes().toString().padStart(2,'0')}</span>`;
                        }
                    } catch(e) {}

                    return `
                        <tr class="hover:bg-indigo-50/30 transition">
                            <td class="px-6 py-4 font-mono text-slate-600 whitespace-nowrap">${timeStr}</td>
                            <td class="px-6 py-4 font-bold text-slate-700">${row.context || '-'}</td>
                            <td class="px-6 py-4 text-rose-600 font-bold font-mono">${row.sbp || '-'}</td>
                            <td class="px-6 py-4 text-blue-600 font-bold font-mono">${row.dbp || '-'}</td>
                            <td class="px-6 py-4 text-slate-600 font-mono">${row.hr || '-'}</td>
                            <td class="px-6 py-4 text-amber-600 font-bold font-mono">${row.glucose || '-'}</td>
                            <td class="px-6 py-4 text-slate-400 text-xs truncate max-w-[150px]" title="${row.note||''}">${row.note || '-'}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error(error);
                document.getElementById('table-body').innerHTML = `<tr><td colspan="7" class="p-8 text-center text-rose-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</td></tr>`;
            }
        }
    </script>
</body>
</html>