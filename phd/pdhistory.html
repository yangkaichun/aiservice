<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©³ç´°æ­·å²ç´€éŒ„ | YangHome Health</title>
    <link rel="icon" type="image/x-icon" href="image/yanghealth.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        const savedSession = localStorage.getItem('healthTwinSession');
        if (!savedSession) { alert("ğŸ”’ è«‹å…ˆç™»å…¥"); window.location.href = 'index.html'; }
    </script>
    <style> body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; } </style>
</head>
<body class="p-6">

    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <div>
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="history" class="w-6 h-6 text-indigo-600"></i> 
                    <span id="pageTitle">è¼‰å…¥ä¸­...</span>
                </h1>
                <p id="userSubtitle" class="text-sm text-slate-500 mt-1">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™åº«...</p>
            </div>
            <button onclick="window.close()" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold hover:bg-slate-50 transition">é—œé–‰è¦–çª—</button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-3">æ™‚é–“</th>
                        <th class="px-6 py-3">æƒ…å¢ƒ</th>
                        <th class="px-6 py-3">æ”¶ç¸®å£“ (SBP)</th>
                        <th class="px-6 py-3">èˆ’å¼µå£“ (DBP)</th>
                        <th class="px-6 py-3">å¿ƒç‡ (HR)</th>
                        <th class="px-6 py-3">è¡€ç³– (Glucose)</th>
                        <th class="px-6 py-3">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="divide-y divide-slate-100">
                    <tr><td colspan="7" class="px-6 py-8 text-center text-slate-400">è³‡æ–™è®€å–ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const API_URL = 'https://script.google.com/macros/s/AKfycbzX0k_hP6poVZAxty89nQ6yJyuhNHw4M713G2IQolRPDQnNLFd_By3xqgfpQRtytOQT4A/exec';

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const uid = params.get('uid');
            if (!uid) { alert("æœªæŒ‡å®šä½¿ç”¨è€… UID"); window.close(); return; }
            fetchData(uid);
        });

        async function fetchData(targetUid) {
            try {
                const ts = new Date().getTime();
                // åŒæ™‚æŠ“å– Users å’Œ Data ä»¥ä¾¿é€²è¡Œå°æ‡‰
                const [dataRes, mapRes] = await Promise.all([
                    fetch(API_URL + `?v=${ts}`),
                    fetch(`${API_URL}?action=getSettings&v=${ts}`)
                ]);

                const allData = await dataRes.json();
                const users = await mapRes.json();

                // 1. æ‰¾å‡ºä½¿ç”¨è€…è³‡è¨Š
                const user = users.find(u => String(u.uid).trim() === targetUid);
                const userName = user ? (user.name || user.email) : "æœªçŸ¥ç”¨æˆ¶";
                
                document.getElementById('pageTitle').innerText = `${userName} çš„æ­·å²ç´€éŒ„`;
                document.getElementById('userSubtitle').innerText = `UID: ${targetUid}`;

                // 2. å»ºç«‹æ¯”å°æ¸…å–® (UID, Email, LineID)
                const validIds = [];
                if (user) {
                    if(user.uid) validIds.push(String(user.uid).toLowerCase().trim());
                    if(user.email) validIds.push(String(user.email).toLowerCase().trim());
                    if(user.lineUserId) validIds.push(String(user.lineUserId).toLowerCase().trim());
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ° User è¨­å®šï¼Œè‡³å°‘æ¯”å° UID æœ¬èº«
                    validIds.push(String(targetUid).toLowerCase().trim());
                }

                // 3. ç¯©é¸è³‡æ–™
                const historyData = allData.filter(d => {
                    const rawId = String(d.rawId || "").toLowerCase().trim();
                    const origId = String(d.originalId || "").toLowerCase().trim();
                    return validIds.includes(rawId) || validIds.includes(origId);
                });

                // 4. æ’åº (æ–° -> èˆŠ)
                historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                renderTable(historyData);

            } catch (e) {
                console.error(e);
                document.getElementById('historyTableBody').innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-rose-500 font-bold">è®€å–å¤±æ•—: ${e.message}</td></tr>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('historyTableBody');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-slate-400">æŸ¥ç„¡è³‡æ–™</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(row => {
                // å®‰å…¨çš„æ™‚é–“æ ¼å¼åŒ–
                let timeStr = row.timestamp;
                // è™•ç†éæ¨™æº–æ—¥æœŸå­—ä¸² (ä¾‹å¦‚ "2025-12-19 09:30:00")
                if (timeStr && !timeStr.includes('T') && timeStr.includes(' ')) {
                    timeStr = timeStr.replace(' ', 'T'); // è®“ Date() èƒ½è§£æ
                }
                const dObj = new Date(timeStr);
                const displayTime = isNaN(dObj.getTime()) ? row.timestamp : 
                    `${dObj.getFullYear()}/${(dObj.getMonth()+1).toString().padStart(2,'0')}/${dObj.getDate().toString().padStart(2,'0')} ${dObj.getHours().toString().padStart(2,'0')}:${dObj.getMinutes().toString().padStart(2,'0')}`;

                return `
                    <tr class="hover:bg-indigo-50/30 transition">
                        <td class="px-6 py-4 font-mono text-slate-600">${displayTime}</td>
                        <td class="px-6 py-4 font-bold text-slate-700">${row.context || '-'}</td>
                        <td class="px-6 py-4 text-rose-600 font-bold">${row.sbp || '-'}</td>
                        <td class="px-6 py-4 text-blue-600 font-bold">${row.dbp || '-'}</td>
                        <td class="px-6 py-4 text-slate-600">${row.pulse || '-'}</td>
                        <td class="px-6 py-4 text-amber-600 font-bold">${row.glucose || '-'}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${row.note || ''}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>