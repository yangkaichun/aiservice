<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PancadAI CRM V6.7 - Filter & Avatar Fix Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="https://www.pancad.ai/static/images/favicon.ico?v=20240229">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            --sidebar-bg: #2c3e50;
            --bg-color: #f3f4f6;
        }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); position: relative; overflow: hidden; padding: 20px; }
        .login-card { width: 100%; max-width: 400px; padding: 2rem; border-radius: 20px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); text-align: center; }

        .sidebar { min-height: 100vh; background-color: var(--sidebar-bg); color: white; box-shadow: 4px 0 10px rgba(0,0,0,0.05); }
        .mobile-navbar { background: var(--sidebar-bg); padding: 10px 20px; color: white; display: none; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-link { color: rgba(255,255,255,0.7); margin: 8px 0; border-radius: 8px; transition: all 0.3s ease; padding: 10px 15px; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.15); transform: translateX(5px); }
        .nav-link.active { background: var(--primary-gradient); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .card { border: none; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; background: #fff; margin-bottom: 1.5rem; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
        
        .cursor-pointer { cursor: pointer; }
        .table-hover tbody tr.cursor-pointer:hover { background-color: rgba(78, 115, 223, 0.05); }
        .table-hover tbody tr.active-row { background-color: rgba(78, 115, 223, 0.15) !important; }

        .card-revenue { background: linear-gradient(120deg, #2c3e50 0%, #4ca1af 100%); color: white; padding: 0; }
        .revenue-item { padding: 2rem; position: relative; }
        .revenue-item:first-child { border-right: 1px solid rgba(255,255,255,0.2); }
        .revenue-title { font-size: 0.9rem; opacity: 0.8; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
        .revenue-value { font-size: 2.2rem; font-weight: 700; letter-spacing: 0.5px; }
        .revenue-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 3rem; opacity: 0.15; }
        .text-gross { color: #6dd5fa; }
        .text-net { color: #a8ff78; }

        .card-kpi { padding: 1.5rem; position: relative; border-top: 5px solid transparent; }
        .kpi-content { position: relative; z-index: 2; }
        .kpi-title { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: #858796; margin-bottom: 0.5rem; }
        .kpi-number { font-size: 2.5rem; font-weight: 800; color: #5a5c69; line-height: 1; }
        .kpi-bg-icon { position: absolute; right: 15px; bottom: 10px; font-size: 4.5rem; opacity: 0.1; transform: rotate(-15deg); z-index: 1; transition: transform 0.3s ease; }
        .card-kpi:hover .kpi-bg-icon { transform: rotate(0deg) scale(1.1); opacity: 0.2; }
        
        .kpi-orange { border-top-color: #f6c23e; } .kpi-orange .kpi-bg-icon { color: #f6c23e; }
        .kpi-teal { border-top-color: #36b9cc; } .kpi-teal .kpi-bg-icon { color: #36b9cc; }
        .kpi-blue { border-top-color: #4e73df; } .kpi-blue .kpi-bg-icon { color: #4e73df; }
        .kpi-green { border-top-color: #1cc88a; } .kpi-green .kpi-bg-icon { color: #1cc88a; }

        .chart-controls { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .date-input { border: 1px solid #e3e6f0; border-radius: 8px; padding: 5px 12px; color: #5a5c69; outline: none; flex-grow: 1; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-custom { min-width: 600px; } 
        .table-custom thead { background-color: #f8f9fc; }
        .table-custom th { font-weight: 600; color: #4e73df; text-transform: uppercase; font-size: 0.8rem; border-bottom: 2px solid #e3e6f0; white-space: nowrap; }
        .table-custom td { vertical-align: middle; font-size: 0.9rem; color: #5a5c69; white-space: nowrap; }
        .status-badge { padding: 6px 12px; border-radius: 30px; font-weight: 600; font-size: 0.75rem; cursor: pointer; }
        
        /* --- ğŸš€ çµ¢éº—çš„é«˜ç§‘æŠ€ Loading å‹•ç•« CSS --- */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.9); 
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            backdrop-filter: blur(10px); 
        }
        .loader-wrapper { position: relative; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; }
        .ring-outer {
            position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 4px solid transparent;
            border-top-color: #4e73df; border-bottom-color: #1cc88a;
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite; box-shadow: 0 0 25px rgba(78, 115, 223, 0.4);
        }
        .ring-inner {
            position: absolute; width: 65%; height: 65%; border-radius: 50%; border: 4px solid transparent;
            border-left-color: #36b9cc; border-right-color: #f6c23e;
            animation: spin-reverse 2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite; box-shadow: 0 0 15px rgba(54, 185, 204, 0.5);
        }
        .loader-core {
            width: 25%; height: 25%; border-radius: 50%; background: linear-gradient(135deg, #1cc88a, #36b9cc);
            animation: core-pulse 1s ease-in-out infinite alternate; box-shadow: 0 0 35px #1cc88a;
        }
        .loading-text {
            margin-top: 30px; font-size: 1.1rem; font-weight: 800; letter-spacing: 4px;
            background: linear-gradient(90deg, #6dd5fa, #ffffff, #a8ff78, #6dd5fa); background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: text-shine 2s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(-360deg); } }
        @keyframes core-pulse { 0% { transform: scale(0.7); opacity: 0.6; } 100% { transform: scale(1.3); opacity: 1; } }
        @keyframes text-shine { to { background-position: 200% center; } }
        /* --- Loading å‹•ç•« CSS çµæŸ --- */

        @media (max-width: 768px) {
            .sidebar { min-height: auto; position: fixed; top: 50px; left: 0; width: 100%; z-index: 1000; height: calc(100vh - 50px); overflow-y: auto; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            .sidebar.show { transform: translateX(0); }
            .mobile-navbar { display: flex; position: fixed; top: 0; left: 0; width: 100%; z-index: 1001; height: 50px; }
            .col-md-10 { margin-top: 50px; padding: 15px; }
            .mobile-user-info { display: block; padding: 15px; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
            .revenue-item:first-child { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.2); }
        }
        @media (min-width: 769px) { .mobile-user-info { display: none; } }
    </style>
</head>
<body>
    <div id="loading-overlay" class="d-none">
        <div class="loader-wrapper">
            <div class="ring-outer"></div>
            <div class="ring-inner"></div>
            <div class="loader-core"></div>
        </div>
        <div class="loading-text" id="loading-text-display">SYNCING DATA...</div>
    </div>
    
    <section id="login-view" class="login-container">
        <div class="login-card">
            <div class="mb-4"><i class="fas fa-chart-network fa-3x text-primary"></i></div>
            <h2 class="mb-2 fw-bold text-dark">PancadAI CRM</h2>
            <p class="text-muted mb-4">Market & Sales Management</p>
            <div id="g_id_onload" data-client_id="469731622214-uiqtuprq4293g3j09nfq5c43uvldadfj.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="center" data-width="280"></div>
        </div>
    </section>

    <div id="app-view" class="container-fluid d-none">
        <div class="mobile-navbar"><span class="fw-bold">PancadAI Manager</span><button class="btn btn-sm btn-outline-light" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button></div>
        <div class="row">
            <div class="col-md-2 sidebar p-3" id="main-sidebar">
                <div class="mobile-user-info"><div class="d-flex align-items-center">
                    <img id="mobile-user-avatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PHBhdGggZD0iTTEyIDJDMi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMyMS41MiAyIDEyIDJ6bTAgM2MzLjE5IDAgNS43OSAyLjU5IDUuNzkgNS43OVMxNS4xOSAxNi41OCAxMiAxNi41OHMtNS43OS0yLjU5LTUuNzktNS43OVM4LjgxIDUgMTIgNXptMCAxNC4yYy0yLjUgMC00LjcxLTEuMjgtNi4wMi0zLjIyLjA0LTEuOTkgNC0zLjA4IDYuMDItMy4wOHMyLjk4IDEuMDkgNi4wMiAzLjA4Yy0xLjMxIDEuOTQtMy41MiAzLjIyLTYuMDIgMy4yMnoiLz48L3N2Zz4=" class="rounded-circle me-2 border border-white" style="width:30px">
                    <span id="mobile-user-name">User</span>
                </div></div>
                <div class="text-center mb-4 mt-3 d-none d-md-block"><h5 class="fw-bold mb-0">PancadAI</h5><small class="text-white-50" style="font-size: 0.7rem;">MANAGER CONSOLE</small></div>
                <div class="d-flex align-items-center mb-4 px-3 py-2 bg-white bg-opacity-10 rounded-3 d-none d-md-flex">
                    <img id="user-avatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PHBhdGggZD0iTTEyIDJDMi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMyMS41MiAyIDEyIDJ6bTAgM2MzLjE5IDAgNS43OSAyLjU5IDUuNzkgNS43OVMxNS4xOSAxNi41OCAxMiAxNi41OHMtNS43OS0yLjU5LTUuNzktNS43OVM4LjgxIDUgMTIgNXptMCAxNC4yYy0yLjUgMC00LjcxLTEuMjgtNi4wMi0zLjIyLjA0LTEuOTkgNC0zLjA4IDYuMDItMy4wOHMyLjk4IDEuMDkgNi4wMiAzLjA4Yy0xLjMxIDEuOTQtMy41MiAzLjIyLTYuMDIgMy4yMnoiLz48L3N2Zz4=" class="rounded-circle me-2 border border-2 border-white" style="width:32px">
                    <span id="user-name" class="text-truncate" style="font-size:0.85rem; font-weight:500; max-width: 100px;">User</span>
                </div>
                <ul class="nav flex-column" onclick="if(window.innerWidth<768) toggleSidebar()">
                    <li class="nav-item"><a class="nav-link active" onclick="showPage('dashboard')"><i class="fas fa-home me-2"></i> æˆ°ç•¥ç¸½è¦½</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('radar')"><i class="fas fa-crosshairs me-2"></i> æˆ°è¡“é›·é”</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('hospitals')"><i class="fas fa-hospital me-2"></i> é†«é™¢åˆç´„</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="openHospitalInput()"><i class="fas fa-plus-circle me-2"></i> æ–°å¢é†«é™¢</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('kols')"><i class="fas fa-user-md me-2"></i> KOL æ‹œè¨ª</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showPage('finance')"><i class="fas fa-file-invoice-dollar me-2"></i> è²¡å‹™çµç®—</a></li>
                    <li class="nav-item d-none" id="nav-admin"><hr class="text-white-50"><a class="nav-link text-warning" onclick="showPage('admin')"><i class="fas fa-user-shield me-2"></i> ç®¡ç†å¾Œå°</a></li>
                    <hr class="text-white-50"><li class="nav-item"><a class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> ç™»å‡ºç³»çµ±</a></li>
                </ul>
            </div>
            
            <div class="col-md-10 p-4" style="height: 100vh; overflow-y: auto;">
                
                <div id="page-dashboard" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark m-0 text-nowrap flex-shrink-0">Director Dashboard</h3>
                    </div>
                    
                    <div class="card card-revenue mb-4">
                        <div class="row g-0">
                            <div class="col-md-6 revenue-item">
                                <div class="revenue-title text-uppercase">Gross Revenue (å€é–“ç¸½ç‡Ÿæ”¶)</div>
                                <div class="revenue-value text-gross" id="kpi-gross-display">$0</div>
                                <div class="revenue-icon"><i class="fas fa-hand-holding-usd"></i></div>
                            </div>
                            <div class="col-md-6 revenue-item">
                                <div class="revenue-title text-uppercase">Net Revenue (å¯¦éš›æ·¨åˆ©)</div>
                                <div class="revenue-value text-net" id="kpi-net-display">$0</div>
                                <div class="revenue-icon"><i class="fas fa-wallet"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-kpi kpi-orange h-100 cursor-pointer" onclick="openDrilldown('kols')">
                                <div class="kpi-content"><div class="kpi-title">å·²æ¥è§¸ KOLs</div><div class="kpi-number" id="kpi-kol-count">0</div></div>
                                <i class="fas fa-user-md kpi-bg-icon"></i>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-kpi kpi-teal h-100 cursor-pointer" onclick="openDrilldown('developing')">
                                <div class="kpi-content"><div class="kpi-title">é–‹ç™¼ä¸­é†«é™¢</div><div class="kpi-number" id="kpi-dev-hospital-count">0</div></div>
                                <i class="fas fa-hospital-user kpi-bg-icon"></i>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-kpi kpi-blue h-100 cursor-pointer" onclick="openDrilldown('intro')">
                                <div class="kpi-content"><div class="kpi-title">ç”¢å“ä»‹ç´¹ä¸­</div><div class="kpi-number" id="kpi-intro-hospital-count">0</div></div>
                                <i class="fas fa-chalkboard-teacher kpi-bg-icon"></i>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-kpi kpi-green h-100 cursor-pointer" onclick="openDrilldown('signed')">
                                <div class="kpi-content"><div class="kpi-title">å·²ç°½ç´„é†«é™¢</div><div class="kpi-number" id="kpi-signed-hospital-count">0</div></div>
                                <i class="fas fa-file-signature kpi-bg-icon"></i>
                            </div>
                        </div>
                    </div>

                    <div class="chart-controls">
                        <i class="fas fa-calendar-alt text-primary"></i>
                        <span class="fw-bold text-dark small d-none d-md-inline text-nowrap">æ•¸æ“šå€é–“ï¼š</span>
                        <input type="month" id="dash-start" class="date-input" onchange="updateDashboardCharts()">
                        <span class="text-muted fw-bold">~</span>
                        <input type="month" id="dash-end" class="date-input" onchange="updateDashboardCharts()">
                        <button class="btn btn-sm btn-primary ms-auto px-3 w-100 w-md-auto mt-2 mt-md-0 text-nowrap" onclick="updateDashboardCharts()"><i class="fas fa-sync-alt me-1"></i> æ›´æ–°åœ–è¡¨</button>
                    </div>

                    <div class="row g-3">
                        <div class="col-12">
                            <div class="card p-4 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-4"><h5 class="fw-bold text-dark m-0 text-nowrap flex-shrink-0"><i class="fas fa-chart-line me-2 text-primary"></i>ç‡Ÿæ”¶è¶¨å‹¢</h5></div>
                                <div style="height: 300px; position: relative;"><canvas id="chart-trend"></canvas></div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-6">
                            <div class="card p-4 h-100">
                                <h5 class="fw-bold mb-4 text-dark text-nowrap flex-shrink-0"><i class="fas fa-chart-pie me-2 text-success"></i>å·²ç°½ç´„é†«é™¢ - å€åŸŸä½”æ¯”</h5>
                                <div style="height: 250px; display: flex; justify-content: center;"><canvas id="chart-region"></canvas></div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-6">
                            <div class="card p-4 h-100">
                                <h5 class="fw-bold mb-4 text-dark text-nowrap flex-shrink-0"><i class="fas fa-chart-pie me-2 text-info"></i>é–‹ç™¼ä¸­é†«é™¢ - å€åŸŸä½”æ¯”</h5>
                                <div style="height: 250px; display: flex; justify-content: center;"><canvas id="chart-dev-region"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-radar" class="page-content d-none">
                    <h3 class="mb-3 text-nowrap flex-shrink-0">æˆ°è¡“é›·é”</h3>
                    <div class="card p-4 mb-4"><div class="row g-3"><div class="col-6 col-md-3"><label class="form-label small text-muted">è¡Œæ”¿å€</label><select class="form-select" id="radar-filter-region" onchange="renderRadarTable()"></select></div><div class="col-6 col-md-3"><label class="form-label small text-muted">è¦æ¨¡</label><select class="form-select" id="radar-filter-level" onchange="renderRadarTable()"></select></div><div class="col-12 col-md-3"><label class="form-label small text-muted">ç‹€æ…‹</label><select class="form-select" id="radar-filter-status" onchange="renderRadarTable()"><option value="All">å…¨éƒ¨</option><option value="å·²ç°½ç´„">å·²ç°½ç´„</option><option value="é–‹ç™¼ä¸­">é–‹ç™¼ä¸­</option></select></div><div class="col-12 col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100 text-nowrap" onclick="renderRadarTable()"><i class="fas fa-sync-alt me-1"></i>é‡æ–°æ•´ç†</button></div></div></div>
                    <div class="card border-0 shadow-sm overflow-hidden"><div class="table-responsive"><table class="table table-custom table-hover mb-0 align-middle"><tbody id="radar-table-body"></tbody></table></div></div>
                </div>

                <div id="page-hospitals" class="page-content d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3"><h3 class="m-0 text-nowrap flex-shrink-0">é†«é™¢åˆç´„</h3><button class="btn btn-success text-nowrap" onclick="openHospitalInput()"><i class="fas fa-plus"></i> æ–°å¢</button></div>
                    <div class="card border-0 shadow-sm overflow-hidden"><div class="table-responsive"><table class="table table-custom table-hover mb-0 align-middle"><thead class="table-light"><tr><th>åç¨±</th><th>ç­‰ç´š</th><th>å–®åƒ¹</th><th>æ’ä»–æ€§</th><th>åˆç´„è¿„æ—¥</th><th>æ“ä½œ</th></tr></thead><tbody id="hospital-list-body"></tbody></table></div></div>
                </div>

                <div id="page-hospital-input" class="page-content d-none">
                    <h3 class="mb-3 text-nowrap flex-shrink-0">æ–°å¢/ç·¨è¼¯é†«é™¢è³‡æ–™</h3>
                    <div class="card p-3 p-md-4 shadow-sm" style="max-width: 900px;">
                        <form id="form-hospital"><input type="hidden" id="h-id"><div class="row g-3"><div class="col-12 col-md-6"><label class="form-label">é†«é™¢åç¨±</label><input type="text" class="form-control" id="h-name" required></div><div class="col-6 col-md-3"><label class="form-label">å€åŸŸ</label><select class="form-select" id="h-region"></select></div><div class="col-6 col-md-3"><label class="form-label">è¦æ¨¡</label><select class="form-select" id="h-level"></select></div><div class="col-12"><label class="form-label">åœ°å€</label><input type="text" class="form-control" id="h-address"></div><div class="col-6 col-md-4"><label class="form-label">ç‹€æ…‹</label><select class="form-select" id="h-status"><option>æœªæ¥è§¸</option><option>é–‹ç™¼ä¸­</option><option>å·²ç°½ç´„</option></select></div><div class="col-6 col-md-4"><label class="form-label">æ’ä»–æ¢æ¬¾</label><select class="form-select" id="h-exclusivity"><option value="No">No</option><option value="Yes">Yes</option></select></div><div class="col-12 col-md-4"><label class="form-label">å–®æ¬¡å–®åƒ¹</label><input type="number" class="form-control" id="h-unit-price"></div><hr class="my-4"><div class="col-12 col-md-4"><label class="form-label">EBMåˆ†æ½¤(%)</label><input type="number" class="form-control" id="h-ebm" value="0"></div><div class="col-6 col-md-4"><label class="form-label">åˆç´„é–‹å§‹</label><input type="date" class="form-control" id="h-start"></div><div class="col-6 col-md-4"><label class="form-label">åˆç´„çµæŸ</label><input type="date" class="form-control" id="h-end"></div><div class="col-12"><label class="form-label">åˆç´„æª”æ¡ˆ (PDF)</label><div class="input-group"><input type="file" class="form-control" id="h-file" accept="application/pdf"><a href="#" target="_blank" id="btn-view-contract" class="btn btn-outline-secondary d-none"><i class="fas fa-eye"></i></a></div><input type="hidden" id="h-link"></div></div><div class="mt-4"><button type="button" class="btn btn-primary px-4 w-100 w-md-auto text-nowrap" onclick="submitHospital()">å„²å­˜</button><button type="button" class="btn btn-light ms-0 ms-md-2 mt-2 mt-md-0 w-100 w-md-auto text-nowrap" onclick="showPage('hospitals')">å–æ¶ˆ</button></div></form>
                    </div>
                </div>

                <div id="page-kols" class="page-content d-none">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
                        <div class="d-flex flex-wrap align-items-center gap-2 w-100">
                            <h3 class="m-0 text-nowrap flex-shrink-0 me-2">KOL æ‹œè¨ª</h3>
                            <select class="form-select form-select-sm shadow-sm flex-grow-1" id="kol-filter-hospital" onchange="renderKOLList()" style="max-width: 200px; min-width: 140px;">
                                <option value="All">ç¯©é¸é†«é™¢ï¼šå…¨éƒ¨</option>
                            </select>
                            <input type="text" class="form-control form-control-sm shadow-sm flex-grow-1" id="kol-filter-keyword" placeholder="ğŸ” æœå°‹å§“åæˆ–é†«é™¢..." oninput="renderKOLList()" style="max-width: 200px; min-width: 150px;">
                        </div>
                        <button class="btn btn-success shadow-sm text-nowrap" onclick="openKOLModal()"><i class="fas fa-plus"></i> æ–°å¢</button>
                    </div>
                    <div class="card border-0 shadow-sm overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-custom table-hover mb-0 align-middle"><thead class="table-light"><tr><th>å§“å</th><th>é†«é™¢</th><th>è·ç¨±</th><th>Email</th><th>éšæ®µ</th><th>æ©Ÿç‡</th><th>æ“ä½œ</th></tr></thead><tbody id="kol-list-body"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="page-finance" class="page-content d-none">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                        <h3 class="mb-2 mb-md-0 text-nowrap flex-shrink-0 me-3">è²¡å‹™çµç®—</h3>
                        <div class="d-flex gap-2 w-100 w-md-auto">
                            <input type="month" id="finance-month-picker" class="form-control flex-grow-1" onchange="renderFinanceTable()">
                            <button class="btn btn-success text-nowrap" onclick="openSettlementModal()">æ–°å¢çµç®—</button>
                        </div>
                    </div>
                    <div class="row mb-4 g-3">
                        <div class="col-6 col-md-3"><div class="card p-3 border-start border-4 border-primary"><span class="small text-muted">æœ¬æœˆé ä¼°</span><div class="fs-5 fw-bold text-primary" id="fin-kpi-gross">$0</div></div></div>
                        <div class="col-6 col-md-3"><div class="card p-3 border-start border-4 border-success"><span class="small text-muted">æœ¬æœˆå¯¦æ”¶</span><div class="fs-5 fw-bold text-success" id="fin-kpi-net">$0</div></div></div>
                        <div class="col-6 col-md-3"><div class="card p-3 border-start border-4 border-warning"><span class="small text-muted">å¾…æ”¶æ¬¾</span><div class="fs-5 fw-bold text-warning" id="fin-kpi-ar">$0</div></div></div>
                        <div class="col-6 col-md-3"><div class="card p-3 border-start border-4 border-danger"><span class="small text-muted">æ‡‰ä»˜EBM</span><div class="fs-5 fw-bold text-danger" id="fin-kpi-ebm">$0</div></div></div>
                    </div>
                    <div class="card border-0 shadow-sm overflow-hidden mb-5"><div class="table-responsive"><table class="table table-custom table-hover mb-0 align-middle"><thead class="table-light"><tr><th>é†«é™¢</th><th>æ¬¡æ•¸</th><th>å–®åƒ¹</th><th>Gross</th><th>Net</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody id="finance-table-body"></tbody></table></div></div>

                    <hr class="my-5" style="border-top: 2px dashed #e3e6f0; opacity: 1;">
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
                        <h4 class="mb-0 fw-bold text-dark text-nowrap flex-shrink-0"><i class="fas fa-chart-bar me-2 text-primary"></i>æ­·å²ä½¿ç”¨é‡èˆ‡ç‡Ÿæ”¶åˆ†æ</h4>
                        <div class="d-flex gap-2 w-100 w-lg-auto align-items-center">
                            <span class="fw-bold text-dark small d-none d-md-inline text-nowrap">å€é–“ï¼š</span>
                            <input type="month" id="usage-start" class="form-control form-control-sm" onchange="renderUsageAnalytics()">
                            <span class="text-muted fw-bold">~</span>
                            <input type="month" id="usage-end" class="form-control form-control-sm" onchange="renderUsageAnalytics()">
                            <button class="btn btn-sm btn-primary text-nowrap" onclick="renderUsageAnalytics()"><i class="fas fa-sync-alt me-1"></i>æ›´æ–°</button>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-lg-8">
                            <div class="card p-4 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="fw-bold text-dark m-0 text-nowrap flex-shrink-0" id="usage-chart-title">æ‰€æœ‰é†«é™¢ - æ¯æœˆè¶¨å‹¢åˆ†æ</h5>
                                    <button class="btn btn-sm btn-outline-secondary d-none text-nowrap flex-shrink-0" id="btn-usage-back" onclick="selectUsageHospital(null)"><i class="fas fa-arrow-left me-1"></i>æŸ¥çœ‹æ‰€æœ‰é†«é™¢</button>
                                </div>
                                <div style="height: 250px; position: relative; margin-bottom: 20px;"><canvas id="chart-usage-trend"></canvas></div>
                                <div style="height: 250px; position: relative;"><canvas id="chart-usage-revenue"></canvas></div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-4">
                            <div class="card p-4 h-100">
                                <h5 class="fw-bold mb-4 text-dark text-nowrap flex-shrink-0">å·²ç°½ç´„é†«é™¢ä½¿ç”¨æ’è¡Œ <br><small class="text-muted fs-6 fw-normal">(é»æ“Šå¯çœ‹å–®ä¸€é†«é™¢è¶¨å‹¢)</small></h5>
                                <div class="table-responsive" style="max-height: 550px; overflow-y: auto;">
                                    <table class="table table-sm table-hover mb-0 align-middle table-custom" id="usage-ranking-table">
                                        <thead class="table-light sticky-top">
                                            <tr><th>æ’å</th><th>é†«é™¢</th><th class="text-end">ç¸½æ¬¡æ•¸</th></tr>
                                        </thead>
                                        <tbody id="usage-ranking-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-admin" class="page-content d-none">
                     <h3 class="mb-4 text-nowrap flex-shrink-0">ç®¡ç†è€…å¾Œå°</h3>
                     <ul class="nav nav-tabs mb-3"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#content-users">ä½¿ç”¨è€…</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-logs">æ—¥èªŒ</button></li></ul>
                     <div class="tab-content">
                        <div class="tab-pane fade show active" id="content-users"><button class="btn btn-warning btn-sm mb-2" onclick="openUserModal()">æ–°å¢</button>
                            <div class="table-responsive"><table class="table table-custom"><tbody id="admin-users-body"></tbody></table></div>
                        </div>
                        <div class="tab-pane fade" id="content-logs"><button class="btn btn-sm btn-outline-secondary mb-2" onclick="loadAdminData()">Refresh</button>
                            <div class="table-responsive"><table class="table table-sm table-striped"><tbody id="admin-logs-body"></tbody></table></div>
                        </div>
                     </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalDrilldown" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="drilldown-title">æ¸…å–®é è¦½</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive" style="max-height: 50vh; overflow-y: auto;">
                        <table class="table table-hover mb-0 align-middle table-custom">
                            <thead class="table-light" id="drilldown-thead"></thead>
                            <tbody id="drilldown-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light p-2">
                    <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSettlement" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">æœˆçµè³‡æ–™</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-settlement">
        <input type="hidden" id="s-record-id">
        <div class="mb-3"><label>æ—¥æœŸ</label><input type="date" class="form-control" id="s-date" required></div>
        <div class="mb-3"><label>é†«é™¢</label><select class="form-select" id="s-hospital" onchange="calcPreview()" required></select><div class="form-text" id="s-hosp-info"></div></div><div class="mb-3"><label>æ¬¡æ•¸</label><input type="number" class="form-control" id="s-usage" oninput="calcPreview()" required></div><div class="alert alert-light border">Gross: <span id="s-prev-gross">$0</span> | Net: <span id="s-prev-net">$0</span></div><div class="mb-3"><label>å‚™è¨»</label><input type="text" class="form-control" id="s-note"></div></form></div>
    <div class="modal-footer d-flex justify-content-between"><button type="button" class="btn btn-danger" id="btn-delete-settlement" onclick="deleteSettlement()" style="display:none;">åˆªé™¤</button><div><button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary" onclick="submitSettlement()">å„²å­˜</button></div></div></div></div></div>
    
    <div class="modal fade" id="modalKOL" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ç·¨è¼¯ KOL</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-kol">
                        <input type="hidden" id="k-id">
                        <select class="form-select mb-2" id="k-hospital-id"></select>
                        <input type="text" class="form-control mb-2" id="k-name" placeholder="å§“å">
                        <input type="text" class="form-control mb-2" id="k-title" placeholder="è·ç¨±">
                        <input type="text" class="form-control mb-2" id="k-phone" placeholder="é€£çµ¡é›»è©±">
                        <input type="email" class="form-control mb-2" id="k-email" placeholder="Email">
                        
                        <select class="form-select mb-2" id="k-stage" onchange="if(this.value.includes('å·²æˆäº¤')) { document.getElementById('k-prob').value=100; document.getElementById('k-prob-val').innerText='100%'; }">
                            <option>1.åˆæ¬¡æ¥è§¸</option>
                            <option>2.ç”¢å“å±•ç¤º</option>
                            <option>3.è©¦ç”¨ä¸­</option>
                            <option>4.è­°åƒ¹ä¸­</option>
                            <option>5.å·²æˆäº¤</option>
                        </select>
                        
                        <div class="mb-2 px-1">
                            <label class="form-label small text-muted mb-0 d-flex justify-content-between">
                                <span>æˆäº¤æ©Ÿç‡</span>
                                <span id="k-prob-val" class="fw-bold text-primary">20%</span>
                            </label>
                            <input type="range" class="form-range" id="k-prob" min="20" max="100" step="20" value="20" oninput="document.getElementById('k-prob-val').innerText = this.value + '%'">
                        </div>
                        
                        <textarea class="form-control" id="k-note" placeholder="ç­†è¨˜"></textarea>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="submitKOL()">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalUser" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">ç·¨è¼¯ä½¿ç”¨è€…</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-user"><input type="email" class="form-control mb-2" id="u-email" placeholder="Email"><input type="text" class="form-control mb-2" id="u-name" placeholder="å§“å"><select class="form-select mb-2" id="u-role"><option value="User">User</option><option value="Admin">Admin</option></select><select class="form-select" id="u-status"><option value="Active">Active</option><option value="Suspended">Suspended</option></select></form></div><div class="modal-footer"><button class="btn btn-warning" onclick="submitUser()">å„²å­˜</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="config.js"></script>
    <script src="app.js"></script>
</body>
</html>