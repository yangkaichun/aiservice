<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health+ OCR è¬ç”¨ç‰ˆ</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        :root {
            --primary-color: #E60012;
            --bg-color: #121212;
            --text-color: #ffffff;
            --guide-color: #00C0F3;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¸Šæ–¹é¡¯ç¤ºå€åŸŸ (Video æˆ– é è¦½åœ–) */
        #display-container {
            position: relative;
            flex: 1;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        video, #preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #preview-img { display: none; } /* é è¨­éš±è—éœæ…‹åœ– */

        /* æƒæå¼•å°æ¡† */
        #guide-box {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 25%;
            border: 2px solid var(--guide-color);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            z-index: 10;
            pointer-events: none;
            transition: all 0.3s;
        }
        #guide-text {
            position: absolute;
            top: -35px;
            left: 0;
            width: 100%;
            text-align: center;
            color: var(--guide-color);
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            font-size: 14px;
        }

        /* ä¸‹æ–¹æ§åˆ¶å€ */
        #controls {
            background: #1e1e1e;
            padding: 20px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            z-index: 20;
            flex-shrink: 0;
        }

        /* æ¨¡å¼åˆ‡æ› Tabs */
       .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            background: #333;
            border-radius: 20px;
            padding: 4px;
        }
       .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            color: #aaa;
        }
       .tab.active {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
       .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
       .btn-capture { background: white; color: var(--primary-color); }
       .btn-upload { background: var(--primary-color); color: white; }
       .btn-upload:disabled { background: #555; color: #888; }

        /* éš±è—çš„åŸç”Ÿæª”æ¡ˆè¼¸å…¥æ¡† */
        #native-camera-input { display: none; }

        /* ç‹€æ…‹æç¤º */
        #status-bar {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            height: 20px;
        }

        /* ç·¨è¼¯çµæœå½ˆçª— */
        #result-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
       .form-group { margin-bottom: 15px; }
       .form-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 14px; }
       .form-group input {
            width: 100%; padding: 12px;
            background: #333; border: 1px solid #555;
            border-radius: 6px; color: white; font-size: 16px;
            box-sizing: border-box;
        }

        /* Loading å‹•ç•« */
       .loading-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 50;
            justify-content: center; align-items: center; flex-direction: column;
        }
       .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="display-container">
    <video id="video" autoplay playsinline muted></video>
    <img id="preview-img" alt="Captured Photo">
    
    <div id="guide-box">
        <div id="guide-text">è«‹å°‡å„€å™¨æ•¸å€¼ç½®æ–¼æ¡†å…§</div>
    </div>

    <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
        <div id="loader-text">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>
</div>

<canvas id="process-canvas" style="display:none;"></canvas>

<input type="file" id="native-camera-input" accept="image/*" capture="environment">

<div id="controls">
    <div class="tabs">
        <div class="tab active" onclick="setMode('vital')">ç”Ÿç†å„€å™¨</div>
        <div class="tab" onclick="setMode('id')">èº«åˆ†è­‰/å¥ä¿å¡</div>
    </div>

    <button class="btn btn-capture" id="main-btn" onclick="handleMainButton()">
        ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ / æ‹ç…§
    </button>
    
    <div id="status-bar">æº–å‚™å°±ç·’</div>
</div>

<div id="result-modal">
    <h2 style="margin-top:0; color:white;">è¾¨è­˜çµæœ</h2>
    <div id="dynamic-fields"></div>
    <br>
    <button class="btn btn-upload" id="upload-btn" onclick="simulateUpload()">
        â˜ï¸ ä¸Šå‚³è‡³é å‚³ Health+
    </button>
    <button class="btn" style="background:transparent; border:1px solid #555; color:#aaa;" onclick="closeModal()">
        é‡æ–°æ‹æ”
    </button>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    const video = document.getElementById('video');
    const previewImg = document.getElementById('preview-img');
    const canvas = document.getElementById('process-canvas');
    const ctx = canvas.getContext('2d');
    const nativeInput = document.getElementById('native-camera-input');
    const statusBar = document.getElementById('status-bar');
    const loader = document.getElementById('loader');
    
    let currentMode = 'vital'; // 'vital' | 'id'
    let useNativeCamera = false; // æ˜¯å¦ä½¿ç”¨åŸç”Ÿç›¸æ©Ÿ (é™ç´šæ¨¡å¼)
    let worker = null; // Tesseract Worker

    // --- 1. æ ¸å¿ƒå•Ÿå‹•é‚è¼¯ (æ··åˆæ¨¡å¼) ---
    async function initSystem() {
        // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ getUserMedia ä»¥åŠæ˜¯å¦åœ¨å®‰å…¨ç’°å¢ƒ (HTTPS/Localhost)
        const isSecure = window.isSecureContext;
        const hasMediaAPI = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;

        if (isSecure && hasMediaAPI) {
            // å˜—è©¦å•Ÿå‹•å³æ™‚è¦–è¨Šæµ
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment", // å¾Œé¡é ­
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }, 
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => video.play();
                useNativeCamera = false;
                statusBar.innerText = "æ¨¡å¼ï¼šå³æ™‚è¦–è¨Šæƒæ";
            } catch (err) {
                console.warn("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œåˆ‡æ›è‡³åŸç”Ÿæ¨¡å¼", err);
                enableNativeMode("ç›¸æ©Ÿæ¬Šé™è¢«æ‹’æˆ–ä¸æ”¯æ´");
            }
        } else {
            // ç’°å¢ƒä¸æ”¯æ´ (ä¾‹å¦‚ HTTP)ï¼Œç›´æ¥åˆ‡æ›åˆ°åŸç”Ÿæ¨¡å¼
            enableNativeMode("ç›®å‰ç’°å¢ƒä¸æ”¯æ´å³æ™‚è¦–è¨Šï¼Œå·²åˆ‡æ›è‡³ç›¸å®¹æ¨¡å¼");
        }
    }

    function enableNativeMode(reason) {
        useNativeCamera = true;
        video.style.display = 'none';
        previewImg.style.display = 'block';
        // é¡¯ç¤ºä¸€å¼µé è¨­åœ–æˆ–é»‘åº•
        previewImg.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23333'/%3E%3Ctext x='50' y='50' fill='%23666' font-size='10' text-anchor='middle'%3Eç›¸å®¹æ¨¡å¼%3C/text%3E%3C/svg%3E";
        statusBar.innerText = reason;
        document.getElementById('main-btn').innerText = "ğŸ“· é–‹å•Ÿæ‰‹æ©Ÿç›¸æ©Ÿ (ç›¸å®¹æ¨¡å¼)";
    }

    // --- 2. æŒ‰éˆ•è¡Œç‚ºåˆ†æµ ---
    function handleMainButton() {
        if (useNativeCamera) {
            // è§¸ç™¼éš±è—çš„ input click
            nativeInput.click();
        } else {
            // æˆªå– Video ç•«é¢
            captureFromVideo();
        }
    }

    // ç›£è½åŸç”Ÿç›¸æ©Ÿæª”æ¡ˆé¸å–
    nativeInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files) {
            const file = e.target.files;
            const reader = new FileReader();
            
            showLoader("è®€å–ç…§ç‰‡ä¸­...");
            
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = () => {
                    // ç¹ªè£½åˆ° Canvas é€²è¡Œè™•ç†
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    previewImg.src = evt.target.result; // é¡¯ç¤ºé è¦½
                    processAndRecognize(); // é–‹å§‹è¾¨è­˜
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // å¾ Video æˆªåœ–
    function captureFromVideo() {
        if (!video.videoWidth) return;
        showLoader("å½±åƒæ“·å–ä¸­...");
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        processAndRecognize();
    }

    // --- 3. å½±åƒè™•ç†èˆ‡ OCR ---
    async function processAndRecognize() {
        showLoader("å½±åƒå„ªåŒ–èˆ‡è¾¨è­˜ä¸­...");

        // è£åˆ‡ ROI (æ„Ÿèˆˆè¶£å€åŸŸ) - æ¨¡æ“¬åªè¾¨è­˜æ¡†æ¡†å…§
        // ç°¡å–®å¯¦ä½œï¼šå–ä¸­å¤® 80% å€åŸŸ
        const w = canvas.width;
        const h = canvas.height;
        let sx, sy, sw, sh;

        if (currentMode === 'vital') {
            sw = w * 0.8; sh = h * 0.3; // å„€å™¨é€šå¸¸æ˜¯æ©«é•·æ¢
        } else {
            sw = w * 0.85; sh = sw * 0.63; // è­‰ä»¶æ¯”ä¾‹
        }
        sx = (w - sw) / 2;
        sy = (h - sh) / 2;

        // å–å¾— ROI åƒç´ 
        const imgData = ctx.getImageData(sx, sy, sw, sh);
        
        // ç°¡å–®äºŒå€¼åŒ–å¢å¼· (Otsu ç°¡åŒ–ç‰ˆé‚è¼¯ï¼šå¢å¼·å°æ¯”)
        // ç‚ºäº†ç¢ºä¿æ‰‹æ©Ÿæ•ˆèƒ½ï¼Œä½¿ç”¨ç°¡å–®çš„é–¾å€¼è™•ç†
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            const avg = (d[i] + d[i+1] + d[i+2]) / 3;
            // å¢å¼·å°æ¯”ï¼šå¤§æ–¼ 100 è®Šç™½ï¼Œå°æ–¼è®Šé»‘ (æ¨¡æ“¬ LCD)
            const v = avg > 100? 255 : 0;
            d[i] = d[i+1] = d[i+2] = v;
        }
        
        // å°‡è™•ç†å¾Œçš„ ROI æ”¾å› Canvas (ç‚ºäº†è½‰ base64)
        canvas.width = sw;
        canvas.height = sh;
        ctx.putImageData(imgData, 0, 0);
        
        const finalImage = canvas.toDataURL('image/jpeg');

        // åŸ·è¡Œ OCR
        try {
            if (!worker) {
                statusBar.innerText = "è¼‰å…¥ OCR å¼•æ“...";
                worker = await Tesseract.createWorker('eng');
            }

            // æ ¹æ“šæ¨¡å¼è¨­å®šç™½åå–®
            if (currentMode === 'vital') {
                await worker.reinitialize('eng');
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789./', // åªèªæ•¸å­—
                });
            } else {
                // è­‰ä»¶æ¨¡å¼ï¼šè¼‰å…¥ä¸­æ–‡ (è‹¥ç¬¬ä¸€æ¬¡éœ€ä¸‹è¼‰)
                if (statusBar.innerText.indexOf("ä¸‹è¼‰") === -1) {
                    statusBar.innerText = "åˆ‡æ›èªè¨€æ¨¡å‹ä¸­ (éœ€ä¸‹è¼‰)...";
                }
                await worker.loadLanguage('chi_tra');
                await worker.reinitialize('chi_tra+eng');
                await worker.setParameters({
                    tessedit_char_whitelist: '', // æ¸…é™¤é™åˆ¶
                });
            }

            statusBar.innerText = "AI è¾¨è­˜ä¸­...";
            const result = await worker.recognize(finalImage);
            console.log("OCR Result:", result.data.text);
            
            parseAndShowResult(result.data.text);

        } catch (e) {
            alert("è¾¨è­˜éŒ¯èª¤ï¼š" + e.message);
        } finally {
            hideLoader();
            statusBar.innerText = "è¾¨è­˜å®Œæˆ";
        }
    }

    // --- 4. çµæœè§£æ ---
    function parseAndShowResult(text) {
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = ''; // æ¸…ç©º

        if (currentMode === 'vital') {
            // å–å‡ºæ‰€æœ‰æ•¸å­—
            const nums = text.match(/\d+(\.\d+)?/g) ||;
            const uniqueNums =.map(Number); // å»é‡ä¸¦è½‰æ•¸å­—

            // é‚è¼¯æ¨æ¸¬
            let sys = uniqueNums.find(n => n > 90 && n < 220) |

| "";
            let dia = uniqueNums.find(n => n > 50 && n < 120 && n!== sys) |

| "";
            let temp = uniqueNums.find(n => n > 34 && n < 43 && n.toString().includes('.')) |

| "";

            if (temp) {
                addInput(container, "é«”æº« (Â°C)", temp);
            } else if (sys |

| dia) {
                addInput(container, "æ”¶ç¸®å£“ (mmHg)", sys);
                addInput(container, "èˆ’å¼µå£“ (mmHg)", dia);
                addInput(container, "è„ˆæ (bpm)", "");
            } else {
                addInput(container, "æ¸¬é‡æ•¸å€¼ (è¡€ç³–/å…¶ä»–)", nums.join(", "));
            }

        } else {
            // è­‰ä»¶æ¨¡å¼è§£æ
            // èº«åˆ†è­‰ (1è‹±æ–‡+9æ•¸å­—)
            const idMatch = text.match(/[A-Z][1]\d{8}/);
            const idVal = idMatch? idMatch : "";
            
            // æŠ“æ—¥æœŸ (æ°‘åœ‹å¹´)
            const dateMatch = text.match(/(\d{2,3})[/\.å¹´](\d{1,2})[/\.æœˆ](\d{1,2})/);
            let birthVal = "";
            if (dateMatch) {
                let y = parseInt(dateMatch[2]) + 1911;
                let m = dateMatch.[3]padStart(2,'0');
                let d = dateMatch.[4]padStart(2,'0');
                birthVal = `${y}-${m}-${d}`;
            }

            // æŠ“å§“å (ç°¡å–®éæ¿¾ä¸­æ–‡ï¼Œä¸”é•·åº¦2~4)
            let lines = text.split('\n');
            let nameVal = "";
            for(let l of lines) {
                let clean = l.replace(/[^\u4e00-\u9fa5]/g, '');
                if (clean.length >= 2 && clean.length <= 4) {
                    nameVal = clean;
                    break;
                }
            }

            addInput(container, "å§“å", nameVal);
            addInput(container, "èº«åˆ†è­‰å­—è™Ÿ", idVal);
            addInput(container, "å‡ºç”Ÿæ—¥æœŸ", birthVal);
        }

        document.getElementById('result-modal').style.display = 'block';
    }

    function addInput(parent, label, value) {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `<label>${label}</label><input type="text" value="${value}">`;
        parent.appendChild(div);
    }

    // --- 5. UI æ“ä½œ ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        // ç°¡å–®åˆ‡æ› active
        if(mode === 'vital') document.querySelectorAll('.tab').classList.add('active');
        else document.querySelectorAll('.tab').[2]classList.add('active');

        // æ›´æ–°å¼•å°æ¡†
        const box = document.getElementById('guide-box');
        const txt = document.getElementById('guide-text');
        if (mode === 'vital') {
            box.style.height = '25%'; 
            txt.innerText = "è«‹å°‡å„€å™¨æ•¸å€¼ç½®æ–¼æ¡†å…§";
        } else {
            box.style.height = '53vw'; // è­‰ä»¶æ¯”ä¾‹
            txt.innerText = "è«‹å°æº–è­‰ä»¶æ­£é¢";
        }
    }

    function showLoader(msg) {
        loader.style.display = 'flex';
        document.getElementById('loader-text').innerText = msg;
    }
    function hideLoader() { loader.style.display = 'none'; }
    function closeModal() { document.getElementById('result-modal').style.display = 'none'; }

    function simulateUpload() {
        const btn = document.getElementById('upload-btn');
        const oldText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "åŠ å¯†å‚³è¼¸ä¸­...";
        setTimeout(() => {
            alert("âœ… ä¸Šå‚³æˆåŠŸï¼\næ•¸æ“šå·²å¯«å…¥é å‚³ Health+ å¥åº·å­˜æ‘ºã€‚");
            btn.disabled = false;
            btn.innerText = oldText;
            closeModal();
        }, 1500);
    }

    // å•Ÿå‹•
    window.addEventListener('load', initSystem);

</script>
</body>
</html>