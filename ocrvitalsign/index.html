<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health+ æ™ºèƒ½é‡æ¸¬ç«™</title>
    <style>
        :root {
            --primary-color: #E60012; /* é å‚³ç´… */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --guide-color: #00C0F3;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* === é€šç”¨è¦–åœ–æ§åˆ¶ === */
        .view-section {
            display: none; /* é è¨­éš±è—æ‰€æœ‰é é¢ */
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            background: var(--bg-color);
            z-index: 1;
        }

        .view-section.active {
            display: flex;
            z-index: 10;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* === æ¨™é ­ === */
        header {
            padding: 15px;
            text-align: center;
            background: #000;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #333;
        }

        /* === Step 1: é¦–é  === */
        #view-home {
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, #1e1e1e 0%, #000 100%);
        }
        
        .logo-circle {
            width: 120px; height: 120px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(230, 0, 18, 0.4);
        }

        /* === Step 2 & 3: æ‹æ”ä»‹é¢ === */
        .camera-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        video, #preview-img { width: 100%; height: 100%; object-fit: cover; }
        #preview-img { display: none; }

        .guide-box {
            position: absolute;
            border: 3px solid var(--guide-color);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            pointer-events: none;
            transition: all 0.3s;
        }
        
        .guide-text {
            position: absolute; top: -50px; left: 0; width: 100%;
            text-align: center; color: var(--guide-color);
            font-weight: bold; font-size: 16px;
            text-shadow: 1px 1px 2px black;
        }

        .controls-area {
            padding: 20px;
            background: #1e1e1e;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
        }

        /* === Step 3: é¸æ“‡è¨­å‚™ === */
        #view-select-device {
            justify-content: center; padding: 20px;
        }
        .device-card {
            background: #333; margin: 10px 0; padding: 25px;
            border-radius: 15px; text-align: center;
            font-size: 20px; font-weight: bold;
            cursor: pointer; border: 2px solid transparent;
            transition: 0.2s;
        }
        .device-card:active { transform: scale(0.98); background: #444; }

        /* === Step 4: çµæœé  === */
        #view-result { padding: 20px; overflow-y: auto; }
        
        .result-card {
            background: #1e1e1e; border-radius: 15px;
            padding: 20px; margin-bottom: 20px;
            border: 1px solid #333;
        }
        .result-title {
            color: var(--primary-color); font-size: 14px; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; color: #888; font-size: 12px; margin-bottom: 4px; }
        .form-group input {
            width: 100%; background: #2a2a2a; border: 1px solid #444;
            color: white; padding: 10px; border-radius: 8px; font-size: 16px;
        }

        /* === æŒ‰éˆ•èˆ‡å‹•ç•« === */
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-outline { background: transparent; border: 2px solid #555; color: #ccc; }

        /* Loading Overlay */
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* éš±è—åŸç”Ÿ Input */
        #native-camera { display: none; }
    </style>
</head>
<body>

<script>
    // â–¼â–¼â–¼ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GOOGLE API KEY â–¼â–¼â–¼
    const API_KEY = "AIzaSyC8fnfqZToCje2pqeRhURYVQZbXIa_eshU"; 
</script>

<div id="view-home" class="view-section active">
    <div class="logo-circle">Health+</div>
    <h1>ç”Ÿç†è³‡è¨Šè¾¨è­˜ç³»çµ±</h1>
    <p style="color:#aaa; margin-bottom:40px;">è‡ªå‹•è¾¨è­˜èº«åˆ†è­‰èˆ‡æ¸¬é‡å„€å™¨</p>
    <button class="btn btn-primary" onclick="goToStep(2)">ğŸš€ é–‹å§‹é‡æ¸¬</button>
</div>

<div id="view-scan-id" class="view-section">
    <header>æ­¥é©Ÿ 1/3ï¼šæƒæèº«åˆ†è­‰</header>
    <div class="camera-container">
        <video id="video-id" autoplay playsinline muted></video>
        <div class="guide-box" style="width: 85%; height: 50%;">
            <div class="guide-text">è«‹å°‡ã€Œèº«åˆ†è­‰æ­£é¢ã€ç½®æ–¼æ¡†å…§</div>
        </div>
    </div>
    <div class="controls-area">
        <button class="btn btn-primary" id="btn-scan-id">ğŸ“· æ‹æ”è¾¨è­˜</button>
        <div style="text-align:center; margin-top:10px; font-size:12px; color:#666;">æˆ– <span onclick="nativeInput.click()" style="text-decoration:underline;">å¾ç›¸ç°¿ä¸Šå‚³</span></div>
    </div>
</div>

<div id="view-select-device" class="view-section">
    <header>æ­¥é©Ÿ 2/3ï¼šé¸æ“‡æ¸¬é‡å„€å™¨</header>
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
        <div class="device-card" onclick="startVitalScan('bp')">
            ğŸ©¸ è¡€å£“è¨ˆ (Blood Pressure)
        </div>
        <div class="device-card" onclick="startVitalScan('bg')">
            ğŸ¬ è¡€ç³–æ©Ÿ (Glucose)
        </div>
    </div>
    <button class="btn btn-outline" onclick="goToStep(2)">â¬… å›ä¸Šä¸€æ­¥</button>
</div>

<div id="view-scan-vital" class="view-section">
    <header>æ­¥é©Ÿ 2/3ï¼šæƒæå„€å™¨æ•¸å€¼</header>
    <div class="camera-container">
        <video id="video-vital" autoplay playsinline muted></video>
        <div class="guide-box" style="width: 70%; height: 35%;">
            <div class="guide-text" id="vital-guide-text">è«‹å°‡è¢å¹•æ•¸å€¼ç½®æ–¼æ¡†å…§</div>
        </div>
    </div>
    <div class="controls-area">
        <button class="btn btn-primary" id="btn-scan-vital">ğŸ“· æ‹æ”è¾¨è­˜</button>
    </div>
</div>

<div id="view-result" class="view-section">
    <header>æ­¥é©Ÿ 3/3ï¼šç¢ºèªè³‡æ–™</header>
    
    <div class="result-card">
        <div class="result-title">ğŸ‘¤ å€‹æ¡ˆè³‡æ–™</div>
        <div class="form-group">
            <label>å§“å</label>
            <input type="text" id="res-name">
        </div>
        <div class="form-group">
            <label>èº«åˆ†è­‰å­—è™Ÿ</label>
            <input type="text" id="res-id">
        </div>
        <div class="form-group">
            <label>å‡ºç”Ÿæ—¥æœŸ</label>
            <input type="text" id="res-birth">
        </div>
    </div>

    <div class="result-card">
        <div class="result-title">ğŸ“Š é‡æ¸¬çµæœ</div>
        <div id="vital-fields"></div>
    </div>

    <button class="btn btn-primary" id="btn-upload">â˜ï¸ ä¸Šå‚³è‡³ Health+</button>
    <button class="btn btn-outline" onclick="goToHome()">ğŸ  æ”¾æ£„ä¸¦å›é¦–é </button>
</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="color:white; font-weight:bold;">è³‡æ–™è™•ç†ä¸­...</div>
</div>

<input type="file" id="native-camera" accept="image/*">

<script>
    // ========== å…¨åŸŸè®Šæ•¸ ==========
    let currentStep = 1;
    let currentDevice = ''; // 'bp' or 'bg'
    let activeStream = null;
    
    // æš«å­˜è³‡æ–™
    const collectedData = {
        name: '',
        id: '',
        birth: '',
        vital: {}
    };

    const nativeInput = document.getElementById('native-camera');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');

    // ========== æµç¨‹æ§åˆ¶ç³»çµ± ==========
    function goToStep(step) {
        // éš±è—æ‰€æœ‰è¦–åœ–
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        stopCamera(); // åˆ‡æ›é é¢æ™‚å…ˆé—œé–‰ç›¸æ©Ÿ

        // æ ¹æ“šæ­¥é©Ÿé¡¯ç¤º
        if (step === 1) document.getElementById('view-home').classList.add('active');
        if (step === 2) {
            document.getElementById('view-scan-id').classList.add('active');
            initCamera('video-id');
        }
        if (step === 3) document.getElementById('view-select-device').classList.add('active');
        if (step === 4) {
            document.getElementById('view-scan-vital').classList.add('active');
            initCamera('video-vital');
        }
        if (step === 5) {
            document.getElementById('view-result').classList.add('active');
            renderResult();
        }
    }

    function goToHome() {
        // æ¸…ç©ºè³‡æ–™
        collectedData.name = '';
        collectedData.id = '';
        collectedData.birth = '';
        collectedData.vital = {};
        goToStep(1);
    }

    // å„€å™¨é¸æ“‡é‚è¼¯
    function startVitalScan(type) {
        currentDevice = type;
        const guideText = document.getElementById('vital-guide-text');
        if (type === 'bp') guideText.innerText = "è«‹å°‡ è¡€å£“/è„ˆæ æ•¸å­—ç½®æ–¼æ¡†å…§";
        else guideText.innerText = "è«‹å°‡ è¡€ç³– æ•¸å­—ç½®æ–¼æ¡†å…§";
        goToStep(4);
    }

    // ========== ç›¸æ©ŸåŠŸèƒ½ ==========
    async function initCamera(videoId) {
        const videoEl = document.getElementById(videoId);
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                activeStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 } }
                });
                videoEl.srcObject = activeStream;
            } catch (e) {
                console.error(e);
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹å…è¨±æ¬Šé™");
            }
        }
    }

    function stopCamera() {
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            activeStream = null;
        }
    }

    function captureImage(videoId) {
        const videoEl = document.getElementById(videoId);
        const canvas = document.createElement('canvas');
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        canvas.getContext('2d').drawImage(videoEl, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
    }

    // ========== è¾¨è­˜èˆ‡æŒ‰éˆ•ç¶å®š ==========

    // 1. èº«åˆ†è­‰æƒæ
    document.getElementById('btn-scan-id').addEventListener('click', () => {
        handleScan('id', 'video-id');
    });

    // åŸç”Ÿä¸Šå‚³ (è£œæ•‘ç”¨)
    nativeInput.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const base64 = evt.target.result.split(',')[1];
                callGoogleAPI(base64, 'id');
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    // 2. å„€å™¨æƒæ
    document.getElementById('btn-scan-vital').addEventListener('click', () => {
        handleScan('vital', 'video-vital');
    });

    function handleScan(mode, videoId) {
        if (!API_KEY || API_KEY === "YOUR_GOOGLE_API_KEY_HERE") {
            return alert("è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Google API Key");
        }
        const base64 = captureImage(videoId);
        callGoogleAPI(base64, mode);
    }

    // ========== Google API æ ¸å¿ƒ ==========
    async function callGoogleAPI(base64, mode) {
        showLoading(true, "AI è¾¨è­˜ä¸­...");
        
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`;
        const body = {
            requests: [{
                image: { content: base64 },
                features: [{ type: "TEXT_DETECTION" }]
            }]
        };

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            
            if (!data.responses || !data.responses[0].textAnnotations) {
                throw new Error("æœªåµæ¸¬åˆ°æ–‡å­—");
            }

            const fullText = data.responses[0].textAnnotations[0].description;
            console.log("OCR Result:", fullText);

            if (mode === 'id') {
                parseIDCard(fullText);
                showLoading(false);
                goToStep(3); // å»é¸æ“‡å„€å™¨
            } else {
                parseVital(fullText);
                showLoading(false);
                goToStep(5); // å»çœ‹çµæœ
            }

        } catch (e) {
            showLoading(false);
            alert("è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦ (" + e.message + ")");
        }
    }

    // ========== è§£æé‚è¼¯ (æ ¸å¿ƒä¿®æ­£) ==========

    // è§£æèº«åˆ†è­‰ (é‡å°å§“åé€²è¡Œå¼·åŒ–)
    function parseIDCard(text) {
        // 1. èº«åˆ†è­‰å­—è™Ÿ
        const cleanText = text.replace(/\s/g, '');
        const idMatch = cleanText.match(/[A-Z][0-9]{9}/);
        collectedData.id = idMatch ? idMatch[0] : "";

        // 2. å‡ºç”Ÿæ—¥æœŸ
        const dateMatch = text.match(/(\d{2,3})\s*[å¹´\.]\s*(\d{1,2})\s*[æœˆ\.]\s*(\d{1,2})/);
        if (dateMatch) {
            let y = parseInt(dateMatch[1]);
            if (y < 1911) y += 1911;
            collectedData.birth = `${y}-${dateMatch[2].padStart(2,'0')}-${dateMatch[3].padStart(2,'0')}`;
        }

        // 3. å§“å (ä¿®æ­£æ¼”ç®—æ³•)
        let nameFound = "";
        const lines = text.split('\n');
        
        // ç­–ç•¥ A: å°‹æ‰¾ "å§“å" é—œéµå­—
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes("å§“å")) {
                let temp = lines[i].replace(/å§“å/g, '').replace(/[:ï¼š\s]/g, '');
                if (temp.length >= 2 && temp.length <= 4) {
                    nameFound = temp;
                } else if (i + 1 < lines.length) {
                    // å¦‚æœé€™è¡Œåªæœ‰ "å§“å"ï¼Œçœ‹ä¸‹ä¸€è¡Œ
                    let nextLine = lines[i+1].replace(/\s/g, '');
                    if (/^[\u4e00-\u9fa5]{2,4}$/.test(nextLine)) {
                        nameFound = nextLine;
                    }
                }
                break;
            }
        }

        // ç­–ç•¥ B: å¦‚æœæ²’æ‰¾åˆ°ï¼Œå°‹æ‰¾ã€Œå­¤ç«‹çš„ç´”ä¸­æ–‡è¡Œã€
        // èº«åˆ†è­‰çš„æ’ç‰ˆç‰¹æ€§ï¼šå§“åé€šå¸¸æ˜¯å­—é«”æœ€å¤§ä¸”å–®ç¨ä¸€è¡Œçš„ä¸­æ–‡
        if (!nameFound) {
            for (let line of lines) {
                // å»é™¤æ‰€æœ‰ç©ºæ ¼
                let raw = line.replace(/\s/g, ''); 
                // æ¢ä»¶ï¼šç´”ä¸­æ–‡ã€2-4å€‹å­—ã€ä¸æ˜¯é—œéµå­—
                if (/^[\u4e00-\u9fa5]{2,4}$/.test(raw)) {
                    if (!['ä¸­è¯æ°‘åœ‹', 'åœ‹æ°‘èº«åˆ†è­‰', 'å‡ºç”Ÿå¹´æœˆæ—¥', 'çµ±ä¸€ç·¨è™Ÿ', 'æ€§åˆ¥', 'ç™¼è­‰æ—¥æœŸ'].some(k => raw.includes(k))) {
                        nameFound = raw;
                        break; // æ‰¾åˆ°ç¬¬ä¸€å€‹ç¬¦åˆçš„é€šå¸¸å°±æ˜¯å§“å
                    }
                }
            }
        }

        collectedData.name = nameFound;
    }

    // è§£æç”Ÿç†æ•¸å€¼
    function parseVital(text) {
        // æŠ“å‡ºæ‰€æœ‰æ•¸å­—
        let nums = (text.match(/\d+(\.\d+)?/g) || []).map(Number);
        // éæ¿¾ä¸åˆç†æ•¸å€¼ (å‡è¨­ < 30 æˆ– > 400 æ˜¯é›œè¨Šæˆ–æ—¥æœŸ)
        nums = nums.filter(n => n > 30 && n < 400);
        // æ’åº (ç”±å¤§åˆ°å°)
        nums = [...new Set(nums)].sort((a, b) => b - a);

        collectedData.vital = {};

        if (currentDevice === 'bp') {
            // è¡€å£“è¨ˆé€šå¸¸æœ‰ 2~3 å€‹æ•¸å€¼
            if (nums.length >= 2) {
                collectedData.vital.sys = nums[0]; // æ”¶ç¸®å£“
                collectedData.vital.dia = nums[1]; // èˆ’å¼µå£“
                if (nums.length >= 3) collectedData.vital.pulse = nums[2];
            }
        } else {
            // è¡€ç³–æ©Ÿé€šå¸¸åªæœ‰ 1 å€‹ä¸»è¦æ•¸å€¼
            if (nums.length >= 1) {
                collectedData.vital.glucose = nums[0]; // è¡€ç³–å€¼
            }
        }
    }

    // ========== çµæœæ¸²æŸ“èˆ‡ä¸Šå‚³ ==========
    function renderResult() {
        document.getElementById('res-name').value = collectedData.name;
        document.getElementById('res-id').value = collectedData.id;
        document.getElementById('res-birth').value = collectedData.birth;

        const vitalContainer = document.getElementById('vital-fields');
        vitalContainer.innerHTML = '';

        if (currentDevice === 'bp') {
            addResultInput(vitalContainer, "æ”¶ç¸®å£“ (Sys)", collectedData.vital.sys || "");
            addResultInput(vitalContainer, "èˆ’å¼µå£“ (Dia)", collectedData.vital.dia || "");
            addResultInput(vitalContainer, "è„ˆæ (Pulse)", collectedData.vital.pulse || "");
        } else {
            addResultInput(vitalContainer, "è¡€ç³–å€¼ (mg/dL)", collectedData.vital.glucose || "");
        }
    }

    function addResultInput(parent, label, value) {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `<label>${label}</label><input type="text" value="${value}">`;
        parent.appendChild(div);
    }

    // ä¸Šå‚³é‚è¼¯
    document.getElementById('btn-upload').addEventListener('click', () => {
        showLoading(true, "è³‡æ–™ä¸Šå‚³ä¸­...");
        
        // æ¨¡æ“¬ 1 ç§’å»¶é²
        setTimeout(() => {
            showLoading(false);
            
            // é¡¯ç¤ºæˆåŠŸæç¤º (ç°¡å–® alert æˆ– toast)
            // é€™è£¡ç›´æ¥ä¿®æ”¹æŒ‰éˆ•ç‹€æ…‹
            const btn = document.getElementById('btn-upload');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = "âœ… ä¸Šå‚³æˆåŠŸ";
            btn.style.backgroundColor = "#4CAF50";
            
            // é¡¯ç¤ºã€Œè¿”å›é¦–é ã€æŒ‰éˆ• (å…¶å¯¦åŸæœ¬å°±æœ‰ï¼Œé€™è£¡åšå€‹å¼·èª¿)
            setTimeout(() => {
                alert("ä¸Šå‚³æˆåŠŸï¼å°‡è¿”å›é¦–é ã€‚");
                goToHome();
                // é‡ç½®æŒ‰éˆ•
                btn.innerHTML = originalText;
                btn.style.backgroundColor = "";
            }, 1000);

        }, 1500);
    });

    function showLoading(show, text) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
        if (text) loadingText.innerText = text;
    }

    // å•Ÿå‹•æ™‚å…ˆè¼‰å…¥é¦–é 
    goToStep(1);

</script>
</body>
</html>