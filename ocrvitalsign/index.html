<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health+ æ™ºèƒ½é‡æ¸¬ç«™ (å¥ä¿å¡å„ªåŒ–ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #E60012;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --guide-color: #00C0F3;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* === è¦–åœ–æ§åˆ¶ === */
        .view-section {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            background: var(--bg-color);
            z-index: 1;
        }
        .view-section.active { display: flex; z-index: 10; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* === æ¨™é ­ === */
        header {
            padding: 15px; text-align: center; background: #000;
            font-size: 18px; font-weight: bold; border-bottom: 1px solid #333;
        }

        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; }

        /* === é¦–é  === */
        #view-home {
            justify-content: center; align-items: center; padding: 40px; text-align: center;
            background: linear-gradient(135deg, #1e1e1e 0%, #000 100%);
        }
        .logo-circle {
            width: 120px; height: 120px; background: var(--primary-color);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 40px; margin-bottom: 30px; box-shadow: 0 0 30px rgba(230, 0, 18, 0.4);
        }

        /* === ç›¸æ©Ÿ === */
        .camera-container {
            flex: 1; position: relative; background: #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .guide-box {
            position: absolute; border: 3px solid var(--guide-color);
            border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            pointer-events: none; transition: all 0.3s;
        }
        .guide-text {
            position: absolute; top: -50px; left: 0; width: 100%;
            text-align: center; color: var(--guide-color);
            font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px black;
        }

        .controls-area {
            padding: 20px; background: #1e1e1e;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
        }

        /* === å¡ç‰‡èˆ‡è¡¨å–® === */
        .device-card {
            background: #333; margin: 10px 0; padding: 25px;
            border-radius: 15px; text-align: center; font-size: 20px; font-weight: bold;
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .device-card:active { transform: scale(0.98); background: #444; }

        .result-card {
            background: #1e1e1e; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #333;
        }
        .result-title {
            color: var(--primary-color); font-size: 14px; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #888; font-size: 12px; margin-bottom: 6px; }
        .form-group input {
            width: 100%; background: #2a2a2a; border: 1px solid #444;
            color: white; padding: 12px; border-radius: 8px; font-size: 16px;
        }

        /* === æŒ‰éˆ• === */
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-outline { background: transparent; border: 2px solid #555; color: #ccc; }
        .btn-warning { background: transparent; border: 2px solid var(--warning-color); color: var(--warning-color); }

        /* Loading */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #native-camera { display: none; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="color:white; font-weight:bold;">æ­£åœ¨è®€å–è¨­å®šæª”...</div>
</div>

<div id="view-home" class="view-section">
    <div class="logo-circle">Health+</div>
    <h1>ç”Ÿç†è³‡è¨Šè¾¨è­˜ç³»çµ±</h1>
    <p style="color:#aaa; margin-bottom:40px;">æ”¯æ´ï¼šèº«åˆ†è­‰ / å¥ä¿å¡ / ç”Ÿç†å„€å™¨</p>
    <button class="btn btn-primary" onclick="goToStep('scan-id')">ğŸš€ é–‹å§‹é‡æ¸¬</button>
</div>

<div id="view-scan-id" class="view-section">
    <header>æ­¥é©Ÿ 1ï¼šæƒæè­‰ä»¶</header>
    <div class="camera-container">
        <video id="video-id" autoplay playsinline muted></video>
        <div class="guide-box" style="width: 85%; height: 50%;">
            <div class="guide-text">è«‹å°‡ã€Œèº«åˆ†è­‰ æˆ– å¥ä¿å¡ã€æ­£é¢ç½®æ–¼æ¡†å…§</div>
        </div>
    </div>
    <div class="controls-area">
        <button class="btn btn-primary" id="btn-scan-id">ğŸ“· æ‹æ”è¾¨è­˜</button>
        <div style="text-align:center; margin-top:10px; font-size:12px; color:#666;">æˆ– <span onclick="nativeInput.click()" style="text-decoration:underline;">å¾ç›¸ç°¿ä¸Šå‚³</span></div>
    </div>
</div>

<div id="view-preview-id" class="view-section">
    <header>ç¢ºèªå€‹æ¡ˆè³‡æ–™</header>
    <div class="content-scroll">
        <div class="result-card">
            <div class="result-title">
                <span>ğŸ‘¤ è¾¨è­˜çµæœ</span>
                <span style="font-size:12px; color:#aaa;">å¯é»æ“Šä¿®æ”¹</span>
            </div>
            <div class="form-group"><label>å§“å</label><input type="text" id="preview-id-name"></div>
            <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="preview-id-no"></div>
            <div class="form-group"><label>å‡ºç”Ÿæ—¥æœŸ (YYYY-MM-DD)</label><input type="text" id="preview-id-birth"></div>
        </div>
        <p style="color:#888; font-size:13px; text-align:center;">æ”¯æ´å¥ä¿å¡(æ°‘åœ‹å¹´)è‡ªå‹•è½‰è¥¿å…ƒ</p>
    </div>
    <div class="controls-area">
        <button class="btn btn-success" onclick="confirmIDAndNext()">âœ… è³‡æ–™æ­£ç¢ºï¼Œä¸‹ä¸€æ­¥</button>
        <button class="btn btn-warning" onclick="goToStep('scan-id')">ğŸ”„ é‡æ–°æ‹æ”</button>
    </div>
</div>

<div id="view-select-device" class="view-section">
    <header>æ­¥é©Ÿ 2ï¼šé¸æ“‡æ¸¬é‡å„€å™¨</header>
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding:20px;">
        <div class="device-card" onclick="startVitalScan('bp')">ğŸ©¸ è¡€å£“è¨ˆ (Blood Pressure)</div>
        <div class="device-card" onclick="startVitalScan('bg')">ğŸ¬ è¡€ç³–æ©Ÿ (Glucose)</div>
    </div>
    <button class="btn btn-outline" style="margin:20px;" onclick="goToStep('preview-id')">â¬… å›ä¸Šä¸€æ­¥</button>
</div>

<div id="view-scan-vital" class="view-section">
    <header>æ­¥é©Ÿ 3ï¼šæƒæå„€å™¨æ•¸å€¼</header>
    <div class="camera-container">
        <video id="video-vital" autoplay playsinline muted></video>
        <div class="guide-box" style="width: 70%; height: 35%;">
            <div class="guide-text" id="vital-guide-text">è«‹å°‡è¢å¹•æ•¸å€¼ç½®æ–¼æ¡†å…§</div>
        </div>
    </div>
    <div class="controls-area">
        <button class="btn btn-primary" id="btn-scan-vital">ğŸ“· æ‹æ”è¾¨è­˜</button>
    </div>
</div>

<div id="view-preview-vital" class="view-section">
    <header>ç¢ºèªæ¸¬é‡æ•¸å€¼</header>
    <div class="content-scroll">
        <div class="result-card">
            <div class="result-title">
                <span>ğŸ“Š è¾¨è­˜çµæœ</span>
                <span style="font-size:12px; color:#aaa;">å¯é»æ“Šä¿®æ”¹</span>
            </div>
            <div id="preview-vital-fields"></div>
        </div>
    </div>
    <div class="controls-area">
        <button class="btn btn-success" onclick="confirmVitalAndNext()">âœ… æ•¸å€¼æ­£ç¢ºï¼Œå®Œæˆ</button>
        <button class="btn btn-warning" onclick="goToStep('scan-vital')">ğŸ”„ é‡æ–°æ‹æ”</button>
    </div>
</div>

<div id="view-result" class="view-section">
    <header>æœ€çµ‚è³‡æ–™ç¢ºèª</header>
    <div class="content-scroll">
        <div class="result-card">
            <div class="result-title">ğŸ‘¤ å€‹æ¡ˆè³‡æ–™</div>
            <div class="form-group"><label>å§“å</label><input type="text" id="final-name" readonly></div>
            <div class="form-group"><label>èº«åˆ†è­‰</label><input type="text" id="final-id" readonly></div>
            <div class="form-group"><label>å‡ºç”Ÿæ—¥æœŸ</label><input type="text" id="final-birth" readonly></div>
        </div>
        <div class="result-card">
            <div class="result-title">ğŸ“Š é‡æ¸¬çµæœ</div>
            <div id="final-vital-fields"></div>
        </div>
    </div>
    <div class="controls-area">
        <button class="btn btn-primary" id="btn-upload">â˜ï¸ ä¸Šå‚³è‡³ Health+</button>
        <button class="btn btn-outline" onclick="goToHome()">ğŸ  æ”¾æ£„ä¸¦å›é¦–é </button>
    </div>
</div>

<input type="file" id="native-camera" accept="image/*">

<script>
    let API_KEY = ""; 
    let activeStream = null;
    let currentDevice = '';
    
    const collectedData = { name: '', id: '', birth: '', vital: {} };

    const nativeInput = document.getElementById('native-camera');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');

    // 0. åˆå§‹åŒ–
    window.addEventListener('load', async () => {
        try {
            const response = await fetch('./config/key.json');
            if (!response.ok) throw new Error("è¨­å®šæª”è®€å–å¤±æ•—");
            const config = await response.json();
            if (config.GOOGLE_API_KEY) {
                API_KEY = config.GOOGLE_API_KEY;
                loadingOverlay.style.display = 'none';
                goToStep('home'); 
            } else { throw new Error("Key ç„¡æ•ˆ"); }
        } catch (error) {
            console.error(error);
            loadingText.innerText = "è¨­å®šæª”è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ config/key.json";
            loadingText.style.color = "#ff4444";
        }
    });

    // æµç¨‹æ§åˆ¶
    function goToStep(stepName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        stopCamera(); 

        if (stepName === 'home') document.getElementById('view-home').classList.add('active');
        
        else if (stepName === 'scan-id') {
            document.getElementById('view-scan-id').classList.add('active');
            initCamera('video-id');
        }
        else if (stepName === 'preview-id') {
            document.getElementById('view-preview-id').classList.add('active');
            document.getElementById('preview-id-name').value = collectedData.name;
            document.getElementById('preview-id-no').value = collectedData.id;
            document.getElementById('preview-id-birth').value = collectedData.birth;
        }
        else if (stepName === 'select-device') {
            document.getElementById('view-select-device').classList.add('active');
        }
        else if (stepName === 'scan-vital') {
            document.getElementById('view-scan-vital').classList.add('active');
            initCamera('video-vital');
        }
        else if (stepName === 'preview-vital') {
            document.getElementById('view-preview-vital').classList.add('active');
            renderVitalPreview();
        }
        else if (stepName === 'result') {
            document.getElementById('view-result').classList.add('active');
            renderFinalResult();
        }
    }

    function goToHome() {
        collectedData.name = ''; collectedData.id = ''; collectedData.birth = ''; collectedData.vital = {};
        goToStep('home');
    }

    function confirmIDAndNext() {
        collectedData.name = document.getElementById('preview-id-name').value;
        collectedData.id = document.getElementById('preview-id-no').value;
        collectedData.birth = document.getElementById('preview-id-birth').value;
        goToStep('select-device');
    }

    function startVitalScan(type) {
        currentDevice = type;
        const guideText = document.getElementById('vital-guide-text');
        guideText.innerText = (type === 'bp') ? "è«‹å°‡ è¡€å£“/è„ˆæ æ•¸å­—ç½®æ–¼æ¡†å…§" : "è«‹å°‡ è¡€ç³– æ•¸å­—ç½®æ–¼æ¡†å…§";
        goToStep('scan-vital');
    }

    function confirmVitalAndNext() {
        const inputs = document.querySelectorAll('#preview-vital-fields input');
        inputs.forEach(input => {
            const key = input.dataset.key;
            collectedData.vital[key] = input.value;
        });
        goToStep('result');
    }

    // ç›¸æ©ŸåŠŸèƒ½
    async function initCamera(videoId) {
        const videoEl = document.getElementById(videoId);
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                activeStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 } }
                });
                videoEl.srcObject = activeStream;
            } catch (e) { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"); }
        }
    }

    function stopCamera() {
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            activeStream = null;
        }
    }

    function captureImage(videoId) {
        const videoEl = document.getElementById(videoId);
        const canvas = document.createElement('canvas');
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        canvas.getContext('2d').drawImage(videoEl, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
    }

    document.getElementById('btn-scan-id').addEventListener('click', () => handleScan('id', 'video-id'));
    document.getElementById('btn-scan-vital').addEventListener('click', () => handleScan('vital', 'video-vital'));
    
    nativeInput.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const base64 = evt.target.result.split(',')[1];
                callGoogleAPI(base64, 'id'); 
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function handleScan(mode, videoId) {
        if (!API_KEY) return alert("API Key æœªè¼‰å…¥");
        const base64 = captureImage(videoId);
        callGoogleAPI(base64, mode);
    }

    // Google API
    async function callGoogleAPI(base64, mode) {
        showLoading(true, "AI è¾¨è­˜ä¸­...");
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`;
        const body = {
            requests: [{
                image: { content: base64 },
                features: [{ type: "TEXT_DETECTION" }]
            }]
        };

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            
            if (!data.responses || !data.responses[0].textAnnotations) throw new Error("æœªåµæ¸¬åˆ°æ–‡å­—");
            
            const fullText = data.responses[0].textAnnotations[0].description;
            console.log("OCR Result:", fullText);

            if (mode === 'id') {
                parseIDCard(fullText);
                showLoading(false);
                goToStep('preview-id');
            } else {
                parseVital(fullText);
                showLoading(false);
                goToStep('preview-vital');
            }
        } catch (e) {
            showLoading(false);
            alert("è¾¨è­˜å¤±æ•—ï¼š" + e.message);
        }
    }

    // ========= è§£æè­‰ä»¶ (èº«åˆ†è­‰/å¥ä¿å¡) =========
    function parseIDCard(text) {
        const cleanText = text.replace(/\s/g, '');
        const idMatch = cleanText.match(/[A-Z][0-9]{9}/);
        collectedData.id = idMatch ? idMatch[0] : "";

        let birthVal = "";
        
        // 1. èº«åˆ†è­‰æ ¼å¼: æ°‘åœ‹XXå¹´XXæœˆXXæ—¥
        const dateMatchID = text.match(/(\d{2,3})\s*[å¹´\.]\s*(\d{1,2})\s*[æœˆ\.]\s*(\d{1,2})/);
        
        // 2. å¥ä¿å¡æ ¼å¼: YY/MM/DD æˆ– YYY/MM/DD (å®¹éŒ¯ç©ºç™½)
        const dateMatchHealth = text.match(/(\d{2,3})\s*\/\s*(\d{1,2})\s*\/\s*(\d{1,2})/);

        if (dateMatchID) {
            let y = parseInt(dateMatchID[1]);
            if (y < 1911) y += 1911;
            birthVal = `${y}-${dateMatchID[2].padStart(2,'0')}-${dateMatchID[3].padStart(2,'0')}`;
        } else if (dateMatchHealth) {
            // è™•ç†å¥ä¿å¡: 67/11/15 -> 1978-11-15
            let y = parseInt(dateMatchHealth[1]);
            let m = dateMatchHealth[2].padStart(2,'0');
            let d = dateMatchHealth[3].padStart(2,'0');
            // æ°‘åœ‹è½‰è¥¿å…ƒ (é€šå¸¸å¥ä¿å¡å¹´ä»½æ˜¯2ä½æˆ–3ä½ï¼Œå¦‚ 67 æˆ– 100)
            if (y < 1911) y += 1911;
            birthVal = `${y}-${m}-${d}`;
        }
        collectedData.birth = birthVal;

        // å§“åè§£æ
        let nameFound = "";
        const lines = text.split('\n');
        const keywordsToExclude = ['ä¸­è¯æ°‘åœ‹', 'åœ‹æ°‘èº«åˆ†è­‰', 'å‡ºç”Ÿå¹´æœˆæ—¥', 'çµ±ä¸€ç·¨è™Ÿ', 'æ€§åˆ¥', 'ç™¼è­‰æ—¥æœŸ', 'å…¨æ°‘å¥åº·ä¿éšª', 'å…¨æ°‘', 'å¥åº·', 'ä¿éšª', 'National', 'Health', 'Insurance'];

        for (let line of lines) {
            if (line.includes("å§“å")) {
                let temp = line.replace(/å§“å/g, '').replace(/[:ï¼š\s]/g, '');
                if (temp.length >= 2 && temp.length <= 4) {
                    nameFound = temp; break;
                }
            }
            let raw = line.replace(/\s/g, ''); 
            if (/^[\u4e00-\u9fa5]{2,4}$/.test(raw)) {
                let isKeyword = keywordsToExclude.some(k => raw.includes(k));
                if (!isKeyword) { nameFound = raw; break; }
            }
        }
        collectedData.name = nameFound;
    }

    // è§£æç”Ÿç†å„€å™¨
    function parseVital(text) {
        collectedData.vital = {};
        let candidates = [];
        let cleanText = text.replace(/O/g, '0').replace(/o/g, '0');
        const lines = cleanText.split('\n');

        lines.forEach(line => {
            if (line.includes(':') || line.includes('/') || line.includes('-')) return;
            let numsInLine = line.match(/\d+(\.\d+)?/g);
            if (numsInLine) {
                numsInLine.forEach(n => {
                    let val = parseFloat(n);
                    if (val > 30 && val < 600 && (val < 1900 || val > 2100)) {
                        candidates.push(val);
                    }
                });
            }
        });

        if (currentDevice === 'bp') {
            if (candidates.length >= 2) {
                let sys = candidates[0];
                let dia = candidates[1];
                let pulse = (candidates.length >= 3) ? candidates[2] : "";
                if (dia > sys) { let temp = sys; sys = dia; dia = temp; }
                collectedData.vital.sys = sys;
                collectedData.vital.dia = dia;
                collectedData.vital.pulse = pulse;
            }
        } else {
            if (candidates.length >= 1) collectedData.vital.glucose = candidates[0];
        }
    }

    function renderVitalPreview() {
        const container = document.getElementById('preview-vital-fields');
        container.innerHTML = '';
        if (currentDevice === 'bp') {
            addInput(container, "æ”¶ç¸®å£“ (Sys)", collectedData.vital.sys, "sys");
            addInput(container, "èˆ’å¼µå£“ (Dia)", collectedData.vital.dia, "dia");
            addInput(container, "è„ˆæ (Pulse)", collectedData.vital.pulse, "pulse");
        } else {
            addInput(container, "è¡€ç³–å€¼ (mg/dL)", collectedData.vital.glucose, "glucose");
        }
    }

    function renderFinalResult() {
        document.getElementById('final-name').value = collectedData.name;
        document.getElementById('final-id').value = collectedData.id;
        document.getElementById('final-birth').value = collectedData.birth;

        const container = document.getElementById('final-vital-fields');
        container.innerHTML = '';
        if (currentDevice === 'bp') {
            addInput(container, "æ”¶ç¸®å£“", collectedData.vital.sys, null, true);
            addInput(container, "èˆ’å¼µå£“", collectedData.vital.dia, null, true);
            addInput(container, "è„ˆæ", collectedData.vital.pulse, null, true);
        } else {
            addInput(container, "è¡€ç³–å€¼", collectedData.vital.glucose, null, true);
        }
    }

    function addInput(parent, label, value, key, readonly=false) {
        const div = document.createElement('div');
        div.className = 'form-group';
        let inputHtml = readonly 
            ? `<input type="text" value="${value || ''}" readonly style="background:#222; border:none;">`
            : `<input type="text" value="${value || ''}" data-key="${key}">`;
        div.innerHTML = `<label>${label}</label>${inputHtml}`;
        parent.appendChild(div);
    }

    document.getElementById('btn-upload').addEventListener('click', () => {
        showLoading(true, "è³‡æ–™ä¸Šå‚³ä¸­...");
        setTimeout(() => {
            showLoading(false);
            const btn = document.getElementById('btn-upload');
            const originalText = btn.innerHTML;
            btn.innerHTML = "âœ… ä¸Šå‚³æˆåŠŸ";
            btn.style.backgroundColor = "#4CAF50";
            setTimeout(() => {
                alert("ä¸Šå‚³æˆåŠŸï¼å°‡è¿”å›é¦–é ã€‚");
                goToHome();
                btn.innerHTML = originalText;
                btn.style.backgroundColor = "";
            }, 1000);
        }, 1500);
    });

    function showLoading(show, text) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
        if (text) loadingText.innerText = text;
    }
</script>
</body>
</html>