<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web OCR 相機掃描修復版 (Tesseract.js v5)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        h1 { font-size: 1.5rem; color: #333; margin-bottom: 1rem; }
        
        /* 視訊容器：模擬相機觀景窗 */
        #video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 確保畫面填滿 */
        }

        /* 掃描線動畫效果 */
       .scan-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(0, 255, 0, 0.2), transparent);
            transform: translateY(-100%);
            animation: scan 2s infinite;
            display: none; /* 預設隱藏 */
            pointer-events: none;
        }
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        /* 控制面板 */
       .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #startBtn { background-color: #007bff; color: white; }
        #startBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #scanBtn { background-color: #28a745; color: white; }
        #scanBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #stopBtn { background-color: #dc3545; color: white; }
        #stopBtn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* 狀態與結果顯示 */
        #status {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
            min-height: 1.2em;
        }
        
        #result-box {
            margin-top: 20px;
            width: 100%;
            max-width: 640px;
            min-height: 120px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            white-space: pre-wrap; /* 保留換行 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
       .error-msg { color: #d93025; font-weight: bold; }
       .success-msg { color: #188038; font-weight: bold; }
        
        /* 隱藏的 Canvas */
        #process-canvas { display: none; }
    </style>
</head>
<body>

    <h1>OCR 智能掃描 (Web Camera Fix)</h1>

    <div id="video-container">
        <video id="camera-feed" playsinline muted autoplay></video>
        <div id="scan-line" class="scan-overlay"></div>
    </div>

    <div class="controls">
        <button id="startBtn">開啟相機</button>
        <button id="scanBtn" disabled>擷取文字</button>
        <button id="stopBtn" disabled>關閉相機</button>
    </div>

    <div id="status">系統準備就緒，請開啟相機。</div>
    
    <div id="result-box" placeholder="辨識結果將顯示於此..."></div>

    <canvas id="process-canvas"></canvas>

    <script>
        // DOM 元素參考
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('process-canvas');
        const startBtn = document.getElementById('startBtn');
        const scanBtn = document.getElementById('scanBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result-box');
        const scanLine = document.getElementById('scan-line');

        // 全域變數管理狀態
        let mediaStream = null;
        let tesseractWorker = null;
        let isWorkerReady = false;

        // ---------------------------------------------------------
        // 1. 安全環境檢查 (Secure Context Check)
        // ---------------------------------------------------------
        function checkEnvironment() {
            // 檢查是否為 HTTPS 或 Localhost
            if (!window.isSecureContext) {
                const msg = "嚴重錯誤：相機功能僅能在安全連線 (HTTPS) 下運作。目前的連線不安全，瀏覽器已封鎖相機存取。";
                statusEl.innerHTML = `<span class="error-msg">${msg}</span>`;
                startBtn.disabled = true;
                return false;
            }
            
            // 檢查瀏覽器是否支援 mediaDevices
            if (!navigator.mediaDevices ||!navigator.mediaDevices.getUserMedia) {
                const msg = "您的瀏覽器不支援相機 API，請使用最新版 Chrome 或 Safari。";
                statusEl.innerHTML = `<span class="error-msg">${msg}</span>`;
                startBtn.disabled = true;
                return false;
            }
            return true;
        }

        // ---------------------------------------------------------
        // 2. Tesseract.js v5 初始化 (Worker Lifecycle)
        // ---------------------------------------------------------
        async function initOCR() {
            if (!checkEnvironment()) return;

            try {
                statusEl.innerText = "正在載入 OCR 辨識核心 (WebAssembly)...";
                
                // v5 新語法：直接使用 createWorker 異步工廠
                // 這裡載入英文 (eng)，可依需求改為 'chi_tra' (繁體中文)
                // 注意：中文模型檔案較大，下載需時較長
                tesseractWorker = await Tesseract.createWorker('eng');
                
                isWorkerReady = true;
                statusEl.innerHTML = `<span class="success-msg">OCR 核心載入完成。請開啟相機。</span>`;
                console.log("Tesseract Worker v5 Initialized");

            } catch (err) {
                console.error("OCR Init Failed:", err);
                statusEl.innerHTML = `<span class="error-msg">OCR 初始化失敗: ${err.message}。請檢查網路連線 (需下載模型)。</span>`;
            }
        }

        // 頁面載入時預先啟動 Worker
        initOCR();

        // ---------------------------------------------------------
        // 3. 相機控制邏輯 (Camera Handling)
        // ---------------------------------------------------------
        startBtn.addEventListener('click', async () => {
            if (mediaStream) return; // 防止重複點擊

            statusEl.innerText = "正在請求相機權限...";

            // 設置約束條件
            const constraints = {
                audio: false, // 不需要音訊
                video: {
                    // 優先使用後置鏡頭，但不強制 (避免 PC 報錯)
                    facingMode: 'environment', 
                    // 理想解析度 720p，平衡效能與辨識率
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                // 請求串流
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // 將串流綁定到 video 元素
                video.srcObject = mediaStream;
                
                // 監聽載入完成事件，確保 video 真的準備好了
                video.onloadedmetadata = () => {
                    video.play()
                       .then(() => {
                            // UI 狀態更新
                            statusEl.innerText = "相機已啟動。對準文字並點擊「擷取文字」。";
                            startBtn.disabled = true;
                            stopBtn.disabled = false;
                            // 只有當 Worker 也準備好時才啟用掃描
                            if (isWorkerReady) scanBtn.disabled = false;
                            
                            // 嘗試套用進階對焦設定 (若硬體支援)
                            applyFocusPolyfill(mediaStream);
                        })
                       .catch(e => {
                            console.error("Video Play Error:", e);
                            statusEl.innerHTML = `<span class="error-msg">視訊播放失敗: ${e.message}</span>`;
                        });
                };

            } catch (err) {
                handleCameraError(err);
            }
        });

        // 錯誤處理專用函數
        function handleCameraError(err) {
            console.error("Camera Error:", err);
            let userMsg = "無法開啟相機。";

            if (err.name === 'NotAllowedError' |

| err.name === 'PermissionDeniedError') {
                userMsg = "存取被拒絕。請檢查瀏覽器網址列設定，允許相機權限後重試。";
            } else if (err.name === 'NotFoundError') {
                userMsg = "找不到相機裝置。";
            } else if (err.name === 'NotReadableError') {
                userMsg = "相機正被其他程式使用，或發生硬體錯誤。";
            } else if (err.name === 'OverconstrainedError') {
                userMsg = "沒有符合需求的相機 (解析度或鏡頭類型不支援)。";
            } else {
                userMsg += ` (${err.name}: ${err.message})`;
            }

            statusEl.innerHTML = `<span class="error-msg">${userMsg}</span>`;
        }

        // 對焦優化嘗試
        function applyFocusPolyfill(stream) {
            const track = stream.getVideoTracks();
            const capabilities = track.getCapabilities();
            
            // 檢查是否支援連續對焦
            if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                track.applyConstraints({
                    advanced: [{ focusMode: 'continuous' }]
                }).catch(err => console.log("Focus config failed:", err));
            }
        }

        // ---------------------------------------------------------
        // 4. 掃描與辨識邏輯 (Scanning & Processing)
        // ---------------------------------------------------------
        scanBtn.addEventListener('click', async () => {
            if (!tesseractWorker ||!mediaStream) return;

            // UI 鎖定
            scanBtn.disabled = true;
            stopBtn.disabled = true;
            scanLine.style.display = 'block'; // 顯示掃描動畫
            statusEl.innerText = "影像處理中... (Preprocessing)";
            resultEl.innerText = "辨識中...";

            try {
                // A. 擷取影像到 Canvas
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // B. (可選) 影像預處理：這裡示範簡單的灰階化
                // 讀取像素數據
                // const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                // const data = imageData.data;
                // for (let i = 0; i < data.length; i += 4) {
                //     const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                //     data[i] = avg; // R
                //     data[i + 1] = avg; // G
                //     data[i + 2] = avg; // B
                // }
                // ctx.putImageData(imageData, 0, 0);

                // C. 轉換為 Data URL
                const imgDataUrl = canvas.toDataURL('image/jpeg', 0.8);

                // D. 傳送給 Tesseract
                statusEl.innerText = "AI 識別中... (OCR Recognizing)";
                const ret = await tesseractWorker.recognize(imgDataUrl);

                // E. 顯示結果
                const text = ret.data.text.trim();
                resultEl.innerText = text.length > 0? text : "(未偵測到清晰文字)";
                
                statusEl.innerHTML = `<span class="success-msg">辨識完成 (信心度: ${ret.data.confidence}%)</span>`;

            } catch (err) {
                console.error("OCR Error:", err);
                statusEl.innerHTML = `<span class="error-msg">辨識過程發生錯誤: ${err.message}</span>`;
                resultEl.innerText = "錯誤";
            } finally {
                // 恢復 UI
                scanBtn.disabled = false;
                stopBtn.disabled = false;
                scanLine.style.display = 'none';
            }
        });

        // ---------------------------------------------------------
        // 5. 資源清理 (Cleanup)
        // ---------------------------------------------------------
        stopBtn.addEventListener('click', () => {
            if (mediaStream) {
                // 停止所有軌道 (視訊與音訊)
                mediaStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                mediaStream = null;
            }
            
            statusEl.innerText = "相機已關閉。";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            scanBtn.disabled = true;
            scanLine.style.display = 'none';
        });

        // 視窗關閉前確保 Worker 被終止，防止記憶體洩漏
        window.addEventListener('beforeunload', async () => {
            if (tesseractWorker) {
                await tesseractWorker.terminate();
            }
        });

    </script>
</body>
</html>