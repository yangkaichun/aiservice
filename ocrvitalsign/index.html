<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health+ Pro OCR (OpenCV å¢å¼·ç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()" type="text/javascript"></script>
    
    <style>
        :root {
            --primary-color: #E60012;
            --bg-color: #121212;
            --text-color: #ffffff;
            --guide-color: #00C0F3;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* ä¸ŠåŠéƒ¨é¡¯ç¤ºå€ */
        #display-container {
            position: relative; flex: 1; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        video, #preview-img { width: 100%; height: 100%; object-fit: cover; }
        #preview-img { display: none; }

        /* é™¤éŒ¯ç”¨ï¼šè®“ä½ çœ‹è¦‹ AI çœ‹åˆ°ä»€éº¼ */
        #debug-canvas-container {
            position: absolute; top: 10px; right: 10px;
            width: 120px; height: auto; border: 2px solid #0f0;
            background: black; z-index: 50; display: none;
        }
        #debug-canvas-container span {
            display: block; font-size: 10px; background: rgba(0,0,0,0.7);
            color: #0f0; text-align: center;
        }
        #process-canvas { width: 100%; height: auto; }

        /* æƒææ¡† */
        #guide-box {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 30%; border: 2px solid var(--guide-color);
            border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            pointer-events: none; z-index: 10;
        }
        #guide-text {
            position: absolute; top: -35px; width: 100%; text-align: center;
            color: var(--guide-color); font-weight: bold; text-shadow: 1px 1px 2px black;
        }

        /* ä¸‹æ–¹æ§åˆ¶å€ */
        #controls {
            background: #1e1e1e; padding: 20px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 20;
        }

        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab {
            flex: 1; padding: 12px; background: #333; border-radius: 12px;
            text-align: center; color: #aaa; cursor: pointer; font-size: 14px;
        }
        .tab.active { background: var(--primary-color); color: white; font-weight: bold; }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; margin-bottom: 10px; cursor: pointer;
        }
        .btn-capture { background: white; color: var(--primary-color); }
        .btn-upload { background: var(--primary-color); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #status-bar { text-align: center; font-size: 12px; color: #888; margin-top: 5px; }
        #native-camera-input { display: none; }

        /* çµæœè¦–çª— */
        #result-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { color: #aaa; font-size: 13px; display: block; margin-bottom: 5px; }
        .form-group input {
            width: 100%; padding: 12px; background: #333; border: 1px solid #555;
            color: white; border-radius: 8px; font-size: 16px;
        }

        /* Loading */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 60;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #fff3; 
            border-top: 4px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="display-container">
    <video id="video" autoplay playsinline muted></video>
    <img id="preview-img">
    <div id="guide-box"><div id="guide-text"></div></div>
    
    <div id="debug-canvas-container">
        <span>AI è¦–è¦º (é™¤éŒ¯ç”¨)</span>
        <canvas id="process-canvas"></canvas>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">è¼‰å…¥è¦–è¦ºå¼•æ“ (OpenCV)...</div>
    </div>
</div>

<input type="file" id="native-camera-input" accept="image/*" capture="environment">

<div id="controls">
    <div class="tabs">
        <div class="tab active" onclick="setMode('vital')">ğŸ“Ÿ ç”Ÿç†å„€å™¨</div>
        <div class="tab" onclick="setMode('id')">ğŸªª èº«åˆ†è­‰</div>
    </div>
    <button class="btn btn-capture" id="main-btn" disabled>â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</button>
    <div id="status-bar">è«‹ç¨å€™...</div>
</div>

<div id="result-modal">
    <h2 style="margin-top:0">è¾¨è­˜çµæœ</h2>
    <div id="dynamic-fields"></div>
    <br>
    <button class="btn btn-upload" onclick="alert('ä¸Šå‚³æˆåŠŸï¼'); closeModal()">â˜ï¸ ç¢ºèªä¸Šå‚³</button>
    <button class="btn" style="background:#444; color:#fff" onclick="closeModal()">ğŸ”„ é‡æ–°æ‹æ”</button>
</div>

<script>
    // è®Šæ•¸å®£å‘Š
    let cvReady = false;
    let currentMode = 'vital';
    let worker = null;
    let videoStream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('process-canvas');
    const ctx = canvas.getContext('2d');
    const loader = document.getElementById('loader');
    const statusText = document.getElementById('status-bar');
    const mainBtn = document.getElementById('main-btn');

    // 1. OpenCV è¼‰å…¥å®Œæˆå›èª¿
    function onOpenCvReady() {
        cvReady = true;
        console.log("OpenCV.js is ready");
        document.getElementById('loader-text').innerText = "å•Ÿå‹•ç›¸æ©Ÿ...";
        initCamera();
    }

    // 2. åˆå§‹åŒ–ç›¸æ©Ÿ
    async function initCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = videoStream;
                loader.style.display = 'none';
                mainBtn.disabled = false;
                mainBtn.innerText = "ğŸ“· æ‹æ”è¾¨è­˜";
                statusText.innerText = "ç³»çµ±å°±ç·’ | OpenCV å½±åƒå¢å¼·å·²å•Ÿç”¨";
                setMode('vital');
            } catch (err) {
                useNativeMode("ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹ä½¿ç”¨ä¸Šå‚³æ¨¡å¼");
            }
        } else {
            useNativeMode("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ WebRTC");
        }
    }

    function useNativeMode(msg) {
        loader.style.display = 'none';
        video.style.display = 'none';
        document.getElementById('preview-img').style.display = 'block';
        mainBtn.disabled = false;
        mainBtn.innerText = "ğŸ“‚ é¸æ“‡ç…§ç‰‡";
        statusText.innerText = msg;
        
        // ç¶å®šåŸç”Ÿä¸Šå‚³
        mainBtn.onclick = () => document.getElementById('native-camera-input').click();
    }

    // 3. æ‹ç…§èˆ‡å½±åƒè™•ç† (æ ¸å¿ƒé‡é»)
    if (!mainBtn.onclick) {
        mainBtn.onclick = () => {
            if (!cvReady) return alert("OpenCV å°šæœªè¼‰å…¥å®Œæˆ");
            captureAndProcess();
        };
    }

    // ç›£è½æª”æ¡ˆä¸Šå‚³
    document.getElementById('native-camera-input').addEventListener('change', (e) => {
        if (e.target.files[0]) {
            const img = new Image();
            img.onload = () => processImage(img);
            img.src = URL.createObjectURL(e.target.files[0]);
            document.getElementById('preview-img').src = img.src;
        }
    });

    function captureAndProcess() {
        // å¾ Video æŠ“åœ–
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = video.videoWidth;
        tempCanvas.height = video.videoHeight;
        tempCanvas.getContext('2d').drawImage(video, 0, 0);
        
        const img = new Image();
        img.onload = () => processImage(img);
        img.src = tempCanvas.toDataURL('image/jpeg');
    }

    function processImage(img) {
        loader.style.display = 'flex';
        document.getElementById('loader-text').innerText = "OpenCV å½±åƒå¢å¼·ä¸­...";

        // 1. å¯«å…¥ Canvas
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // 2. è£åˆ‡ ROI
        let src = cv.imread(canvas);
        let dst = new cv.Mat();
        let rect;
        
        // è¨­å®šè£åˆ‡ç¯„åœ (æ ¹æ“šæ¨¡å¼)
        if (currentMode === 'vital') {
            // è¡€å£“è¨ˆï¼šå–ä¸­é–“ 60% å¯¬, 50% é«˜
            let w = src.cols * 0.6;
            let h = src.rows * 0.5;
            rect = new cv.Rect((src.cols - w)/2, (src.rows - h)/2, w, h);
        } else {
            // èº«åˆ†è­‰ï¼šå–ä¸­é–“ 90% å¯¬, 60% é«˜
            let w = src.cols * 0.9;
            let h = w * 0.63; 
            rect = new cv.Rect((src.cols - w)/2, (src.rows - h)/2, w, h);
        }
        
        dst = src.roi(rect);

        // 3. OpenCV é€²éšè™•ç† (é­”æ³•ç™¼ç”Ÿçš„åœ°æ–¹)
        try {
            cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY, 0); // è½‰ç°éš

            if (currentMode === 'vital') {
                // === è¡€å£“è¨ˆå„ªåŒ–ç®—æ³• ===
                // 1. é«˜æ–¯æ¨¡ç³Šå»é™¤é›œè¨Š (å¹³æ»‘åŒ–)
                let ksize = new cv.Size(5, 5);
                cv.GaussianBlur(dst, dst, ksize, 0, 0, cv.BORDER_DEFAULT);
                
                // 2. è‡ªé©æ‡‰äºŒå€¼åŒ– (Adaptive Threshold) - å°æŠ—åå…‰èˆ‡é™°å½±
                // åƒæ•¸èªªæ˜ï¼š255(æœ€å¤§å€¼), ADAPTIVE_THRESH_GAUSSIAN_C, THRESH_BINARY, 11(å€å¡Šå¤§å°), 2(å¸¸æ•¸)
                cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 31, 2);

                // 3. å½¢æ…‹å­¸è†¨è„¹ (Dilate) - è®“ LCD çš„æ–·å­—é€£èµ·ä¾†ï¼Œè®Šç²—
                // å‰µå»ºä¸€å€‹ 3x3 çš„æ ¸
                let M = cv.Mat.ones(3, 3, cv.CV_8U);
                let anchor = new cv.Point(-1, -1);
                // é€™è£¡ä½¿ç”¨ ERODE å› ç‚ºåœ¨äºŒå€¼åŒ–å¾Œï¼Œæ–‡å­—æ˜¯é»‘çš„(0)ï¼ŒèƒŒæ™¯æ˜¯ç™½çš„(255)
                // Erode æœƒè®“é»‘è‰²å€åŸŸæ“´å¤§ (ä¹Ÿå°±æ˜¯æ–‡å­—è®Šç²—)
                cv.erode(dst, dst, M, anchor, 1, cv.BORDER_CONSTANT, cv.morphologyDefaultBorderValue());
                M.delete();

            } else {
                // === èº«åˆ†è­‰å„ªåŒ–ç®—æ³• ===
                // 1. ç¨å¾®å¢å¼·å°æ¯” (Histogram Equalization å¯èƒ½å¤ªå¼·ï¼Œæ”¹ç”¨ç°¡å–®äºŒå€¼)
                // èº«åˆ†è­‰èƒŒæ™¯å¾ˆèŠ±ï¼Œæˆ‘å€‘ç”¨ Threshold ä¾†æ¿¾æ‰æ·ºè‰²èƒŒæ™¯
                cv.threshold(dst, dst, 100, 255, cv.THRESH_BINARY);
            }

            cv.imshow('process-canvas', dst); // é¡¯ç¤ºè™•ç†å¾Œçš„åœ–çµ¦ Canvas
            
            // é‡‹æ”¾è¨˜æ†¶é«”
            src.delete();
            dst.delete();
            
            // é¡¯ç¤ºé™¤éŒ¯è¦–çª—ï¼Œè®“ä½ çŸ¥é“ AI çœ‹åˆ°ä»€éº¼
            document.getElementById('debug-canvas-container').style.display = 'block';
            
            runOCR(); // åŸ·è¡Œ Tesseract

        } catch (e) {
            console.error(e);
            alert("å½±åƒè™•ç†å¤±æ•—");
            loader.style.display = 'none';
        }
    }

    // 4. åŸ·è¡Œ OCR
    async function runOCR() {
        document.getElementById('loader-text').innerText = "AI è¾¨è­˜æ–‡å­—ä¸­...";
        const dataUrl = canvas.toDataURL('image/jpeg');

        if (!worker) worker = await Tesseract.createWorker();

        try {
            let ret;
            if (currentMode === 'vital') {
                await worker.loadLanguage('eng');
                await worker.reinitialize('eng');
                // é‡å° LCD æ•¸å­—å„ªåŒ–åƒæ•¸
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789', // åªè¦æ•¸å­—
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK, // å‡è¨­æ˜¯å–®ä¸€å€å¡Š
                });
                ret = await worker.recognize(dataUrl);
                parseVital(ret.data);
            } else {
                document.getElementById('loader-text').innerText = "è¼‰å…¥ä¸­æ–‡æ¨¡å‹ (é¦–æ¬¡éœ€ç´„ 30ç§’)...";
                await worker.loadLanguage('chi_tra');
                await worker.reinitialize('chi_tra');
                await worker.setParameters({
                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                });
                ret = await worker.recognize(dataUrl);
                parseID(ret.data.text);
            }
        } catch (e) {
            console.error(e);
            alert("OCR è¾¨è­˜éŒ¯èª¤");
        }
        loader.style.display = 'none';
        document.getElementById('result-modal').style.display = 'block';
    }

    // 5. è§£æé‚è¼¯
    function parseVital(data) {
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = '';
        
        // å¾ OpenCV è™•ç†å¾Œçš„åœ–ç‰‡æŠ“åˆ°çš„è¡Œ
        // é‚è¼¯ï¼šLCD æ•¸å­—é€šå¸¸å¾ˆå¤§ï¼Œæˆ‘å€‘æ‰¾ä¿¡å¿ƒåº¦é«˜çš„
        const lines = data.lines.map(l => l.text.trim()).filter(t => /\d/.test(t));
        console.log("OCR Lines:", lines);

        let nums = [];
        lines.forEach(line => {
             // æ‰¾å‡ºé€™ä¸€è¡Œè£¡æ‰€æœ‰çš„æ•¸å­—
             let match = line.match(/\d+/g);
             if (match) {
                 match.forEach(n => {
                     let val = parseInt(n);
                     // è¡€å£“åˆç†ç¯„åœéæ¿¾ (æ’é™¤é›œè¨Š)
                     if (val > 40 && val < 200) nums.push(val);
                 });
             }
        });

        // ç°¡å–®é‚è¼¯ï¼šç¬¬ä¸€æ˜¯æ”¶ç¸®ï¼Œç¬¬äºŒæ˜¯èˆ’å¼µï¼Œç¬¬ä¸‰æ˜¯å¿ƒè·³
        if (nums.length >= 2) {
            addInput("æ”¶ç¸®å£“ (Sys)", nums[0]);
            addInput("èˆ’å¼µå£“ (Dia)", nums[1]);
            if (nums[2]) addInput("è„ˆæ (Pulse)", nums[2]);
        } else {
            addInput("åµæ¸¬æ•¸å€¼ (è«‹æ ¸å°)", nums.join(', '));
            container.innerHTML += `<div style="color:orange; font-size:12px">* æœªèƒ½å®Œæ•´è¾¨è­˜ï¼Œè«‹åƒè€ƒå³ä¸Šè§’ç¶ è‰²æ¡†æ¡†å…§çš„å½±åƒæ˜¯å¦æ¸…æ™°</div>`;
        }
    }

    function parseID(text) {
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = '';
        
        // ç§»é™¤æ‰€æœ‰ç©ºç™½
        const cleanText = text.replace(/\s/g, '');
        console.log("ID Text:", cleanText);

        // 1. èº«åˆ†è­‰å­—è™Ÿ
        const idMatch = cleanText.match(/[A-Z][0-9O]{9}/);
        let idVal = idMatch ? idMatch[0].replace(/O/g, '0') : "";

        // 2. æ—¥æœŸ (æ°‘åœ‹xxå¹´)
        const dateMatch = text.match(/(\d{2,3})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})/);
        let birthVal = "";
        if (dateMatch) {
            let y = parseInt(dateMatch[1]) + 1911;
            birthVal = `${y}-${dateMatch[2].padStart(2,'0')}-${dateMatch[3].padStart(2,'0')}`;
        }

        // 3. å§“å (ç°¡å–®å•Ÿç™¼å¼ï¼šæ‰¾"å§“å"å¾Œé¢çš„å­—ï¼Œæˆ–ç´”ä¸­æ–‡è¡Œ)
        let nameVal = "";
        const lines = text.split('\n');
        for(let line of lines) {
            if (line.includes("å§“å")) {
                let temp = line.replace(/å§“å/g, '').replace(/[^\u4e00-\u9fa5]/g, '');
                if (temp.length >= 2) nameVal = temp;
                break;
            }
        }

        addInput("å§“å", nameVal);
        addInput("èº«åˆ†è­‰å­—è™Ÿ", idVal);
        addInput("å‡ºç”Ÿæ—¥æœŸ", birthVal);
    }

    function addInput(label, val) {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `<label>${label}</label><input value="${val}">`;
        document.getElementById('dynamic-fields').appendChild(div);
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(mode === 'vital') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('guide-text').innerText = "è«‹å°‡æ•¸å­—ç½®æ–¼æ¡†å…§ (å·²å•Ÿç”¨æŠ—åå…‰)";
            document.getElementById('guide-box').style.height = "30%";
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('guide-text').innerText = "è«‹å°‡è­‰ä»¶ç½®æ–¼æ¡†å…§ (å·²å•Ÿç”¨å»åº•ç´‹)";
            document.getElementById('guide-box').style.height = "50%";
        }
    }

    function closeModal() { document.getElementById('result-modal').style.display = 'none'; }
</script>
</body>
</html>