<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OCR è‡ªå‹•è¼‰å…¥ Key ç‰ˆ</title>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* API Key é¡¯ç¤ºå€ */
        .input-area { padding: 15px; background: #222; border-bottom: 1px solid #444; display: flex; align-items: center; gap: 10px; }
        .key-status { font-size: 12px; color: #aaa; }
        input { flex: 1; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        input:disabled { background: #1a1a1a; color: #4CAF50; border-color: #4CAF50; }
        
        /* å½±åƒå€ */
        .preview-area { flex: 1; position: relative; background: black; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        video, img { max-width: 100%; max-height: 100%; }
        
        /* é™¤éŒ¯ç´€éŒ„å€ */
        #debug-log {
            height: 150px; background: #000; color: #0f0; 
            font-family: monospace; font-size: 12px; 
            padding: 10px; overflow-y: scroll; border-top: 2px solid #444;
            white-space: pre-wrap;
        }

        /* æ§åˆ¶å€ */
        .controls { padding: 10px; display: flex; gap: 10px; background: #222; }
        button { flex: 1; padding: 15px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }
        .btn-cam { background: #E60012; color: white; }
        .btn-file { background: #444; color: white; }
        
        /* çµæœå½ˆçª— */
        #result-box { display: none; position: fixed; top: 10%; left: 5%; width: 90%; background: #333; padding: 20px; border-radius: 10px; border: 1px solid #666; box-shadow: 0 0 20px black; z-index: 100; max-height: 80%; overflow-y: auto;}
        .field { margin-bottom: 10px; }
        .field label { display: block; color: #aaa; font-size: 12px; }
        .field input { width: 100%; font-size: 16px; font-weight: bold; padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; }
    </style>
</head>
<body>

<div class="input-area">
    <div class="key-status" id="key-status-icon">ğŸ”‘</div>
    <input type="text" id="api-key" placeholder="æ­£åœ¨è®€å– apikey/key.json...">
</div>

<div class="preview-area">
    <video id="video" autoplay playsinline muted></video>
    <img id="preview-img" style="display:none">
</div>

<div id="debug-log">=== ç³»çµ±å•Ÿå‹• ===<br>ç­‰å¾…è¼‰å…¥ Key...</div>

<div class="controls">
    <button class="btn-file" onclick="document.getElementById('file-input').click()">ğŸ“‚ é¸ç…§ç‰‡</button>
    <button class="btn-cam" id="snap-btn">ğŸ“· æ‹ç…§è¾¨è­˜</button>
</div>
<input type="file" id="file-input" accept="image/*" style="display:none">

<div id="result-box">
    <h3>è§£æçµæœ</h3>
    <div id="parsed-fields"></div>
    <br>
    <button onclick="document.getElementById('result-box').style.display='none'" style="width:100%; padding:10px; background:#555; color:white; border:none; border-radius:5px;">é—œé–‰</button>
</div>

<script>
    const logBox = document.getElementById('debug-log');
    const video = document.getElementById('video');
    const previewImg = document.getElementById('preview-img');
    const apiKeyInput = document.getElementById('api-key');
    
    // 1. è‡ªå‹•è¼‰å…¥ Key (æœ¬æ¬¡ä¿®æ”¹é‡é»)
    window.addEventListener('load', async () => {
        log("æ­£åœ¨å˜—è©¦è®€å– apikey/key.json...");
        try {
            const response = await fetch('apikey/key.json');
            if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ (404)");
            
            const data = await response.json();
            if (data.key) {
                apiKeyInput.value = data.key;
                apiKeyInput.disabled = true; // é–å®šè¼¸å…¥æ¡†ï¼Œè¡¨ç¤ºæˆåŠŸ
                document.getElementById('key-status-icon').innerText = "âœ…";
                log("æˆåŠŸè¼‰å…¥ API Keyï¼");
            } else {
                throw new Error("JSON æ ¼å¼éŒ¯èª¤ (ç¼ºå°‘ key æ¬„ä½)");
            }
        } catch (e) {
            log("âŒ è‡ªå‹•è¼‰å…¥å¤±æ•—: " + e.message);
            log("æç¤º: è«‹ç¢ºä¿ä½¿ç”¨ Live Server é–‹å•Ÿç¶²é ï¼Œä¸¦ç¢ºèªæª”æ¡ˆè·¯å¾‘æ­£ç¢ºã€‚");
            apiKeyInput.placeholder = "è«‹æ‰‹å‹•è¼¸å…¥ API Key";
        }
        
        initCamera();
    });

    // 2. å•Ÿå‹•ç›¸æ©Ÿ
    function initCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => video.srcObject = stream)
            .catch(err => log("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err));
    }

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logBox.innerHTML += `\n[${time}] ${msg}`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    // 3. æ‹ç…§èˆ‡é¸æª”
    document.getElementById('snap-btn').addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        if (!key) return alert("æ²’æœ‰ API Keyï¼Œç„¡æ³•é€²è¡Œè¾¨è­˜ï¼");
        
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        processImage(canvas.toDataURL('image/jpeg', 0.8), key);
    });

    document.getElementById('file-input').addEventListener('change', (e) => {
        const key = apiKeyInput.value.trim();
        if (!key) return alert("æ²’æœ‰ API Keyï¼Œç„¡æ³•é€²è¡Œè¾¨è­˜ï¼");
        if (!e.target.files[0]) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
            previewImg.src = evt.target.result;
            video.style.display = 'none';
            previewImg.style.display = 'block';
            processImage(evt.target.result, key);
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    // 4. å‘¼å« Google Vision API
    async function processImage(base64Data, apiKey) {
        log("-----------------------------");
        log("æº–å‚™å‚³é€è«‹æ±‚è‡³ Google...");
        
        const base64Content = base64Data.split(',')[1];
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`;
        
        try {
            const res = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({
                    requests: [{
                        image: { content: base64Content },
                        features: [{ type: "TEXT_DETECTION" }, { type: "DOCUMENT_TEXT_DETECTION" }]
                    }]
                }),
                headers: { 'Content-Type': 'application/json' }
            });

            if (!res.ok) {
                const errData = await res.json();
                log("âŒ API éŒ¯èª¤: " + JSON.stringify(errData.error, null, 2));
                return;
            }

            const data = await res.json();
            const annotations = data.responses[0].textAnnotations;

            if (!annotations || annotations.length === 0) {
                log("âš ï¸ Google å›å‚³æˆåŠŸï¼Œä½†æœªç™¼ç¾æ–‡å­—");
                alert("æœªåµæ¸¬åˆ°æ–‡å­—ï¼Œè«‹é‡è©¦");
                return;
            }

            const fullText = annotations[0].description;
            log("âœ… è¾¨è­˜æˆåŠŸï¼Œé–‹å§‹è§£æ...");
            parseAndShow(fullText);

        } catch (e) {
            log("âŒ ç³»çµ±éŒ¯èª¤: " + e.message);
        }
    }

    // 5. è§£æé‚è¼¯ (åŒ…å«è¡€å£“è¨ˆèˆ‡èº«åˆ†è­‰)
    function parseAndShow(text) {
        const container = document.getElementById('parsed-fields');
        container.innerHTML = '';
        const lines = text.split('\n');

        // --- æ•¸å­—è§£æ (è¡€å£“è¨ˆ) ---
        // æ’é™¤æ‰åƒå¹´ä»½çš„æ•¸å­— (19xx, 20xx) å’Œæ¥µç«¯å€¼
        let nums = (text.match(/\d+/g) || []).map(Number);
        nums = nums.filter(n => n > 30 && n < 280 && (n < 1900 || n > 2100));
        
        // --- è­‰ä»¶è§£æ (èº«åˆ†è­‰) ---
        let name = "", id = "", birth = "";
        
        // ID Regex (æŠ“å– A123456789)
        const idMatch = text.replace(/\s/g,'').match(/[A-Z][0-9]{9}/);
        if (idMatch) id = idMatch[0];

        // å§“åè§£æ (å˜—è©¦æŠ“å–é—œéµå­—å¾Œçš„å…§å®¹)
        for(let line of lines) {
            if(line.includes("å§“å")) {
                let temp = line.replace(/å§“å/g, '').replace(/[^\u4e00-\u9fa5]/g, '');
                if(temp.length >= 2) name = temp;
            }
        }
        // å‚™ç”¨å§“åè§£æ (ç´”ä¸­æ–‡è¡Œ)
        if(!name) {
            for(let line of lines) {
                let clean = line.replace(/\s/g, '');
                if(/^[\u4e00-\u9fa5]{2,4}$/.test(clean) && !clean.includes("èº«åˆ†") && !clean.includes("ä¸­è¯") && !clean.includes("ç”·å¥³")) {
                    name = clean;
                }
            }
        }

        // --- åˆ¤æ–·æ¨¡å¼ä¸¦é¡¯ç¤º ---
        log("--- è§£æçµæœ ---");
        
        if (id) {
            log("åˆ¤å®šç‚º: èº«åˆ†è­‰");
            addInput("å§“å", name);
            addInput("èº«åˆ†è­‰å­—è™Ÿ", id);
            
            // å˜—è©¦æŠ“ç”Ÿæ—¥ (æ°‘åœ‹ xx å¹´ xx æœˆ xx æ—¥)
            const dateMatch = text.match(/(\d{2,3})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})/);
            if(dateMatch) {
                let y = parseInt(dateMatch[1]);
                if(y < 1911) y += 1911;
                addInput("å‡ºç”Ÿæ—¥æœŸ", `${y}-${dateMatch[2]}-${dateMatch[3]}`);
            }

        } else if (nums.length >= 2) {
            log("åˆ¤å®šç‚º: ç”Ÿç†å„€å™¨");
            // æ’åºï¼šé€šå¸¸æ”¶ç¸®å£“æœ€é«˜
            nums.sort((a,b) => b-a);
            
            let sys = nums[0];
            let dia = nums[1];
            let pulse = nums.length > 2 ? nums[2] : "";

            // é‚è¼¯æª¢æŸ¥: å¦‚æœ dia > sys å‰‡äº¤æ› (é˜²å‘†)
            if (dia > sys) { [sys, dia] = [dia, sys]; }

            addInput("æ”¶ç¸®å£“ (Sys)", sys);
            addInput("èˆ’å¼µå£“ (Dia)", dia);
            addInput("è„ˆæ (Pulse)", pulse);
        } else {
            log("âš ï¸ ç„¡æ³•è‡ªå‹•æ­¸é¡");
            addInput("åŸå§‹æ–‡å­—", text);
        }

        document.getElementById('result-box').style.display = 'block';
    }

    function addInput(label, val) {
        const div = document.createElement('div');
        div.className = 'field';
        div.innerHTML = `<label>${label}</label><input value="${val}">`;
        document.getElementById('parsed-fields').appendChild(div);
    }
</script>
</body>
</html>