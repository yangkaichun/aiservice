<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health+ OCR (Google Cloud Vision ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --bg-color: #121212;
            --text-color: #ffffff;
            --guide-color: #34A853; /* Google Green */
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* API Key è¼¸å…¥å€ (æ¸¬è©¦ç”¨) */
        #api-key-bar {
            background: #202124; padding: 10px;
            display: flex; gap: 10px; border-bottom: 1px solid #444;
            z-index: 100;
        }
        #api-key-input {
            flex: 1; background: #333; border: 1px solid #555;
            color: white; padding: 8px; border-radius: 4px; font-size: 12px;
        }

        /* é¡¯ç¤ºå€ */
        #display-container {
            position: relative; flex: 1; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        video, #preview-img { width: 100%; height: 100%; object-fit: cover; }
        #preview-img { display: none; }

        /* æƒææ¡† */
        #guide-box {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 30%; border: 3px solid var(--guide-color);
            border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            pointer-events: none; z-index: 10;
        }
        #guide-text {
            position: absolute; top: -40px; width: 100%; text-align: center;
            color: var(--guide-color); font-weight: bold; text-shadow: 1px 1px 2px black;
        }

        /* æ§åˆ¶å€ */
        #controls {
            background: #202124; padding: 20px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 20;
        }

        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab {
            flex: 1; padding: 12px; background: #333; border-radius: 8px;
            text-align: center; color: #aaa; cursor: pointer; transition: 0.3s;
        }
        .tab.active { background: var(--primary-color); color: white; font-weight: bold; }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;
        }
        .btn-capture { background: white; color: var(--primary-color); }
        .btn-upload { background: var(--primary-color); color: white; }

        #native-input { display: none; }

        /* çµæœè¦–çª— */
        #result-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; padding: 20px; overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { color: #aaa; font-size: 13px; margin-bottom: 5px; display: block; }
        .form-group input {
            width: 100%; padding: 12px; background: #303134; border: 1px solid #555;
            color: white; border-radius: 6px; font-size: 16px;
        }

        /* Loading */
        #loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #fff3;
            border-top: 4px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="api-key-bar">
    <input type="password" id="api-key-input" placeholder="622103517974-bfo3kj1e60mdgftfsk8fq13ih6sj7db7.apps.googleusercontent.com">
</div>

<div id="display-container">
    <video id="video" autoplay playsinline muted></video>
    <img id="preview-img">
    <div id="guide-box"><div id="guide-text"></div></div>
</div>

<div id="loader">
    <div class="spinner"></div>
    <div style="color:white">Google é›²ç«¯é‹ç®—ä¸­...</div>
</div>

<input type="file" id="native-input" accept="image/*" capture="environment">

<div id="controls">
    <div class="tabs">
        <div class="tab active" data-mode="vital">ğŸ“Ÿ ç”Ÿç†å„€å™¨</div>
        <div class="tab" data-mode="id">ğŸªª èº«åˆ†è­‰</div>
    </div>
    <button class="btn btn-capture" id="main-btn">ğŸ“· æ‹æ”è¾¨è­˜</button>
</div>

<div id="result-modal">
    <h2 style="color:white; margin-top:0">âœ… Google è¾¨è­˜çµæœ</h2>
    <div id="dynamic-fields"></div>
    <br>
    <button class="btn btn-upload" onclick="alert('ä¸Šå‚³æˆåŠŸï¼'); closeModal()">â˜ï¸ ç¢ºèªä¸Šå‚³</button>
    <button class="btn" style="background:#444; color:#white" onclick="closeModal()">ğŸ”„ é‡æ–°æ‹æ”</button>
</div>

<script>
    // ========== è®Šæ•¸ ==========
    let currentMode = 'vital';
    const video = document.getElementById('video');
    const nativeInput = document.getElementById('native-input');
    const modal = document.getElementById('result-modal');
    const loader = document.getElementById('loader');
    
    // åˆå§‹åŒ–
    initCamera();
    setMode('vital');

    // ========== 1. ç›¸æ©Ÿèˆ‡æ¨¡å¼ ==========
    async function initCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 } }
                });
                video.srcObject = stream;
            } catch (e) {
                console.warn("Camera failed, fallback to file input");
            }
        }
    }

    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        setMode(this.dataset.mode);
    }));

    function setMode(mode) {
        currentMode = mode;
        const box = document.getElementById('guide-box');
        const txt = document.getElementById('guide-text');
        
        if (mode === 'vital') {
            box.style.height = '40%';
            box.style.width = '70%';
            txt.innerText = "è«‹å°‡å„€å™¨æ•¸å€¼ç½®æ–¼æ¡†å…§";
        } else {
            box.style.height = '50%';
            box.style.width = '85%';
            txt.innerText = "è«‹å°‡è­‰ä»¶æ­£é¢ç½®æ–¼æ¡†å…§";
        }
    }

    // ========== 2. æ‹æ”èˆ‡ API å‘¼å« ==========
    document.getElementById('main-btn').addEventListener('click', () => {
        const apiKey = document.getElementById('api-key-input').value.trim();
        if (!apiKey) return alert("è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥ Google API Key");

        if (video.srcObject) {
            captureVideo(apiKey);
        } else {
            nativeInput.click();
        }
    });

    nativeInput.addEventListener('change', (e) => {
        const apiKey = document.getElementById('api-key-input').value.trim();
        if (e.target.files[0] && apiKey) {
            processFile(e.target.files[0], apiKey);
        }
    });

    function captureVideo(apiKey) {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // è½‰ Base64 ä¸¦ç§»é™¤æª”é ­ (Google API åªéœ€è¦ raw base64)
        const base64 = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
        callGoogleVision(base64, apiKey);
    }

    function processFile(file, apiKey) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64 = e.target.result.split(',')[1];
            callGoogleVision(base64, apiKey);
        };
        reader.readAsDataURL(file);
    }

    // ========== 3. Google Vision API æ ¸å¿ƒ ==========
    async function callGoogleVision(base64Image, apiKey) {
        loader.style.display = 'flex';
        
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`;
        const payload = {
            requests: [{
                image: { content: base64Image },
                features: [{ type: "TEXT_DETECTION" }] // ä½¿ç”¨ä¸€èˆ¬æ–‡å­—åµæ¸¬å³å¯ï¼ŒDOCUMENT_TEXT_DETECTION ä¹Ÿå¯ä»¥
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            
            if (data.responses && data.responses[0].textAnnotations) {
                // index 0 æ˜¯å®Œæ•´æ–‡å­—ï¼Œå¾Œé¢æ˜¯å€‹åˆ¥å–®å­—
                const fullText = data.responses[0].textAnnotations[0].description;
                console.log("Google OCR Result:", fullText);
                parseResult(fullText);
            } else {
                alert("ç„¡æ³•è¾¨è­˜æ–‡å­—ï¼Œè«‹é‡è©¦");
                loader.style.display = 'none';
            }
        } catch (error) {
            console.error(error);
            alert("API å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºæˆ–é¡åº¦æ˜¯å¦è¶³å¤ ");
            loader.style.display = 'none';
        }
    }

    // ========== 4. æ™ºæ…§è§£æé‚è¼¯ ==========
    function parseResult(text) {
        loader.style.display = 'none';
        modal.style.display = 'block';
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = '';

        if (currentMode === 'vital') {
            parseVital(text, container);
        } else {
            parseID(text, container);
        }
    }

    // è§£æç”Ÿç†æ•¸æ“š (Google ç‰ˆ)
    function parseVital(text, container) {
        // 1. æŠ“å‡ºæ‰€æœ‰æ•¸å­—
        let nums = (text.match(/\d+(\.\d+)?/g) || []).map(Number);
        
        // 2. éæ¿¾é›œè¨Š (æ™‚é–“ 7:30, æ—¥æœŸ 2023, æ¥µå°å€¼)
        // å‡è¨­æ”¶ç¸®å£“ä¸æœƒè¶…é 250ï¼Œè„ˆæä¸æœƒä½æ–¼ 40
        nums = nums.filter(n => n >= 40 && n <= 250);
        
        // 3. å»é‡ä¸¦æ’åº (é€šå¸¸ Sys > Dia > Pulseï¼Œæˆ–è€…ä¾ç…§ä½ç½®ç”±ä¸Šè€Œä¸‹)
        // é€™è£¡å…ˆç”¨ç°¡å–®çš„å¤§å°æ’åºæ³•
        nums = [...new Set(nums)].sort((a, b) => b - a);
        
        let sys = nums[0] || "";
        let dia = nums[1] || "";
        let pulse = nums[2] || "";

        // ç‰¹æ®Šä¿®æ­£ï¼šå¦‚æœè„ˆææ¯”èˆ’å¼µå£“é«˜ (å°‘è¦‹ä½†å¯èƒ½)ï¼Œå¯èƒ½éœ€è¦äº¤æ›
        // ä½† Google Vision é€šå¸¸æœƒç…§é †åºè®€ï¼Œæˆ‘å€‘å‡è¨­æœ€å¤§çš„å…©å€‹æ˜¯è¡€å£“
        
        addInput(container, "æ”¶ç¸®å£“ (Sys)", sys);
        addInput(container, "èˆ’å¼µå£“ (Dia)", dia);
        addInput(container, "è„ˆæ (Pulse)", pulse);
        
        if (nums.length === 0) {
            container.innerHTML += `<div style="color:orange">* æœªåµæ¸¬åˆ°æ•¸å€¼</div>`;
        }
    }

    // è§£æèº«åˆ†è­‰ (Google ç‰ˆ - å¼·å¤§ï¼)
    function parseID(text, container) {
        // ç§»é™¤å¤šé¤˜ç©ºæ ¼ï¼Œæ–¹ä¾¿ Regex
        const cleanText = text.replace(/ /g, ''); 
        
        // 1. èº«åˆ†è­‰å­—è™Ÿ (1è‹±+9æ•¸)
        const idMatch = cleanText.match(/[A-Z][0-9]{9}/);
        let idVal = idMatch ? idMatch[0] : "";

        // 2. ç”Ÿæ—¥ (æ°‘åœ‹/è¥¿å…ƒ)
        let birthVal = "";
        // å˜—è©¦æŠ“å– æ°‘åœ‹xxå¹´xxæœˆxxæ—¥
        const dateMatch = text.match(/(\d{2,3})\s*[å¹´/.]\s*(\d{1,2})\s*[æœˆ/.]\s*(\d{1,2})/);
        if (dateMatch) {
            let y = parseInt(dateMatch[1]);
            let m = dateMatch[2].padStart(2, '0');
            let d = dateMatch[3].padStart(2, '0');
            if (y < 1911) y += 1911; // è½‰è¥¿å…ƒ
            birthVal = `${y}-${m}-${d}`;
        }

        // 3. å§“å (å°‹æ‰¾ "å§“å" é—œéµå­—)
        let nameVal = "";
        // å°‡æ–‡å­—æŒ‰è¡Œåˆ†å‰²
        const lines = text.split('\n');
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (line.includes("å§“å")) {
                // æƒ…æ³ 1: "å§“å é™³ç­±ç²" åœ¨åŒä¸€è¡Œ
                let temp = line.replace(/å§“å/g, '').replace(/[:ï¼š]/g, '').trim();
                if (temp.length > 1) {
                    nameVal = temp;
                } 
                // æƒ…æ³ 2: "å§“å" æ˜¯ä¸€è¡Œï¼Œåå­—åœ¨ä¸‹ä¸€è¡Œ
                else if (i + 1 < lines.length) {
                    nameVal = lines[i+1].trim();
                }
                break;
            }
        }
        
        // Google æœ‰æ™‚æœƒæŠŠ "å§“åé™³ç­±ç²" è®€å¾—å¾ˆæº–ï¼Œå¦‚æœä¸Šè¿°æ²’æŠ“åˆ°ï¼Œ
        // å˜—è©¦æ‰¾ç´”ä¸­æ–‡å­—ä¸² (2-4å­—) ä¸”éæ¨™é¡Œ
        if (!nameVal) {
             for (let line of lines) {
                 if (/^[\u4e00-\u9fa5]{2,4}$/.test(line) && !line.includes("èº«åˆ†") && !line.includes("ä¸­è¯")) {
                     nameVal = line;
                     break;
                 }
             }
        }

        addInput(container, "å§“å", nameVal);
        addInput(container, "èº«åˆ†è­‰å­—è™Ÿ", idVal);
        addInput(container, "å‡ºç”Ÿæ—¥æœŸ", birthVal);
    }

    function addInput(parent, label, value) {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `<label>${label}</label><input type="text" value="${value}">`;
        parent.appendChild(div);
    }

    function closeModal() {
        modal.style.display = 'none';
    }
</script>
</body>
</html>