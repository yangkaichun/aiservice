<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é å‚³ Health+ ç”Ÿç†é‡æ¸¬èˆ‡èº«åˆ†èªè­‰ç³»çµ±</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        :root {
            --primary-color: #e60012; /* é å‚³ç´… */
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 15px; }
       .container { max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { color: #333; text-align: center; margin-bottom: 20px; }
       .camera-box { position: relative; width: 100%; height: 300px; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; }
       .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 60%; border: 2px solid var(--primary-color); border-radius: 8px; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); pointer-events: none; }
       .overlay::after { content: 'è«‹å°‡æ•¸å€¼/è­‰ä»¶å°æº–æ¡†å…§'; position: absolute; top: -30px; left: 0; width: 100%; text-align: center; color: white; font-weight: bold; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        
       .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
       .btn-capture { background: var(--primary-color); color: white; width: 100%; grid-column: span 2; }
       .btn-mode { background: #e0e0e0; color: #555; }
       .btn-mode.active { background: #333; color: white; }
       .btn-upload { background: #28a745; color: white; margin-top: 20px; width: 100%; display: none; }

       .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
       .status { text-align: center; color: #666; font-size: 14px; margin-top: 10px; min-height: 20px; }
       .preview-img { width: 100%; height: auto; border-radius: 8px; margin-top: 10px; display: none; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h2>ç”Ÿç†é‡æ¸¬èˆ‡èº«åˆ†é©—è­‰</h2>

    <div class="camera-box">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="overlay"></div>
    </div>

    <div class="controls">
        <button class="btn-mode active" onclick="setMode('device')">ğŸ“· ç”Ÿç†è¨­å‚™æ¨¡å¼</button>
        <button class="btn-mode" onclick="setMode('idcard')">ğŸ†” èº«åˆ†è­‰æ¨¡å¼</button>
        <button class="btn-capture" onclick="captureAndOCR()">æ‹æ”ä¸¦è¾¨è­˜</button>
    </div>

    <div id="status" class="status">æº–å‚™å°±ç·’ï¼Œè«‹é¸æ“‡æ¨¡å¼</div>
    <img id="processedPreview" class="preview-img" alt="è™•ç†å¾Œå½±åƒé è¦½">

    <div id="device-form" style="display:block;">
        <h3>ç”Ÿç†æ•¸å€¼</h3>
        <div class="form-group"><label>æ”¶ç¸®å£“ (SYS)</label><input type="number" id="sys" placeholder="mmHg"></div>
        <div class="form-group"><label>èˆ’å¼µå£“ (DIA)</label><input type="number" id="dia" placeholder="mmHg"></div>
        <div class="form-group"><label>è„ˆæ (PUL)</label><input type="number" id="pul" placeholder="bpm"></div>
        <div class="form-group"><label>å…¶ä»–æ•¸å€¼ (è¡€ç³–/è¡€æ°§/é«”æº«)</label><input type="text" id="other_val" placeholder="Value"></div>
    </div>

    <div id="id-form" style="display:none;">
        <h3>èº«åˆ†è³‡æ–™</h3>
        <div class="form-group"><label>å§“å</label><input type="text" id="name"></div>
        <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="id_no"></div>
        <div class="form-group"><label>å‡ºç”Ÿå¹´æœˆæ—¥ (YYYY-MM-DD)</label><input type="date" id="birthday"></div>
    </div>

    <button id="btn-upload" class="btn-upload" onclick="uploadToHealthPlus()">â˜ï¸ ä¸Šå‚³è‡³é å‚³ Health+</button>
</div>

<script>
    let currentMode = 'device'; // 'device' or 'idcard'
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusDiv = document.getElementById('status');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    // 1. åˆå§‹åŒ–ç›¸æ©Ÿ (é‡å°æ‰‹æ©Ÿå„ªåŒ–)
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: "environment", // å¼·åˆ¶ä½¿ç”¨å¾Œç½®é¡é ­
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            });
            video.srcObject = stream;
        } catch (err) {
            statusDiv.innerHTML = "âŒ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ: " + err.message;
        }
    }
    initCamera();

    // 2. åˆ‡æ›æ¨¡å¼é‚è¼¯
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('device-form').style.display = mode === 'device'? 'block' : 'none';
        document.getElementById('id-form').style.display = mode === 'idcard'? 'block' : 'none';
        statusDiv.innerHTML = mode === 'device'? "æ¨¡å¼ï¼šç”Ÿç†è¨­å‚™ (è¾¨è­˜ 7-segment æ•¸å­—)" : "æ¨¡å¼ï¼šèº«åˆ†è­‰ (è¾¨è­˜ä¸­æ–‡èˆ‡è­‰è™Ÿ)";
    }

    // 3. å½±åƒè™•ç†æ ¸å¿ƒæ¼”ç®—æ³•
    function preprocessImage(width, height) {
        let imgData = ctx.getImageData(0, 0, width, height);
        let data = imgData.data;

        // A. ç°éšåŒ– (Luminance Weighted)
        for (let i = 0; i < data.length; i += 4) {
            let gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            data[i] = data[i + 1] = data[i + 2] = gray;
        }

        // B. éŠ³åŒ– (åƒ…é‡å°èº«åˆ†è­‰æ¨¡å¼ï¼Œå¢å¼·æ–‡å­—é‚Šç·£)
        if (currentMode === 'idcard') {
            // ç°¡å–®çš„éŠ³åŒ–å·ç©å¯åœ¨æ­¤å¯¦ä½œï¼Œç‚ºç°¡åŒ–ç¨‹å¼ç¢¼ç•¥éè¤‡é›œçŸ©é™£é‹ç®—ï¼Œç›´æ¥é€²å…¥äºŒå€¼åŒ–
        }

        // C. Otsu äºŒå€¼åŒ– (æ ¸å¿ƒï¼šè‡ªå‹•è¨ˆç®—æœ€ä½³é–¾å€¼)
        const histogram = new Array(256).fill(0);
        for (let i = 0; i < data.length; i += 4) histogram[Math.floor(data[i])]++;
        
        let sum = 0, sumB = 0, wB = 0, wF = 0, max = 0, threshold = 0;
        let total = data.length / 4;
        for (let i = 0; i < 256; i++) sum += i * histogram[i];

        for (let t = 0; t < 256; t++) {
            wB += histogram[t];
            if (wB === 0) continue;
            wF = total - wB;
            if (wF === 0) break;
            sumB += t * histogram[t];
            let mB = sumB / wB;
            let mF = (sum - sumB) / wF;
            let between = wB * wF * (mB - mF) * (mB - mF);
            if (between > max) { max = between; threshold = t; }
        }

        // æ‡‰ç”¨é–¾å€¼ä¸¦é€²è¡Œåè½‰ (è‹¥éœ€è¦)
        // å‡è¨­è¢å¹•æ˜¯ç°åº•é»‘å­—ï¼ŒäºŒå€¼åŒ–å¾Œå¯èƒ½éœ€è¦åè½‰ä»¥ç¬¦åˆ Tesseract (ç™½åº•é»‘å­—)
        for (let i = 0; i < data.length; i += 4) {
            let val = data[i] > threshold? 255 : 0;
            if (currentMode === 'device') { 
                // é‡å° LCDï¼Œæœ‰æ™‚éœ€è¦è†¨è„¹æ“ä½œ (Dilation) ä¾†é€£æ¥æ–·è£‚çš„æ•¸å­—
                // é€™è£¡ä½¿ç”¨ç°¡æ˜“çš„é‚è¼¯ï¼šå¦‚æœå‘¨åœæœ‰é»‘é»ï¼Œå‰‡è®Šé»‘
            }
            data[i] = data[i + 1] = data[i + 2] = val;
        }
        
        ctx.putImageData(imgData, 0, 0);
    }

    // 4. æ‹æ”èˆ‡ OCR ä¸»æµç¨‹
    async function captureAndOCR() {
        statusDiv.innerHTML = "â³ å½±åƒè™•ç†èˆ‡è¾¨è­˜ä¸­...";
        
        // ç¹ªè£½ Video åˆ° Canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // åŸ·è¡Œå½±åƒé è™•ç†
        preprocessImage(canvas.width, canvas.height);
        
        // é¡¯ç¤ºé è™•ç†å¾Œçš„å½±åƒ (Debugç”¨)
        const processedImg = document.getElementById('processedPreview');
        processedImg.src = canvas.toDataURL();
        processedImg.style.display = 'block';

        // å»ºç«‹ Tesseract Worker
        const worker = await Tesseract.createWorker();
        
        try {
            if (currentMode === 'device') {
                // === ç”Ÿç†è¨­å‚™æ¨¡å¼é…ç½® ===
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                // é—œéµï¼šè¨­å®šç™½åå–®èˆ‡ PSM 6 (å‡è¨­çµ±ä¸€å€å¡Š)
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789.', 
                    tessedit_pageseg_mode: '6',
                });
            } else {
                // === èº«åˆ†è­‰æ¨¡å¼é…ç½® ===
                // éœ€åŠ è¼‰ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡
                await worker.loadLanguage('chi_tra+eng');
                await worker.initialize('chi_tra+eng');
                await worker.setParameters({
                    tessedit_pageseg_mode: '3', // è‡ªå‹•ç‰ˆé¢åˆ†æ
                });
            }

            const { data: { text } } = await worker.recognize(canvas);
            console.log("åŸå§‹è­˜åˆ¥æ–‡å­—:", text);
            statusDiv.innerHTML = "âœ… è¾¨è­˜å®Œæˆ";

            // 5. æ•¸æ“šè§£æèˆ‡å¡«å…¥
            if (currentMode === 'device') {
                parseDeviceData(text);
            } else {
                parseIDCardData(text);
            }

            document.getElementById('btn-upload').style.display = 'block';

        } catch (err) {
            console.error(err);
            statusDiv.innerHTML = "âŒ è¾¨è­˜å¤±æ•—: " + err.message;
        } finally {
            await worker.terminate();
        }
    }

    // 6. æ•¸æ“šè§£æé‚è¼¯ (Regex & Heuristics)
    function parseDeviceData(text) {
        // æ¸…ç†éæ•¸å­—å­—ç¬¦
        const numbers = text.match(/\d+(\.\d+)?/g);
        if (!numbers) return;

        // è½‰æ›ç‚ºæµ®é»æ•¸ä¸¦æ’åº
        let vals = numbers.map(n => parseFloat(n)).filter(n => n > 30 && n < 250); // éæ¿¾ä¸åˆç†æ•¸å€¼
        
        // å•Ÿç™¼å¼å¡«å…¥ï¼šå‡è¨­æ•¸å€¼ç”±å¤§åˆ°å°ç‚º æ”¶ç¸®å£“ > èˆ’å¼µå£“ > è„ˆæ
        if (vals.length >= 2) {
            vals.sort((a, b) => b - a); // é™åº
            document.getElementById('sys').value = vals; // æœ€å¤§å€¼
            document.getElementById('dia').value = vals[2]; // æ¬¡å¤§å€¼
            if (vals.length >= 3) document.getElementById('pul').value = vals[3];
        } else if (vals.length === 1) {
            // å¯èƒ½æ˜¯é«”æº«æˆ–è¡€ç³–
            document.getElementById('other_val').value = vals;
        }
    }

    function parseIDCardData(text) {
        // A. èº«åˆ†è­‰å­—è™Ÿ Regex: é¦–å­—å¤§å¯«è‹±æ–‡ + 1æˆ–2 + 8ä½æ•¸å­—
        const idMatch = text.match(/[A-Z][1]\d{8}/);
        if (idMatch) document.getElementById('id_no').value = idMatch;

        // B. æ°‘åœ‹ç”Ÿæ—¥ Regex: æŠ“å– "å¹´" "æœˆ" "æ—¥" å‰çš„æ•¸å­—
        const dateMatch = text.match(/(\d{2,3})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
        if (dateMatch) {
            let rocYear = parseInt(dateMatch[2]);
            let month = dateMatch.[3]padStart(2, '0');
            let day = dateMatch.[4]padStart(2, '0');
            let adYear = rocYear + 1911; // æ°‘åœ‹è½‰è¥¿å…ƒ
            document.getElementById('birthday').value = `${adYear}-${month}-${day}`;
        }

        // C. å§“å Regex: æŠ“å– "å§“å" é—œéµå­—å¾Œçš„ 2-4 å€‹ä¸­æ–‡å­—
        // [\u4e00-\u9fa5] æ˜¯ä¸­æ–‡å­— Unicode ç¯„åœ
        const nameMatch = text.match(/å§“å[:\s]*([\u4e00-\u9fa5]{2,4})/);
        if (nameMatch) document.getElementById('name').value = nameMatch[2];
    }

    // 7. æ¨¡æ“¬ä¸Šå‚³è‡³é å‚³ Health+
    function uploadToHealthPlus() {
        const payload = {
            timestamp: new Date().toISOString(),
            dataType: currentMode === 'device'? 'VITAL_SIGNS' : 'IDENTITY',
            data: currentMode === 'device'? {
                systolic: document.getElementById('sys').value,
                diastolic: document.getElementById('dia').value,
                pulse: document.getElementById('pul').value,
                other: document.getElementById('other_val').value
            } : {
                name: document.getElementById('name').value,
                id: document.getElementById('id_no').value,
                birthday: document.getElementById('birthday').value
            }
        };

        statusDiv.innerHTML = "â˜ï¸ æ­£åœ¨ä¸Šå‚³è‡³é å‚³ Health+...";
        console.log("Uploading Payload:", JSON.stringify(payload, null, 2));

        // æ¨¡æ“¬ API å»¶é²
        setTimeout(() => {
            alert(`ä¸Šå‚³æˆåŠŸï¼\n\nå·²å‚³é€è‡³é å‚³ Health+ å¹³å°ã€‚\nè³‡æ–™å…§å®¹ï¼š\n${JSON.stringify(payload.data, null, 2)}`);
            statusDiv.innerHTML = "âœ… ä¸Šå‚³å®Œæˆ";
        }, 1500);
    }
</script>

</body>
</html>