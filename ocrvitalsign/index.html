<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OCR é™¤éŒ¯æ¨¡å¼</title>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* API Key è¼¸å…¥å€ */
        .input-area { padding: 15px; background: #222; border-bottom: 1px solid #444; }
        input { width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        
        /* å½±åƒå€ */
        .preview-area { flex: 1; position: relative; background: black; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        video, img { max-width: 100%; max-height: 100%; }
        
        /* é™¤éŒ¯ç´€éŒ„å€ (é‡é») */
        #debug-log {
            height: 150px; background: #000; color: #0f0; 
            font-family: monospace; font-size: 12px; 
            padding: 10px; overflow-y: scroll; border-top: 2px solid #444;
            white-space: pre-wrap;
        }

        /* æ§åˆ¶å€ */
        .controls { padding: 10px; display: flex; gap: 10px; background: #222; }
        button { flex: 1; padding: 15px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }
        .btn-cam { background: #E60012; color: white; }
        .btn-file { background: #444; color: white; }
        
        /* çµæœå½ˆçª— */
        #result-box { display: none; position: fixed; top: 10%; left: 5%; width: 90%; background: #333; padding: 20px; border-radius: 10px; border: 1px solid #666; box-shadow: 0 0 20px black; }
        .field { margin-bottom: 10px; }
        .field label { display: block; color: #aaa; font-size: 12px; }
        .field input { font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

<div class="input-area">
    <input type="text" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Š Google API Key (å¿…å¡«)">
</div>

<div class="preview-area">
    <video id="video" autoplay playsinline muted></video>
    <img id="preview-img" style="display:none">
</div>

<div id="debug-log">=== ç³»çµ±æº–å‚™å°±ç·’ ===<br>è«‹è¼¸å…¥ Key ä¸¦é–‹å§‹æ‹æ”...</div>

<div class="controls">
    <button class="btn-file" onclick="document.getElementById('file-input').click()">ğŸ“‚ é¸ç…§ç‰‡</button>
    <button class="btn-cam" id="snap-btn">ğŸ“· æ‹ç…§è¾¨è­˜</button>
</div>
<input type="file" id="file-input" accept="image/*" style="display:none">

<div id="result-box">
    <h3>è§£æçµæœ</h3>
    <div id="parsed-fields"></div>
    <br>
    <button onclick="document.getElementById('result-box').style.display='none'" style="background:#555; color:white;">é—œé–‰</button>
</div>

<script>
    const logBox = document.getElementById('debug-log');
    const video = document.getElementById('video');
    const previewImg = document.getElementById('preview-img');
    
    // 1. å•Ÿå‹•ç›¸æ©Ÿ
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => video.srcObject = stream)
        .catch(err => log("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err));

    // 2. é¡¯ç¤º Log çš„å·¥å…·
    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logBox.innerHTML += `\n[${time}] ${msg}`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    // 3. è™•ç†æŒ‰éˆ•
    document.getElementById('snap-btn').addEventListener('click', () => {
        const key = document.getElementById('api-key').value.trim();
        if (!key) return alert("è«‹å…ˆè¼¸å…¥ API Keyï¼");
        
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        processImage(canvas.toDataURL('image/jpeg', 0.8), key);
    });

    document.getElementById('file-input').addEventListener('change', (e) => {
        const key = document.getElementById('api-key').value.trim();
        if (!key) return alert("è«‹å…ˆè¼¸å…¥ API Keyï¼");
        if (!e.target.files[0]) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
            previewImg.src = evt.target.result;
            video.style.display = 'none';
            previewImg.style.display = 'block';
            processImage(evt.target.result, key);
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    // 4. å‘¼å« Google API (é—œéµéƒ¨åˆ†)
    async function processImage(base64Data, apiKey) {
        log("-----------------------------");
        log("æº–å‚™ä¸Šå‚³åœ–ç‰‡è‡³ Google...");
        
        // ç§»é™¤ Data URI header
        const base64Content = base64Data.split(',')[1];
        
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`;
        const body = {
            requests: [{
                image: { content: base64Content },
                features: [{ type: "TEXT_DETECTION" }, { type: "DOCUMENT_TEXT_DETECTION" }]
            }]
        };

        try {
            log("ç™¼é€è«‹æ±‚ä¸­ (POST)...");
            const res = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(body),
                headers: { 'Content-Type': 'application/json' }
            });

            log(`HTTP ç‹€æ…‹ç¢¼: ${res.status}`);

            if (!res.ok) {
                const errData = await res.json();
                log("âŒ API éŒ¯èª¤: " + JSON.stringify(errData.error, null, 2));
                alert("API å‘¼å«å¤±æ•—ï¼Œè«‹çœ‹ä¸‹æ–¹ç´€éŒ„");
                return;
            }

            const data = await res.json();
            const annotations = data.responses[0].textAnnotations;

            if (!annotations || annotations.length === 0) {
                log("âš ï¸ Google å›å‚³æˆåŠŸï¼Œä½†æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•æ–‡å­—ï¼");
                alert("åœ–ç‰‡æ¸…æ™°åº¦ä¸è¶³ï¼Œæˆ–ç„¡æ–‡å­—");
                return;
            }

            // æˆåŠŸæŠ“åˆ°æ–‡å­—
            const fullText = annotations[0].description;
            log("âœ… è¾¨è­˜æˆåŠŸï¼åŸå§‹æ–‡å­—å¦‚ä¸‹ï¼š\n" + fullText);
            
            parseAndShow(fullText);

        } catch (e) {
            log("âŒ ç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤: " + e.message);
        }
    }

    // 5. è§£æé‚è¼¯ (æ›´å¯¬é¬†çš„åˆ¤æ–·)
    function parseAndShow(text) {
        const container = document.getElementById('parsed-fields');
        container.innerHTML = '';
        const lines = text.split('\n');

        // === å˜—è©¦è§£æè¡€å£“ ===
        // æ‰¾æ•¸å­—ï¼Œéæ¿¾æ‰ä¸åƒè¡€å£“çš„
        let nums = (text.match(/\d+/g) || []).map(Number);
        nums = nums.filter(n => n > 30 && n < 250); // éæ¿¾æ‰æ¥µç«¯å€¼
        // æ’é™¤æ‰å¯èƒ½æ˜¯æ—¥æœŸçš„ (ä¾‹å¦‚ 2023, 1999)
        nums = nums.filter(n => n < 1900); 

        // === å˜—è©¦è§£æèº«åˆ†è­‰ ===
        let name = "", id = "", birth = "";
        
        // ID Regex
        const idMatch = text.replace(/\s/g,'').match(/[A-Z][0-9]{9}/);
        if (idMatch) id = idMatch[0];

        // å§“å Regex (å¯¬é¬†)
        for(let line of lines) {
            if(line.includes("å§“å")) {
                let temp = line.replace(/å§“å/g, '').replace(/[^\u4e00-\u9fa5]/g, ''); // åªç•™ä¸­æ–‡
                if(temp.length > 1) name = temp;
            }
        }
        // å¦‚æœæ²’æ‰¾åˆ°å§“åæ¨™ç±¤ï¼Œæ‰¾ç´”ä¸­æ–‡çŸ­å­—ä¸²
        if(!name) {
            for(let line of lines) {
                if(/^[\u4e00-\u9fa5]{2,4}$/.test(line.trim())) {
                    if(!line.includes("èº«åˆ†") && !line.includes("ä¸­è¯")) name = line.trim();
                }
            }
        }

        // é¡¯ç¤ºçµæœ
        log("--- è§£æçµæœ ---");
        if(id) {
            log("æ¨¡å¼: èº«åˆ†è­‰");
            addInput("å§“å", name);
            addInput("èº«åˆ†è­‰", id);
        } else if (nums.length >= 2) {
            log("æ¨¡å¼: ç”Ÿç†å„€å™¨");
            // æ’åº: å‡è¨­å¤§çš„æ˜¯è¡€å£“
            nums.sort((a,b) => b-a);
            addInput("æ”¶ç¸®å£“", nums[0]);
            addInput("èˆ’å¼µå£“", nums[1]);
            if(nums[2]) addInput("è„ˆæ", nums[2]);
        } else {
            log("âš ï¸ ç„¡æ³•è‡ªå‹•æ­¸é¡ï¼Œé¡¯ç¤ºåŸå§‹æ–‡å­—");
            addInput("åŸå§‹å…§å®¹", text);
        }

        document.getElementById('result-box').style.display = 'block';
    }

    function addInput(label, val) {
        const div = document.createElement('div');
        div.className = 'field';
        div.innerHTML = `<label>${label}</label><input value="${val}">`;
        document.getElementById('parsed-fields').appendChild(div);
    }
</script>
</body>
</html>