<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訪視路徑規劃最佳化</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
        }
       .container {
            width: 100%;
            max-width: 600px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 24px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0;
        }
       .form-group,.waypoint-entry {
            margin-bottom: 16px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* 確保 padding 不影響寬度 */
        }
       .waypoint-entry {
            display: flex;
            align-items: center;
            gap: 10px;
        }
       .waypoint-entry input[type="text"] {
            flex-grow: 1; /* 讓輸入框填滿剩餘空間 */
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
       .controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        #add-waypoint-btn {
            background-color: #3498db;
            color: white;
        }
        #add-waypoint-btn:hover {
            background-color: #2980b9;
        }
        #plan-route-btn {
            background-color: #2ecc71;
            color: white;
            flex-grow: 1; /* 讓規劃按鈕更顯著 */
        }
        #plan-route-btn:hover {
            background-color: #27ae60;
        }
       .remove-waypoint-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
        }
       .remove-waypoint-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>訪視路徑規劃最佳化</h1>
        
        <div class="form-group">
            <label for="origin-address">起始點地址：</label>
            <input type="text" id="origin-address" placeholder="請輸入起始點..." required>
        </div>
        
        <div id="waypoints-container">
            </div>
        
        <div class="controls">
            <button type="button" id="add-waypoint-btn">新增到達點</button>
            <button type="button" id="plan-route-btn">規劃最佳路徑</button>
        </div>
    </div>

    <script>
        // === 應用程式初始化 ===
        function initApp() {
            // 實例化 DirectionsService
            const directionsService = new google.maps.DirectionsService();

            // 綁定事件監聽器
            document.getElementById('add-waypoint-btn').addEventListener('click', addWaypointInput);
            document.getElementById('waypoints-container').addEventListener('click', handleRemoveWaypoint);
            document.getElementById('plan-route-btn').addEventListener('click', () => {
                calculateOptimizedRoute(directionsService);
            });
            
            // 預設新增一個到達點欄位
            addWaypointInput();
        }

        // === (Part 3) 動態管理中途站點 ===

        function addWaypointInput() {
            const container = document.getElementById('waypoints-container');

            const entryDiv = document.createElement('div');
            entryDiv.className = 'waypoint-entry';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'waypoint-input';
            input.placeholder = '請輸入到達點...';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-waypoint-btn';
            removeBtn.textContent = '移除';

            entryDiv.appendChild(input);
            entryDiv.appendChild(removeBtn);
            container.appendChild(entryDiv);
        }

        function handleRemoveWaypoint(event) {
            if (event.target.classList.contains('remove-waypoint-btn')) {
                // 檢查是否為最後一個輸入框，如果是，則不清空，而是清除其內容
                const container = document.getElementById('waypoints-container');
                if (container.children.length > 1) {
                    event.target.parentElement.remove();
                } else {
                    // 如果是最後一個，只清空內容
                    event.target.parentElement.querySelector('.waypoint-input').value = '';
                }
            }
        }

        // === (Part 4) 核心邏輯（第一階段）- 呼叫 API ===

        function calculateOptimizedRoute(directionsService) {
            // 1. 獲取起始點
            const origin = document.getElementById('origin-address').value;
            
            // 2. 獲取所有 "到達點"
            const waypointInputs = document.querySelectorAll('.waypoint-input');
            
            // 3. 轉換為地址字串陣列並過濾空值
            const waypointAddresses = Array.from(waypointInputs)
                                          .map(input => input.value)
                                          .filter(address => address.trim()!== '');

            // 4. 輸入驗證
            if (!origin) {
                alert('請輸入起始點地址。');
                return;
            }
            if (waypointAddresses.length === 0) {
                alert('請至少新增一個到達點。');
                return;
            }

            // 5. 邏輯分岔：分離 destination 和 intermediateWaypoints
            const destination = waypointAddresses[waypointAddresses.length - 1];
            const intermediateWaypoints = waypointAddresses.slice(0, -1);

            // 6. 轉換為 DirectionsWaypoint 物件
            const waypts = intermediateWaypoints.map(location => ({
                location: location,
                stopover: true 
            }));

            // 7. 建構 Request 物件
            const request = {
                origin: origin,
                destination: destination,
                waypoints: waypts,
                optimizeWaypoints: true, // 核心：自動判斷順序
                travelMode: google.maps.TravelMode.DRIVING
            };

            // 8. 執行 API 呼叫
            directionsService.route(request, function(response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    // 成功：進入第二階段
                    handleApiResponse(response, origin, destination, intermediateWaypoints);
                } else {
                    alert('路徑規劃失敗：' + status + '。請檢查地址是否正確。');
                }
            });
        }

        // === (Part 5) 核心邏輯（第二階段）- 解析與建構 URL ===

        function handleApiResponse(response, origin, destination, originalWaypoints) {
            // 1. 獲取最佳化後的索引順序
            const optimizedOrder = response.routes.waypoint_order;
            
            // 2. 根據索引順序，重新排序原始地址陣列
            const reorderedWaypoints = optimizedOrder.map(index => originalWaypoints[index]);

            // 3. 將中途點陣列轉換為 "pipe-separated" 字串
            const waypointString = reorderedWaypoints.join('|');
            
            // 4. URL 編碼
            const encodedOrigin = encodeURIComponent(origin);
            const encodedDestination = encodeURIComponent(destination);
            const encodedWaypoints = encodeURIComponent(waypointString);
            
            // 5. 建構基礎 URL
            let mapsUrl = `https://www.google.com/maps/dir/?api=1`;
            mapsUrl += `&origin=${encodedOrigin}`;
            mapsUrl += `&destination=${encodedDestination}`;
            
            if (encodedWaypoints) {
                mapsUrl += `&waypoints=${encodedWaypoints}`;
            }
            
            mapsUrl += `&travelmode=driving`;
            
            // 6. 添加 "navigate" 動作
            mapsUrl += `&dir_action=navigate`;

            // 7. 在新分頁中開啟
            window.open(mapsUrl, '_blank');
        }

    </script>
    <script async 
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initApp">
    </script>
</body>
</html>
