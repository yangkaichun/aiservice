<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訪視路徑規劃最佳化 (ORS 免費版)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
        }
     .container {
            width: 100%;
            max-width: 600px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 24px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0;
        }
     .form-group,.waypoint-entry {
            margin-bottom: 16px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; 
        }
     .waypoint-entry {
            display: flex;
            align-items: center;
            gap: 10px;
        }
     .waypoint-entry input[type="text"] {
            flex-grow: 1; 
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
     .controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        #add-waypoint-btn {
            background-color: #3498db;
            color: white;
        }
        #add-waypoint-btn:hover {
            background-color: #2980b9;
        }
        #plan-route-btn {
            background-color: #2ecc71;
            color: white;
            flex-grow: 1; 
        }
        #plan-route-btn:hover {
            background-color: #27ae60;
        }
     .remove-waypoint-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
        }
     .remove-waypoint-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>訪視路徑規劃最佳化</h1>
        
        <div class="form-group">
            <label for="origin-address">起始點地址：</label>
            <input type="text" id="origin-address" placeholder="請輸入起始點..." required>
        </div>
        
        <div id="waypoints-container">
            </div>
        
        <div class="controls">
            <button type="button" id="add-waypoint-btn">新增到達點</button>
            <button type="button" id="plan-route-btn">規劃最佳路徑</button>
        </div>
        
        <div id="status-message" style="margin-top: 15px; text-align: center; font-weight: 600;"></div>
    </div>

    <script>
        // === 請將此處替換為您自己的 OpenRouteService API 金鑰 ===
        const OPENROUTESERVICE_API_KEY = "YOUR_ORS_API_KEY"; 
        // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        // 前往 https://openrouteservice.org/ 註冊免費帳戶以取得

        // === 應用程式初始化 ===
        function initApp() {
            // 綁定事件監聽器
            document.getElementById('add-waypoint-btn').addEventListener('click', addWaypointInput);
            document.getElementById('waypoints-container').addEventListener('click', handleRemoveWaypoint);
            document.getElementById('plan-route-btn').addEventListener('click', () => {
                // 檢查金鑰是否已填入
                if (OPENROUTESERVICE_API_KEY === "YOUR_ORS_API_KEY") {
                    alert("請在 HTML 程式碼中填入您的 openrouteservice API 金鑰。");
                    return;
                }
                calculateOptimizedRoute(OPENROUTESERVICE_API_KEY);
            });
            
            // 預設新增一個到達點欄位
            addWaypointInput();
        }
        
        // === 動態管理中途站點 (與前版相同) ===
        function addWaypointInput() {
            const container = document.getElementById('waypoints-container');

            const entryDiv = document.createElement('div');
            entryDiv.className = 'waypoint-entry';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'waypoint-input';
            input.placeholder = '請輸入到達點...';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-waypoint-btn';
            removeBtn.textContent = '移除';

            entryDiv.appendChild(input);
            entryDiv.appendChild(removeBtn);
            container.appendChild(entryDiv);
        }

        function handleRemoveWaypoint(event) {
            if (event.target.classList.contains('remove-waypoint-btn')) {
                const container = document.getElementById('waypoints-container');
                if (container.children.length > 1) {
                    event.target.parentElement.remove();
                } else {
                    event.target.parentElement.querySelector('.waypoint-input').value = '';
                }
            }
        }

        // === (ORS) 步驟 1：地理編碼 (將地址轉換為座標) ===
        async function fetchGeocode(address, apiKey) {
            const url = `https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(address)}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Geocode HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    // 回傳第一個結果的座標 [經度, 緯度]
                    return data.features.geometry.coordinates;
                } else {
                    throw new Error(`找不到地址: ${address}`);
                }
            } catch (error) {
                console.error('Geocode error:', error);
                throw error; // 將錯誤向上拋出
            }
        }

        // === (ORS) 步驟 2：呼叫 ORS 最佳化 API ===
        async function calculateOptimizedRoute(apiKey) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = '正在規劃路徑，請稍候...';
            statusEl.style.color = 'blue';

            try {
                // 1. 收集所有地址
                const origin = document.getElementById('origin-address').value;
                const waypointInputs = document.querySelectorAll('.waypoint-input');
                const waypointAddresses = Array.from(waypointInputs)
                                             .map(input => input.value)
                                             .filter(address => address.trim()!== '');

                // 2. 驗證輸入
                if (!origin) throw new Error('請輸入起始點地址。');
                if (waypointAddresses.length === 0) throw new Error('請至少新增一個到達點。');

                // 3. 執行所有地理編碼
                statusEl.textContent = '正在轉換地址 (共 ' + (waypointAddresses.length + 1) + ' 個)...';
                
                const originCoordPromise = fetchGeocode(origin, apiKey);
                
                const destination = waypointAddresses[waypointAddresses.length - 1];
                const intermediateWaypoints = waypointAddresses.slice(0, -1);
                
                const destinationCoordPromise = fetchGeocode(destination, apiKey);
                const waypointCoordPromises = intermediateWaypoints.map(addr => fetchGeocode(addr, apiKey));

                // 等待所有編碼完成
                const [startCoord, endCoord, wayptsCoords] = await Promise.all([
                    originCoordPromise,
                    destinationCoordPromise,
                    Promise.all(waypointCoordPromises)
                ]);

                // 4. 建構 ORS Optimization API 請求
                statusEl.textContent = '正在計算最佳順序...';
                
                const jobs = wayptsCoords.map((coord, index) => ({
                    id: index,
                    location: coord // [經度, 緯度]
                }));
                
                const optimizationRequest = {
                    jobs: jobs,
                    vehicles: [
                        {
                            id: 1,
                            profile: 'driving-car',
                            start: startCoord, // [經度, 緯度]
                            end: endCoord    // [經度, 緯度]
                        }
                    ]
                };

                // 5. 發送 POST 請求到 Optimization API
                const response = await fetch('https://api.openrouteservice.org/v2/optimization', {
                    method: 'POST',
                    headers: {
                        'Authorization': apiKey,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8'
                    },
                    body: JSON.stringify(optimizationRequest)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`ORS API 錯誤: ${errorData.error? errorData.error.message : response.status}`);
                }

                const result = await response.json();
                
                if (result.routes && result.routes.length > 0) {
                    // 6. 成功：處理回應並開啟 Google 地圖
                    handleApiResponse(result, startCoord, endCoord);
                    statusEl.textContent = '路徑規劃完成！正在開啟地圖...';
                    statusEl.style.color = 'green';
                } else if (result.code === 2010) { // 特定錯誤碼：找不到點
                     throw new Error('ORS 錯誤：找不到點。請檢查地址是否在陸地上。');
                } else {
                    throw new Error('ORS 未能找到路徑。');
                }

            } catch (error) {
                console.error('路徑規劃失敗:', error);
                statusEl.textContent = `錯誤：${error.message}`;
                statusEl.style.color = 'red';
            }
        }

        // === (ORS) 步驟 3：解析回應並建構 Google Maps URL ===
        function handleApiResponse(response, startCoord, endCoord) {
            
            const steps = response.routes.steps;
            let optimizedCoords =; // 儲存 "緯度,經度" 格式的字串

            // ORS `steps` 陣列已包含 start, end, 和所有 jobs
            steps.forEach(step => {
                // step.location 是 [經度, 緯度]
                if (step.type === 'start') {
                    // 轉換為 "緯度,經度"
                    optimizedCoords.push(`${startCoord[1]},${startCoord}`);
                } else if (step.type === 'job') {
                    optimizedCoords.push(`${step.location[1]},${step.location}`);
                }
                // 我們在迴圈的最後單獨添加終點
            });
            
            // 添加固定的終點
            optimizedCoords.push(`${endCoord[1]},${endCoord}`);

            // 建構 Google Maps 導航 URL
            // 格式: /dir/緯度,經度/緯度,經度/...
            const googleMapsUrl = `https://www.google.com/maps/dir/${optimizedCoords.join('/')}`;

            // 在新分頁中開啟
            window.open(googleMapsUrl, '_blank');
        }

        // === 啟動應用程式 ===
        // 我們不需要等待 Google API，所以直接啟動
        initApp();

    </script>
</body>
</html>
