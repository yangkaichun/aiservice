<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk 後台管理系統 | 中山醫大 x FET</title>
    <link rel="icon" href="images/feticon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --c-primary: #009944; /* CSMUH Green */
            --c-primary-dark: #007a36;
            --c-secondary: #E60012; /* FET Red */
            --c-bg: #f4f7f6;
            --c-sidebar: #ffffff;
            --c-text: #333;
            --c-border: #e0e0e0;
            --font-main: "Microsoft JhengHei", "Heiti TC", sans-serif;
            --wf-node-bg: #ffffff;
            --wf-node-border: #d1d5db;
            --wf-grid-dot: #e5e7eb;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            font-family: var(--font-main);
            background: var(--c-bg);
            display: flex;
            height: 100vh;
            color: var(--c-text);
            overflow: hidden; /* Prevent body scroll for canvas */
        }

        /* --- Sidebar --- */
        aside {
            width: 260px;
            background: var(--c-sidebar);
            border-right: 1px solid var(--c-border);
            display: flex; flex-direction: column;
            flex-shrink: 0;
            z-index: 20;
        }
        .brand {
            height: 70px; display: flex; align-items: center; padding: 0 20px;
            border-bottom: 1px solid var(--c-border); gap: 10px;
        }
        .brand img { height: 28px; }
        .brand span { font-weight: bold; font-size: 16px; color: #555; }
        .nav-menu { flex: 1; padding: 20px 0; }
        .nav-item {
            padding: 15px 25px; display: flex; align-items: center; gap: 15px;
            cursor: pointer; transition: all 0.2s; color: #666; font-size: 15px;
        }
        .nav-item:hover { background: #f0f9f4; color: var(--c-primary); }
        .nav-item.active {
            background: #e6fff0; color: var(--c-primary);
            border-right: 4px solid var(--c-primary); font-weight: bold;
        }
        .nav-footer { padding: 20px; border-top: 1px solid var(--c-border); font-size: 12px; color: #999; }

        /* --- Main Content --- */
        main {
            flex: 1;
            display: flex; flex-direction: column;
            background: #f8f9fa;
            position: relative;
        }

        header {
            height: 70px;
            background: #fff;
            border-bottom: 1px solid var(--c-border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 20px; color: #2c3e50; }
        .user-profile { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .avatar-circle { width: 36px; height: 36px; background: var(--c-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; }

        /* --- Sections --- */
        .content-section {
            display: none;
            padding: 30px;
            overflow-y: auto;
            height: 100%;
        }
        .content-section.active { display: block; }

        /* --- Workflow Editor specific styles --- */
        #tab-workflow {
            padding: 0; /* Remove padding for full canvas */
            display: none;
            flex-direction: row;
            height: calc(100vh - 70px);
        }
        #tab-workflow.active { display: flex; }

        /* Workflow Toolbox */
        .wf-toolbox {
            width: 220px;
            background: #fff;
            border-right: 1px solid var(--c-border);
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            z-index: 10;
        }
        .toolbox-title { font-size: 14px; font-weight: bold; color: #888; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .toolbox-item {
            padding: 12px;
            background: #fff;
            border: 1px solid var(--c-border);
            border-radius: 8px;
            cursor: grab;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: all 0.2s;
        }
        .toolbox-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); border-color: var(--c-primary); }
        .toolbox-item i { color: #666; width: 20px; text-align: center; }

        /* Workflow Canvas */
        .wf-canvas-container {
            flex: 1;
            position: relative;
            background-color: #f9fafb;
            background-image: radial-gradient(var(--wf-grid-dot) 2px, transparent 2px);
            background-size: 20px 20px;
            overflow: hidden;
            cursor: grab;
        }
        .wf-canvas-container:active { cursor: grabbing; }

        /* Workflow Nodes */
        .wf-node {
            position: absolute;
            width: 280px;
            background: var(--wf-node-bg);
            border: 1px solid var(--wf-node-border);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex; flex-direction: column;
            z-index: 5;
            cursor: default;
        }
        .wf-node-header {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            display: flex; align-items: center; justify-content: space-between;
            cursor: move; /* Drag handle */
        }
        .wf-node-header i { margin-right: 8px; color: var(--c-primary); }
        .wf-node-body { padding: 15px; font-size: 13px; color: #555; line-height: 1.5; }
        .wf-node-ports {
            display: flex; justify-content: space-between;
            padding: 0 10px 10px;
        }
        .wf-port {
            width: 12px; height: 12px;
            background: #fff; border: 2px solid #999;
            border-radius: 50%;
            cursor: crosshair;
        }
        .wf-port.in { border-color: var(--c-primary); }
        .wf-port.out { border-color: var(--c-secondary); }

        /* Active Node Style */
        .wf-node.selected { border: 2px solid #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .wf-node.selected .wf-node-header { background: #eff6ff; color: #1e40af; }

        /* SVG Connections Layer */
        .connections-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass through to nodes */
            z-index: 1;
        }
        path.connection-line {
            fill: none;
            stroke: #b1b1b1;
            stroke-width: 2px;
            transition: stroke 0.3s;
        }

        /* --- Standard Forms --- */
        .card { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 25px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; transition: background 0.2s; }
        .btn-primary { background: var(--c-primary); color: white; }
        .btn-secondary { background: #e9ecef; color: #333; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;}
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    </style>
</head>
<body>

    <aside>
        <div class="brand">
            <img src="images/fetlogo.png" alt="FET">
            <span>Kiosk Admin</span>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" onclick="switchTab('tab-kb', this)">
                <i class="fa-solid fa-book"></i> 知識庫管理
            </div>
            <div class="nav-item" onclick="switchTab('tab-workflow', this)">
                <i class="fa-solid fa-project-diagram"></i> AI 流程設計
            </div>
            <div class="nav-item" onclick="switchTab('tab-logic', this)">
                <i class="fa-solid fa-brain"></i> 邏輯參數設定
            </div>
            <div class="nav-item" onclick="switchTab('tab-api', this)">
                <i class="fa-solid fa-network-wired"></i> 系統 API 介接
            </div>
            <div class="nav-item" onclick="switchTab('tab-avatar', this)">
                <i class="fa-solid fa-user-astronaut"></i> 虛擬人 Avatar
            </div>
        </nav>
        <div class="nav-footer">
            v2.0.1 | CSMUH IT Dept.
        </div>
    </aside>

    <main>
        <header>
            <h1 id="page-title">知識庫管理 (RAG)</h1>
            <div class="user-profile">
                <span>Admin User</span>
                <div class="avatar-circle">A</div>
            </div>
        </header>

        <section id="tab-kb" class="content-section active">
            <div class="card">
                <h2>文本資料列表</h2>
                <p>此處為知識庫管理介面 (與之前相同)...</p>
                <button class="btn btn-primary">上傳新文件</button>
            </div>
        </section>

        <section id="tab-workflow">
            <div class="wf-toolbox">
                <div class="toolbox-title">觸發 (Trigger)</div>
                <div class="toolbox-item" draggable="true"><i class="fa-solid fa-microphone"></i> 語音輸入開始</div>
                <div class="toolbox-item" draggable="true"><i class="fa-solid fa-id-card"></i> 健保卡插入</div>
                
                <div class="toolbox-title" style="margin-top:20px;">動作 (Actions)</div>
                <div class="toolbox-item" draggable="true"><i class="fa-solid fa-language"></i> STT 語音轉文字</div>
                <div class="toolbox-item" draggable="true"><i class="fa-solid fa-robot"></i> LLM 意圖識別</div>
                <div class="toolbox-item" draggable="true"><i class="fa-solid fa-database"></i> RAG 知識庫搜尋</div>
                <div class="toolbox-item" draggable="true"><i class="fa-solid fa-comment-dots"></i> 生成回應 (TTS)</div>
                
                <div style="margin-top:auto;">
                    <button class="btn btn-primary" style="width:100%;" onclick="alert('流程已儲存並部署！')"><i class="fa-solid fa-save"></i> 部署流程</button>
                </div>
            </div>

            <div class="wf-canvas-container" id="canvas-area">
                <svg class="connections-layer" id="svg-layer">
                    </svg>

                <div class="wf-node" id="node-1" style="top: 50px; left: 50px;">
                    <div class="wf-node-header"><i class="fa-solid fa-microphone"></i> 使用者說話 (Trigger)</div>
                    <div class="wf-node-body">
                        當偵測到麥克風輸入訊號大於 -40dB 時觸發。
                    </div>
                    <div class="wf-node-ports">
                        <div class="wf-port in" style="visibility:hidden;"></div> <div class="wf-port out" id="port-out-1"></div>
                    </div>
                </div>

                <div class="wf-node" id="node-2" style="top: 50px; left: 400px;">
                    <div class="wf-node-header"><i class="fa-solid fa-language"></i> STT 轉換 (Whisper)</div>
                    <div class="wf-node-body">
                        將音訊流轉換為繁體中文文本。<br>
                        Engine: Azure STT
                    </div>
                    <div class="wf-node-ports">
                        <div class="wf-port in" id="port-in-2"></div>
                        <div class="wf-port out" id="port-out-2"></div>
                    </div>
                </div>

                <div class="wf-node selected" id="node-3" style="top: 250px; left: 400px;">
                    <div class="wf-node-header"><i class="fa-solid fa-brain"></i> 意圖識別 (GPT-4)</div>
                    <div class="wf-node-body">
                        分析文本意圖：<br>
                        1. 掛號查詢<br>
                        2. 症狀諮詢
                    </div>
                    <div class="wf-node-ports">
                        <div class="wf-port in" id="port-in-3"></div>
                        <div class="wf-port out" id="port-out-3"></div>
                    </div>
                </div>

                <div class="wf-node" id="node-4" style="top: 250px; left: 750px;">
                    <div class="wf-node-header"><i class="fa-solid fa-comment-dots"></i> 產生掛號建議</div>
                    <div class="wf-node-body">
                        綜合知識庫檢索結果，生成建議科別與醫師。
                    </div>
                    <div class="wf-node-ports">
                        <div class="wf-port in" id="port-in-4"></div>
                        <div class="wf-port out" style="visibility:hidden;"></div>
                    </div>
                </div>

            </div>
        </section>

        <section id="tab-logic" class="content-section">
            <div class="card">
                <h2>LLM 參數設定</h2>
                <div class="grid-2">
                    <div>
                        <label>Temperature</label>
                        <input type="number" class="form-control" value="0.7">
                    </div>
                    <div>
                        <label>Max Tokens</label>
                        <input type="number" class="form-control" value="2048">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="alert('已儲存')">儲存設定</button>
            </div>
        </section>

        <section id="tab-api" class="content-section"><div class="card"><h2>API 設定</h2></div></section>
        <section id="tab-avatar" class="content-section"><div class="card"><h2>Avatar 設定</h2></div></section>

    </main>

    <script>
        // --- 1. Tab Switching Logic ---
        function switchTab(tabId, navElement) {
            // Hide all
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('#tab-workflow').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Show Target
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');
            
            navElement.classList.add('active');

            // Update Title
            const titles = {
                'tab-kb': '知識庫管理',
                'tab-workflow': 'AI 流程自動化設計 (Workflow)',
                'tab-logic': '邏輯參數設定',
                'tab-api': '系統 API 介接',
                'tab-avatar': '虛擬人 Avatar 設定'
            };
            document.getElementById('page-title').innerText = titles[tabId];

            // Re-draw connections if entering workflow tab (to fix sizing issues)
            if(tabId === 'tab-workflow') {
                updateAllConnections();
            }
        }

        // --- 2. Workflow Drag & Drop + Connections Logic ---
        const canvas = document.getElementById('canvas-area');
        const svgLayer = document.getElementById('svg-layer');
        let activeDragNode = null;
        let offset = { x: 0, y: 0 };

        // Define Connections (Logical links between node IDs)
        const connections = [
            { from: 'node-1', to: 'node-2' },
            { from: 'node-2', to: 'node-3' },
            { from: 'node-3', to: 'node-4' }
        ];

        // Init: Create SVG paths
        connections.forEach((conn, index) => {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.classList.add('connection-line');
            path.id = `line-${index}`;
            svgLayer.appendChild(path);
        });

        // Helper: Get center of a port
        function getPortPos(nodeId, type) {
            const node = document.getElementById(nodeId);
            // Default offsets based on CSS styles
            // In: bottom leftish or top center? Let's assume In is left, Out is right based on layout, 
            // BUT our CSS has .ports at bottom. Let's fix ports to bottom-left (in) and bottom-right (out)
            // rect relative to canvas
            const rect = node.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            const relX = rect.left - canvasRect.left;
            const relY = rect.top - canvasRect.top;

            if (type === 'out') {
                return { x: relX + rect.width - 20, y: relY + rect.height - 15 }; // Right bottom
            } else {
                return { x: relX + 20, y: relY + rect.height - 15 }; // Left bottom
            }
        }

        // Draw Function
        function updateAllConnections() {
            connections.forEach((conn, index) => {
                const start = getPortPos(conn.from, 'out');
                const end = getPortPos(conn.to, 'in');
                const path = document.getElementById(`line-${index}`);
                
                // Draw Bezier Curve
                // M startX startY C cp1x cp1y, cp2x cp2y, endX endY
                const cp1 = { x: start.x, y: start.y + 50 }; // Control point 1 (down)
                const cp2 = { x: end.x, y: end.y + 50 };     // Control point 2 (down) - creating a loop
                
                // Better curve for Top-Down flow or Left-Right? 
                // Our layout is somewhat mixed. Let's do a standard S-curve
                // If nodes are side-by-side, control points should be horizontal
                
                const d = `M ${start.x} ${start.y} C ${start.x + 50} ${start.y}, ${end.x - 50} ${end.y}, ${end.x} ${end.y}`;
                path.setAttribute('d', d);
            });
        }

        // Dragging Event Listeners
        document.querySelectorAll('.wf-node-header').forEach(header => {
            header.addEventListener('mousedown', (e) => {
                activeDragNode = header.parentElement;
                
                // Calculate offset
                const rect = activeDragNode.getBoundingClientRect();
                offset.x = e.clientX - rect.left;
                offset.y = e.clientY - rect.top;

                // Bring to front
                activeDragNode.style.zIndex = 10;
                
                // Add selected class
                document.querySelectorAll('.wf-node').forEach(n => n.classList.remove('selected'));
                activeDragNode.classList.add('selected');

                e.preventDefault(); // Prevent text selection
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (!activeDragNode) return;

            const canvasRect = canvas.getBoundingClientRect();
            let newX = e.clientX - canvasRect.left - offset.x;
            let newY = e.clientY - canvasRect.top - offset.y;

            // Boundaries
            // newX = Math.max(0, newX);
            // newY = Math.max(0, newY);

            activeDragNode.style.left = `${newX}px`;
            activeDragNode.style.top = `${newY}px`;

            updateAllConnections();
        });

        document.addEventListener('mouseup', () => {
            if (activeDragNode) {
                activeDragNode.style.zIndex = 5;
                activeDragNode = null;
            }
        });

        // Initial Draw
        window.onload = function() {
            // Delay slightly to ensure layout is computed
            setTimeout(updateAllConnections, 100);
        };
        // Also redraw on resize
        window.onresize = updateAllConnections;

    </script>
</body>
</html>