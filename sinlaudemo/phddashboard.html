<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生理監控中心 - 新樓醫院</title>
    
    <link rel="icon" href="image/carepathicon.ico">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="config.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: { brand: { blue: '#0066FF', purple: '#7B2CBF', teal: '#0096C7', green: '#2E8B57', orange: '#FB8500', red: '#D00000' } }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        body { background-color: #f8fafc; }
        .btn-gradient { background-size: 200% auto; transition: 0.5s; }
        .btn-gradient:hover { background-position: right center; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">
    <div id="app" class="h-full flex flex-col" v-cloak>

        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm z-20">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-red to-pink-600 rounded-xl flex items-center justify-center text-white mr-3 shadow-md">
                    <i class="fa-solid fa-heart-pulse text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">生理監控中心</h1>
                    <p class="text-xs text-gray-500">Physiological Monitoring Dashboard</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right mr-2">
                    <p class="text-sm font-bold text-gray-800">{{ currentUser?.name }}</p>
                    <p class="text-xs text-gray-500">{{ currentUser?.role === 'admin' ? '系統管理員' : '個案管理師' }}</p>
                </div>
                <button @click="closeWindow" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg text-sm font-bold transition">
                    <i class="fa-solid fa-xmark mr-2"></i> 關閉視窗
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden flex flex-col p-6 max-w-[1920px] mx-auto w-full">
            
            <div class="flex space-x-6 mb-6 shrink-0">
                <div class="flex-1 grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center">
                        <div class="w-12 h-12 rounded-full bg-blue-50 text-brand-blue flex items-center justify-center text-xl mr-4"><i class="fa-solid fa-users"></i></div>
                        <div><p class="text-xs text-gray-400 font-bold uppercase">總收案人數</p><h3 class="text-2xl font-extrabold text-gray-800">{{ patients.length }}</h3></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm flex items-center relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-2 -mt-2"></div>
                        <div class="w-12 h-12 rounded-full bg-red-100 text-brand-red flex items-center justify-center text-xl mr-4 z-10"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <div class="z-10"><p class="text-xs text-red-400 font-bold uppercase">今日異常個案</p><h3 class="text-2xl font-extrabold text-brand-red">{{ abnormalCount }}</h3></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-orange-100 shadow-sm flex items-center">
                        <div class="w-12 h-12 rounded-full bg-orange-50 text-brand-orange flex items-center justify-center text-xl mr-4"><i class="fa-solid fa-star"></i></div>
                        <div><p class="text-xs text-orange-400 font-bold uppercase">重點追蹤</p><h3 class="text-2xl font-extrabold text-gray-800">3</h3></div>
                    </div>
                </div>

                <div class="w-96 bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center">
                    <div class="relative w-full">
                        <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
                        <input v-model="searchKeyword" type="text" placeholder="搜尋姓名、身分證或病歷號..." 
                            class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue outline-none transition">
                    </div>
                    <button @click="refreshData" class="ml-3 w-12 h-11 flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg transition" title="重新整理">
                        <i class="fa-solid fa-rotate-right" :class="{'fa-spin': loading}"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden flex flex-col">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800"><i class="fa-solid fa-list-ul mr-2 text-brand-blue"></i> 個案監控列表</h3>
                    <div class="flex items-center space-x-4">
                        <span class="text-xs text-gray-400">資料最後更新: {{ lastUpdateTime }}</span>
                        <span class="text-xs font-bold text-gray-600 bg-gray-200 px-2 py-1 rounded">
                            第 {{ currentPage }} / {{ totalPages }} 頁 (共 {{ fullMonitoringList.length }} 筆)
                        </span>
                    </div>
                </div>
                
                <div class="flex-1 overflow-auto relative">
                    <div v-if="loading" class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                        <div class="flex flex-col items-center">
                            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-brand-blue mb-2"></i>
                            <p class="text-sm text-gray-500">資料載入中...</p>
                        </div>
                    </div>

                    <table class="w-full text-left">
                        <thead class="bg-white sticky top-0 z-10 border-b border-gray-100 shadow-sm">
                            <tr class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                                <th class="px-6 py-4 bg-gray-50/90">病患資料</th>
                                <th class="px-6 py-4 bg-gray-50/90">最新血壓 (mmHg)</th>
                                <th class="px-6 py-4 bg-gray-50/90">最新血糖 (mg/dL)</th>
                                <th class="px-6 py-4 bg-gray-50/90 text-center">狀態</th>
                                <th class="px-6 py-4 bg-gray-50/90 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50 text-sm">
                            <tr v-for="item in paginatedList" :key="item.id" class="hover:bg-blue-50/30 transition group">
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-full bg-blue-100 text-brand-blue flex items-center justify-center font-bold mr-3 text-sm">{{ item.name ? item.name[0] : '?' }}</div>
                                        <div>
                                            <p class="font-bold text-gray-900 text-base">{{ item.name }}</p>
                                            <p class="text-xs text-gray-500 font-mono">{{ item.id }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div v-if="item.bp.systolic">
                                        <span class="text-lg font-mono" :class="item.bp.isAbnormal ? 'text-brand-red font-bold' : 'text-gray-700'">
                                            {{ item.bp.systolic }}<span class="text-gray-400 mx-1">/</span>{{ item.bp.diastolic }}
                                        </span>
                                        <div class="text-[10px] text-gray-400 mt-0.5">{{ item.bp.time }}</div>
                                    </div>
                                    <span v-else class="text-gray-300">-</span>
                                </td>
                                <td class="px-6 py-4">
                                    <div v-if="item.glucose.value">
                                        <span class="text-lg font-mono" :class="item.glucose.isAbnormal ? 'text-brand-red font-bold' : 'text-gray-700'">
                                            {{ item.glucose.value }}
                                        </span>
                                        <span class="text-xs text-gray-500 ml-1">({{ item.glucose.type }})</span>
                                        <div class="text-[10px] text-gray-400 mt-0.5">{{ item.glucose.time }}</div>
                                    </div>
                                    <span v-else class="text-gray-300">-</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span v-if="item.hasAbnormal" class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                                        <i class="fa-solid fa-circle-exclamation mr-1.5"></i> 異常
                                    </span>
                                    <span v-else class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">
                                        <i class="fa-solid fa-check mr-1.5"></i> 正常
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button @click="openDetail(item.raw)" class="bg-brand-blue text-white hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:shadow transition">
                                        <i class="fa-solid fa-chart-line mr-1"></i> 詳情與登打
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div v-if="fullMonitoringList.length === 0 && !loading" class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <i class="fa-regular fa-folder-open text-4xl mb-3 opacity-30"></i>
                        <p>查無符合條件的個案</p>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center" v-if="fullMonitoringList.length > 0">
                    <div class="text-sm text-gray-500">
                        顯示 {{ (currentPage - 1) * itemsPerPage + 1 }} 到 {{ Math.min(currentPage * itemsPerPage, fullMonitoringList.length) }} 筆
                    </div>
                    <div class="flex space-x-2">
                        <button @click="changePage(currentPage - 1)" :disabled="currentPage === 1" 
                            class="px-4 py-2 rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-sm">
                            <i class="fa-solid fa-chevron-left mr-1"></i> 上一頁
                        </button>
                        <button @click="changePage(currentPage + 1)" :disabled="currentPage >= totalPages" 
                            class="px-4 py-2 rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-sm">
                            下一頁 <i class="fa-solid fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showDetailModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/90 backdrop-blur-sm p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[95rem] h-[95vh] flex flex-col overflow-hidden animate-fade-in-up">
                <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-white shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                            {{ selectedPatient.name }} 
                            <span class="ml-3 text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded font-mono">{{ selectedPatient.id }}</span>
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">
                            <i class="fa-solid fa-venus-mars mr-1"></i> {{ selectedPatient.gender==='male'?'男':'女' }} 
                            <span class="mx-2">|</span> 
                            <i class="fa-solid fa-cake-candles mr-1"></i> {{ selectedPatient.birthDate }}
                        </p>
                    </div>
                    <button @click="showDetailModal = false" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition">
                        <i class="fa-solid fa-xmark text-xl text-gray-600"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-hidden flex bg-gray-50">
                    <div class="flex-1 overflow-y-auto p-8 space-y-6 custom-scrollbar">
                        <div class="grid grid-cols-4 gap-5">
                            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-red-500 relative">
                                <p class="text-xs font-bold text-red-500 mb-1">收縮壓 (SYS)</p>
                                <h3 class="text-4xl font-extrabold text-gray-800">{{ latestMetrics.sys || '--' }} <span class="text-sm text-gray-400 font-normal">mmHg</span></h3>
                            </div>
                            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-blue-500 relative">
                                <p class="text-xs font-bold text-blue-500 mb-1">舒張壓 (DIA)</p>
                                <h3 class="text-4xl font-extrabold text-gray-800">{{ latestMetrics.dia || '--' }} <span class="text-sm text-gray-400 font-normal">mmHg</span></h3>
                            </div>
                            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-500 relative">
                                <p class="text-xs font-bold text-green-600 mb-1">心率 (HR)</p>
                                <h3 class="text-4xl font-extrabold text-gray-800">{{ latestMetrics.hr || '--' }} <span class="text-sm text-gray-400 font-normal">BPM</span></h3>
                            </div>
                            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-orange-500 relative">
                                <p class="text-xs font-bold text-orange-500 mb-1">血糖 (GLU)</p>
                                <h3 class="text-4xl font-extrabold text-gray-800">{{ latestMetrics.glu || '--' }} <span class="text-sm text-gray-400 font-normal">mg/dL</span></h3>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h4 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fa-solid fa-heart-pulse mr-2 text-red-500"></i> 血壓/心率趨勢</h4>
                                <div class="h-64"><canvas id="bpChart"></canvas></div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h4 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fa-solid fa-droplet mr-2 text-orange-500"></i> 血糖趨勢</h4>
                                <div class="h-64"><canvas id="gluChart"></canvas></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h4 class="font-bold text-gray-700 mb-4">詳細歷史紀錄</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-4 py-3 rounded-l-lg">時間</th>
                                            <th class="px-4 py-3">項目</th>
                                            <th class="px-4 py-3">數值</th>
                                            <th class="px-4 py-3 rounded-r-lg">單位</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-50">
                                        <tr v-for="obs in patientObservations" :key="obs.id">
                                            <td class="px-4 py-3 font-mono text-gray-500">{{ obs.timestamp }}</td>
                                            <td class="px-4 py-3 font-bold text-gray-800">{{ translateCode(obs.code) }}</td>
                                            <td class="px-4 py-3 font-mono text-lg font-bold text-brand-blue">{{ obs.value }}</td>
                                            <td class="px-4 py-3 text-gray-500">{{ obs.unit }}</td>
                                        </tr>
                                        <tr v-if="patientObservations.length === 0">
                                            <td colspan="4" class="px-4 py-8 text-center text-gray-400">尚無資料</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="w-[400px] bg-white border-l border-gray-200 p-8 flex flex-col shadow-2xl z-10 overflow-y-auto">
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-gray-900 mb-1">新增生理數據</h3>
                            <p class="text-xs text-gray-400">資料將即時寫入雲端資料庫</p>
                        </div>

                        <form @submit.prevent="submitData" class="space-y-6 flex-1">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">測量時機</label>
                                <div class="relative">
                                    <i class="fa-regular fa-clock absolute left-3 top-3.5 text-gray-400"></i>
                                    <select v-model="form.timing" class="w-full pl-10 border border-gray-200 rounded-xl py-3 text-sm focus:ring-2 focus:ring-brand-blue outline-none bg-gray-50 hover:bg-white transition">
                                        <option>起床空腹</option><option>早餐後</option><option>午餐前</option><option>午餐後</option><option>晚餐前</option><option>晚餐後</option><option>睡前</option>
                                    </select>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-4">
                                <div class="flex items-center text-sm font-bold text-gray-700 mb-2"><i class="fa-solid fa-heart-pulse mr-2 text-red-500"></i> 血壓 (BP)</div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">收縮壓</label><input v-model="form.sys" type="number" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-lg font-bold text-center focus:ring-2 focus:ring-red-200 outline-none" placeholder="---"></div>
                                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">舒張壓</label><input v-model="form.dia" type="number" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-lg font-bold text-center focus:ring-2 focus:ring-blue-200 outline-none" placeholder="---"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-green-600 mb-1 uppercase">心跳 (BPM)</label><input v-model="form.hr" type="number" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-center focus:ring-2 focus:ring-green-200 outline-none" placeholder="---"></div>
                                <div><label class="block text-xs font-bold text-orange-500 mb-1 uppercase">血糖 (mg/dL)</label><input v-model="form.glu" type="number" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-center focus:ring-2 focus:ring-orange-200 outline-none" placeholder="---"></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 mb-1.5 uppercase">備註說明</label>
                                <textarea v-model="form.note" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-gray-200 outline-none h-24 resize-none bg-gray-50 focus:bg-white" placeholder="輸入備註..."></textarea>
                            </div>
                            <button type="submit" :disabled="loading" class="w-full btn-gradient bg-gradient-to-r from-brand-blue to-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transition transform active:scale-[0.98] flex justify-center items-center group">
                                <span v-if="loading"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> 資料傳輸中...</span>
                                <span v-else><i class="fa-solid fa-cloud-arrow-up mr-2 group-hover:-translate-y-1 transition"></i> 確認上傳</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    googleClientId: typeof GOOGLE_CLIENT_ID !== 'undefined' ? GOOGLE_CLIENT_ID : '',
                    loading: false, currentUser: null, patients: [], observations: [], searchKeyword: '', lastUpdateTime: '',
                    
                    // 分頁設定
                    currentPage: 1,
                    itemsPerPage: 30, // 每頁 30 筆

                    showDetailModal: false, selectedPatient: {}, patientObservations: [], latestMetrics: {}, bpChart: null, gluChart: null,
                    form: { timing: '起床空腹', sys: '', dia: '', hr: '', glu: '', note: '' }
                }
            },
            watch: {
                // 當搜尋條件改變時，自動回到第一頁
                searchKeyword() {
                    this.currentPage = 1;
                }
            },
            computed: {
                // 1. 計算完整的列表（含篩選、資料整合、排序）
                fullMonitoringList() {
                    let list = this.patients;
                    
                    // 篩選
                    if (this.searchKeyword) {
                        const k = this.searchKeyword.toLowerCase();
                        list = list.filter(p => p.name.includes(k) || p.nationalId.includes(k) || String(p.id).toLowerCase().includes(k));
                    }
                    
                    // 整合數據
                    const mappedList = list.map(p => {
                        // 強制轉型比對
                        const pObs = this.observations.filter(o => String(o.patientId || o.patientID) === String(p.id));
                        
                        // 找出最新數據 (用時間戳記排序)
                        const sortedObs = pObs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                        const lastTime = sortedObs.length > 0 ? sortedObs[0].timestamp : '1970-01-01 00:00';

                        const sys = sortedObs.find(o => o.code === 'systolic_bp');
                        const dia = sortedObs.find(o => o.code === 'diastolic_bp');
                        const gluc = sortedObs.find(o => o.code.startsWith('glucose'));
                        
                        let hasAbnormal = false;
                        if (sys && sys.value > 140) hasAbnormal = true;
                        if (gluc && gluc.value > 126) hasAbnormal = true;

                        return {
                            raw: p, id: p.id, name: p.name, nationalId: p.nationalId,
                            lastUpdate: lastTime, // 用於排序
                            bp: { 
                                systolic: sys?.value, 
                                diastolic: dia?.value, 
                                time: sys?.timestamp.slice(5, 16), 
                                isAbnormal: (sys?.value > 140) 
                            },
                            glucose: { 
                                value: gluc?.value, 
                                type: gluc?.code === 'glucose_ac' ? '飯前' : '飯後', 
                                time: gluc?.timestamp.slice(5, 16),
                                isAbnormal: (gluc?.value > 126)
                            },
                            hasAbnormal: hasAbnormal
                        };
                    });

                    // 排序：最新的在上
                    return mappedList.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));
                },

                // 2. 根據當前頁碼切片
                paginatedList() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.fullMonitoringList.slice(start, end);
                },

                // 3. 總頁數
                totalPages() {
                    return Math.ceil(this.fullMonitoringList.length / this.itemsPerPage);
                },

                abnormalCount() { return this.fullMonitoringList.filter(i => i.hasAbnormal).length; }
            },
            mounted() {
                const user = localStorage.getItem('currentUser');
                if (!user) { window.location.href = 'login.html'; return; }
                this.currentUser = JSON.parse(user);
                this.refreshData();
            },
            methods: {
                closeWindow() { window.close(); },
                
                // 分頁切換
                changePage(page) {
                    if (page >= 1 && page <= this.totalPages) {
                        this.currentPage = page;
                    }
                },

                async refreshData() {
                    this.loading = true;
                    const t = new Date().getTime();
                    try {
                        const [pRes, oRes] = await Promise.all([
                            fetch(`${API_BASE_URL}?endpoint=patients&_t=${t}`),
                            fetch(`${API_BASE_URL}?endpoint=observations&_t=${t}`)
                        ]);
                        
                        const pJson = await pRes.json();
                        const oJson = await oRes.json();
                        
                        if(pJson.status === 'success') this.patients = pJson.data;
                        if(oJson.status === 'success') this.observations = oJson.data;
                        
                        this.lastUpdateTime = new Date().toLocaleTimeString();
                    } catch(e) { console.error(e); }
                    this.loading = false;
                },

                openDetail(patient) {
                    this.selectedPatient = patient;
                    this.showDetailModal = true;
                    this.updateDetailView();
                },

                updateDetailView() {
                    const allObs = this.observations
                        .filter(o => String(o.patientId || o.patientID) === String(this.selectedPatient.id))
                        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    this.patientObservations = allObs;

                    this.latestMetrics = {
                        sys: allObs.find(o=>o.code==='systolic_bp')?.value,
                        dia: allObs.find(o=>o.code==='diastolic_bp')?.value,
                        hr:  allObs.find(o=>o.code==='heart_rate')?.value,
                        glu: allObs.find(o=>o.code.startsWith('glucose'))?.value
                    };

                    const chartData = [...allObs].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                    this.$nextTick(() => { this.renderCharts(chartData); });
                },

                async submitData() {
                    this.loading = true;
                    const requests = [];
                    const localObs = [];
                    const now = new Date();
                    const timeStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');

                    const createReq = (code, val, unit) => {
                        const params = new URLSearchParams({
                            action: 'addObservation',
                            patientId: this.selectedPatient.id,
                            code: code,
                            value: val,
                            unit: unit,
                            _t: new Date().getTime()
                        });
                        
                        localObs.push({ id: 'temp_'+Date.now()+Math.random(), patientId: this.selectedPatient.id, code: code, value: Number(val), unit: unit, timestamp: timeStr });
                        
                        return fetch(`${API_BASE_URL}?${params.toString()}`).then(r => r.json()).then(j => {
                            if(j.status !== 'success') throw new Error(j.message);
                        });
                    };

                    try {
                        if(this.form.sys) requests.push(createReq('systolic_bp', this.form.sys, 'mmHg'));
                        if(this.form.dia) requests.push(createReq('diastolic_bp', this.form.dia, 'mmHg'));
                        if(this.form.hr)  requests.push(createReq('heart_rate', this.form.hr, 'BPM'));
                        if(this.form.glu) {
                            const code = this.form.timing.includes('空腹') ? 'glucose_ac' : 'glucose_pc';
                            requests.push(createReq(code, this.form.glu, 'mg/dL'));
                        }

                        await Promise.all(requests);
                        
                        this.observations.push(...localObs);
                        this.updateDetailView(); 
                        alert('上傳成功！');
                        this.form = { timing: '起床空腹', sys: '', dia: '', hr: '', glu: '', note: '' };

                    } catch(e) {
                        alert('上傳失敗：' + e.message);
                    } finally {
                        this.loading = false;
                    }
                },

                renderCharts(data) {
                    if(this.bpChart) this.bpChart.destroy();
                    if(this.gluChart) this.gluChart.destroy();

                    const labels = [...new Set(data.map(d => d.timestamp))];
                    
                    const sysData = data.filter(d => d.code === 'systolic_bp').map(d => ({x: d.timestamp, y: d.value}));
                    const diaData = data.filter(d => d.code === 'diastolic_bp').map(d => ({x: d.timestamp, y: d.value}));
                    this.bpChart = new Chart(document.getElementById('bpChart'), { type: 'line', data: { labels: labels, datasets: [ { label: '收縮壓', data: sysData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }, { label: '舒張壓', data: diaData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 } ] }, options: { responsive: true, maintainAspectRatio: false } });

                    const gluData = data.filter(d => d.code.startsWith('glucose')).map(d => ({x: d.timestamp, y: d.value}));
                    this.gluChart = new Chart(document.getElementById('gluChart'), { type: 'line', data: { labels: labels, datasets: [{ label: '血糖', data: gluData, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
                },
                translateCode(code) { return { 'systolic_bp': '收縮壓', 'diastolic_bp': '舒張壓', 'glucose_ac': '飯前血糖', 'glucose_pc': '飯後血糖', 'heart_rate': '心率' }[code] || code; }
            }
        }).mount('#app');
    </script>
</body>
</html>