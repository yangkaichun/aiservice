<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="image/carepathicon.ico">
    <title>專業護理評估表單</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="config.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; }
        .form-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; transition: all 0.3s; }
        .form-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .tab-btn { padding: 12px 24px; font-weight: bold; border-bottom: 3px solid transparent; transition: all 0.3s; color: #6b7280; }
        .tab-btn.active { color: #0066FF; border-bottom-color: #0066FF; background-color: #eff6ff; }
        
        .input-std { width: 100%; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px; transition: 0.2s; }
        .input-std:focus { ring: 2px solid #3b82f6; border-color: #3b82f6; outline: none; }
        
        /* Radio Button Group Styling */
        .radio-group label { display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer; }
        .radio-group input[type="radio"] { margin-right: 6px; width: 16px; height: 16px; accent-color: #0066FF; }
        
        /* Badge Styles */
        .badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background-color: #d1fae5; color: #065f46; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
        .badge-gray { background-color: #f3f4f6; color: #374151; }

        /* Question Row */
        .q-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #e5e7eb; }
        .q-row:last-child { border-bottom: none; }
        .q-label { flex: 1; font-weight: 500; color: #374151; }
        
        /* Autocomplete Results */
        .autocomplete-list { position: absolute; z-index: 50; background: white; border: 1px solid #e5e7eb; width: 100%; max-height: 250px; overflow-y: auto; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); top: 100%; margin-top: 4px; }
        .autocomplete-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background-color 0.2s; }
        .autocomplete-item:hover { background-color: #eff6ff; }
        .autocomplete-item:last-child { border-bottom: none; }
        .highlight-text { color: #0066FF; font-weight: bold; }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="max-w-6xl mx-auto p-4 md:p-8" v-cloak>
        
        <header class="flex justify-between items-center mb-6 sticky top-0 bg-[#f3f4f6] z-10 py-2">
            <h1 class="text-2xl font-bold flex items-center text-gray-800">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white mr-3 shadow-lg">
                    <i class="fa-solid fa-notes-medical"></i>
                </div>
                綜合護理評估系統
            </h1>
            <div class="flex items-center space-x-3">
                <span class="text-sm text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm border">操作者: {{ currentUser.name }}</span>
                <button @click="closeWindow" class="bg-white border border-gray-300 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-bold transition">
                    <i class="fa-solid fa-xmark mr-1"></i> 關閉
                </button>
            </div>
        </header>

        <div v-if="loading" class="fixed inset-0 bg-black/60 z-[99] flex items-center justify-center flex-col text-white backdrop-blur-sm">
            <i class="fa-solid fa-circle-notch fa-spin text-5xl mb-4 text-blue-400"></i>
            <p class="text-lg font-bold">{{ loadingText }}</p>
        </div>

        <div v-if="isLoggedIn">
            
            <div class="form-card border-l-4 border-blue-600">
                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center"><i class="fa-solid fa-user-tag mr-2 text-blue-600"></i>個案基本資料</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    
                    <div class="md:col-span-1 relative">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">病歷號 (ID) / 搜尋</label>
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                            <input 
                                v-model="searchQuery" 
                                @focus="showSuggestions = true"
                                @input="handleSearchInput"
                                type="text" 
                                class="input-std pl-9 bg-yellow-50 font-mono font-bold focus:bg-white" 
                                placeholder="輸入ID或姓名..."
                            >
                        </div>
                        
                        <div v-if="showSuggestions && filteredPatients.length > 0" class="autocomplete-list">
                            <div v-for="p in filteredPatients" :key="p.id" @click="selectPatient(p)" class="autocomplete-item">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-gray-800">{{ p.name }}</span>
                                    <span class="text-xs font-mono bg-blue-100 text-blue-800 px-2 py-0.5 rounded">{{ p.id }}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    {{ p.gender === 'male' ? '男' : '女' }} | {{ p.birthDate }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-1">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">姓名</label>
                        <input v-model="patient.name" type="text" class="input-std bg-gray-50" readonly>
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">性別</label>
                        <select v-model="patient.gender" class="input-std">
                            <option value="male">男</option>
                            <option value="female">女</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">身高 (cm)</label>
                        <input v-model="patient.height" type="number" class="input-std" @input="calculateBMI">
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">體重 (kg)</label>
                        <input v-model="patient.weight" type="number" class="input-std" @input="calculateBMI">
                    </div>
                </div>
                <div class="mt-3 flex items-center justify-end">
                    <span class="text-sm font-bold text-gray-500 mr-2">BMI 計算結果:</span>
                    <span class="text-xl font-bold font-mono" :class="patient.bmi > 24 || patient.bmi < 18.5 ? 'text-red-500' : 'text-green-600'">{{ patient.bmi || '--' }}</span>
                </div>
            </div>

            <div class="flex border-b border-gray-200 bg-white rounded-t-xl shadow-sm mb-6 sticky top-20 z-10">
                <button @click="currentTab = 'icope'" :class="['tab-btn flex-1', currentTab === 'icope' ? 'active' : '']"><i class="fa-solid fa-person-cane mr-2"></i>ICOPE 長者評估</button>
                <button @click="currentTab = 'cms'" :class="['tab-btn flex-1', currentTab === 'cms' ? 'active' : '']"><i class="fa-solid fa-wheelchair mr-2"></i>照顧管理 (CMS)</button>
                <button @click="currentTab = 'health'" :class="['tab-btn flex-1', currentTab === 'health' ? 'active' : '']"><i class="fa-solid fa-heart-pulse mr-2"></i>成人健檢</button>
            </div>

            <div v-if="currentTab === 'icope'" class="space-y-6 animate-fade-in-up pb-20">
                
                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-2">A. 認知功能 (Cognition)</h3>
                    <div class="q-row">
                        <div class="q-label">1. 記憶力 (複誦3樣物品)</div>
                        <div class="radio-group">
                            <label><input type="radio" v-model="icope.cognition_q1" value="pass"> 通過</label>
                            <label><input type="radio" v-model="icope.cognition_q1" value="fail"> <span class="text-red-600 font-bold">未通過</span></label>
                        </div>
                    </div>
                    <div class="q-row">
                        <div class="q-label">2. 定向力 (現在的年、月、日、星期、地點)</div>
                        <div class="radio-group">
                            <label><input type="radio" v-model="icope.cognition_q2" value="pass"> 通過</label>
                            <label><input type="radio" v-model="icope.cognition_q2" value="fail"> <span class="text-red-600 font-bold">未通過</span></label>
                        </div>
                    </div>

                    <div v-if="isIcopeCognitionAbnormal" class="mt-4 bg-red-50 p-5 rounded-xl border border-red-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-red-700"><i class="fa-solid fa-clipboard-question mr-2"></i>AD-8 極早期失智症篩檢</h4>
                            <span class="badge" :class="icope.ad8_score >= 2 ? 'badge-red' : 'badge-green'">得分: {{ icope.ad8_score }}/8 ({{ icope.ad8_score >= 2 ? '異常' : '正常' }})</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">請勾選「有改變」的項目：</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="1" class="mr-2"> 1. 判斷力困難 (如落入圈套)</label>
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="2" class="mr-2"> 2. 對活動興趣降低</label>
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="3" class="mr-2"> 3. 重複相同問題/陳述</label>
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="4" class="mr-2"> 4. 學習使用工具設備有困難</label>
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="5" class="mr-2"> 5. 忘記正確的年份月份</label>
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="6" class="mr-2"> 6. 處理複雜財務有困難</label>
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="7" class="mr-2"> 7. 記住約會/時間有困難</label>
                            <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50"><input type="checkbox" v-model="icope.ad8_items" :value="8" class="mr-2"> 8. 思考/記憶有持續性問題</label>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-2">B. 行動功能 (Mobility)</h3>
                    <div class="q-row">
                        <div class="q-label">椅子起身測試 (雙手抱胸，連續起立坐下5次)</div>
                        <div class="flex items-center space-x-2">
                            <input v-model="icope.chair_stand_sec" type="number" class="input-std w-24 text-center" placeholder="秒數">
                            <span class="text-sm text-gray-500">秒</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">* 超過 12 秒為異常</p>

                    <div v-if="isIcopeMobilityAbnormal" class="mt-4 bg-orange-50 p-5 rounded-xl border border-orange-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-orange-800"><i class="fa-solid fa-person-walking mr-2"></i>SPPB 簡易身體表現量表</h4>
                            <span class="badge" :class="icope.sppb_total <= 9 ? 'badge-red' : 'badge-green'">總分: {{ icope.sppb_total }}/12</span>
                        </div>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded border">
                                <label class="text-sm font-bold block mb-1">1. 平衡測試 (並排/半並排/直線)</label>
                                <select v-model="icope.sppb_balance" class="input-std text-sm">
                                    <option value="4">4分 (直線站立 > 10秒)</option>
                                    <option value="3">3分 (直線站立 3~9.9秒)</option>
                                    <option value="2">2分 (半並排 > 10秒, 直線 < 3秒)</option>
                                    <option value="1">1分 (並排 > 10秒)</option>
                                    <option value="0">0分 (並排 < 10秒)</option>
                                </select>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <label class="text-sm font-bold block mb-1">2. 4公尺行走速度</label>
                                <select v-model="icope.sppb_gait" class="input-std text-sm">
                                    <option value="4">4分 (< 4.82秒)</option>
                                    <option value="3">3分 (4.82 ~ 6.20秒)</option>
                                    <option value="2">2分 (6.21 ~ 8.70秒)</option>
                                    <option value="1">1分 (> 8.70秒)</option>
                                    <option value="0">0分 (無法完成)</option>
                                </select>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <label class="text-sm font-bold block mb-1">3. 椅子起立測試 (5次)</label>
                                <select v-model="icope.sppb_chair" class="input-std text-sm">
                                    <option value="4">4分 (< 11.19秒)</option>
                                    <option value="3">3分 (11.2 ~ 13.69秒)</option>
                                    <option value="2">2分 (13.7 ~ 16.69秒)</option>
                                    <option value="1">1分 (> 16.7秒)</option>
                                    <option value="0">0分 (無法完成)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-2">C. 營養 (Nutrition)</h3>
                    <div class="q-row">
                        <div class="q-label">過去三個月體重減輕 3 公斤以上?</div>
                        <div class="radio-group"><label><input type="radio" v-model="icope.nutri_q1" value="yes"> 是</label><label><input type="radio" v-model="icope.nutri_q1" value="no"> 否</label></div>
                    </div>
                    <div class="q-row">
                        <div class="q-label">過去三個月食慾減少?</div>
                        <div class="radio-group"><label><input type="radio" v-model="icope.nutri_q2" value="yes"> 是</label><label><input type="radio" v-model="icope.nutri_q2" value="no"> 否</label></div>
                    </div>

                    <div v-if="isIcopeNutriAbnormal" class="mt-4 bg-yellow-50 p-5 rounded-xl border border-yellow-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-yellow-800"><i class="fa-solid fa-utensils mr-2"></i>MNA-SF 迷你營養評估</h4>
                            <span class="badge" :class="icope.mna_total >= 12 ? 'badge-green' : (icope.mna_total >= 8 ? 'badge-yellow bg-yellow-200 text-yellow-800' : 'badge-red')">總分: {{ icope.mna_total }}/14</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div class="bg-white p-2 rounded border">A. 食慾: <select v-model="icope.mna_a" class="w-full border-none outline-none"><option value="0">0:嚴重減少</option><option value="1">1:中度減少</option><option value="2">2:無改變</option></select></div>
                            <div class="bg-white p-2 rounded border">B. 體重: <select v-model="icope.mna_b" class="w-full border-none outline-none"><option value="0">0:減>3kg</option><option value="1">1:不知道</option><option value="2">2:減1~3kg</option><option value="3">3:無改變</option></select></div>
                            <div class="bg-white p-2 rounded border">C. 活動: <select v-model="icope.mna_c" class="w-full border-none outline-none"><option value="0">0:臥床</option><option value="1">1:可下床但無法自如</option><option value="2">2:可自如</option></select></div>
                            <div class="bg-white p-2 rounded border">D. 壓力: <select v-model="icope.mna_d" class="w-full border-none outline-none"><option value="0">0:有</option><option value="2">2:無</option></select></div>
                            <div class="bg-white p-2 rounded border">E. 精神: <select v-model="icope.mna_e" class="w-full border-none outline-none"><option value="0">0:嚴重癡呆/憂鬱</option><option value="1">1:輕度癡呆</option><option value="2">2:無問題</option></select></div>
                            <div class="bg-white p-2 rounded border flex justify-between items-center">F. BMI: <span class="font-bold font-mono">{{ mna_bmi_score }} 分</span> (自動計算)</div>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-2">F. 憂鬱 (Depression)</h3>
                    <div class="q-row"><div class="q-label">過去兩週常感到情緒低落、沮喪或絕望?</div><div class="radio-group"><label><input type="radio" v-model="icope.dep_q1" value="yes"> 是</label><label><input type="radio" v-model="icope.dep_q1" value="no"> 否</label></div></div>
                    <div class="q-row"><div class="q-label">過去兩週對事情提不起興趣或樂趣?</div><div class="radio-group"><label><input type="radio" v-model="icope.dep_q2" value="yes"> 是</label><label><input type="radio" v-model="icope.dep_q2" value="no"> 否</label></div></div>

                    <div v-if="isIcopeDepAbnormal" class="mt-4 bg-gray-50 p-5 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-gray-700"><i class="fa-regular fa-face-frown mr-2"></i>GDS-15 老人憂鬱量表</h4>
                            <span class="badge" :class="icope.gds_score >= 5 ? 'badge-red' : 'badge-green'">得分: {{ icope.gds_score }}/15</span>
                        </div>
                        <div class="h-48 overflow-y-auto pr-2 custom-scrollbar space-y-2">
                            <label class="flex justify-between items-center p-2 bg-white rounded border text-sm"><span class="flex-1">1. 對生活滿意嗎? (否=1分)</span><input type="checkbox" v-model="icope.gds_items" :value="1" class="ml-2"></label>
                            <label class="flex justify-between items-center p-2 bg-white rounded border text-sm"><span class="flex-1">2. 放棄了許多活動? (是=1分)</span><input type="checkbox" v-model="icope.gds_items" :value="2" class="ml-2"></label>
                            <label class="flex justify-between items-center p-2 bg-white rounded border text-sm"><span class="flex-1">3. 覺得生活空虛? (是=1分)</span><input type="checkbox" v-model="icope.gds_items" :value="3" class="ml-2"></label>
                            <label class="flex justify-between items-center p-2 bg-white rounded border text-sm"><span class="flex-1">4. 常感到無聊? (是=1分)</span><input type="checkbox" v-model="icope.gds_items" :value="4" class="ml-2"></label>
                            <div class="text-center text-xs text-gray-400 mt-2">(...請依照量表填寫 GDS 得分項目)</div>
                            <div class="flex justify-end items-center mt-2">
                                <span class="text-sm font-bold mr-2">手動修正總分:</span>
                                <input type="number" v-model="icope.gds_score" class="input-std w-16 text-center h-8" min="0" max="15">
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div v-if="currentTab === 'cms'" class="space-y-6 animate-fade-in-up pb-20">
                
                <div class="form-card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold text-teal-700">E. ADL 基本日常生活功能</h3>
                        <span class="badge badge-gray text-lg">總分: {{ cms_adl_score }}</span>
                    </div>
                    <div class="space-y-4">
                        <div v-for="(item, key) in cmsAdlItems" :key="key" class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <label class="font-bold text-gray-700 block mb-2">{{ item.label }}</label>
                            <select v-model="cms.adl[key]" class="input-std text-sm">
                                <option v-for="opt in item.options" :value="opt.val">{{ opt.text }}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold text-teal-700">F. IADL 工具性日常生活功能</h3>
                        <span class="badge badge-gray text-lg">總分: {{ cms_iadl_score }}</span>
                    </div>
                    <div class="space-y-4">
                        <div v-for="(item, key) in cmsIadlItems" :key="key" class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <label class="font-bold text-gray-700 block mb-2">{{ item.label }}</label>
                            <select v-model="cms.iadl[key]" class="input-std text-sm">
                                <option v-for="opt in item.options" :value="opt.val">{{ opt.text }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'health'" class="space-y-6 animate-fade-in-up pb-20">
                <div class="form-card">
                    <h3 class="text-lg font-bold text-rose-700 mb-4 border-b pb-2">成人預防保健檢查</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-rose-50/50 p-4 rounded-xl border border-rose-100">
                            <h4 class="font-bold text-rose-800 mb-3 text-sm uppercase">理學檢查</h4>
                            <div class="space-y-3">
                                <div><label class="text-xs font-bold block">收縮壓 (mmHg)</label><input v-model="health.sbp" type="number" class="input-std"></div>
                                <div><label class="text-xs font-bold block">舒張壓 (mmHg)</label><input v-model="health.dbp" type="number" class="input-std"></div>
                                <div><label class="text-xs font-bold block">腰圍 (cm)</label><input v-model="health.waist" type="number" class="input-std"></div>
                            </div>
                        </div>
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <h4 class="font-bold text-blue-800 mb-3 text-sm uppercase">生化檢驗</h4>
                            <div class="space-y-3">
                                <div><label class="text-xs font-bold block">肌酸酐 (Cre) mg/dL</label><input v-model="health.cre" type="number" class="input-std"></div>
                                <div><label class="text-xs font-bold block">飯前血糖 (AC) mg/dL</label><input v-model="health.glu_ac" type="number" class="input-std"></div>
                                <div><label class="text-xs font-bold block">三酸甘油脂 (TG) mg/dL</label><input v-model="health.tg" type="number" class="input-std"></div>
                                <div><label class="text-xs font-bold block">高密度膽固醇 (HDL) mg/dL</label><input v-model="health.hdl" type="number" class="input-std"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-bold text-gray-700 mb-3">系統自動判讀</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-500">eGFR (腎功能)</span>
                                <span class="font-mono font-bold text-lg text-blue-600">{{ calculatedEgfr }}</span>
                            </div>
                            <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-500">代謝症候群</span>
                                <span class="font-bold text-lg" :class="isMetabolicSyndrome ? 'text-red-600' : 'text-green-600'">
                                    {{ isMetabolicSyndrome ? '異常 (符合標準)' : '正常' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex justify-between items-center z-40">
                <div class="text-xs text-gray-400 hidden md:block">
                    <i class="fa-solid fa-circle-info mr-1"></i> 請完成所有必要欄位後再送出
                </div>
                <div class="flex space-x-3 w-full md:w-auto">
                    <button @click="resetForm" class="flex-1 md:flex-none px-6 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-100 transition">重置</button>
                    <button @click="showPreview" class="flex-1 md:flex-none bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition transform">
                        <i class="fa-solid fa-check-circle mr-2"></i> 預覽並儲存
                    </button>
                </div>
            </div>

        </div>

        <div v-if="showPreviewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4 backdrop-blur-md animate-fade-in-up">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-gray-50 to-white">
                    <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-file-contract mr-2 text-blue-600"></i>確認評估資料</h3>
                    <button @click="showPreviewModal = false" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                    <div class="flex items-center p-4 bg-white rounded-xl border border-blue-100 shadow-sm mb-6">
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xl mr-4">{{ patient.name[0] || 'U' }}</div>
                        <div>
                            <p class="font-bold text-gray-800 text-lg">{{ patient.name }} <span class="text-sm font-normal text-gray-500 ml-2">({{ patient.id }})</span></p>
                            <p class="text-xs text-gray-500">BMI: {{ patient.bmi }} | {{ patient.gender === 'male' ? '男' : '女' }}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="(item, idx) in previewData" :key="idx" class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-500">{{ item.label }}</span>
                            <div class="text-right">
                                <span class="block font-bold text-gray-800" :class="item.isAbnormal ? 'text-red-600' : ''">{{ item.value }}</span>
                                <span v-if="item.unit" class="text-xs text-gray-400">{{ item.unit }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="previewData.length === 0" class="text-center py-12 text-gray-400">
                        <i class="fa-regular fa-folder-open text-3xl mb-2 block"></i>
                        尚未填寫任何資料
                    </div>
                </div>

                <div class="p-5 border-t border-gray-100 bg-white flex justify-end space-x-3">
                    <button @click="showPreviewModal = false" class="px-6 py-2.5 rounded-xl text-gray-500 font-bold hover:bg-gray-100 transition">返回修改</button>
                    <button @click="submitToGas" class="px-8 py-2.5 rounded-xl bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 hover:shadow-xl transition flex items-center">
                        <span v-if="!loading">確認送出</span>
                        <span v-else><i class="fa-solid fa-spinner fa-spin mr-2"></i>傳輸中</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, reactive, computed, ref, onMounted } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const loadingText = ref('');
                const isLoggedIn = ref(false);
                const currentUser = ref({});
                const currentTab = ref('icope');
                const showPreviewModal = ref(false);

                // --- 資料模型 ---
                const patientsList = ref([]); // 存放所有病患
                const searchQuery = ref(''); // 搜尋關鍵字
                const showSuggestions = ref(false); // 控制下拉選單顯示

                const patient = reactive({ id: '', name: '', gender: 'male', height: '', weight: '', bmi: '' });
                const icope = reactive({
                    cognition_q1: '', cognition_q2: '', ad8_items: [], ad8_score: 0,
                    mobility_q1: '', chair_stand_sec: '', sppb_balance: '4', sppb_gait: '4', sppb_chair: '4', sppb_total: 12,
                    nutri_q1: '', nutri_q2: '', mna_a: '2', mna_b: '3', mna_c: '2', mna_d: '2', mna_e: '2', mna_total: 14,
                    dep_q1: '', dep_q2: '', gds_items: [], gds_score: 0
                });
                const cms = reactive({ adl: { e1: 10, e2: 10, e3: 10, e4: 10, e5: 10, e6: 10, e7: 10, e8: 10, e9: 10, e10: 10 }, iadl: { f1: 3, f2: 3, f3: 3, f4: 3, f5: 3, f6: 3, f7: 3, f8: 3 } });
                const health = reactive({ sbp: '', dbp: '', waist: '', cre: '', glu_ac: '', tg: '', hdl: '' });

                // --- 字典與選項 ---
                const cmsAdlItems = {
                    e1: { label: '1. 進食', options: [{val:10, text:'獨立'},{val:5, text:'需協助'},{val:0, text:'依賴'}] },
                    e2: { label: '2. 移位', options: [{val:15, text:'獨立'},{val:10, text:'稍微協助'},{val:5, text:'可坐起'},{val:0, text:'依賴'}] },
                    e3: { label: '3. 個人修飾', options: [{val:5, text:'獨立'},{val:0, text:'依賴'}] },
                    e4: { label: '4. 如廁', options: [{val:10, text:'獨立'},{val:5, text:'需協助'},{val:0, text:'依賴'}] },
                    e5: { label: '5. 洗澡', options: [{val:5, text:'獨立'},{val:0, text:'依賴'}] },
                    e6: { label: '6. 行走', options: [{val:15, text:'獨立'},{val:10, text:'需協助'},{val:5, text:'輪椅'},{val:0, text:'依賴'}] },
                    e7: { label: '7. 上下樓梯', options: [{val:10, text:'獨立'},{val:5, text:'需協助'},{val:0, text:'依賴'}] },
                    e8: { label: '8. 穿脫衣', options: [{val:10, text:'獨立'},{val:5, text:'需協助'},{val:0, text:'依賴'}] },
                    e9: { label: '9. 大便控制', options: [{val:10, text:'自控'},{val:5, text:'偶爾失禁'},{val:0, text:'失禁'}] },
                    e10: { label: '10. 小便控制', options: [{val:10, text:'自控'},{val:5, text:'偶爾失禁'},{val:0, text:'失禁'}] }
                };
                
                const cmsIadlItems = {
                    f1: { label: '1. 上街購物', options: [{val:3, text:'獨立'},{val:2, text:'陪同可'},{val:1, text:'代購'},{val:0, text:'無能力'}] },
                    f2: { label: '2. 外出活動', options: [{val:3, text:'獨立'},{val:2, text:'陪同可'},{val:1, text:'需接送'},{val:0, text:'無能力'}] },
                    f3: { label: '3. 食物烹調', options: [{val:3, text:'獨立'},{val:2, text:'準備可'},{val:1, text:'加熱'},{val:0, text:'無能力'}] },
                    f4: { label: '4. 家務維持', options: [{val:3, text:'獨立'},{val:2, text:'簡易'},{val:1, text:'無法'}] },
                    f5: { label: '5. 洗衣服', options: [{val:3, text:'獨立'},{val:2, text:'小件'},{val:1, text:'無法'}] },
                };

                // --- 邏輯與計算 ---
                onMounted(async () => {
                    const userStr = localStorage.getItem('currentUser');
                    if (!userStr) { alert('請先從首頁登入'); window.location.href = 'index.html'; } 
                    else { 
                        currentUser.value = JSON.parse(userStr); 
                        isLoggedIn.value = true;
                        
                        // 載入病患清單
                        try {
                            const res = await fetch(`${API_BASE_URL}?endpoint=patients`);
                            const json = await res.json();
                            if(json.status === 'success') {
                                patientsList.value = json.data;
                            }
                        } catch(e) {
                            console.error("無法載入病患清單", e);
                        }
                    }
                });

                // 搜尋過濾邏輯
                const filteredPatients = computed(() => {
                    if (!searchQuery.value) return [];
                    const q = searchQuery.value.toLowerCase();
                    return patientsList.value.filter(p => 
                        p.id.toLowerCase().includes(q) || 
                        p.name.toLowerCase().includes(q)
                    ).slice(0, 10); // 只顯示前10筆
                });

                const handleSearchInput = () => {
                    // 當手動輸入 ID 時，也同步更新 patient.id，以便支援直接輸入新 ID
                    patient.id = searchQuery.value;
                };

                const selectPatient = (p) => {
                    // 自動帶入資料
                    patient.id = p.id;
                    patient.name = p.name;
                    patient.gender = p.gender;
                    // 若資料庫有身高體重 (這裡假設欄位名稱，需視實際 API 回傳調整)
                    if(p.height) patient.height = p.height;
                    if(p.weight) patient.weight = p.weight;
                    
                    searchQuery.value = p.id; // 輸入框顯示 ID
                    showSuggestions.value = false; // 關閉選單
                    calculateBMI(); // 重新計算 BMI
                };

                // 點擊外部關閉下拉選單 (簡易實作)
                // 實務上建議使用 v-click-outside directive
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative')) {
                        showSuggestions.value = false;
                    }
                });

                const calculateBMI = () => {
                    if (patient.height && patient.weight) {
                        const h = patient.height / 100;
                        patient.bmi = (patient.weight / (h * h)).toFixed(1);
                    }
                };

                // ... (其餘邏輯保持不變: ICOPE, CMS, Health, Preview, Submit) ...
                // ICOPE 邏輯
                const isIcopeCognitionAbnormal = computed(() => icope.cognition_q1 === 'fail' || icope.cognition_q2 === 'fail');
                const isIcopeMobilityAbnormal = computed(() => icope.chair_stand_sec > 12 || icope.mobility_q1 === 'yes');
                const isIcopeNutriAbnormal = computed(() => icope.nutri_q1 === 'yes' || icope.nutri_q2 === 'yes');
                const isIcopeDepAbnormal = computed(() => icope.dep_q1 === 'yes' || icope.dep_q2 === 'yes');

                const updateScores = () => {
                    icope.ad8_score = icope.ad8_items.length;
                    icope.sppb_total = parseInt(icope.sppb_balance) + parseInt(icope.sppb_gait) + parseInt(icope.sppb_chair);
                    const bmiScore = !patient.bmi ? 0 : (patient.bmi < 19 ? 0 : (patient.bmi < 21 ? 1 : (patient.bmi < 23 ? 2 : 3)));
                    icope.mna_total = parseInt(icope.mna_a) + parseInt(icope.mna_b) + parseInt(icope.mna_c) + parseInt(icope.mna_d) + parseInt(icope.mna_e) + bmiScore;
                };
                
                const mna_bmi_score = computed(() => {
                    if(!patient.bmi) return 0;
                    if(patient.bmi < 19) return 0;
                    if(patient.bmi < 21) return 1;
                    if(patient.bmi < 23) return 2;
                    return 3;
                });

                const cms_adl_score = computed(() => Object.values(cms.adl).reduce((a,b) => parseInt(a)+parseInt(b), 0));
                const cms_iadl_score = computed(() => Object.values(cms.iadl).reduce((a,b) => parseInt(a)+parseInt(b), 0));

                const calculatedEgfr = computed(() => {
                    if (!health.cre) return '--';
                    const age = 65; 
                    let egfr = 186 * Math.pow(health.cre, -1.154) * Math.pow(age, -0.203);
                    if (patient.gender === 'female') egfr *= 0.742;
                    return egfr.toFixed(1);
                });

                const isMetabolicSyndrome = computed(() => {
                    let c = 0;
                    if (health.waist && ((patient.gender === 'male' && health.waist >= 90) || (patient.gender === 'female' && health.waist >= 80))) c++;
                    if (health.sbp >= 130 || health.dbp >= 85) c++;
                    if (health.glu_ac >= 100) c++;
                    if (health.tg >= 150) c++;
                    if (health.hdl && ((patient.gender === 'male' && health.hdl < 40) || (patient.gender === 'female' && health.hdl < 50))) c++;
                    return c >= 3;
                });

                const previewData = computed(() => {
                    updateScores();
                    const list = [];
                    if(patient.bmi) list.push({label:'BMI', value: patient.bmi, isAbnormal: patient.bmi>24 || patient.bmi<18.5});
                    
                    if(icope.cognition_q1) list.push({label:'ICOPE-記憶力', value: icope.cognition_q1==='pass'?'通過':'異常', isAbnormal: icope.cognition_q1==='fail'});
                    if(isIcopeCognitionAbnormal.value) list.push({label:'AD8 總分', value: icope.ad8_score + '/8', isAbnormal: icope.ad8_score >= 2});
                    
                    if(icope.chair_stand_sec) list.push({label:'起立測試(秒)', value: icope.chair_stand_sec, isAbnormal: icope.chair_stand_sec>12});
                    if(isIcopeMobilityAbnormal.value) list.push({label:'SPPB 總分', value: icope.sppb_total + '/12', isAbnormal: icope.sppb_total <= 9});
                    
                    if(isIcopeNutriAbnormal.value) list.push({label:'MNA-SF 營養', value: icope.mna_total + '/14', isAbnormal: icope.mna_total < 12});
                    if(isIcopeDepAbnormal.value) list.push({label:'GDS-15 憂鬱', value: icope.gds_score + '/15', isAbnormal: icope.gds_score >= 5});

                    if(Object.values(cms.adl).some(v=>v!==10)) list.push({label:'ADL 巴氏量表', value: cms_adl_score.value + '/100', isAbnormal: cms_adl_score.value < 100});
                    
                    if(health.sbp) list.push({label:'血壓', value: `${health.sbp}/${health.dbp}`, unit:'mmHg', isAbnormal: health.sbp>=130});
                    if(calculatedEgfr.value !== '--') list.push({label:'eGFR', value: calculatedEgfr.value, isAbnormal: calculatedEgfr.value < 60});
                    if(isMetabolicSyndrome.value) list.push({label:'代謝症候群', value: '符合', isAbnormal: true});

                    return list;
                });

                const showPreview = () => {
                    if (!patient.id) { alert('請填寫或選擇病歷號 (ID)'); return; }
                    showPreviewModal.value = true;
                };

                const submitToGas = async () => {
                    loading.value = true;
                    loadingText.value = '加密傳輸中...';
                    
                    const records = [];
                    const pushRec = (c, v, u='') => { if(v!=='' && v!==null && v!==undefined) records.push({code:c, value:v, unit:u}); };

                    pushRec('body_height', patient.height, 'cm');
                    pushRec('body_weight', patient.weight, 'kg');
                    pushRec('bmi', patient.bmi);
                    pushRec('icope_cog_screen', isIcopeCognitionAbnormal.value ? 'fail' : 'pass');
                    if(isIcopeCognitionAbnormal.value) pushRec('icope_ad8_score', icope.ad8_score);
                    pushRec('icope_mob_screen', isIcopeMobilityAbnormal.value ? 'fail' : 'pass');
                    if(isIcopeMobilityAbnormal.value) pushRec('icope_sppb_score', icope.sppb_total);
                    pushRec('icope_nut_screen', isIcopeNutriAbnormal.value ? 'fail' : 'pass');
                    if(isIcopeNutriAbnormal.value) pushRec('icope_mna_score', icope.mna_total);
                    pushRec('cms_adl_score', cms_adl_score.value);
                    pushRec('cms_iadl_score', cms_iadl_score.value);
                    pushRec('systolic_bp', health.sbp, 'mmHg');
                    pushRec('diastolic_bp', health.dbp, 'mmHg');
                    pushRec('lab_cre', health.cre, 'mg/dL');
                    pushRec('lab_egfr', calculatedEgfr.value, 'ml/min');
                    pushRec('health_metabolic', isMetabolicSyndrome.value ? 'yes' : 'no');

                    const payload = {
                        action: 'saveAssessment',
                        patientId: patient.id,
                        records: records
                    };

                    try {
                        await fetch(API_BASE_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        setTimeout(() => {
                            alert('評估資料已成功存入雲端資料庫！');
                            showPreviewModal.value = false;
                        }, 500);
                    } catch (e) {
                        console.error(e);
                        alert('連線錯誤，請檢查網路');
                    } finally {
                        loading.value = false;
                    }
                };

                const resetForm = () => {
                    if(confirm('確定要清空所有欄位嗎？')) window.location.reload();
                };

                const closeWindow = () => window.close();

                return {
                    loading, loadingText, isLoggedIn, currentUser, currentTab,
                    patientsList, searchQuery, showSuggestions, filteredPatients, handleSearchInput, selectPatient,
                    patient, icope, cms, health,
                    calculateBMI, isIcopeCognitionAbnormal, isIcopeMobilityAbnormal, isIcopeNutriAbnormal, isIcopeDepAbnormal,
                    mna_bmi_score, cms_adl_score, cms_iadl_score, cmsAdlItems, cmsIadlItems,
                    calculatedEgfr, isMetabolicSyndrome,
                    showPreviewModal, showPreview, previewData, submitToGas, closeWindow, resetForm
                };
            }
        }).mount('#app');
    </script>
</body>
</html>