<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="image/carepathicon.ico">
    <title>專業護理評估表單</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="config.js"></script>

    <style>
        body { background-color: #f0f4f8; font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; }
        .form-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 24px; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #f1f5f9; }
        .form-card:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
        .tab-btn { padding: 14px 24px; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s; color: #64748b; display: flex; align-items: center; justify-content: center; }
        .tab-btn:hover { color: #3b82f6; background-color: #f8fafc; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; background-color: #eff6ff; }
        .input-std { width: 100%; border: 1px solid #cbd5e1; border-radius: 10px; padding: 10px 14px; transition: all 0.2s; background-color: #fff; }
        .input-std:focus { ring: 3px solid #bfdbfe; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .radio-group label { display: inline-flex; align-items: center; margin-right: 20px; cursor: pointer; padding: 6px 12px; border-radius: 8px; transition: background 0.2s; }
        .radio-group label:hover { background-color: #f1f5f9; }
        .radio-group input[type="radio"] { margin-right: 8px; width: 18px; height: 18px; accent-color: #2563eb; }
        .radio-group input[type="checkbox"] { margin-right: 8px; width: 18px; height: 18px; accent-color: #2563eb; rounded: 4px; }
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.025em; display: inline-flex; align-items: center; }
        .badge-green { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-red { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .autocomplete-list { position: absolute; z-index: 50; background: white; border: 1px solid #e2e8f0; width: 100%; max-height: 280px; overflow-y: auto; border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.15); top: 100%; margin-top: 6px; }
        .autocomplete-item { padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .autocomplete-item:hover { background-color: #eff6ff; }
        .autocomplete-item:last-child { border-bottom: none; }
        .q-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #e5e7eb; }
        .q-label { flex: 1; font-weight: 500; color: #374151; }
        .timeline-item { position: relative; padding-left: 24px; margin-bottom: 24px; border-left: 2px solid #e2e8f0; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: #3b82f6; border: 2px solid white; box-shadow: 0 0 0 2px #bfdbfe; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-gray-700">
    <div id="app" class="max-w-6xl mx-auto p-4 md:p-6" v-cloak>
        <header class="flex justify-between items-center mb-6 sticky top-0 bg-[#f0f4f8]/90 backdrop-blur-sm z-20 py-3">
            <h1 class="text-2xl font-extrabold flex items-center text-slate-800 tracking-tight">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white mr-4 shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-notes-medical text-xl"></i>
                </div>
                <div>綜合護理評估系統<span class="block text-xs font-normal text-gray-500 mt-0.5">Integrated Care Assessment Platform</span></div>
            </h1>
            <div class="flex items-center space-x-3">
                <div class="flex items-center bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200"><div class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></div><span class="text-sm font-bold text-gray-600">{{ currentUser.name }}</span></div>
                <button @click="closeWindow" class="bg-white border border-gray-300 hover:bg-red-50 hover:text-red-600 hover:border-red-200 px-4 py-2 rounded-xl text-sm font-bold transition flex items-center shadow-sm"><i class="fa-solid fa-power-off mr-2"></i> 關閉</button>
            </div>
        </header>

        <div v-if="loading" class="fixed inset-0 bg-slate-900/60 z-[99] flex items-center justify-center flex-col text-white backdrop-blur-sm">
            <div class="relative"><div class="w-16 h-16 border-4 border-white/20 border-t-blue-400 rounded-full animate-spin"></div></div>
            <p class="mt-4 text-lg font-bold tracking-wide">{{ loadingText }}</p>
        </div>

        <div v-if="isLoggedIn">
            <div class="form-card border-l-[6px] border-blue-600 relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-5 pointer-events-none"><i class="fa-solid fa-user-doctor text-9xl"></i></div>
                <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center"><span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm"><i class="fa-solid fa-user"></i></span>個案身分識別</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-5 relative z-10">
                    <div class="md:col-span-1 relative">
                        <label class="text-xs font-bold text-gray-500 mb-1.5 uppercase block tracking-wider">病歷號 (ID) / 搜尋</label>
                        <div class="relative group">
                            <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-3.5 text-gray-400 group-hover:text-blue-500 transition"></i>
                            <input v-model="searchQuery" @focus="showSuggestions = true" @input="handleSearchInput" type="text" class="input-std pl-10 bg-yellow-50/50 font-mono font-bold focus:bg-white border-yellow-200 focus:border-blue-500" placeholder="輸入ID或姓名...">
                            <button v-if="searchQuery" @click="clearSearch" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div v-if="showSuggestions && filteredPatients.length > 0" class="autocomplete-list">
                            <div v-for="p in filteredPatients" :key="p.id" @click="selectPatient(p)" class="autocomplete-item group">
                                <div><div class="font-bold text-gray-800 group-hover:text-blue-600">{{ p.name }}</div><div class="text-xs text-gray-400">{{ p.gender === 'male' ? '男' : '女' }} • {{ p.birthDate }}</div></div>
                                <span class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded border group-hover:bg-blue-100 group-hover:text-blue-700 group-hover:border-blue-200">{{ p.id }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-1"><label class="text-xs font-bold text-gray-500 mb-1.5 uppercase block tracking-wider">姓名</label><input v-model="patient.name" type="text" class="input-std bg-gray-50 text-gray-600 cursor-not-allowed" readonly></div>
                    <div class="md:col-span-1"><label class="text-xs font-bold text-gray-500 mb-1.5 uppercase block tracking-wider">性別</label><select v-model="patient.gender" class="input-std"><option value="male">男</option><option value="female">女</option></select></div>
                    <div class="md:col-span-1"><label class="text-xs font-bold text-gray-500 mb-1.5 uppercase block tracking-wider">身高 (cm)</label><input v-model="patient.height" type="number" class="input-std" @input="calculateBMI"></div>
                    <div class="md:col-span-1"><label class="text-xs font-bold text-gray-500 mb-1.5 uppercase block tracking-wider">體重 (kg)</label><input v-model="patient.weight" type="number" class="input-std" @input="calculateBMI"></div>
                </div>
                <div class="mt-4 flex items-center justify-end border-t border-gray-100 pt-3">
                    <div class="flex items-center bg-gray-50 px-4 py-2 rounded-lg border border-gray-200">
                        <span class="text-xs font-bold text-gray-500 mr-3 uppercase tracking-wide">BMI 指數</span>
                        <span class="text-xl font-black font-mono" :class="patient.bmi > 24 || patient.bmi < 18.5 ? 'text-red-500' : 'text-green-600'">{{ patient.bmi || '--' }}</span>
                    </div>
                </div>
            </div>

            <div class="flex border-b border-gray-200 bg-white rounded-t-2xl shadow-sm mb-6 sticky top-[80px] z-10 mx-1">
                <button @click="currentTab = 'icope'" :class="['tab-btn flex-1', currentTab === 'icope' ? 'active' : '']"><i class="fa-solid fa-person-cane mr-2 text-lg"></i> ICOPE 長者評估</button>
                <button @click="currentTab = 'cms'" :class="['tab-btn flex-1', currentTab === 'cms' ? 'active' : '']"><i class="fa-solid fa-wheelchair mr-2 text-lg"></i> 照顧管理 (CMS)</button>
                <button @click="currentTab = 'health'" :class="['tab-btn flex-1', currentTab === 'health' ? 'active' : '']"><i class="fa-solid fa-heart-pulse mr-2 text-lg"></i> 成人健檢</button>
                <button @click="currentTab = 'history'" :class="['tab-btn flex-1', currentTab === 'history' ? 'active text-purple-600 border-purple-600 bg-purple-50' : 'text-gray-500 hover:text-purple-500']"><i class="fa-solid fa-clock-rotate-left mr-2 text-lg"></i> 歷史紀錄查詢</button>
            </div>

            <div v-if="currentTab === 'icope'" class="space-y-6 animate-fade-in-up pb-24">
                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-3 flex items-center"><i class="fa-solid fa-brain mr-2 bg-indigo-100 p-2 rounded-lg"></i> A. 認知功能</h3>
                    <div class="q-row"><div class="q-label">1. 記憶力 (複誦3樣物品)</div><div class="radio-group"><label><input type="radio" v-model="icope.cognition_q1" value="pass"> 通過</label><label><input type="radio" v-model="icope.cognition_q1" value="fail"> <span class="text-red-600">未通過</span></label></div></div>
                    <div class="q-row"><div class="q-label">2. 定向力 (日期/地點)</div><div class="radio-group"><label><input type="radio" v-model="icope.cognition_q2" value="pass"> 通過</label><label><input type="radio" v-model="icope.cognition_q2" value="fail"> <span class="text-red-600">未通過</span></label></div></div>
                    <div v-if="isIcopeCognitionAbnormal" class="mt-5 bg-red-50 p-5 rounded-2xl border border-red-100 shadow-inner">
                        <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-red-700">AD-8 極早期失智症篩檢</h4><span class="badge" :class="icope.ad8_score >= 2 ? 'badge-red' : 'badge-green'">{{ icope.ad8_score }}/8</span></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3"><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="1" class="mr-2"> 1. 判斷力困難</label><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="2" class="mr-2"> 2. 興趣降低</label><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="3" class="mr-2"> 3. 重複問題</label><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="4" class="mr-2"> 4. 學習困難</label><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="5" class="mr-2"> 5. 忘記年月</label><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="6" class="mr-2"> 6. 財務困難</label><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="7" class="mr-2"> 7. 記住約會困難</label><label class="flex items-center p-3 bg-white border rounded cursor-pointer hover:bg-red-50"><input type="checkbox" v-model="icope.ad8_items" :value="8" class="mr-2"> 8. 記憶問題</label></div>
                    </div>
                </div>
                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-3 flex items-center"><i class="fa-solid fa-person-walking mr-2 bg-indigo-100 p-2 rounded-lg"></i> B. 行動功能</h3>
                    <div class="q-row"><div class="q-label">椅子起身測試 (雙手抱胸，連續起立坐下5次)</div><div class="flex items-center space-x-2"><input v-model="icope.chair_stand_sec" type="number" class="input-std w-24 text-center font-bold" placeholder="秒數"><span class="text-sm text-gray-500">秒</span></div></div>
                    <div v-if="isIcopeMobilityAbnormal" class="mt-5 bg-orange-50 p-5 rounded-2xl border border-orange-100 shadow-inner">
                        <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-orange-800">SPPB 簡易身體表現量表</h4><span class="badge" :class="icope.sppb_total <= 9 ? 'badge-red' : 'badge-green'">總分: {{ icope.sppb_total }}/12</span></div>
                        <div class="space-y-3"><div class="bg-white p-3 rounded-xl border"><label class="text-sm font-bold block mb-1">1. 平衡測試</label><select v-model="icope.sppb_balance" class="input-std text-sm"><option value="4">4分</option><option value="3">3分</option><option value="2">2分</option><option value="1">1分</option><option value="0">0分</option></select></div><div class="bg-white p-3 rounded-xl border"><label class="text-sm font-bold block mb-1">2. 4M行走</label><select v-model="icope.sppb_gait" class="input-std text-sm"><option value="4">4分</option><option value="3">3分</option><option value="2">2分</option><option value="1">1分</option><option value="0">0分</option></select></div><div class="bg-white p-3 rounded-xl border"><label class="text-sm font-bold block mb-1">3. 起立測試</label><select v-model="icope.sppb_chair" class="input-std text-sm"><option value="4">4分</option><option value="3">3分</option><option value="2">2分</option><option value="1">1分</option><option value="0">0分</option></select></div></div>
                    </div>
                </div>
                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-3 flex items-center"><i class="fa-solid fa-utensils mr-2 bg-indigo-100 p-2 rounded-lg"></i> C. 營養</h3>
                    <div class="q-row"><div class="q-label">體重減輕 >3kg?</div><div class="radio-group"><label><input type="radio" v-model="icope.nutri_q1" value="yes"> 是</label><label><input type="radio" v-model="icope.nutri_q1" value="no"> 否</label></div></div>
                    <div class="q-row"><div class="q-label">食慾減少?</div><div class="radio-group"><label><input type="radio" v-model="icope.nutri_q2" value="yes"> 是</label><label><input type="radio" v-model="icope.nutri_q2" value="no"> 否</label></div></div>
                    <div v-if="isIcopeNutriAbnormal" class="mt-5 bg-yellow-50 p-5 rounded-2xl border border-yellow-200"><div class="flex justify-between mb-3"><h4 class="font-bold text-yellow-800">MNA-SF</h4><span class="badge badge-yellow">總分: {{ icope.mna_total }}/14</span></div><div class="grid grid-cols-2 gap-4 text-sm"><div class="bg-white p-2 border rounded">A.食慾:<select v-model="icope.mna_a" class="w-full"><option value="2">無變</option><option value="1">中減</option><option value="0">嚴減</option></select></div><div class="bg-white p-2 border rounded">B.體重:<select v-model="icope.mna_b" class="w-full"><option value="3">無變</option><option value="2">減1-3</option><option value="0">減>3</option></select></div><div class="bg-white p-2 border rounded">C.活動:<select v-model="icope.mna_c" class="w-full"><option value="2">自如</option><option value="1">可下床</option><option value="0">臥床</option></select></div><div class="bg-white p-2 border rounded">D.壓力:<select v-model="icope.mna_d" class="w-full"><option value="2">無</option><option value="0">有</option></select></div><div class="bg-white p-2 border rounded">E.精神:<select v-model="icope.mna_e" class="w-full"><option value="2">無</option><option value="1">輕度</option><option value="0">嚴重</option></select></div><div class="bg-white p-2 border rounded flex items-center">F.BMI: <span class="ml-auto font-bold">{{ mna_bmi_score }}</span></div></div></div>
                </div>
                <div class="form-card">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4 border-b pb-3 flex items-center"><i class="fa-solid fa-face-frown mr-2 bg-indigo-100 p-2 rounded-lg"></i> F. 憂鬱</h3>
                    <div class="q-row"><div class="q-label">常感到情緒低落?</div><div class="radio-group"><label><input type="radio" v-model="icope.dep_q1" value="yes"> 是</label><label><input type="radio" v-model="icope.dep_q1" value="no"> 否</label></div></div>
                    <div class="q-row"><div class="q-label">提不起興趣?</div><div class="radio-group"><label><input type="radio" v-model="icope.dep_q2" value="yes"> 是</label><label><input type="radio" v-model="icope.dep_q2" value="no"> 否</label></div></div>
                    <div v-if="isIcopeDepAbnormal" class="mt-5 bg-gray-50 p-5 rounded-2xl border border-gray-200"><div class="flex justify-between mb-3"><h4 class="font-bold text-gray-700">GDS-15</h4><span class="badge" :class="icope.gds_score>=5?'badge-red':'badge-green'">得分: {{ icope.gds_score }}/15</span></div><div class="h-32 overflow-y-auto space-y-2"><label v-for="n in 15" :key="n" class="flex items-center p-2 bg-white border rounded"><span class="flex-1">題目 {{n}}</span><input type="checkbox" v-model="icope.gds_items" :value="n" class="ml-2"></label></div></div>
                </div>
            </div>

            <div v-if="currentTab === 'cms'" class="space-y-6 animate-fade-in-up pb-24">
                <div class="form-card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="text-lg font-bold text-teal-700 flex items-center"><i class="fa-solid fa-hands-holding-circle mr-2"></i>E. ADL</h3><span class="badge badge-gray text-lg bg-teal-50 text-teal-800 border-teal-200">總分: {{ cms_adl_score }}</span></div>
                    <div class="space-y-4"><div v-for="(item, key) in cmsAdlItems" :key="key" class="bg-gray-50 p-4 rounded-xl border border-gray-100 hover:border-teal-200 transition"><label class="font-bold text-gray-700 block mb-2 text-sm">{{ item.label }}</label><select v-model="cms.adl[key]" class="input-std text-sm bg-white shadow-sm border-gray-200"><option v-for="opt in item.options" :value="opt.val">{{ opt.text }} ({{opt.val}}分)</option></select></div></div>
                </div>
                <div class="form-card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="text-lg font-bold text-teal-700 flex items-center"><i class="fa-solid fa-phone-volume mr-2"></i>F. IADL</h3><span class="badge badge-gray text-lg bg-teal-50 text-teal-800 border-teal-200">總分: {{ cms_iadl_score }}</span></div>
                    <div class="space-y-4"><div v-for="(item, key) in cmsIadlItems" :key="key" class="bg-gray-50 p-4 rounded-xl border border-gray-100 hover:border-teal-200 transition"><label class="font-bold text-gray-700 block mb-2 text-sm">{{ item.label }}</label><select v-model="cms.iadl[key]" class="input-std text-sm bg-white shadow-sm border-gray-200"><option v-for="opt in item.options" :value="opt.val">{{ opt.text }} ({{opt.val}}分)</option></select></div></div>
                </div>
            </div>

            <div v-if="currentTab === 'health'" class="space-y-6 animate-fade-in-up pb-24">
                <div class="form-card">
                    <h3 class="text-lg font-bold text-slate-700 mb-6 border-b pb-2 flex items-center"><i class="fa-solid fa-clipboard-list mr-2"></i>病史與行為</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><h4 class="font-bold text-sm text-gray-500 mb-3 uppercase">個人病史</h4><div class="space-y-2"><label class="flex items-center"><input type="checkbox" v-model="health.history_htn" class="mr-2"> 高血壓</label><label class="flex items-center"><input type="checkbox" v-model="health.history_dm" class="mr-2"> 糖尿病</label><label class="flex items-center"><input type="checkbox" v-model="health.history_kidney" class="mr-2"> 腎臟病</label></div></div>
                        <div><h4 class="font-bold text-sm text-gray-500 mb-3 uppercase">健康行為</h4><div class="space-y-4"><div><span class="text-sm font-bold block">吸菸</span><select v-model="health.habit_smoke" class="input-std text-sm"><option value="no">不吸菸</option><option value="yes">吸菸</option><option value="quit">已戒菸</option></select></div><div><span class="text-sm font-bold block">喝酒</span><select v-model="health.habit_alcohol" class="input-std text-sm"><option value="no">不喝酒</option><option value="yes">偶爾/常喝</option></select></div></div></div>
                    </div>
                </div>
                <div class="form-card">
                    <h3 class="text-lg font-bold text-rose-700 mb-6 border-b pb-2 flex items-center"><i class="fa-solid fa-file-medical mr-2"></i>檢查數值</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-rose-50/30 p-5 rounded-2xl border border-rose-100"><h4 class="font-bold text-rose-800 mb-4 text-sm uppercase flex items-center">理學檢查</h4><div class="space-y-4"><div><label class="text-xs font-bold block text-gray-500 mb-1">收縮壓 (mmHg)</label><input v-model="health.sbp" type="number" class="input-std font-mono font-bold text-lg"></div><div><label class="text-xs font-bold block text-gray-500 mb-1">舒張壓 (mmHg)</label><input v-model="health.dbp" type="number" class="input-std font-mono font-bold text-lg"></div><div><label class="text-xs font-bold block text-gray-500 mb-1">腰圍 (cm)</label><input v-model="health.waist" type="number" class="input-std font-mono font-bold text-lg"></div></div></div>
                        <div class="bg-blue-50/30 p-5 rounded-2xl border border-blue-100"><h4 class="font-bold text-blue-800 mb-4 text-sm uppercase flex items-center">生化檢驗</h4><div class="space-y-4"><div><label class="text-xs font-bold block text-gray-500 mb-1">肌酸酐 (Cre)</label><input v-model="health.cre" type="number" class="input-std font-mono font-bold text-lg"></div><div><label class="text-xs font-bold block text-gray-500 mb-1">飯前血糖 (AC)</label><input v-model="health.glu_ac" type="number" class="input-std font-mono font-bold text-lg"></div><div><label class="text-xs font-bold block text-gray-500 mb-1">TG / HDL</label><div class="flex gap-2"><input v-model="health.tg" type="number" class="input-std" placeholder="TG"><input v-model="health.hdl" type="number" class="input-std" placeholder="HDL"></div></div></div></div>
                    </div>
                    <div class="mt-8 border-t border-dashed border-gray-200 pt-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm"><span class="text-sm font-bold text-gray-500">eGFR (腎功能)</span><span class="font-mono font-black text-2xl text-blue-600">{{ calculatedEgfr }}</span></div>
                            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm"><span class="text-sm font-bold text-gray-500">代謝症候群</span><span class="font-bold text-lg flex items-center" :class="isMetabolicSyndrome ? 'text-red-600' : 'text-green-600'"><i :class="isMetabolicSyndrome ? 'fa-solid fa-circle-exclamation mr-2' : 'fa-solid fa-circle-check mr-2'"></i>{{ isMetabolicSyndrome ? '異常' : '正常' }}</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'history'" class="space-y-6 animate-fade-in-up pb-24">
                <div class="form-card min-h-[400px]">
                    <h3 class="text-lg font-bold text-purple-700 mb-6 flex items-center border-b pb-3"><i class="fa-solid fa-file-waveform mr-3 bg-purple-100 p-2 rounded-lg"></i> 歷史評估紀錄</h3>
                    <div v-if="historyResults.length > 0" class="pl-4 border-l-2 border-purple-100 space-y-8">
                        <div v-for="(session, timestamp) in groupedHistory" :key="timestamp" class="relative pl-6">
                            <div class="absolute -left-[21px] top-0 w-4 h-4 rounded-full bg-purple-500 border-4 border-white shadow-sm"></div>
                            <div class="mb-3"><span class="text-sm font-bold text-purple-600 bg-purple-50 px-3 py-1 rounded-full border border-purple-100">{{ timestamp }}</span></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div v-if="session.hasHealth" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><h5 class="font-bold text-rose-700 mb-2 border-b pb-1 text-sm">健康檢查</h5><ul class="text-sm space-y-1"><li v-if="session.data['systolic_bp']" class="flex justify-between"><span>BP</span><span>{{session.data['systolic_bp']}}/{{session.data['diastolic_bp']}}</span></li><li v-if="session.data['lab_egfr']" class="flex justify-between"><span>eGFR</span><span>{{session.data['lab_egfr']}}</span></li></ul></div>
                                <div v-if="session.hasIcope" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><h5 class="font-bold text-indigo-700 mb-2 border-b pb-1 text-sm">ICOPE</h5><ul class="text-sm space-y-1"><li v-if="session.data['icope_ad8_score']" class="flex justify-between"><span>AD8</span><span>{{session.data['icope_ad8_score']}}</span></li><li v-if="session.data['icope_sppb_score']" class="flex justify-between"><span>SPPB</span><span>{{session.data['icope_sppb_score']}}</span></li></ul></div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center py-12 text-gray-400">請先選擇病患以查看歷史紀錄</div>
                </div>
            </div>

            <div v-if="currentTab !== 'history'" class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex justify-between items-center z-40">
                <div class="text-xs text-gray-400 hidden md:block"><i class="fa-solid fa-circle-info mr-1"></i> 請完成所有必要欄位後再送出</div>
                <div class="flex space-x-3 w-full md:w-auto">
                    <button @click="resetForm" class="flex-1 md:flex-none px-6 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-100 transition">重置</button>
                    <button @click="showPreview" class="flex-1 md:flex-none bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition transform"><i class="fa-solid fa-check-circle mr-2"></i> 預覽並儲存</button>
                </div>
            </div>
        </div>

        <div v-if="showPreviewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4 backdrop-blur-md animate-fade-in-up">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-gray-50 to-white"><h3 class="text-xl font-bold text-gray-800">確認評估資料</h3><button @click="showPreviewModal = false" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-xmark"></i></button></div>
                <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="(item, idx) in previewData" :key="idx" class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex justify-between items-center"><span class="text-sm font-bold text-gray-500">{{ item.label }}</span><div class="text-right"><span class="block font-bold text-gray-800" :class="item.isAbnormal ? 'text-red-600' : ''">{{ item.value }}</span><span v-if="item.unit" class="text-xs text-gray-400">{{ item.unit }}</span></div></div>
                    </div>
                </div>
                <div class="p-5 border-t border-gray-100 bg-white flex justify-end space-x-3"><button @click="showPreviewModal = false" class="px-6 py-2.5 rounded-xl text-gray-500 font-bold hover:bg-gray-100 transition">返回修改</button><button @click="submitToGas" class="px-8 py-2.5 rounded-xl bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 hover:shadow-xl transition flex items-center"><span v-if="!loading">確認送出</span><span v-else>傳輸中...</span></button></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, reactive, computed, ref, onMounted, watch } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const loadingText = ref('');
                const isLoggedIn = ref(false);
                const currentUser = ref({});
                const currentTab = ref('icope');
                const showPreviewModal = ref(false);

                const patientsList = ref([]);
                const searchQuery = ref('');
                const showSuggestions = ref(false);
                const historySearchQuery = ref('');
                const isSearchingHistory = ref(false);
                const historyResults = ref([]);
                const historySearchPerformed = ref(false);

                const patient = reactive({ id: '', name: '', gender: 'male', height: '', weight: '', bmi: '' });
                
                // Initialize all reactive objects
                const icope = reactive({ 
                    cognition_q1: '', cognition_q2: '', ad8_items: [], ad8_score: 0, 
                    mobility_q1: '', chair_stand_sec: '', sppb_balance: '4', sppb_gait: '4', sppb_chair: '4', sppb_total: 12, 
                    nutri_q1: '', nutri_q2: '', mna_a: '2', mna_b: '3', mna_c: '2', mna_d: '2', mna_e: '2', mna_total: 14, 
                    dep_q1: '', dep_q2: '', gds_items: [], gds_score: 0 
                });
                const cms = reactive({ adl: { e1: 10, e2: 10, e3: 10, e4: 10, e5: 10, e6: 10, e7: 10, e8: 10, e9: 10, e10: 10 }, iadl: { f1: 3, f2: 3, f3: 3, f4: 3, f5: 3, f6: 3, f7: 3, f8: 3 } });
                const health = reactive({ 
                    sbp: '', dbp: '', waist: '', pulse: '', cre: '', glu_ac: '', tg: '', hdl: '', lab_ast: '', lab_alt: '', lab_tcho: '', lab_hbsag: '', lab_hcv: '',
                    history_htn: false, history_dm: false, history_kidney: false, history_lipid: false, history_heart: false, history_stroke: false,
                    habit_smoke: 'no', habit_alcohol: 'no', habit_betel: 'no', habit_exercise: 'no', urine_protein: '-'
                });

                // Dictionaries
                const cmsAdlItems = { e1: {label:'1.進食',options:[{val:10,text:'獨立'},{val:5,text:'協助'},{val:0,text:'依賴'}]}, e2: {label:'2.移位',options:[{val:15,text:'獨立'},{val:10,text:'稍助'},{val:5,text:'可坐'},{val:0,text:'依賴'}]}, e3: {label:'3.修飾',options:[{val:5,text:'獨立'},{val:0,text:'依賴'}]}, e4: {label:'4.如廁',options:[{val:10,text:'獨立'},{val:5,text:'協助'},{val:0,text:'依賴'}]}, e5: {label:'5.洗澡',options:[{val:5,text:'獨立'},{val:0,text:'依賴'}]}, e6: {label:'6.行走',options:[{val:15,text:'獨立'},{val:10,text:'協助'},{val:5,text:'輪椅'},{val:0,text:'依賴'}]}, e7: {label:'7.上下樓',options:[{val:10,text:'獨立'},{val:5,text:'協助'},{val:0,text:'依賴'}]}, e8: {label:'8.穿脫衣',options:[{val:10,text:'獨立'},{val:5,text:'協助'},{val:0,text:'依賴'}]}, e9: {label:'9.大便',options:[{val:10,text:'自控'},{val:5,text:'偶失禁'},{val:0,text:'失禁'}]}, e10: {label:'10.小便',options:[{val:10,text:'自控'},{val:5,text:'偶失禁'},{val:0,text:'失禁'}]} };
                const cmsIadlItems = { f1: {label:'1.購物',options:[{val:3,text:'獨立'},{val:2,text:'陪同'},{val:1,text:'代購'},{val:0,text:'無'}]}, f2: {label:'2.外出',options:[{val:3,text:'獨立'},{val:2,text:'陪同'},{val:1,text:'接送'},{val:0,text:'無'}]}, f3: {label:'3.烹調',options:[{val:3,text:'獨立'},{val:2,text:'準備'},{val:1,text:'加熱'},{val:0,text:'無'}]}, f4: {label:'4.家務',options:[{val:3,text:'獨立'},{val:2,text:'簡易'},{val:1,text:'無法'}]}, f5: {label:'5.洗衣',options:[{val:3,text:'獨立'},{val:2,text:'小件'},{val:1,text:'無法'}]} };

                onMounted(async () => {
                    const userStr = localStorage.getItem('currentUser');
                    if (!userStr) { alert('請先從首頁登入'); window.location.href = 'index.html'; } 
                    else { 
                        currentUser.value = JSON.parse(userStr); isLoggedIn.value = true; 
                        try { const res = await fetch(`${API_BASE_URL}?endpoint=patients`); const json = await res.json(); if(json.status === 'success') patientsList.value = json.data;
                        const targetId = localStorage.getItem('targetPatientId');
                        if(targetId) { const p = patientsList.value.find(x => x.id === targetId); if(p) selectPatient(p); localStorage.removeItem('targetPatientId'); }
                        } catch(e){console.error(e);} 
                    }
                });

                watch(() => patient.id, (newVal) => { if (newVal) historySearchQuery.value = newVal; });
                const filteredPatients = computed(() => { if (!searchQuery.value) return []; const q = searchQuery.value.toLowerCase(); return patientsList.value.filter(p => p.id.toLowerCase().includes(q) || p.name.toLowerCase().includes(q)).slice(0, 10); });
                const handleSearchInput = () => { patient.id = searchQuery.value; };
                const clearSearch = () => { searchQuery.value = ''; patient.id = ''; patient.name = ''; patient.height = ''; patient.weight = ''; patient.bmi = ''; };
                
                const selectPatient = async (p) => { 
                    patient.id = p.id; patient.name = p.name; patient.gender = p.gender; searchQuery.value = p.id; showSuggestions.value = false; 
                    try { 
                        loading.value = true; 
                        const res = await fetch(`${API_BASE_URL}?endpoint=observations`); 
                        const json = await res.json(); 
                        if (json.status === 'success') { 
                            const patientObs = json.data.filter(o => String(o.patientID) === String(p.id)); 
                            patientObs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
                            const latestH = patientObs.find(o => o.code === 'body_height'); 
                            const latestW = patientObs.find(o => o.code === 'body_weight'); 
                            if (latestH) patient.height = latestH.value; 
                            if (latestW) patient.weight = latestW.value; 
                            calculateBMI(); 
                            historyResults.value = patientObs.filter(obs => obs.code.startsWith('icope') || obs.code.startsWith('cms') || obs.code.startsWith('health') || obs.code.startsWith('lab') || obs.code.startsWith('sys') || obs.code.startsWith('dias') || obs.code.startsWith('bmi') || obs.code.startsWith('body')); 
                            historySearchQuery.value = p.id; 
                        } 
                    } catch (e) { console.error(e); } finally { loading.value = false; } 
                };
                
                document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) showSuggestions.value = false; });
                const calculateBMI = () => { if (patient.height && patient.weight) { const h = patient.height / 100; patient.bmi = (patient.weight / (h * h)).toFixed(1); } };

                // Logics
                const isIcopeCognitionAbnormal = computed(() => icope.cognition_q1 === 'fail' || icope.cognition_q2 === 'fail');
                const isIcopeMobilityAbnormal = computed(() => icope.chair_stand_sec > 12 || icope.mobility_q1 === 'yes');
                const isIcopeNutriAbnormal = computed(() => icope.nutri_q1 === 'yes' || icope.nutri_q2 === 'yes');
                const isIcopeDepAbnormal = computed(() => icope.dep_q1 === 'yes' || icope.dep_q2 === 'yes');
                const updateScores = () => { icope.ad8_score = icope.ad8_items.length; icope.sppb_total = parseInt(icope.sppb_balance) + parseInt(icope.sppb_gait) + parseInt(icope.sppb_chair); const bmiScore = !patient.bmi ? 0 : (patient.bmi < 19 ? 0 : (patient.bmi < 21 ? 1 : (patient.bmi < 23 ? 2 : 3))); icope.mna_total = parseInt(icope.mna_a) + parseInt(icope.mna_b) + parseInt(icope.mna_c) + parseInt(icope.mna_d) + parseInt(icope.mna_e) + bmiScore; icope.gds_score = icope.gds_items.length; };
                const mna_bmi_score = computed(() => { if(!patient.bmi) return 0; if(patient.bmi < 19) return 0; if(patient.bmi < 21) return 1; if(patient.bmi < 23) return 2; return 3; });
                const cms_adl_score = computed(() => Object.values(cms.adl).reduce((a,b) => parseInt(a)+parseInt(b), 0));
                const cms_iadl_score = computed(() => Object.values(cms.iadl).reduce((a,b) => parseInt(a)+parseInt(b), 0));
                
                const calculatedEgfr = computed(() => { if (!health.cre) return '--'; const age = 65; let egfr = 186 * Math.pow(health.cre, -1.154) * Math.pow(age, -0.203); if (patient.gender === 'female') egfr *= 0.742; return egfr.toFixed(1); });
                const calculatedLdl = computed(() => { if(health.lab_tcho && health.hdl && health.tg && health.tg <= 400) { return (health.lab_tcho - health.hdl - (health.tg / 5)).toFixed(0); } return '--'; });
                const isMetabolicSyndrome = computed(() => { let c = 0; if (health.waist && ((patient.gender === 'male' && health.waist >= 90) || (patient.gender === 'female' && health.waist >= 80))) c++; if (health.sbp >= 130 || health.dbp >= 85) c++; if (health.glu_ac >= 100) c++; if (health.tg >= 150) c++; if (health.hdl && ((patient.gender === 'male' && health.hdl < 40) || (patient.gender === 'female' && health.hdl < 50))) c++; return c >= 3; });

                const previewData = computed(() => { updateScores(); const list = [];
                    if(patient.bmi) list.push({label:'BMI', value: patient.bmi, isAbnormal: patient.bmi>24 || patient.bmi<18.5});
                    if(health.sbp) list.push({label:'血壓', value: `${health.sbp}/${health.dbp}`, unit:'mmHg', isAbnormal: health.sbp>=130});
                    if(calculatedEgfr.value !== '--') list.push({label:'eGFR', value: calculatedEgfr.value, isAbnormal: calculatedEgfr.value < 60});
                    if(icope.cognition_q1) list.push({label:'ICOPE-記憶力', value: icope.cognition_q1==='pass'?'通過':'異常', isAbnormal: icope.cognition_q1==='fail'});
                    if(isIcopeCognitionAbnormal.value) list.push({label:'AD8 總分', value: icope.ad8_score + '/8', isAbnormal: icope.ad8_score >= 2});
                    return list;
                });

                const searchHistory = async () => { if(!historySearchQuery.value) { alert('請輸入病歷號'); return; } isSearchingHistory.value = true; historyResults.value = []; historySearchPerformed.value = true; try { const res = await fetch(`${API_BASE_URL}?endpoint=observations`); const json = await res.json(); if(json.status === 'success') { const q = historySearchQuery.value.toLowerCase(); let targetId = q; const foundPatient = patientsList.value.find(p => p.name.toLowerCase() === q || p.id.toLowerCase() === q); if(foundPatient) targetId = foundPatient.id.toLowerCase(); historyResults.value = json.data.filter(obs => String(obs.patientID).toLowerCase() === targetId && (obs.code.startsWith('icope') || obs.code.startsWith('cms') || obs.code.startsWith('health') || obs.code.startsWith('lab') || obs.code.startsWith('sys') || obs.code.startsWith('dias') || obs.code.startsWith('bmi') || obs.code.startsWith('body'))); } } catch(e) { console.error(e); } finally { isSearchingHistory.value = false; } };
                const groupedHistory = computed(() => { if(historyResults.value.length === 0) return {}; const groups = {}; historyResults.value.forEach(obs => { const timeKey = obs.timestamp.substring(0, 16); if(!groups[timeKey]) { groups[timeKey] = { timestamp: timeKey, data: {}, hasIcope:false, hasCms:false, hasHealth:false }; } groups[timeKey].data[obs.code] = obs.value; if(obs.code.startsWith('icope')) groups[timeKey].hasIcope = true; if(obs.code.startsWith('cms')) groups[timeKey].hasCms = true; if(obs.code.startsWith('health') || obs.code.startsWith('lab') || obs.code.startsWith('sys')) groups[timeKey].hasHealth = true; }); return Object.keys(groups).sort().reverse().reduce((obj, key) => { obj[key] = groups[key]; return obj; }, {}); });

                const showPreview = () => { if (!patient.id) { alert('請填寫病歷號'); return; } showPreviewModal.value = true; };
                
                // [FIX] Full Submit Function
                const submitToGas = async () => {
                    loading.value = true; loadingText.value = '加密傳輸中...';
                    const records = [];
                    const pushRec = (c, v, u='') => { if(v!=='' && v!==null && v!==undefined) records.push({code:c, value:v, unit:u}); };
                    
                    updateScores(); // Ensure scores calculated

                    // Basic
                    pushRec('body_height', patient.height, 'cm'); pushRec('body_weight', patient.weight, 'kg'); pushRec('bmi', patient.bmi);
                    
                    // Health
                    if(health.history_htn) pushRec('history_htn', 'yes');
                    pushRec('habit_smoke', health.habit_smoke);
                    pushRec('systolic_bp', health.sbp, 'mmHg'); pushRec('diastolic_bp', health.dbp, 'mmHg'); pushRec('body_waist', health.waist, 'cm');
                    pushRec('lab_cre', health.cre, 'mg/dL'); pushRec('lab_egfr', calculatedEgfr.value, 'ml/min');
                    pushRec('health_metabolic', isMetabolicSyndrome.value ? 'yes' : 'no');

                    // ICOPE (Comprehensive)
                    pushRec('icope_cog_screen', isIcopeCognitionAbnormal.value?'fail':'pass');
                    if(isIcopeCognitionAbnormal.value) {
                        pushRec('icope_ad8_score', icope.ad8_score);
                        pushRec('icope_ad8_items', icope.ad8_items.join(',')); // Fixed: Array to string
                    }
                    pushRec('icope_mob_screen', isIcopeMobilityAbnormal.value?'fail':'pass');
                    if(isIcopeMobilityAbnormal.value) {
                        pushRec('icope_sppb_total', icope.sppb_total);
                        pushRec('icope_chair_stand_sec', icope.chair_stand_sec, 'sec');
                    }
                    pushRec('icope_nut_screen', isIcopeNutriAbnormal.value?'fail':'pass');
                    if(isIcopeNutriAbnormal.value) pushRec('icope_mna_total', icope.mna_total);
                    pushRec('icope_dep_screen', isIcopeDepAbnormal.value?'fail':'pass');
                    if(isIcopeDepAbnormal.value) {
                        pushRec('icope_gds_score', icope.gds_score);
                        pushRec('icope_gds_items', icope.gds_items.join(',')); // Fixed: Array to string
                    }

                    // CMS
                    pushRec('cms_adl_score', cms_adl_score.value);
                    pushRec('cms_iadl_score', cms_iadl_score.value);

                    try { await fetch(API_BASE_URL, { method: 'POST', body: JSON.stringify({ action: 'saveAssessment', patientId: patient.id, records: records }) }); setTimeout(() => { alert('存檔成功'); showPreviewModal.value = false; }, 500); } 
                    catch (e) { console.error(e); alert('連線錯誤: ' + e.message); } finally { loading.value = false; }
                };

                const resetForm = () => { if(confirm('清空?')) window.location.reload(); };
                const closeWindow = () => window.close();

                return { loading, loadingText, isLoggedIn, currentUser, currentTab, patientsList, searchQuery, showSuggestions, filteredPatients, handleSearchInput, selectPatient, clearSearch, patient, icope, cms, health, calculateBMI, isIcopeCognitionAbnormal, isIcopeMobilityAbnormal, isIcopeNutriAbnormal, isIcopeDepAbnormal, mna_bmi_score, cms_adl_score, cms_iadl_score, cmsAdlItems, cmsIadlItems, calculatedEgfr, calculatedLdl, isMetabolicSyndrome, showPreviewModal, showPreview, previewData, submitToGas, closeWindow, resetForm, historySearchQuery, isSearchingHistory, searchHistory, groupedHistory, historyResults, historySearchPerformed };
            }
        }).mount('#app');
    </script>
</body>
</html>