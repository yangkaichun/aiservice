<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœæ¡è³¼ AI æˆ°æƒ…å®¤ v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .btn-gradient { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm/50 backdrop-blur-md bg-white/90">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white w-10 h-10 flex items-center justify-center rounded-lg shadow-lg shadow-blue-500/30">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <h1 class="font-bold text-xl text-slate-900 tracking-tight">æ”¿åºœæ¡è³¼ AI æˆ°æƒ…å®¤</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="sendTestData()" class="hidden md:flex items-center gap-2 px-3 py-2 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-md transition text-sm font-bold border border-amber-200">
                    <i class="fas fa-vial"></i> æ¸¬è©¦é€£ç·š
                </button>
                <a href="https://web.pcc.gov.tw/prkms/today/common/todayTender" target="_blank" class="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-md transition text-sm font-medium">
                    <i class="fas fa-external-link-alt"></i> æ¡è³¼ç¶²
                </a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">

        <script>
            /* ============================================================
               âš™ï¸ è«‹åœ¨æ­¤ä¿®æ”¹æ‚¨çš„é€£çµ
               ============================================================ */
            // 1. Google Sheet CSV ç™¼å¸ƒé€£çµ
            const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRkEEW8B0tTRNlfJ2x0XTGoLh2fn02FXgPf2GF4lY_fZS0teUFHGq_qhjofp8zHMpqRiOhN9fcMz2MX/pub?output=csv";

            // 2. n8n Webhook æ­£å¼é€£çµ (Production URL)
            const WEBHOOK_URL = "https://ai.yangkaichun.net/webhook/pcc-receiver";
            /* ============================================================ */
        </script>

        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white border border-blue-100 rounded-2xl p-6 shadow-sm flex flex-col justify-between relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 transition group-hover:scale-110"></div>
                <div>
                    <h2 class="text-lg font-bold text-slate-800 mb-2"><i class="fas fa-download text-blue-500 mr-2"></i>å®‰è£æŠ“å–å·¥å…·</h2>
                    <p class="text-sm text-slate-500 mb-4">è«‹å°‡ä¸‹æ–¹æŒ‰éˆ• <strong class="text-blue-600">æ‹–æ›³åˆ°æ›¸ç±¤åˆ—</strong>ï¼Œåœ¨æ¡è³¼ç¶²é é¢é»æ“Šå³å¯ä½¿ç”¨ã€‚</p>
                </div>
                <a id="bookmarklet-link" href="" onclick="return false;" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition transform hover:-translate-y-1 cursor-grab active:cursor-grabbing">
                    <i class="fas fa-bookmark mr-2"></i> AI æ¡è³¼åˆ†æ (æ‹–æ‹‰æˆ‘)
                </a>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm flex flex-col justify-between">
                <div>
                    <h2 class="text-lg font-bold text-slate-800 mb-2"><i class="fas fa-network-wired text-green-500 mr-2"></i>ç³»çµ±ç‹€æ…‹æ¸¬è©¦</h2>
                    <p class="text-sm text-slate-500 mb-4">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç¶²é æœƒæ¨¡æ“¬å‚³é€ä¸€ç­†ã€Œæ¸¬è©¦è³‡æ–™ã€çµ¦ AIï¼Œé©—è­‰ n8n æ˜¯å¦æ­£å¸¸é‹ä½œã€‚</p>
                </div>
                <button onclick="sendTestData()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg transition transform hover:-translate-y-1">
                    <i class="fas fa-paper-plane mr-2"></i> ç™¼é€æ¸¬è©¦æ•¸æ“š (Execute Java)
                </button>
            </div>
        </div>

        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-chart-line text-blue-600"></i> æœ€æ–°æ¨™æ¡ˆæƒ…å ±
            </h2>
            <button onclick="location.reload()" class="text-sm text-slate-500 hover:text-blue-600 transition">
                <i class="fas fa-sync-alt mr-1"></i> é‡æ–°æ•´ç†
            </button>
        </div>
        
        <div id="loading" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600 mb-4"></div>
            <p class="text-slate-400 font-medium">æ­£åœ¨é€£ç·šè³‡æ–™åº«...</p>
        </div>

        <div id="tender-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>

    </main>

    <footer class="text-center py-8 text-slate-400 text-sm border-t border-slate-200 mt-12 bg-white">
        <p>Â© 2026 Government Procurement AI Dashboard.</p>
    </footer>

    <script>
        // 1. åˆå§‹åŒ–æ›¸ç±¤æŒ‰éˆ•ä»£ç¢¼
        const bookmarkletCode = `javascript:(function(){const u="${WEBHOOK_URL}";let t=[];const r=document.querySelectorAll("#print_area tr");r.forEach((e,n)=>{if(n===0)return;const c=e.querySelectorAll("td");if(c.length>3){const a=c[1]?.innerText.trim(),l=c[2]?.innerText.trim(),p=c[3]?.innerText.trim(),h=c[2]?.querySelector("a")?.href;l&&h&&t.push({agency:a,title:l,price:p,link:h})}});if(t.length===0)alert("âš ï¸ æ‰¾ä¸åˆ°æ¨™æ¡ˆï¼Œè«‹ç¢ºèªæ‚¨åœ¨æ¡è³¼ç¶²é é¢ä¸Šã€‚");else if(confirm("ğŸ” æ‰¾åˆ° "+t.length+" ç­†æ¨™æ¡ˆï¼Œå‚³é€çµ¦ AI åˆ†æï¼Ÿ")){fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:t})}).then(e=>{e.ok?alert("âœ… å‚³é€æˆåŠŸï¼"):alert("âŒ å‚³é€å¤±æ•—")}).catch(e=>alert("âŒ éŒ¯èª¤ï¼š"+e))}})();`;
        document.getElementById('bookmarklet-link').href = bookmarkletCode;

        // 2. æ¸¬è©¦é€£ç·šåŠŸèƒ½ (Execute JS in HTML)
        function sendTestData() {
            Swal.fire({
                title: 'æ­£åœ¨ç™¼é€æ¸¬è©¦...',
                text: 'æ¨¡æ“¬ä¸€ç­†æ¨™æ¡ˆè³‡æ–™å‚³é€çµ¦ n8n',
                didOpen: () => Swal.showLoading()
            });

            // æ¨¡æ“¬è³‡æ–™
            const testData = [{
                agency: "æ¸¬è©¦æ©Ÿé—œ_HTMLå‰ç«¯",
                title: "æ¸¬è©¦æ¨™æ¡ˆ - " + new Date().toLocaleString(),
                price: "1,000,000",
                link: "https://web.pcc.gov.tw"
            }];

            fetch(WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: testData })
            })
            .then(response => {
                if(response.ok) {
                    Swal.fire('æˆåŠŸï¼', 'æ¸¬è©¦è³‡æ–™å·²ç™¼é€ï¼ŒAI åˆ†æå¾Œæœƒå¯«å…¥ Google Sheetã€‚è«‹ç¨å¾Œé‡æ–°æ•´ç†ç¶²é æŸ¥çœ‹ã€‚', 'success');
                } else {
                    Swal.fire('å¤±æ•—', 'n8n å›å‚³éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Webhook URL', 'error');
                }
            })
            .catch(error => {
                Swal.fire('é€£ç·šéŒ¯èª¤', 'ç„¡æ³•é€£ç·šåˆ° n8n (CORS æˆ– ç¶²å€éŒ¯èª¤)', 'error');
            });
        }

        // 3. è®€å– Google Sheet CSV
        Papa.parse(SHEET_CSV_URL, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                const list = document.getElementById('tender-list');
                document.getElementById('loading').classList.add('hidden');
                
                if (!results.data || results.data.length === 0) {
                    list.innerHTML = `<div class="col-span-full text-center text-slate-400 py-10">å°šç„¡è³‡æ–™ï¼Œè«‹ä½¿ç”¨æ›¸ç±¤å·¥å…·æŠ“å–æˆ–é»æ“Šæ¸¬è©¦æŒ‰éˆ•ã€‚</div>`;
                    list.classList.remove('hidden');
                    return;
                }

                list.classList.remove('hidden');
                const tenders = results.data.reverse(); // æœ€æ–°åœ¨æœ€å‰

                tenders.forEach(item => {
                    if (!item.Title) return;

                    // åˆ†é¡æ¨£å¼é‚è¼¯
                    let catClass = "bg-gray-100 text-gray-600";
                    let icon = "fa-folder";
                    const c = (item.Category || "").toLowerCase();
                    if (c.includes("ai")) { catClass = "bg-purple-100 text-purple-600"; icon = "fa-brain"; }
                    else if (c.includes("é†«")) { catClass = "bg-emerald-100 text-emerald-600"; icon = "fa-heartbeat"; }
                    else if (c.includes("è»Ÿé«”") || c.includes("è³‡è¨Š")) { catClass = "bg-blue-100 text-blue-600"; icon = "fa-laptop-code"; }
                    else if (c.includes("æ¸¬è©¦")) { catClass = "bg-amber-100 text-amber-600"; icon = "fa-vial"; }

                    const card = document.createElement('div');
                    card.className = "card-hover bg-white rounded-xl border border-slate-100 p-5 flex flex-col h-full transition-all duration-300";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs font-bold px-2 py-1 rounded-md ${catClass} flex items-center gap-1">
                                <i class="fas ${icon}"></i> ${item.Category || 'æœªåˆ†é¡'}
                            </span>
                            <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded truncate max-w-[100px]">${item.Agency}</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 mb-2 leading-snug hover:text-blue-600 transition">
                            <a href="${item.Link}" target="_blank">${item.Title}</a>
                        </h3>
                        <div class="bg-slate-50 rounded-lg p-3 mb-4 border border-slate-100">
                            <p class="text-sm text-slate-600 leading-relaxed">
                                <i class="fas fa-magic text-amber-400 mr-1.5"></i> 
                                ${item.Summary || 'ç­‰å¾… AI åˆ†æ...'}
                            </p>
                        </div>
                        <div class="mt-auto pt-4 border-t border-slate-50 flex justify-between items-center text-sm">
                            <span class="font-mono font-bold text-slate-600">ğŸ’° ${item.Price || '-'}</span>
                            <a href="${item.Link}" target="_blank" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition">
                                <i class="fas fa-arrow-right text-xs"></i>
                            </a>
                        </div>
                    `;
                    list.appendChild(card);
                });
            },
            error: function() {
                document.getElementById('loading').innerHTML = `<p class="text-red-500">ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ Google Sheet CSV é€£çµã€‚</p>`;
            }
        });
    </script>
</body>
</html>