<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日招標資訊列表 - g0v API (CORS 修正版)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #555;
            margin-top: 50px;
        }
        .tender-list {
            list-style: none;
            padding: 0;
            max-width: 900px;
            margin: 20px auto;
        }
        .tender-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .tender-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .tender-item h3 {
            color: #007bff;
            margin-top: 0;
            border-bottom: 1px dotted #eee;
            padding-bottom: 5px;
        }
        .tender-item p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            width: 80px;
        }
        .no-data {
            text-align: center;
            color: #ff5733;
            font-size: 1.5em;
            padding: 50px;
        }
    </style>
</head>
<body>

    <h1 id="page-title">今日招標資訊列表</h1>

    <div id="loading">正在載入今日招標資料...</div>

    <ul class="tender-list" id="tender-results">
        </ul>

    <script>
        // **【CORS 修正】使用公開代理服務 (Proxy)**
        // 注意：公開代理服務不保證穩定性，建議正式環境使用自建後端服務。
        const PROXY_URL = 'https://api.allorigins.win/raw?url=';

        // g0v API 的基本 URL
        const G0V_API_BASE = 'https://pcc.g0v.ronny.tw/api/v1/tender/date/';
        const RESULTS_CONTAINER = document.getElementById('tender-results');
        const LOADING_ELEMENT = document.getElementById('loading');
        const PAGE_TITLE = document.getElementById('page-title');

        /**
         * 獲取今天的日期並格式化為 YYYY-MM-DD
         * @returns {string} 今天的日期字串
         */
        function getTodayDate() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * 從 g0v API 獲取今日招標資料 (透過代理服務)
         */
        async function fetchTodayTenders() {
            const today = getTodayDate();
            const originalApiUrl = `${G0V_API_BASE}${today}`;
            
            // **【關鍵修改】將原始 API 網址編碼後，透過代理服務的網址發出請求**
            const apiUrl = `${PROXY_URL}${encodeURIComponent(originalApiUrl)}`;
            
            // 更新頁面標題顯示今天的日期
            PAGE_TITLE.textContent = `今日招標資訊列表 (${today})`;

            try {
                // 發出請求到代理服務
                const response = await fetch(apiUrl); 
                
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤: ${response.status}`);
                }
                
                // 代理服務會直接返回 g0v API 的 JSON 內容
                const data = await response.json(); 
                
                // 檢查是否有資料
                if (data.tenders && data.tenders.length > 0) {
                    displayTenders(data.tenders);
                } else {
                    displayNoData(today);
                }

            } catch (error) {
                console.error("獲取資料失敗:", error);
                displayError("很抱歉，獲取招標資料失敗。這是由於 CORS 限制，請檢查網路連線，或嘗試更換代理服務。");
            } finally {
                // 無論成功或失敗，都移除載入中的訊息
                if (LOADING_ELEMENT) {
                    LOADING_ELEMENT.remove();
                }
            }
        }

        /**
         * 將招標資料列表顯示在頁面上
         * @param {Array<Object>} tenders - 招標案件陣列
         */
        function displayTenders(tenders) {
            tenders.forEach(tender => {
                const li = document.createElement('li');
                li.className = 'tender-item';
                
                // 標案連結
                const tenderUrl = `https://web.pcc.gov.tw/prkms/prms-viewTenderDetail.do?tenderId=${tender.unit_id}&seq=${tender.job_number}`;

                li.innerHTML = `
                    <h3><a href="${tenderUrl}" target="_blank" title="點擊前往政府採購網查看">${tender.name}</a></h3>
                    <p><span class="label">機關名稱:</span> ${tender.unit_name}</p>
                    <p><span class="label">採購金額:</span> ${tender.amount}</p>
                    <p><span class="label">聯絡人:</span> ${tender.contact_name || '無'}</p>
                    <p><span class="label">公告日期:</span> ${tender.publish_time}</p>
                `;
                RESULTS_CONTAINER.appendChild(li);
            });
        }

        /**
         * 顯示無資料訊息
         * @param {string} date - 日期
         */
        function displayNoData(date) {
            RESULTS_CONTAINER.innerHTML = `<div class="no-data">今日 (${date}) 暫無新的招標公告資料。</div>`;
        }

        /**
         * 顯示錯誤訊息
         * @param {string} message - 錯誤訊息
         */
        function displayError(message) {
            RESULTS_CONTAINER.innerHTML = `<div class="no-data" style="color:red;">${message}</div>`;
        }

        // 執行主要功能
        document.addEventListener('DOMContentLoaded', fetchTodayTenders);
    </script>

</body>
</html>
